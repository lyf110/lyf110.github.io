import{_ as e}from"./plugin-vue_export-helper-c27b6911.js";import{r as o,o as c,c as l,a as n,b as s,d as t,e as p}from"./app-5f6064b2.js";const i="/assets/image-20240407183435187-69-a3afe2cb.gif",u="/assets/image-20240407183435187-70-409b61c3.svg",k="/assets/image-20240407183435187-71-12ddb881.png",r="/assets/image-20240407183435187-72-421b1948.svg",d="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfoAAABQCAYAAADx5bd1AAAOMUlEQVR4nO3dvW6jShsH8L9fHcnkEtJbSsMpQwe1pZWirHwHdNBESpMoFxAdNxE0LtkrsE4UaWVql0553FhMnVzCupu3wF/gr8HGxh7/f1KKTYB5Zhh4jJmZrUkpJUrw/f0NALi+vi7jcERERFSC/1UdABERER0OEz0REZHGmOiJiIg0xkRPRESkMSZ6IiIijTHRExERaYyJnoiISGNM9ERERBpjoj+6GL5hwAlF1YHQyWHfUKd3W8W+AcNwoGn16MiY6I9MhK+IYKH1o1F1KHRi2DfUbWur0DFwdXU1+2HSpEvGRH9UAm9PA8B9wYNm9/LQMWD4cdVhnDF9+0b5trfVQ3+MP3/+pD///QPruAESnZS/qg7gkojQRQQL7cdm1aHQiWHfUHcJbdXsjDHuVB0F6YKJ/mgEfncHgPvOJzbKYd9Qx7YiKoqJ/ljiNzwNLLQjfZ9CaEfsG+rYVkSF8R39UQiEr5H6+1chEPoOHMPIDCZy/BBxHMLJDCxKRx+vG3AU+4bygCQRh3AWBjEZzqTM0Idh+Mi/gRehM9v2+bOG2q+fmQFQ8+OEm6sbh/AdJ7OP4/gI4+Vgp/UxDAdhHMN35v/2YwEgbbvZcdaOG8huN98+xIpiV9b56upqPupbxEvlqo392tY3qju/mRjPoq3KU6RP5mOMc9eu4/hpO4lw9vtV7b3LAMLl6yF333Cm1wVdNFmSr68v+fX1Vdbh9NLzpGEY0uupbWvXbekFPZkkC79PEtkLPGnX67Jet2WQ5PZLAmmv+r3i33ve5Li97AZJL5iU6clN4Qd2XdaVKpgv15Z125O9pfr0pGfXpb3qmEkak2EYs78ngS3rdVvadl3W7SBtu8l2y4foSa9en5S7UHCSpPHUbYVzlR7DDhKZTM9ZL5Hp0RL19lDtG5Wd3zNsq7xtbbdUzA59Mt1z8vcgc+3O6hwUiKNIzAvXQ/48pWWnbU+Xi4n+4CY3MjtQ2HRdYspvU3aiT2/E6+9f3kESfRLYaVJev4UM7BU3qUk7ZcubJqTs8XpefjuFxNLzVn+Yym4kvczNdTn27bfWon3j2Of3TNtqaVf1pLlzn5RbroFpnz1gol8Xd/ohePP1S3pjoj+0Ak8hy0mpgDKe+OxAJslun/yLJ/otyWce2PJNamVd5k+N2d1zcSklJpVzsfqDRSFFnlCrOL/n2lZ5yklzjz6p0FbTb50Ok+h37xukP03f0c/fa2772fxucn/hawR5+w+2zwQS+IgA66aaocTNzhjDlxFc18y9w/UPs9BI/IEILu62tUvzDi4ifJR0ksRoCFgtbFuTpnnnAtHH1r5htX5g1zOm3jf2t8v5vbi22qNPTttq09iBxo1ZSphERWk66r6JzniMyqehxj6eP2tw/31QuMGld1uzokQPAI1mB/1mttWEiPHmGnBaQ/Q1mM8kRgPUPj/x99Wzwta3GAmgeYhqF+ob5Sh6fi+5rYoSowGA1uaNGjewMDxKPESLNE30pyH+iCBv24WeQoYHu1vuptFoohO14Zgm/JsxOmc+q6lxY0HetjDsV5s0dukbh7Dp/LKt1DVuLGzN4WIEhY8DRKXT9Kv7EyBCpDOBVG+STdy5wGB0glNhGg9oWUBU1vfngPpX8qpfpypq/GjBGnTxu8pmLtw3DmzN+b24ttqjTzZuTGDQ3fiaK/6ISgmTqCgm+gOJ354wsIo9hTQf27Cie2xeMl7stK68+N3FYM3fYt/YMtc9xmiwefxA8dePTTy2LUSv4YY51Om8aav9iNIe5hoPeHEHeHI3lQsgnswtP0CS26VvbHOQ86tpW623R59sdtC2Bnh6W3NdTj6wEFWBif4QJhd14cFHjQdE7y6iewd+mL1hCDFdiMNE12xjmP8OfXpTfssuPiJEuqiM28XG/9ij9vk8Wdgjd4sTAqFzj8hqI9rwjr5556L26yecxbiFmC08YhjOUiJoPPTxbnZhrig3jdtE13wvfWxAszOelRvGYqm9Qt+BcT+E234s/y3KHn2jivN7lm21h3365EP/He7wfmkBIBH7cMwnmO02/3MdqkZZw/c5vW4uXZzE230qUdKTgWfPFsEwDCNdDMYLsouWLO8oA8+e7WMYhrSnC2hkFtXIzkWeTo9KpuXaC+Xa6eI9amEH0lvYd1p+EPQ2tkW633Lc+cVdprEubjevy8Jc7YWpT4vb56dNrSp3Wt/V8c7L2PSzaarZfn2juvN7Pm2VznPfVm6+n6jUd12fzJffy1279nTtgLXT3HaNebmN83Vaf73QJalJKWUZHxi+v78BANfX12Uc7nyJEI75BLT1GKVOJWLfUKdjW4kQjtlFa9jnf8hDR8VR9yVL35W6eOeVTDnsG+q0bCuOuqeK8ImeiOgIROjA7LYw7j9UHQpdGA7GIyI6KIE4dGA+Ae8RkzwdHxM9EVFpVi2//TdeRy0Mh/1TWguLLgi/uiciItIYn+iJiIg0xkRPRESkMSZ6IiIijTHRExERaYyJnoiISGNM9ERERBpjoiciItIYEz0REZHGmOiJiIg0xkRPRESkMSZ6IiIijTHRExERaYyJnoiISGNM9ERERBpjoiciItIYEz0REZHGmOiPLoZvGHBCUXUgdHLYN9SxrYhUMdEfmQhfEcFC60ej6lDoxLBvqDuPthKIfQeOYeDq6mr24zjOmX9AEfAndTIMB2ddlQvBRH9UAm9PA8B9wcMp3592EDoGDD+uOowzpm/fKN95tFXomLiPTLwMx/jz58/sp9/vo3/KgW/VQGc8xp///oFVdSikhIn+iEToIoKF9mOz6lDoxLBvqDuLthIhugML7WEHzXPO6aSFv6oO4HII/O4OAPf9pJ9CqArsG+rOpK3ECAOYeDnlGOliMNEfS/yGp4GFdnTCTyFUDfYNdWwrosL41f1RCISvkfo7RSEQ5gbxGIYDxw8RxyGczACYeOPAmNjPHmPTwBkRh3Cche2dSZmhD8PwkX8DL0Jntu3zZw21Xz8zg47mxwk3VzcO4TtObsCSjzBeDnZaH8NwEMYxfGf+bz8WANK2mx1n7biB7Hbz7UOsKHZlna+uruaDqkS8VK7aGKVtfaO685uJ8Szaqqxyd6svYn++/c9fqNV+4eeK62HVQLzKYp7uvXPfmO7v5/Zfff1SRWRJvr6+5NfXV1mH00vPk4ZhSK+ntq1dt6UX9GSSLPw+SWQv8KRdr8t63ZZBktsvCaS96veKf+95k+P2shskvWBSpic3hR/YdVlXqmC+XFvWbU/2lurTk55dl/aqYyZpTIZhzP6eBLas121p23VZt4O07SbbLR+iJ716fVLuQsFJksZTtxXOVXoMO0hkMj1nvUSmR0vU20O1b1R2fs+wrfYqt4z6prFuu2ZOJead+8akz9mTmDK3q5635tqjKjDRH9zk4rQDhU3XJab8NmUn+vRGsbZchZvWLok+Cew0Ka/fQgZ2etPL7ZjegDLlTW922eP1vPx2Coml563+MJXdSHqTDxsrP6jIZEO9crEo941jn98zbaudyy2rvnLvRH+8mPe49qfX4ZprOP3wvUsbUNmY6A+twFPIclIqoIwnPjuQSbL9lrtK8US/5QYzD2z5ZrGyLvMnoezuubgUb9Tbz8XqDxaFFHlCreL8nmtb7VpuafWVeyf6Y8a887W/Z5+k49H0Hf38vea2H5X3T/sIXyPI23+wfSaQwEcEWDfVDNNtdsYYvozgumbuPZ1/mAUx4g9EcHG3rV2ad3AR4aOkkyRGQ8BqYds6K807F4g+tvYNq/UDu54x9b6xv13Ory5tpVpu2fXdxzFjPvq1T0en6aj7JjrjMTpVhxH7eP6swf33QeGiTa8os6JEDwCNZgf9ZrbVhIjx5hpwWsMzX+QjJUYD1D4/8ffVs8LWtxgJHGYedKG+UY6i5/fS2upk6ltAWTFfwrV/yTRN9Kch/oggb9uFnkKGp3D3WNBoNNGJ2nBME/7NGJ0zn9XUuLEgb1sY9o+XYFfZpW8cwqbze2ltdSr1LeKQMet27V8yTb+6PwEiRDoTSPUCbOLOBQajE/yurPGAlgVEZX1/Dqh/Ja/6Fb+ixo8WrEEXv6ts5sJ948DWnN9La6uTqG9BB4/5ENc+HR0T/YHEb08YWMWeQpqPbVjRPTYvGS92Wlde/O5isOZvsW9smeseYzTYPH7gxiwUDoAmHtsWotdwwxzqdN601X5EaQ8TjQe8uAM8uZvKBRBP5g8f4Aa6S9/Y5iDnV9O2WusE6lvYnjGXce3T6WOiP4TJU0jhwUeNB0TvLqJ7B36YTeRCTP8nLBNds41h/nu06QX/ll1QQ4h0URm3i43/AUXt8xmO4yMWuTuBEAide0RWG9GG93TNOxe1Xz/hLMYtxGwxHMNwlm4yjYc+3s0uzBXlpnGb6Jrvpb8fbHbGs3LDWCy1V+g7MO6HcNuP5b9F2aNvVHF+z7Kt9lBpfXe0b8z7Xvt0Bsoavs/pdXPpAhTe7lOJkp4MPHu2KIxhGOliMF6QXRBjeUcZePZsH8MwpD1dRGNhkZn8XOTp1JtkWq69UK6dLt6jFnYgvYV9p+UHQW9jW6T7LcedX8BjGuvidvO6LMw/XpjWtLh9fnbRqnKn9V0d77yMTT+bpl7t1zeqO7/n01b7l7tbfdN549vKXT1FsLqYd+sby/FmpxJu+zsdW01KKcv4wPD9/Q0AuL6+LuNw50uEcMwnoM2RqpTDvqGObUVUGo66L1n6rtTFO29OlMO+oY5tRVQePtETERFpjIPxiIiINMZET0REpDEmeiIiIo0x0RMREWmMiZ6IiEhjTPREREQaY6InIiLSGBM9ERGRxpjoiYiINMZET0REpDEmeiIiIo0x0RMREWns/4T06CAseRyFAAAAAElFTkSuQmCC",m="/assets/image-20240407183435188-74-ca5a360e.png",v="/assets/image-20240407183435188-75-ebc7a133.png",b="/assets/image-20240407183435188-76-179a8129.png",g="/assets/image-20240407183435188-77-5933e80f.png",y="/assets/image-20240407183435188-78-b55a34cf.png",f="/assets/image-20240407183435189-79-1c6bfa88.png",h="/assets/image-20240407183435189-80-37e0b297.png",w="/assets/image-20240407183435189-81-9bc27b34.png",_="/assets/image-20240407183435189-82-608348a7.png",E="/assets/image-20240407183435189-83-9d986409.png",q="/assets/image-20240407183435189-84-4975652a.png",S="/assets/image-20240407183435189-85-9f6aab7a.png",T="/assets/image-20240407183435189-86-77ac320d.png",R="/assets/image-20240407183435189-87-40c2f9ac.jpg",P="/assets/image-20240407183435190-88-c76e72bd.jpg",C="/assets/image-20240407183435190-89-135081b3.png",O="/assets/image-20240407183435191-90-f8712d07.png",j="/assets/image-20240407183435191-91-e69d0736.png",N="/assets/image-20240407183435191-92-c79ffe08.png",A="/assets/image-20240407183435191-93-c82fca93.png",I="/assets/1653382830810-63ab0fc4.png",L="/assets/image-20240407183435191-95-b34694ca.png",x="/assets/image-20240407183435192-96-dcedaa6e.png",U="/assets/1653385920025-c36cd3a2.png",D="/assets/1653546070602-fe27008f.png",H="/assets/image-20240407183435192-99-75c469a1.png",B="/assets/image-20240407183435192-100-23554788.png",F="/assets/image-20240407183435192-101-5c8b7dbf.png",M="/assets/image-20240407183435192-102-d8277490.png",W={},V=p('<h1 id="课程安排" tabindex="-1"><a class="header-anchor" href="#课程安排" aria-hidden="true">#</a> 课程安排</h1><ul><li>单token存在的问题</li><li>双token三验证</li><li>用户端token校验与鉴权</li><li>对接三方支付平台</li><li>分布式锁</li></ul><h1 id="_1、场景说明" tabindex="-1"><a class="header-anchor" href="#_1、场景说明" aria-hidden="true">#</a> 1、场景说明</h1><p>新入职的你加入了开发一组，也接到了开发任务，并且你也顺利的修复了bug，完成了快递员、司机的鉴权，现在的你已经对项目的业务功能、开发环境以及网关代码设计都有了一定的了解，但是对于<strong>用户端</strong>的校验和鉴权并没有涉及，接下来你需要完成用户端的校验和鉴权。另外，需要你了解下如何与三方支付平台对接，因为后面你需要接手支付微服务的开发。<br><img src="'+i+'" alt="" loading="lazy"></p><h1 id="_2、单token存在的问题" tabindex="-1"><a class="header-anchor" href="#_2、单token存在的问题" aria-hidden="true">#</a> 2、单token存在的问题</h1><p>在司机端、快递员端和管理管，登录成功后会生成jwt的token，前端将此token保存起来，当请求后端服务时，在请求头中携带此token，服务端需要对token进行校验以及鉴权操作，这种模式就是【单token模式】。<br> 该模式存在什么问题吗？<br> 其实是有问题的，主要是token有效期设置长短的问题，如果设置的比较短，用户会频繁的登录，如果设置的比较长，会不太安全，因为token一旦被黑客截取的话，就可以通过此token与服务端进行交互了。<br> 另外一方面，token是无状态的，也就是说，服务端一旦颁发了token就无法让其失效（除非过了有效期），这样的话，如果我们检测到token异常也无法使其失效，所以这也是无状态token存在的问题。<br> 为了解决此问题，我们将采用【双token三验证】的解决方案来解决此问题。</p><h1 id="_3、双token三验证" tabindex="-1"><a class="header-anchor" href="#_3、双token三验证" aria-hidden="true">#</a> 3、双token三验证</h1><p>为了解决单token模式下存在的问题，所以我们可以通过【双token三验证】的模式进行改进实现，主要解决的两个问题如下：</p><ul><li>token有效期长不安全 <ul><li>登录成功后，生成2个token，分别是：access_token、refresh_token，前者有效期短（如：5分钟），后者的有效期长（如：24小时）</li><li>正常请求后端服务时，携带access_token，如果发现access_token失效，就通过refresh_token到后台服务中换取新的access_token和refresh_token，这个可以理解为token的续签</li><li>以此往复，直至refresh_token过期，需要用户重新登录</li></ul></li><li>token的无状态性 <ul><li>为了使token有状态，也就是后端可以控制其提前失效，需要将refresh_token设计成只能<strong>使用一次</strong></li><li>需要将refresh_token存储到redis中，并且要设置过期时间</li><li>这样的话，服务端如果检测到用户token有安全隐患（如：异地登录），只需要将refresh_token失效即可</li></ul></li></ul><p>详细流程如下：<br><img src="'+u+'" alt="" loading="lazy"><br> 客户端的token是采用了【双token三验证】解决方案来实现的。</p><h2 id="_4-1、微信小程序登录流程" tabindex="-1"><a class="header-anchor" href="#_4-1、微信小程序登录流程" aria-hidden="true">#</a> 4.1、微信小程序登录流程</h2>',11),z={href:"https://www.yuque.com/zhangzhijun-91vgw/xze2gr/rhyie35xipdqk9dg",target:"_blank",rel:"noopener noreferrer"},K=n("br",null,null,-1),G=n("br",null,null,-1),Y=n("img",{src:k,alt:"",loading:"lazy"},null,-1),J=n("br",null,null,-1),Q={href:"https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html",target:"_blank",rel:"noopener noreferrer"},Z=p('<h2 id="_4-2、基本流程" tabindex="-1"><a class="header-anchor" href="#_4-2、基本流程" aria-hidden="true">#</a> 4.2、基本流程</h2><p><img src="'+r+'" alt="" loading="lazy"><br> 在<code>sl-express-gateway</code>中将用户端的登录和刷新token地址设置到白名单中：<br><img src="'+d+`" alt="" loading="lazy"></p><h3 id="_4-3-1、登录" tabindex="-1"><a class="header-anchor" href="#_4-3-1、登录" aria-hidden="true">#</a> 4.3.1、登录</h3><p>在登录接口中接收<code>com.sl.ms.web.customer.vo.user.UserLoginRequestVO</code>对象，该对象中包含了【登录临时凭证】和【手机号临时凭证】，其中【手机号临时凭证】是用于用户授权获取手机号的凭证，否则获取不到手机号。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * C端用户登录
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserLoginRequestVO</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span><span class="token string">&quot;登录临时凭证&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> code<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span><span class="token string">&quot;手机号临时凭证&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> phoneCode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Controller方法定义如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * C端用户登录--微信登录
     *
     * <span class="token keyword">@param</span> <span class="token parameter">userLoginRequestVO</span> 用户登录信息
     * <span class="token keyword">@return</span> 登录结果
     */</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;登录&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserLoginVO</span><span class="token punctuation">&gt;</span></span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">UserLoginRequestVO</span> userLoginRequestVO<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">UserLoginVO</span> login <span class="token operator">=</span> memberService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>userLoginRequestVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>login<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在MemberServiceImpl实现类中，主要完对于登录业务的实现，首先根据【登录临时凭证】通过微信开放平台接口进行查询，如果用户不存在就需要通过【手机号临时凭证】查询手机号，完成用户注册。<br> 最终通过<code>com.sl.ms.web.customer.service.TokenService</code>生成token，分别生成了长短令牌。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * 登录
     *
     * <span class="token keyword">@param</span> <span class="token parameter">userLoginRequestVO</span> 登录code
     * <span class="token keyword">@return</span> 用户信息
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserLoginVO</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">UserLoginRequestVO</span> userLoginRequestVO<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1 调用微信开放平台小程序的api，根据code获取openid</span>
        <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> wechatService<span class="token punctuation">.</span><span class="token function">getOpenid</span><span class="token punctuation">(</span>userLoginRequestVO<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2 若code不正确，则获取不到openid，响应失败</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>jsonObject<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">&quot;errcode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLWebException</span><span class="token punctuation">(</span>jsonObject<span class="token punctuation">.</span><span class="token function">getStr</span><span class="token punctuation">(</span><span class="token string">&quot;errmsg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> openid <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getStr</span><span class="token punctuation">(</span><span class="token string">&quot;openid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
        * 3 根据openid从数据库查询用户
        * 3.1 如果为新用户，此处返回为null
        * 3.2 如果为已经登录过的老用户，此处返回为user对象 （包含openId,phone,unionId等字段）
         */</span>
        <span class="token class-name">MemberDTO</span> user <span class="token operator">=</span> <span class="token function">getByOpenid</span><span class="token punctuation">(</span>openid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         * 4 构造用户数据，设置openId,unionId
         * 4.1 如果user为null，则为新用户，需要构建新的user对象，并设置openId,unionId
         * 4.2 如果user不为null，则为老用户，无需设置openId,unionId
         */</span>
        user <span class="token operator">=</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token operator">?</span> user <span class="token operator">:</span> <span class="token class-name">MemberDTO</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// openId</span>
                <span class="token punctuation">.</span><span class="token function">openId</span><span class="token punctuation">(</span>openid<span class="token punctuation">)</span>
                <span class="token comment">// 平台唯一ID</span>
                <span class="token punctuation">.</span><span class="token function">authId</span><span class="token punctuation">(</span>jsonObject<span class="token punctuation">.</span><span class="token function">getStr</span><span class="token punctuation">(</span><span class="token string">&quot;unionid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">// 5 调用微信开放平台小程序的api获取微信绑定的手机号</span>
        <span class="token class-name">String</span> phone <span class="token operator">=</span> wechatService<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span>userLoginRequestVO<span class="token punctuation">.</span><span class="token function">getPhoneCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         * 6 新用户绑定手机号或者老用户更新手机号
         * 6.1 如果user.getPhone()为null，则为新用户，需要设置手机号，并保存数据库
         * 6.2 如果user.getPhone()不为null，但是与微信获取到的手机号不一样 则表示用户改了微信绑定的手机号，需要设置手机号，并保存数据库
         * 以上俩种情况，都需要重新设置手机号，并保存数据库
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">notEqual</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> phone<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            user<span class="token punctuation">.</span><span class="token function">setPhone</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token comment">// 7 如果为新用户，查询数据库获取用户ID</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            user <span class="token operator">=</span> <span class="token function">getByOpenid</span><span class="token punctuation">(</span>openid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 8 将用户ID存入token</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> claims <span class="token operator">=</span> <span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">GATEWAY</span><span class="token punctuation">.</span><span class="token constant">USER_ID</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 9 封装用户信息和双token，响应结果</span>
        <span class="token keyword">return</span> <span class="token class-name">UserLoginVO</span>
                <span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">openid</span><span class="token punctuation">(</span>openid<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">accessToken</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tokenService<span class="token punctuation">.</span><span class="token function">createAccessToken</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">refreshToken</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tokenService<span class="token punctuation">.</span><span class="token function">createRefreshToken</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">binding</span><span class="token punctuation">(</span><span class="token class-name">StatusEnum</span><span class="token punctuation">.</span><span class="token constant">NORMAL</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-2、tokenservice" tabindex="-1"><a class="header-anchor" href="#_4-3-2、tokenservice" aria-hidden="true">#</a> 4.3.2、TokenService</h3><p>在TokenService中定义了3个方法，分别是：</p><ul><li>创建AccessToken，短令牌时间单位为分钟</li><li>创建RefreshToken，长令牌时间单位为小时，需要将refreshToken转md5后存储到redis中，变成有状态的token</li><li>刷新token <ul><li>校验token的有效性</li><li>校验redis中是否存在，如果不存在说明失效或已经使用过</li><li>校验通过后，需要将原token删除</li><li>重新生成长短令牌</li></ul></li></ul><p>代码实现如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>ms<span class="token punctuation">.</span>web<span class="token punctuation">.</span>customer<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>date<span class="token punctuation">.</span></span><span class="token class-name">DateField</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">StrUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span><span class="token class-name">SecureUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>ms<span class="token punctuation">.</span>web<span class="token punctuation">.</span>customer<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">JwtProperties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>ms<span class="token punctuation">.</span>web<span class="token punctuation">.</span>customer<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">TokenService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>ms<span class="token punctuation">.</span>web<span class="token punctuation">.</span>customer<span class="token punctuation">.</span>vo<span class="token punctuation">.</span>user<span class="token punctuation">.</span></span><span class="token class-name">UserLoginVO</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>transport<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">JwtUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>transport<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ObjectUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">StringRedisTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">TokenService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">JwtProperties</span> jwtProperties<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">REDIS_REFRESH_TOKEN_PREFIX</span> <span class="token operator">=</span> <span class="token string">&quot;SL_CUSTOMER_REFRESH_TOKEN_&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">createAccessToken</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> claims<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//生成短令牌的有效期时间单位为：分钟</span>
        <span class="token keyword">return</span> <span class="token class-name">JwtUtils</span><span class="token punctuation">.</span><span class="token function">createToken</span><span class="token punctuation">(</span>claims<span class="token punctuation">,</span> jwtProperties<span class="token punctuation">.</span><span class="token function">getPrivateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> jwtProperties<span class="token punctuation">.</span><span class="token function">getAccessTtl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">DateField</span><span class="token punctuation">.</span><span class="token constant">MINUTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">createRefreshToken</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> claims<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//生成长令牌的有效期时间单位为：小时</span>
        <span class="token class-name">Integer</span> ttl <span class="token operator">=</span> jwtProperties<span class="token punctuation">.</span><span class="token function">getRefreshTtl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> refreshToken <span class="token operator">=</span> <span class="token class-name">JwtUtils</span><span class="token punctuation">.</span><span class="token function">createToken</span><span class="token punctuation">(</span>claims<span class="token punctuation">,</span> jwtProperties<span class="token punctuation">.</span><span class="token function">getPrivateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ttl<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//长令牌只能使用一次，需要将其存储到redis中，变成有状态的</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRedisRefreshToken</span><span class="token punctuation">(</span>refreshToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> refreshToken<span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofHours</span><span class="token punctuation">(</span>ttl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> refreshToken<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserLoginVO</span> <span class="token function">refreshToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> refreshToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>refreshToken<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> originClaims <span class="token operator">=</span> <span class="token class-name">JwtUtils</span><span class="token punctuation">.</span><span class="token function">checkToken</span><span class="token punctuation">(</span>refreshToken<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jwtProperties<span class="token punctuation">.</span><span class="token function">getPublicKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>originClaims<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//token无效</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//通过redis校验，原token是否使用过，来确保token只能使用一次</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRedisRefreshToken</span><span class="token punctuation">(</span>refreshToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Boolean</span> bool <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stringRedisTemplate<span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">notEqual</span><span class="token punctuation">(</span>bool<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//原token过期或已经使用过</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//删除原token</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//重新生成长短令牌</span>
        <span class="token class-name">String</span> newRefreshToken <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createRefreshToken</span><span class="token punctuation">(</span>originClaims<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> accessToken <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createAccessToken</span><span class="token punctuation">(</span>originClaims<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">UserLoginVO</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">accessToken</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">refreshToken</span><span class="token punctuation">(</span>newRefreshToken<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getRedisRefreshToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> refreshToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//md5是为了缩短key的长度</span>
        <span class="token keyword">return</span> <span class="token constant">REDIS_REFRESH_TOKEN_PREFIX</span> <span class="token operator">+</span> <span class="token class-name">SecureUtil</span><span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span>refreshToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>生成token使用的私钥配置在nacos中：<br><img src="`+m+`" alt="" loading="lazy"></p><h3 id="_4-3-3、刷新token" tabindex="-1"><a class="header-anchor" href="#_4-3-3、刷新token" aria-hidden="true">#</a> 4.3.3、刷新token</h3><p>刷新token接收请求头中的<code>refresh_token</code>参数，用此参数来刷新新的长短令牌。具体代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * 刷新token，校验请求头中的长令牌，生成新的长短令牌
     *
     * <span class="token keyword">@param</span> <span class="token parameter">refreshToken</span> 原令牌
     * <span class="token keyword">@return</span> 登录结果
     */</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/refresh&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;刷新token&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserLoginVO</span><span class="token punctuation">&gt;</span></span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestHeader</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">GATEWAY</span><span class="token punctuation">.</span><span class="token constant">REFRESH_TOKEN</span><span class="token punctuation">)</span> <span class="token class-name">String</span> refreshToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">UserLoginVO</span> loginVO <span class="token operator">=</span> memberService<span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span>refreshToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>loginVO<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;刷新token失败，请重新登录.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>loginVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserLoginVO</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token class-name">String</span> refreshToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tokenService<span class="token punctuation">.</span><span class="token function">refreshToken</span><span class="token punctuation">(</span>refreshToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-4、网关校验" tabindex="-1"><a class="header-anchor" href="#_4-4、网关校验" aria-hidden="true">#</a> 4.4、网关校验</h2><p>在网关中需要配置校验token的公钥，同样也是配置在nacos中：<br><img src="`+v+`" alt="" loading="lazy"><br> 有了公钥就可以对token的合法性进行校验了，具体的代码实现：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthUserInfoDTO</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 普通用户的token没有对接权限系统，需要自定实现</span>
        <span class="token comment">// 鉴权逻辑在用户端自行实现 网关统一放行</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;开始解析token {}&quot;</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> claims <span class="token operator">=</span> <span class="token class-name">JwtUtils</span><span class="token punctuation">.</span><span class="token function">checkToken</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> jwtProperties<span class="token punctuation">.</span><span class="token function">getPublicKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//token失效</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>claims<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">GATEWAY</span><span class="token punctuation">.</span><span class="token constant">USER_ID</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//token解析成功，放行</span>
        <span class="token class-name">AuthUserInfoDTO</span> authUserInfoDTO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AuthUserInfoDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        authUserInfoDTO<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> authUserInfoDTO<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于用户端只需要校验token即可，不需要鉴权。</p><h2 id="_4-5、测试" tabindex="-1"><a class="header-anchor" href="#_4-5、测试" aria-hidden="true">#</a> 4.5、测试</h2><p>基于小程序进行功能测试即可。</p><h1 id="_5、对接三方支付平台" tabindex="-1"><a class="header-anchor" href="#_5、对接三方支付平台" aria-hidden="true">#</a> 5、对接三方支付平台</h1><h2 id="_5-1、了解三方支付平台" tabindex="-1"><a class="header-anchor" href="#_5-1、了解三方支付平台" aria-hidden="true">#</a> 5.1、了解三方支付平台</h2><p>第三方支付平台是指平台提供商通过通信、计算机和信息安全技术，在商家和银行之间建立连接，从而实现消费者、金融机构以及商家之间货币支付、现金流转、资金清算、查询统计的一个平台。<br> 国内主流的三方支付平台有：支付宝、微信支付、京东支付、银联商务、拉卡拉、快钱支付、易宝支付等。<br> 在课程中，我们主要是会对接<strong>支付宝</strong>和<strong>微信支付</strong>。</p><h2 id="_5-2、支付宝支付" tabindex="-1"><a class="header-anchor" href="#_5-2、支付宝支付" aria-hidden="true">#</a> 5.2、支付宝支付</h2><h3 id="_5-2-1、开放平台" tabindex="-1"><a class="header-anchor" href="#_5-2-1、开放平台" aria-hidden="true">#</a> 5.2.1、开放平台</h3>`,30),X={href:"https://open.alipay.com/",target:"_blank",rel:"noopener noreferrer"},$=n("br",null,null,-1),nn=n("br",null,null,-1),sn=n("img",{src:b,alt:"",loading:"lazy"},null,-1),an=n("br",null,null,-1),tn={href:"https://open.alipay.com/api",target:"_blank",rel:"noopener noreferrer"},pn=n("br",null,null,-1),en=n("img",{src:g,alt:"",loading:"lazy"},null,-1),on=n("br",null,null,-1),cn=n("br",null,null,-1),ln=n("br",null,null,-1),un=n("img",{src:y,alt:"",loading:"lazy"},null,-1),kn=n("br",null,null,-1),rn=n("img",{src:f,alt:"",loading:"lazy"},null,-1),dn=n("br",null,null,-1),mn=n("br",null,null,-1),vn={href:"https://opendocs.alipay.com/open/194/105072?ref=api",target:"_blank",rel:"noopener noreferrer"},bn=n("h3",{id:"_5-2-2、沙箱环境",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_5-2-2、沙箱环境","aria-hidden":"true"},"#"),s(" 5.2.2、沙箱环境")],-1),gn=n("br",null,null,-1),yn=n("img",{src:h,alt:"",loading:"lazy"},null,-1),fn=n("br",null,null,-1),hn=n("br",null,null,-1),wn=n("br",null,null,-1),_n={href:"https://opendocs.alipay.com/common/02kkv7",target:"_blank",rel:"noopener noreferrer"},En=n("br",null,null,-1),qn=n("br",null,null,-1),Sn=n("img",{src:w,alt:"",loading:"lazy"},null,-1),Tn=n("br",null,null,-1),Rn=n("br",null,null,-1),Pn=n("img",{src:_,alt:"",loading:"lazy"},null,-1),Cn=n("h3",{id:"_5-2-3、扫码支付",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_5-2-3、扫码支付","aria-hidden":"true"},"#"),s(" 5.2.3、扫码支付")],-1),On={href:"https://opendocs.alipay.com/open/194/106078?ref=api",target:"_blank",rel:"noopener noreferrer"},jn=n("br",null,null,-1),Nn=n("br",null,null,-1),An=n("img",{src:"https://yuque.antfin.com/images/lark/0/2022/jpeg/210044/1668698883088-cfe7db2b-ab80-4de4-ac6e-c2551c101047.jpeg#from=url&id=pvNlb&originHeight=856&originWidth=1968&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title=",alt:"",loading:"lazy"},null,-1),In=n("br",null,null,-1),Ln=n("br",null,null,-1),xn=n("img",{src:"https://gw.alipayobjects.com/zos/skylark-tools/public/files/0dd5f9ae0c3da01ce2b9d6019efde979.png#from=url&id=qgxUe&originHeight=925&originWidth=837&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title=",alt:"",loading:"lazy"},null,-1),Un={href:"https://opendocs.alipay.com/open/02ekfg?scene=19",target:"_blank",rel:"noopener noreferrer"},Dn={href:"https://opendocs.alipay.com/open/02ekfh?scene=23",target:"_blank",rel:"noopener noreferrer"},Hn=n("li",null,"如果仍然返回等待用户付款（WAIT_BUYER_PAY），则再次等待 5 秒后继续查询，直到返回确切的支付结果（成功 TRADE_SUCCESS 或 已撤销关闭 TRADE_CLOSED），或是超出轮询时间。",-1),Bn={href:"https://opendocs.alipay.com/open/02ekfi",target:"_blank",rel:"noopener noreferrer"},Fn={href:"https://opendocs.alipay.com/open/194/103296",target:"_blank",rel:"noopener noreferrer"},Mn=n("br",null,null,-1),Wn={href:"https://opendocs.alipay.com/open/194/105322/#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86",target:"_blank",rel:"noopener noreferrer"},Vn=p('<p>交易状态流程：<br><img src="https://yuque.antfin.com/images/lark/0/2022/png/210044/1668514572734-eb773fc9-daea-471f-b6fb-9479db1b311f.png#from=url&amp;id=ynefl&amp;originHeight=669&amp;originWidth=1113&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=shadow&amp;title=" alt="" loading="lazy"><br> 随着订单支付成功、退款、关闭等操作，订单交易的每一个环节 <strong>trade_status</strong>（交易状态）不同。</p><ol><li>交易创建成功后，用户支付成功，交易状态转为 <strong>TRADE_SUCCESS</strong>（交易成功）。</li><li>交易成功后，规定退款时间内没有退款，交易状态转为 <strong>TRADE_FINISHED</strong>（交易完成）。</li><li>交易支付成功后，交易部分退款，交易状态为 <strong>TRADE_SUCCESS</strong>（交易成功）。</li><li>交易成功后，交易全额退款，交易状态转为 <strong>TRADE_CLOSED</strong>（交易关闭）。</li><li>交易创建成功后，用户未付款交易超时关闭，交易状态转为 <strong>TRADE_CLOSED</strong>（交易关闭）。</li><li>交易创建成功后，用户支付成功后，若用户商品不支持退款，交易状态直接转为 <strong>TRADE_FINISHED</strong>（交易完成）。</li></ol><p><strong>注意</strong>：交易成功后部分退款，交易状态仍为 <strong>TRADE_SUCCESS</strong>（交易成功），如果一直部分退款退完所有交易金额则交易状态转为 <strong>TRADE_CLOSED</strong>（交易关闭），如果未退完所有交易金额，超过有效退款时间后交易状态转为 <strong>TRADE_FINISHED</strong>（交易完成）不可退款。</p><h3 id="_5-2-4、sdk" tabindex="-1"><a class="header-anchor" href="#_5-2-4、sdk" aria-hidden="true">#</a> 5.2.4、SDK</h3>',4),zn=n("br",null,null,-1),Kn=n("img",{src:E,alt:"",loading:"lazy"},null,-1),Gn=n("br",null,null,-1),Yn={href:"https://opendocs.alipay.com/open/02np95",target:"_blank",rel:"noopener noreferrer"},Jn=n("br",null,null,-1),Qn=p(`<div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alipay.sdk<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>alipay-easysdk<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>\${alipay.easysdk.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>easysdk<span class="token punctuation">.</span>factory<span class="token punctuation">.</span></span><span class="token class-name">Factory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>easysdk<span class="token punctuation">.</span>factory<span class="token punctuation">.</span></span><span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token class-name">Payment</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>easysdk<span class="token punctuation">.</span>kernel<span class="token punctuation">.</span></span><span class="token class-name">Config</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>easysdk<span class="token punctuation">.</span>kernel<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ResponseChecker</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>easysdk<span class="token punctuation">.</span>payment<span class="token punctuation">.</span>facetoface<span class="token punctuation">.</span>models<span class="token punctuation">.</span></span><span class="token class-name">AlipayTradePrecreateResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 设置参数（全局只需设置一次）</span>
        <span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">setOptions</span><span class="token punctuation">(</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 2. 发起API调用（以创建当面付收款二维码为例）</span>
            <span class="token class-name">AlipayTradePrecreateResponse</span> response <span class="token operator">=</span> <span class="token class-name">Payment<span class="token punctuation">.</span>FaceToFace</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">preCreate</span><span class="token punctuation">(</span><span class="token string">&quot;Apple iPhone11 128G&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2234567890&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;5799.00&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 3. 处理响应或异常</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ResponseChecker</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;调用成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;调用失败，原因：&quot;</span> <span class="token operator">+</span> response<span class="token punctuation">.</span>msg <span class="token operator">+</span> <span class="token string">&quot;，&quot;</span> <span class="token operator">+</span> response<span class="token punctuation">.</span>subMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;调用遭遇异常，原因：&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Config</span> <span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span>protocol <span class="token operator">=</span> <span class="token string">&quot;https&quot;</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span>gatewayHost <span class="token operator">=</span> <span class="token string">&quot;openapi.alipay.com&quot;</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span>signType <span class="token operator">=</span> <span class="token string">&quot;RSA2&quot;</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span>appId <span class="token operator">=</span> <span class="token string">&quot;&lt;-- 请填写您的AppId，例如：2019091767145019 --&gt;&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// 为避免私钥随源码泄露，推荐从文件中读取私钥字符串而不是写入源码中</span>
        config<span class="token punctuation">.</span>merchantPrivateKey <span class="token operator">=</span> <span class="token string">&quot;&lt;-- 请填写您的应用私钥，例如：MIIEvQIBADANB ... ... --&gt;&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">//注：证书文件路径支持设置为文件系统中的路径或CLASS_PATH中的路径，优先从文件系统中加载，加载失败后会继续尝试从CLASS_PATH中加载</span>
        config<span class="token punctuation">.</span>merchantCertPath <span class="token operator">=</span> <span class="token string">&quot;&lt;-- 请填写您的应用公钥证书文件路径，例如：/foo/appCertPublicKey_2019051064521003.crt --&gt;&quot;</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span>alipayCertPath <span class="token operator">=</span> <span class="token string">&quot;&lt;-- 请填写您的支付宝公钥证书文件路径，例如：/foo/alipayCertPublicKey_RSA2.crt --&gt;&quot;</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span>alipayRootCertPath <span class="token operator">=</span> <span class="token string">&quot;&lt;-- 请填写您的支付宝根证书文件路径，例如：/foo/alipayRootCert.crt --&gt;&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">//注：如果采用非证书模式，则无需赋值上面的三个证书路径，改为赋值如下的支付宝公钥字符串即可</span>
        <span class="token comment">// config.alipayPublicKey = &quot;&lt;-- 请填写您的支付宝公钥，例如：MIIBIjANBg... --&gt;&quot;;</span>
        <span class="token comment">//可设置异步通知接收服务地址（可选）</span>
        config<span class="token punctuation">.</span>notifyUrl <span class="token operator">=</span> <span class="token string">&quot;&lt;-- 请填写您的支付类接口异步通知接收服务地址，例如：https://www.test.com/callback --&gt;&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">//可设置AES密钥，调用AES加解密相关接口时需要（可选）</span>
        config<span class="token punctuation">.</span>encryptKey <span class="token operator">=</span> <span class="token string">&quot;&lt;-- 请填写您的AES密钥，例如：aa4BtZ4tspm2wnXLb1ThQA== --&gt;&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> config<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-5、编写代码" tabindex="-1"><a class="header-anchor" href="#_5-2-5、编写代码" aria-hidden="true">#</a> 5.2.5、编写代码</h3>`,3),Zn={href:"http://git.sl-express.com/sl/sl-express-pay.git",target:"_blank",rel:"noopener noreferrer"},Xn=n("br",null,null,-1),$n=n("code",null,"NativePayHandler",-1),ns=p(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>alipay</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>convert<span class="token punctuation">.</span></span><span class="token class-name">Convert</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>json<span class="token punctuation">.</span></span><span class="token class-name">JSONUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>easysdk<span class="token punctuation">.</span>factory<span class="token punctuation">.</span></span><span class="token class-name">Factory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>easysdk<span class="token punctuation">.</span>kernel<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ResponseChecker</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>easysdk<span class="token punctuation">.</span>payment<span class="token punctuation">.</span>facetoface<span class="token punctuation">.</span>models<span class="token punctuation">.</span></span><span class="token class-name">AlipayTradePrecreateResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">TradingEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>enums<span class="token punctuation">.</span></span><span class="token class-name">TradingStateEnum</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>handler<span class="token punctuation">.</span></span><span class="token class-name">NativePayHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>transport<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span><span class="token class-name">SLException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 支付宝实现类
 */</span>
<span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span><span class="token string">&quot;aliNativePayHandler&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AliNativePayHandler</span> <span class="token keyword">implements</span> <span class="token class-name">NativePayHandler</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createDownLineTrading</span><span class="token punctuation">(</span><span class="token class-name">TradingEntity</span> tradingEntity<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SLException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 设置参数（全局只需设置一次）</span>
        <span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">setOptions</span><span class="token punctuation">(</span><span class="token class-name">AlipayConfig</span><span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 2. 发起API调用（以创建当面付收款二维码为例）</span>
            <span class="token class-name">AlipayTradePrecreateResponse</span> response <span class="token operator">=</span> <span class="token class-name">Factory<span class="token punctuation">.</span>Payment<span class="token punctuation">.</span>FaceToFace</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">preCreate</span><span class="token punctuation">(</span>tradingEntity<span class="token punctuation">.</span><span class="token function">getMemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//订单描述</span>
                            <span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toStr</span><span class="token punctuation">(</span>tradingEntity<span class="token punctuation">.</span><span class="token function">getTradingOrderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//交易单号</span>
                            <span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toStr</span><span class="token punctuation">(</span>tradingEntity<span class="token punctuation">.</span><span class="token function">getTradingAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//交易金额</span>
            <span class="token comment">// 3. 处理响应或异常</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ResponseChecker</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;调用成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                tradingEntity<span class="token punctuation">.</span><span class="token function">setPlaceOrderMsg</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getQrCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//二维码信息</span>
                tradingEntity<span class="token punctuation">.</span><span class="token function">setPlaceOrderCode</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                tradingEntity<span class="token punctuation">.</span><span class="token function">setPlaceOrderJson</span><span class="token punctuation">(</span><span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                tradingEntity<span class="token punctuation">.</span><span class="token function">setTradingState</span><span class="token punctuation">(</span><span class="token class-name">TradingStateEnum</span><span class="token punctuation">.</span><span class="token constant">FKZ</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;调用失败，原因：&quot;</span> <span class="token operator">+</span> response<span class="token punctuation">.</span>msg <span class="token operator">+</span> <span class="token string">&quot;，&quot;</span> <span class="token operator">+</span> response<span class="token punctuation">.</span>subMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;调用遭遇异常，原因：&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编写测试用例：</p><blockquote><p>测试时自行修改订单号和交易单号，如果重复会支付失败</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>alipay</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">TradingEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>handler<span class="token punctuation">.</span></span><span class="token class-name">NativePayHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token import static"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">class</span> <span class="token class-name">AliNativePayHandlerTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;aliNativePayHandler&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">NativePayHandler</span> nativePayHandler<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">createDownLineTrading</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TradingEntity</span> tradingEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TradingEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tradingEntity<span class="token punctuation">.</span><span class="token function">setProductOrderNo</span><span class="token punctuation">(</span><span class="token number">12345L</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//订单号</span>
        tradingEntity<span class="token punctuation">.</span><span class="token function">setTradingOrderNo</span><span class="token punctuation">(</span><span class="token number">11223344L</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//交易单号</span>
        tradingEntity<span class="token punctuation">.</span><span class="token function">setMemo</span><span class="token punctuation">(</span><span class="token string">&quot;运费&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tradingEntity<span class="token punctuation">.</span><span class="token function">setTradingAmount</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>nativePayHandler<span class="token punctuation">.</span><span class="token function">createDownLineTrading</span><span class="token punctuation">(</span>tradingEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;二维码信息：&quot;</span> <span class="token operator">+</span> tradingEntity<span class="token punctuation">.</span><span class="token function">getPlaceOrderMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>tradingEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试结果：<br><img src="`+q+'" alt="" loading="lazy"><br> 可以看到，调用成功后会返回支付链接，下面需要将支付链接转成二维码的形式，下面通过【草料二维码】工具来生成：<br><img src="'+S+'" alt="" loading="lazy"><br> 在后侧可以看到生成二维码：<br><img src="'+T+'" alt="" loading="lazy"><br> 下面通过沙箱环境的支付宝APP进行扫码支付（支付密码默认：111111）：<br><img src="'+R+'" alt="" loading="lazy"><br><img src="'+P+'" alt="" loading="lazy"><br> 虽然可以通过沙箱环境进行测试，但是沙箱环境的APP查看账单并不方便，有时候查询不到数据，所以在后面的测试中建议使用正式环境，也就是神领物流项目中真实的支付宝账号信息，需要注意的是，测试时需要使用支付宝正式APP进行。<br> 将<code>com.sl.pay.handler.alipay.AlipayConfig#getConfig</code>代码的注释放开即可，同时要将沙箱环境的代码注释掉。<br><img src="'+C+'" alt="" loading="lazy"></p><h3 id="_5-2-6、查询交易单" tabindex="-1"><a class="header-anchor" href="#_5-2-6、查询交易单" aria-hidden="true">#</a> 5.2.6、查询交易单</h3>',6),ss={href:"https://opendocs.alipay.com/open/02ekfh?ref=api&scene=23",target:"_blank",rel:"noopener noreferrer"},as=n("br",null,null,-1),ts=p(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">queryTrading</span><span class="token punctuation">(</span><span class="token class-name">TradingEntity</span> trading<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SLException</span> <span class="token punctuation">{</span>
        <span class="token comment">//Factory使用配置</span>
        <span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">setOptions</span><span class="token punctuation">(</span><span class="token class-name">AlipayConfig</span><span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AlipayTradeQueryResponse</span> queryResponse<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//调用支付宝API：通用查询支付情况</span>
            queryResponse <span class="token operator">=</span> <span class="token class-name">Factory
                    <span class="token punctuation">.</span>Payment
                    <span class="token punctuation">.</span>Common</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>trading<span class="token punctuation">.</span><span class="token function">getTradingOrderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;查询支付宝统一下单失败：trading = {}&quot;</span><span class="token punctuation">,</span> trading<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//修改交易单状态</span>
        trading<span class="token punctuation">.</span><span class="token function">setResultCode</span><span class="token punctuation">(</span>queryResponse<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        trading<span class="token punctuation">.</span><span class="token function">setResultMsg</span><span class="token punctuation">(</span>queryResponse<span class="token punctuation">.</span><span class="token function">getSubMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        trading<span class="token punctuation">.</span><span class="token function">setResultJson</span><span class="token punctuation">(</span><span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>queryResponse<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token class-name">ResponseChecker</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>queryResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//响应成功，分析交易状态</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> tradeStatus <span class="token operator">=</span> queryResponse<span class="token punctuation">.</span><span class="token function">getTradeStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">TradingConstant</span><span class="token punctuation">.</span><span class="token constant">ALI_TRADE_CLOSED</span><span class="token punctuation">,</span> tradeStatus<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//支付取消：TRADE_CLOSED（未付款交易超时关闭，或支付完成后全额退款）</span>
                trading<span class="token punctuation">.</span><span class="token function">setTradingState</span><span class="token punctuation">(</span><span class="token class-name">TradingStateEnum</span><span class="token punctuation">.</span><span class="token constant">QXDD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">equalsAny</span><span class="token punctuation">(</span>tradeStatus<span class="token punctuation">,</span> <span class="token class-name">TradingConstant</span><span class="token punctuation">.</span><span class="token constant">ALI_TRADE_SUCCESS</span><span class="token punctuation">,</span> <span class="token class-name">TradingConstant</span><span class="token punctuation">.</span><span class="token constant">ALI_TRADE_FINISHED</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// TRADE_SUCCESS（交易支付成功）</span>
                <span class="token comment">// TRADE_FINISHED（交易结束，不可退款）</span>
                trading<span class="token punctuation">.</span><span class="token function">setTradingState</span><span class="token punctuation">(</span><span class="token class-name">TradingStateEnum</span><span class="token punctuation">.</span><span class="token constant">YJS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//非最终状态不处理，当前交易状态：WAIT_BUYER_PAY（交易创建，等待买家付款）不处理</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span>trading<span class="token punctuation">.</span><span class="token function">getResultJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TradingEnum</span><span class="token punctuation">.</span><span class="token constant">NATIVE_QUERY_FAIL</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TradingEnum</span><span class="token punctuation">.</span><span class="token constant">NATIVE_QUERY_FAIL</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试用例：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">queryTrading</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TradingEntity</span> tradingEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TradingEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tradingEntity<span class="token punctuation">.</span><span class="token function">setTradingOrderNo</span><span class="token punctuation">(</span><span class="token number">11223388L</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//交易单号</span>
        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aliBasicPayHandler<span class="token punctuation">.</span><span class="token function">queryTrading</span><span class="token punctuation">(</span>tradingEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;执行是否成功：&quot;</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>tradingEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试结果：</p><blockquote><p>执行是否成功：true<br> TradingEntity(openId=null, productOrderNo=null, tradingOrderNo=11223388, tradingChannel=null, tradingType=null, tradingState=QXDD, payeeName=null, payeeId=null, payerName=null, payerId=null, tradingAmount=null, refund=null, isRefund=null, resultCode=10000, resultMsg=null, resultJson={&quot;httpBody&quot;:&quot;{&quot;alipay_trade_query_response&quot;:{&quot;code&quot;:&quot;10000&quot;,&quot;msg&quot;:&quot;Success&quot;,&quot;buyer_logon_id&quot;:&quot;zha***@163.com&quot;,&quot;buyer_pay_amount&quot;:&quot;0.00&quot;,&quot;buyer_user_id&quot;:&quot;2088102229491411&quot;,&quot;invoice_amount&quot;:&quot;0.00&quot;,&quot;out_trade_no&quot;:&quot;11223388&quot;,&quot;point_amount&quot;:&quot;0.00&quot;,&quot;receipt_amount&quot;:&quot;0.00&quot;,&quot;send_pay_date&quot;:&quot;2022-12-22 15:30:10&quot;,&quot;total_amount&quot;:&quot;1.00&quot;,&quot;trade_no&quot;:&quot;2022122222001491411434343927&quot;,&quot;trade_status&quot;:&quot;TRADE_CLOSED&quot;},&quot;sign&quot;:&quot;N6pBPloZlLFG7XSE4xegTYF7OYzaN5kWEsJnUEJj822Qwz5WQRafRgDL/hMKXMiOpJ+2//oRzdktx8r9saY4r4U+bSBJ+sxaRZF0gLo3ubtyQLTTvGOf7zpIeUaMaRld8LASFaN1ZmH/2BG+qLBD0SGL7TgbTS+nOSxn3ol1+eTrPW+YYEn0bpPKPtM5mU+NdkkFUecHZH2zkgN+4OLnBfiP/QuupsRh0vV+Rz9sDj4i8Io12uQPVOHnJ88Z/rzjS77IGkp3SpII2CaiG2urzsDyJPJO3JaRln8EEtsk9JNXyq+mj8gkOXp1mUHIP2BSM+tCSWn+XqtRBSuL0L9u9Q==&quot;}&quot;,&quot;code&quot;:&quot;10000&quot;,&quot;msg&quot;:&quot;Success&quot;,&quot;tradeNo&quot;:&quot;2022122222001491411434343927&quot;,&quot;outTradeNo&quot;:&quot;11223388&quot;,&quot;buyerLogonId&quot;:&quot;zha***@163.com&quot;,&quot;tradeStatus&quot;:&quot;TRADE_CLOSED&quot;,&quot;totalAmount&quot;:&quot;1.00&quot;,&quot;buyerPayAmount&quot;:&quot;0.00&quot;,&quot;pointAmount&quot;:&quot;0.00&quot;,&quot;invoiceAmount&quot;:&quot;0.00&quot;,&quot;sendPayDate&quot;:&quot;2022-12-22 15:30:10&quot;,&quot;receiptAmount&quot;:&quot;0.00&quot;,&quot;buyerUserId&quot;:&quot;2088102229491411&quot;}, placeOrderCode=null, placeOrderMsg=null, placeOrderJson=null, enterpriseId=null, memo=null, qrCode=null, enableFlag=null)</p></blockquote><h3 id="_5-2-7、关闭交易" tabindex="-1"><a class="header-anchor" href="#_5-2-7、关闭交易" aria-hidden="true">#</a> 5.2.7、关闭交易</h3>`,6),ps={href:"https://opendocs.alipay.com/open/02o6e7?ref=api",target:"_blank",rel:"noopener noreferrer"},es=n("br",null,null,-1),os=p(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">closeTrading</span><span class="token punctuation">(</span><span class="token class-name">TradingEntity</span> trading<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SLException</span> <span class="token punctuation">{</span>
        <span class="token comment">//Factory使用配置</span>
        <span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">setOptions</span><span class="token punctuation">(</span><span class="token class-name">AlipayConfig</span><span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//调用支付宝API：通用查询支付情况</span>
            <span class="token class-name">AlipayTradeCloseResponse</span> closeResponse <span class="token operator">=</span> <span class="token class-name">Factory
                    <span class="token punctuation">.</span>Payment
                    <span class="token punctuation">.</span>Common</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>trading<span class="token punctuation">.</span><span class="token function">getTradingOrderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token class-name">ResponseChecker</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>closeResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                trading<span class="token punctuation">.</span><span class="token function">setTradingState</span><span class="token punctuation">(</span><span class="token class-name">TradingStateEnum</span><span class="token punctuation">.</span><span class="token constant">QXDD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span><span class="token class-name">TradingEnum</span><span class="token punctuation">.</span><span class="token constant">CLOSE_FAIL</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试用例：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">closeTrading</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TradingEntity</span> tradingEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TradingEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tradingEntity<span class="token punctuation">.</span><span class="token function">setTradingOrderNo</span><span class="token punctuation">(</span><span class="token number">11223377L</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//交易单号</span>
        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aliBasicPayHandler<span class="token punctuation">.</span><span class="token function">closeTrading</span><span class="token punctuation">(</span>tradingEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;执行是否成功：&quot;</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>tradingEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-8、退款" tabindex="-1"><a class="header-anchor" href="#_5-2-8、退款" aria-hidden="true">#</a> 5.2.8、退款</h3>`,4),cs={href:"https://opendocs.alipay.com/open/02ekfk?ref=api",target:"_blank",rel:"noopener noreferrer"},ls=n("br",null,null,-1),is=p(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">refundTrading</span><span class="token punctuation">(</span><span class="token class-name">RefundRecordEntity</span> refundRecord<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SLException</span> <span class="token punctuation">{</span>
        <span class="token comment">//Factory使用配置</span>
        <span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">setOptions</span><span class="token punctuation">(</span><span class="token class-name">AlipayConfig</span><span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//调用支付宝API：通用查询支付情况</span>
        <span class="token class-name">AlipayTradeRefundResponse</span> refundResponse<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 支付宝easy sdk</span>
            refundResponse <span class="token operator">=</span> <span class="token class-name">Factory
                    <span class="token punctuation">.</span>Payment
                    <span class="token punctuation">.</span>Common</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token comment">//扩展参数：退款单号</span>
                    <span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span><span class="token string">&quot;out_request_no&quot;</span><span class="token punctuation">,</span> refundRecord<span class="token punctuation">.</span><span class="token function">getRefundNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">refund</span><span class="token punctuation">(</span><span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toStr</span><span class="token punctuation">(</span>refundRecord<span class="token punctuation">.</span><span class="token function">getTradingOrderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toStr</span><span class="token punctuation">(</span>refundRecord<span class="token punctuation">.</span><span class="token function">getRefundAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;调用支付宝退款接口出错！refundRecord = {}&quot;</span><span class="token punctuation">,</span> refundRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token class-name">TradingEnum</span><span class="token punctuation">.</span><span class="token constant">NATIVE_REFUND_FAIL</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TradingEnum</span><span class="token punctuation">.</span><span class="token constant">NATIVE_REFUND_FAIL</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        refundRecord<span class="token punctuation">.</span><span class="token function">setRefundCode</span><span class="token punctuation">(</span>refundResponse<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        refundRecord<span class="token punctuation">.</span><span class="token function">setRefundMsg</span><span class="token punctuation">(</span><span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>refundResponse<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token class-name">ResponseChecker</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>refundResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            refundRecord<span class="token punctuation">.</span><span class="token function">setRefundStatus</span><span class="token punctuation">(</span><span class="token class-name">RefundStatusEnum</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span>refundRecord<span class="token punctuation">.</span><span class="token function">getRefundMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TradingEnum</span><span class="token punctuation">.</span><span class="token constant">NATIVE_REFUND_FAIL</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TradingEnum</span><span class="token punctuation">.</span><span class="token constant">NATIVE_REFUND_FAIL</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试用例：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">refundTrading</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RefundRecordEntity</span> refundRecordEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RefundRecordEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        refundRecordEntity<span class="token punctuation">.</span><span class="token function">setTradingOrderNo</span><span class="token punctuation">(</span><span class="token number">11223388L</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//交易单号</span>
        refundRecordEntity<span class="token punctuation">.</span><span class="token function">setRefundNo</span><span class="token punctuation">(</span><span class="token number">11223380L</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//退款单号</span>
        refundRecordEntity<span class="token punctuation">.</span><span class="token function">setRefundAmount</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//退款金额</span>
        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aliBasicPayHandler<span class="token punctuation">.</span><span class="token function">refundTrading</span><span class="token punctuation">(</span>refundRecordEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;执行是否成功：&quot;</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>refundRecordEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-9、查询退款" tabindex="-1"><a class="header-anchor" href="#_5-2-9、查询退款" aria-hidden="true">#</a> 5.2.9、查询退款</h3>`,4),us={href:"https://opendocs.alipay.com/open/02ekfl?ref=api",target:"_blank",rel:"noopener noreferrer"},ks=n("br",null,null,-1),rs=p(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">queryRefundTrading</span><span class="token punctuation">(</span><span class="token class-name">RefundRecordEntity</span> refundRecord<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SLException</span> <span class="token punctuation">{</span>
        <span class="token comment">//Factory使用配置</span>
        <span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">setOptions</span><span class="token punctuation">(</span><span class="token class-name">AlipayConfig</span><span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AlipayTradeFastpayRefundQueryResponse</span> response<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            response <span class="token operator">=</span> <span class="token class-name">Factory<span class="token punctuation">.</span>Payment<span class="token punctuation">.</span>Common</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">queryRefund</span><span class="token punctuation">(</span>
                    <span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toStr</span><span class="token punctuation">(</span>refundRecord<span class="token punctuation">.</span><span class="token function">getTradingOrderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toStr</span><span class="token punctuation">(</span>refundRecord<span class="token punctuation">.</span><span class="token function">getRefundNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;调用支付宝查询退款接口出错！refundRecord = {}&quot;</span><span class="token punctuation">,</span> refundRecord<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span><span class="token class-name">TradingEnum</span><span class="token punctuation">.</span><span class="token constant">NATIVE_REFUND_FAIL</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        refundRecord<span class="token punctuation">.</span><span class="token function">setRefundCode</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        refundRecord<span class="token punctuation">.</span><span class="token function">setRefundMsg</span><span class="token punctuation">(</span><span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token class-name">ResponseChecker</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            refundRecord<span class="token punctuation">.</span><span class="token function">setRefundStatus</span><span class="token punctuation">(</span><span class="token class-name">RefundStatusEnum</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span>refundRecord<span class="token punctuation">.</span><span class="token function">getRefundMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TradingEnum</span><span class="token punctuation">.</span><span class="token constant">NATIVE_REFUND_FAIL</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TradingEnum</span><span class="token punctuation">.</span><span class="token constant">NATIVE_REFUND_FAIL</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试用例：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">queryRefundTrading</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RefundRecordEntity</span> refundRecordEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RefundRecordEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        refundRecordEntity<span class="token punctuation">.</span><span class="token function">setTradingOrderNo</span><span class="token punctuation">(</span><span class="token number">11223388L</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//交易单号</span>
        refundRecordEntity<span class="token punctuation">.</span><span class="token function">setRefundNo</span><span class="token punctuation">(</span><span class="token number">11223388L</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//退款单号</span>
        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aliBasicPayHandler<span class="token punctuation">.</span><span class="token function">queryRefundTrading</span><span class="token punctuation">(</span>refundRecordEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;执行是否成功：&quot;</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>refundRecordEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-3、微信支付" tabindex="-1"><a class="header-anchor" href="#_5-3、微信支付" aria-hidden="true">#</a> 5.3、微信支付</h2><h3 id="_5-3-1、开放平台" tabindex="-1"><a class="header-anchor" href="#_5-3-1、开放平台" aria-hidden="true">#</a> 5.3.1、开放平台</h3><p>微信支付也有对应的开放平台，类似支付宝。<br> 微信支付的接口分v2和v3版本，早期使用的是v2版本，目前推荐使用v3版本，v2与v3的区别如下：<br><img src="`+O+'" alt="" loading="lazy"></p><div class="hint-container info"><p class="hint-container-title">相关信息</p><p>需要注意的是，微信并没有提供沙箱环境，只能使用正式环境的账号信息才能接口调试。</p></div><h3 id="_5-3-2、native支付" tabindex="-1"><a class="header-anchor" href="#_5-3-2、native支付" aria-hidden="true">#</a> 5.3.2、Native支付</h3><p>微信中的扫码支付称之为【Native支付】，原理与支付宝类型。<br><img src="'+j+'" alt="" loading="lazy"><br> Native支付API列表：</p>',9),ds=n("thead",null,[n("tr",null,[n("th",null,"模块名称"),n("th",null,"功能列表"),n("th",null,"描述")])],-1),ms=n("td",null,"Native支付",-1),vs={href:"https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_4_1.shtml",target:"_blank",rel:"noopener noreferrer"},bs=n("td",null,"通过本接口提交微信支付Native支付订单。",-1),gs=n("td",null,null,-1),ys={href:"https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_4_2.shtml",target:"_blank",rel:"noopener noreferrer"},fs=n("td",null,"通过此接口查询订单状态。",-1),hs=n("td",null,null,-1),ws={href:"https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_4_3.shtml",target:"_blank",rel:"noopener noreferrer"},_s=n("td",null,"通过此接口关闭待支付订单。",-1),Es=n("td",null,null,-1),qs={href:"https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_4_4.shtml",target:"_blank",rel:"noopener noreferrer"},Ss=n("td",null,"商户后台系统先调用微信支付的Native支付接口，微信后台系统返回链接参数code_url，商户后台系统将code_url值生成二维码图片，用户使用微信客户端扫码后发起支付。",-1),Ts=n("td",null,null,-1),Rs={href:"https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_4_5.shtml",target:"_blank",rel:"noopener noreferrer"},Ps=n("td",null,"微信支付通过支付通知接口将用户支付成功消息通知给商户。",-1),Cs=n("td",null,null,-1),Os={href:"https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_4_9.shtml",target:"_blank",rel:"noopener noreferrer"},js=n("td",null,"商户可以通过该接口将支付金额退还给买家。",-1),Ns=n("td",null,null,-1),As={href:"https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_4_10.shtml",target:"_blank",rel:"noopener noreferrer"},Is=n("td",null,"提交退款申请后，通过调用该接口查询退款状态 。",-1),Ls=n("td",null,null,-1),xs={href:"https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_4_11.shtml",target:"_blank",rel:"noopener noreferrer"},Us=n("td",null,"微信支付通过退款通知接口将用户退款成功消息通知给商户。",-1),Ds=n("td",null,null,-1),Hs={href:"https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_4_6.shtml",target:"_blank",rel:"noopener noreferrer"},Bs=n("td",null,"商户可以通过该接口获取交易账单文件的下载地址。",-1),Fs=n("td",null,null,-1),Ms={href:"https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_4_7.shtml",target:"_blank",rel:"noopener noreferrer"},Ws=n("td",null,"商户可以通过该接口获取资金账单文件的下载地址。",-1),Vs=n("td",null,null,-1),zs={href:"https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_4_8.shtml",target:"_blank",rel:"noopener noreferrer"},Ks=n("td",null,"通过申请交易/资金账单获取到download_url在该接口获取到对应的账单。",-1),Gs=p('<p>业务流程如下：<br><img src="'+N+`" alt="" loading="lazy"></p><h3 id="_5-3-3、sdk" tabindex="-1"><a class="header-anchor" href="#_5-3-3、sdk" aria-hidden="true">#</a> 5.3.3、SDK</h3><p>微信支付的接口是标准的RETful风格，同样也提供了SDK，与支付宝提供的SDK相比就简化了很多，微信支付的SDK仅仅是基于Httpclient进行了必要的封装，并没有将业务api封装进去。<br> 通过maven坐标导入依赖：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.wechatpay-apiv3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>wechatpay-apache-httpclient<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>\${wechatpay.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>二次封装代码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>wechat</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>net<span class="token punctuation">.</span>url<span class="token punctuation">.</span></span><span class="token class-name">UrlBuilder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>net<span class="token punctuation">.</span>url<span class="token punctuation">.</span></span><span class="token class-name">UrlPath</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>net<span class="token punctuation">.</span>url<span class="token punctuation">.</span></span><span class="token class-name">UrlQuery</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">CharsetUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">StrUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>json<span class="token punctuation">.</span></span><span class="token class-name">JSONUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>wechat<span class="token punctuation">.</span>response<span class="token punctuation">.</span></span><span class="token class-name">WeChatResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>wechat<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>httpclient<span class="token punctuation">.</span>auth<span class="token punctuation">.</span></span><span class="token class-name">PrivateKeySigner</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>wechat<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>httpclient<span class="token punctuation">.</span>auth<span class="token punctuation">.</span></span><span class="token class-name">WechatPay2Credentials</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>wechat<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>httpclient<span class="token punctuation">.</span>auth<span class="token punctuation">.</span></span><span class="token class-name">WechatPay2Validator</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>wechat<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>httpclient<span class="token punctuation">.</span>cert<span class="token punctuation">.</span></span><span class="token class-name">CertificatesManager</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>wechat<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>httpclient<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">PemUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Builder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">NoArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>client<span class="token punctuation">.</span>methods<span class="token punctuation">.</span></span><span class="token class-name">CloseableHttpResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>client<span class="token punctuation">.</span>methods<span class="token punctuation">.</span></span><span class="token class-name">HttpGet</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>client<span class="token punctuation">.</span>methods<span class="token punctuation">.</span></span><span class="token class-name">HttpPost</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">StringEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">CloseableHttpClient</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">URI</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">PrivateKey</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 微信支付远程调用对象
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WechatPayHttpClient</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> mchId<span class="token punctuation">;</span> <span class="token comment">//商户号</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> appId<span class="token punctuation">;</span> <span class="token comment">//应用号</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> privateKey<span class="token punctuation">;</span> <span class="token comment">//私钥字符串</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> mchSerialNo<span class="token punctuation">;</span> <span class="token comment">//商户证书序列号</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> apiV3Key<span class="token punctuation">;</span> <span class="token comment">//V3密钥</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> domain<span class="token punctuation">;</span> <span class="token comment">//请求域名</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> notifyUrl<span class="token punctuation">;</span> <span class="token comment">//请求地址</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">WechatPayHttpClient</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//通过渠道对象转化成微信支付的client对象</span>
        <span class="token keyword">return</span> <span class="token class-name">WechatPayHttpClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">appId</span><span class="token punctuation">(</span><span class="token string">&quot;wx6592a2db3f85ed25&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">domain</span><span class="token punctuation">(</span><span class="token string">&quot;api.mch.weixin.qq.com&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">privateKey</span><span class="token punctuation">(</span><span class="token string">&quot;-----BEGIN PRIVATE KEY-----\\n&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDBHGgIh80193Gh\\n&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;dpD1LtMZfTRpcWI0fImyuBCyrd3gYb3rrsARebGcHdJsQA3mVjVqVp5ybhEZDPa4\\n&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;ecoK4Ye1hTppNpI/lmLt4/uUV/zhF5ahli7hi+116Ty6svHSbuMQBuUZeTFOwGrx\\n&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;jvofU/4pGIwh8ZvkcSnyOp9uX2177UVxDBkhgbZbJp9XF2b83vUa5eHo93CziPzn\\n&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;3hFdAlBCdTXB7DH+m0nN3Jou0szGukvq7cIgGpHku4ycKSTkIhhl9WRhN6OoSEJx\\n&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;q88MXzjkzTruc85PHN52aUTUifwg3T8Y4XqFQ61dTnEmgxeD2O6/pLdB9gLsp6yC\\n&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;GqN5Lqk7AgMBAAECggEBAL4X+WzUSbSjFS9NKNrCMjm4H1zgqTxjj6TnPkC1mGEl\\n&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;tjAHwLgzJBw62wWGdGhWWpSIGccpBBm1wjTMZpAZfF66fEpP1t1Ta6UjtGZNyvfF\\n&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;IZmE3jdWZ/WXGBnsxtFQKKKBNwrBW0Fbdqq9BQjLxLitmlxbmwrgPttcy855j6vZ\\n&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;qq4MBT1v8CtUT/gz4UWW2xWovVnmWOrRSScv7Nh0pMbRpPLkNHXrBwSSNz/keORz\\n&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;XB9JSm85wlkafa7n5/IJbdTml3A/uAgW3q3JZZQotHxQsYvD4Zb5Cnc9CPAXE5L2\\n&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;Yk877kVXZMGt5QPIVcPMj/72AMtaJT67Y0fN0RYHEGkCgYEA38BIGDY6pePgPbxB\\n&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;7N/l6Df0/OKPP0u8mqR4Q0aQD3VxeGiZUN1uWXEFKsKwlOxLfIFIFk1/6zQeC0xe\\n&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;tNTKk0gTL8hpMUTNkE7vI9gFWws2LY6DE86Lm0bdFEIwh6d7Fr7zZtyQKPzMsesC\\n&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;3XV9sdSUExEi5o/VwAyf+xZlOXcCgYEA3PGZYlILjg3esPNkhDz2wxFw432i8l/B\\n&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;CPD8ZtqIV9eguu4fVtFYcUVfawBb0T11RamJkc4eiSOqayC+2ehgb+GyRLJNK4Fq\\n&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;bFcsIT+CK0HlscZw51jrMR0MxTc4RzuOIMoYDeZqeGB6/YnNyG4pw2sD8bIwHm84\\n&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;06gtJsX/v10CgYAo8g3/aEUZQHcztPS3fU2cTkkl0ev24Ew2XGypmwsX2R0XtMSB\\n&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;uNPNyFHyvkgEKK2zrhDcC/ihuRraZHJcUyhzBViFgP5HBtk7VEaM36YzP/z9Hzw7\\n&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;bqu7kZ85atdoq6xpwC3Yn/o9le17jY8rqamD1mv2hUdGvAGYsHbCQxnpBwKBgHTk\\n&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;eaMUBzr7yZLS4p435tHje1dQVBJpaKaDYPZFrhbTZR0g+IGlNmaPLmFdCjbUjiPy\\n&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;A2+Znnwt227cHz0IfWUUAo3ny3419QkmwZlBkWuzbIO2mms7lwsf9G6uvV6qepKM\\n&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;eVd5TWEsokVbT/03k27pQmfwPxcK/wS0GFdIL/udAoGAOYdDqY5/aadWCyhzTGI6\\n&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;qXPLvC+fsJBPhK2RXyc+jYV0KmrEv4ewxlK5NksuFsNkyB7wlI1oMCa/xB3T/2vT\\n&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;BALgGFPi8BJqceUjtnTYtI4R2JIVEl08RtEJwyU5JZ2rvWcilsotVZYwfuLZ9Kfd\\n&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;hkTrgNxlp/KKkr+UuKce4Vs=\\n&quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;-----END PRIVATE KEY-----\\n&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">mchId</span><span class="token punctuation">(</span><span class="token string">&quot;1561414331&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">mchSerialNo</span><span class="token punctuation">(</span><span class="token string">&quot;25FBDE3EFD31B03A4377EB9A4A47C517969E6620&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">apiV3Key</span><span class="token punctuation">(</span><span class="token string">&quot;CZBK51236435wxpay435434323FFDuv3&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">notifyUrl</span><span class="token punctuation">(</span><span class="token string">&quot;https://www.itcast.cn/&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/***
     * 构建CloseableHttpClient远程请求对象
     * <span class="token keyword">@return</span> org.apache.http.impl.client.CloseableHttpClient
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">CloseableHttpClient</span> <span class="token function">createHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 加载商户私钥（privateKey：私钥字符串）</span>
        <span class="token class-name">PrivateKey</span> merchantPrivateKey <span class="token operator">=</span> <span class="token class-name">PemUtil</span><span class="token punctuation">.</span><span class="token function">loadPrivateKey</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>privateKey<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 加载平台证书（mchId：商户号,mchSerialNo：商户证书序列号,apiV3Key：V3密钥）</span>
        <span class="token class-name">PrivateKeySigner</span> privateKeySigner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrivateKeySigner</span><span class="token punctuation">(</span>mchSerialNo<span class="token punctuation">,</span> merchantPrivateKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WechatPay2Credentials</span> wechatPay2Credentials <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WechatPay2Credentials</span><span class="token punctuation">(</span>mchId<span class="token punctuation">,</span> privateKeySigner<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 向证书管理器增加需要自动更新平台证书的商户信息</span>
        <span class="token class-name">CertificatesManager</span> certificatesManager <span class="token operator">=</span> <span class="token class-name">CertificatesManager</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        certificatesManager<span class="token punctuation">.</span><span class="token function">putMerchant</span><span class="token punctuation">(</span>mchId<span class="token punctuation">,</span> wechatPay2Credentials<span class="token punctuation">,</span> apiV3Key<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 初始化httpClient</span>
        <span class="token keyword">return</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>wechat<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>httpclient<span class="token punctuation">.</span></span>WechatPayHttpClientBuilder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withMerchant</span><span class="token punctuation">(</span>mchId<span class="token punctuation">,</span> mchSerialNo<span class="token punctuation">,</span> merchantPrivateKey<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withValidator</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WechatPay2Validator</span><span class="token punctuation">(</span>certificatesManager<span class="token punctuation">.</span><span class="token function">getVerifier</span><span class="token punctuation">(</span>mchId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/***
     * 支持post请求的远程调用
     *
     * <span class="token keyword">@param</span> <span class="token parameter">apiPath</span> api地址
     * <span class="token keyword">@param</span> <span class="token parameter">params</span> 携带请求参数
     * <span class="token keyword">@return</span> 返回字符串
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">WeChatResponse</span> <span class="token function">doPost</span><span class="token punctuation">(</span><span class="token class-name">String</span> apiPath<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> params<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;https://{}{}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>domain<span class="token punctuation">,</span> apiPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HttpPost</span> httpPost <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpPost</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpPost<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Accept&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpPost<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Content-type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/json; charset=utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> body <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpPost<span class="token punctuation">.</span><span class="token function">setEntity</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringEntity</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CloseableHttpResponse</span> response <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>httpPost<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WeChatResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/***
     * 支持get请求的远程调用
     * <span class="token keyword">@param</span> <span class="token parameter">apiPath</span> api地址
     * <span class="token keyword">@param</span> <span class="token parameter">params</span> 在路径中请求的参数
     * <span class="token keyword">@return</span> 返回字符串
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">WeChatResponse</span> <span class="token function">doGet</span><span class="token punctuation">(</span><span class="token class-name">String</span> apiPath<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> params<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">URI</span> uri <span class="token operator">=</span> <span class="token class-name">UrlBuilder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>domain<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setScheme</span><span class="token punctuation">(</span><span class="token string">&quot;https&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token class-name">UrlPath</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>apiPath<span class="token punctuation">,</span> <span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span><span class="token constant">CHARSET_UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setQuery</span><span class="token punctuation">(</span><span class="token class-name">UrlQuery</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setCharset</span><span class="token punctuation">(</span><span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span><span class="token constant">CHARSET_UTF_8</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">toURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doGet</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/***
     * 支持get请求的远程调用
     * <span class="token keyword">@param</span> <span class="token parameter">apiPath</span> api地址
     * <span class="token keyword">@return</span> 返回字符串
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">WeChatResponse</span> <span class="token function">doGet</span><span class="token punctuation">(</span><span class="token class-name">String</span> apiPath<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">URI</span> uri <span class="token operator">=</span> <span class="token class-name">UrlBuilder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>domain<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setScheme</span><span class="token punctuation">(</span><span class="token string">&quot;https&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token class-name">UrlPath</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>apiPath<span class="token punctuation">,</span> <span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span><span class="token constant">CHARSET_UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setCharset</span><span class="token punctuation">(</span><span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span><span class="token constant">CHARSET_UTF_8</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">toURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doGet</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">WeChatResponse</span> <span class="token function">doGet</span><span class="token punctuation">(</span><span class="token class-name">URI</span> uri<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">HttpGet</span> httpGet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpGet</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpGet<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Accept&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CloseableHttpResponse</span> response <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>httpGet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WeChatResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>代码说明：</p><ul><li>通过<code>get()</code>方法查询配置信息，最后封装到<code>WechatPayHttpClient</code>对象中。</li><li>通过<code>createHttpClient()</code>方法封装了请求微信接口必要的参数，最后返回<code>CloseableHttpClient</code>对象。</li><li>封装了<code>doGet()、doPost()</code>方便对微信接口进行调用。</li></ul><h3 id="_5-3-4、编写代码" tabindex="-1"><a class="header-anchor" href="#_5-3-4、编写代码" aria-hidden="true">#</a> 5.3.4、编写代码</h3><p>编写WechatNativePayHandler，同样也是实现NativePayHandler接口，主要是对接微信支付的扫码支付。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>wechat</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>convert<span class="token punctuation">.</span></span><span class="token class-name">Convert</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>map<span class="token punctuation">.</span></span><span class="token class-name">MapUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">NumberUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>json<span class="token punctuation">.</span></span><span class="token class-name">JSONUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">TradingEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>enums<span class="token punctuation">.</span></span><span class="token class-name">TradingEnum</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>enums<span class="token punctuation">.</span></span><span class="token class-name">TradingStateEnum</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>handler<span class="token punctuation">.</span></span><span class="token class-name">NativePayHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>wechat<span class="token punctuation">.</span>response<span class="token punctuation">.</span></span><span class="token class-name">WeChatResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>transport<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span><span class="token class-name">SLException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 微信二维码支付
 */</span>
<span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span><span class="token string">&quot;wechatNativePayHandler&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WechatNativePayHandler</span> <span class="token keyword">implements</span> <span class="token class-name">NativePayHandler</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createDownLineTrading</span><span class="token punctuation">(</span><span class="token class-name">TradingEntity</span> tradingEntity<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SLException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 查询配置</span>
        <span class="token class-name">WechatPayHttpClient</span> client <span class="token operator">=</span> <span class="token class-name">WechatPayHttpClient</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//请求地址</span>
        <span class="token class-name">String</span> apiPath <span class="token operator">=</span> <span class="token string">&quot;/v3/pay/transactions/native&quot;</span><span class="token punctuation">;</span>

        <span class="token comment">//请求参数</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;mchid&quot;</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">getMchId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;appid&quot;</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">getAppId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;description&quot;</span><span class="token punctuation">,</span> tradingEntity<span class="token punctuation">.</span><span class="token function">getMemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;notify_url&quot;</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">getNotifyUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toStr</span><span class="token punctuation">(</span>tradingEntity<span class="token punctuation">.</span><span class="token function">getTradingOrderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;amount&quot;</span><span class="token punctuation">,</span> <span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;total&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token class-name">NumberUtil</span><span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>tradingEntity<span class="token punctuation">.</span><span class="token function">getTradingAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//金额，单位：分</span>
                        <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;currency&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;CNY&quot;</span><span class="token punctuation">)</span> <span class="token comment">//人民币</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">WeChatResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">doPost</span><span class="token punctuation">(</span>apiPath<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//下单失败</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span><span class="token class-name">TradingEnum</span><span class="token punctuation">.</span><span class="token constant">NATIVE_PAY_FAIL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//指定统一下单code</span>
            tradingEntity<span class="token punctuation">.</span><span class="token function">setPlaceOrderCode</span><span class="token punctuation">(</span><span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toStr</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//二维码需要展现的信息</span>
            tradingEntity<span class="token punctuation">.</span><span class="token function">setPlaceOrderMsg</span><span class="token punctuation">(</span><span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">parseObj</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStr</span><span class="token punctuation">(</span><span class="token string">&quot;code_url&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//指定统一下单json字符串</span>
            tradingEntity<span class="token punctuation">.</span><span class="token function">setPlaceOrderJson</span><span class="token punctuation">(</span><span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//指定交易状态</span>
            tradingEntity<span class="token punctuation">.</span><span class="token function">setTradingState</span><span class="token punctuation">(</span><span class="token class-name">TradingStateEnum</span><span class="token punctuation">.</span><span class="token constant">FKZ</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span><span class="token class-name">TradingEnum</span><span class="token punctuation">.</span><span class="token constant">NATIVE_PAY_FAIL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试用例：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>wechat</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">TradingEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>handler<span class="token punctuation">.</span></span><span class="token class-name">NativePayHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token import static"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">class</span> <span class="token class-name">WechatNativePayHandlerTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;wechatNativePayHandler&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">NativePayHandler</span> nativePayHandler<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">createDownLineTrading</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TradingEntity</span> tradingEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TradingEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tradingEntity<span class="token punctuation">.</span><span class="token function">setProductOrderNo</span><span class="token punctuation">(</span><span class="token number">12345L</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//订单号</span>
        tradingEntity<span class="token punctuation">.</span><span class="token function">setTradingOrderNo</span><span class="token punctuation">(</span><span class="token number">11223388L</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//交易单号</span>
        tradingEntity<span class="token punctuation">.</span><span class="token function">setMemo</span><span class="token punctuation">(</span><span class="token string">&quot;运费&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tradingEntity<span class="token punctuation">.</span><span class="token function">setTradingAmount</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>nativePayHandler<span class="token punctuation">.</span><span class="token function">createDownLineTrading</span><span class="token punctuation">(</span>tradingEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;二维码信息：&quot;</span> <span class="token operator">+</span> tradingEntity<span class="token punctuation">.</span><span class="token function">getPlaceOrderMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>tradingEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试结果：<br><img src="`+A+`" alt="" loading="lazy"></p><h3 id="_5-3-5、其他操作" tabindex="-1"><a class="header-anchor" href="#_5-3-5、其他操作" aria-hidden="true">#</a> 5.3.5、其他操作</h3><p>与支付宝类型，微信支付也有查询交易单、退款等操作，同样也是实现了<code>BasicPayHandler</code>接口。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>wechat</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>convert<span class="token punctuation">.</span></span><span class="token class-name">Convert</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>date<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTimeUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>map<span class="token punctuation">.</span></span><span class="token class-name">MapUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">NumberUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">StrUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>json<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>json<span class="token punctuation">.</span></span><span class="token class-name">JSONUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>constant<span class="token punctuation">.</span></span><span class="token class-name">TradingConstant</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">RefundRecordEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">TradingEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>enums<span class="token punctuation">.</span></span><span class="token class-name">RefundStatusEnum</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>enums<span class="token punctuation">.</span></span><span class="token class-name">TradingStateEnum</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>handler<span class="token punctuation">.</span></span><span class="token class-name">BasicPayHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>wechat<span class="token punctuation">.</span>response<span class="token punctuation">.</span></span><span class="token class-name">WeChatResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>transport<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span><span class="token class-name">SLException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>temporal<span class="token punctuation">.</span></span><span class="token class-name">ChronoUnit</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token import static"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>enums<span class="token punctuation">.</span></span><span class="token class-name">TradingEnum</span><span class="token punctuation">.</span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 微信基础支付功能的实现
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span><span class="token string">&quot;weChatBasicPayHandler&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeChatBasicPayHandler</span> <span class="token keyword">implements</span> <span class="token class-name">BasicPayHandler</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">queryTrading</span><span class="token punctuation">(</span><span class="token class-name">TradingEntity</span> trading<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SLException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取微信支付的client对象</span>
        <span class="token class-name">WechatPayHttpClient</span> client <span class="token operator">=</span> <span class="token class-name">WechatPayHttpClient</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//请求地址</span>
        <span class="token class-name">String</span> apiPath <span class="token operator">=</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;/v3/pay/transactions/out-trade-no/{}&quot;</span><span class="token punctuation">,</span> trading<span class="token punctuation">.</span><span class="token function">getTradingOrderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//请求参数</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;mchid&quot;</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">getMchId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">WeChatResponse</span> response<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">doGet</span><span class="token punctuation">(</span>apiPath<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;调用微信接口出错！apiPath = {}, params = {}&quot;</span><span class="token punctuation">,</span> apiPath<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span><span class="token constant">NATIVE_REFUND_FAIL</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">parseObj</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 交易状态，枚举值：</span>
            <span class="token comment">// SUCCESS：支付成功</span>
            <span class="token comment">// REFUND：转入退款</span>
            <span class="token comment">// NOTPAY：未支付</span>
            <span class="token comment">// CLOSED：已关闭</span>
            <span class="token comment">// REVOKED：已撤销（仅付款码支付会返回）</span>
            <span class="token comment">// USERPAYING：用户支付中（仅付款码支付会返回）</span>
            <span class="token comment">// PAYERROR：支付失败（仅付款码支付会返回）</span>
            <span class="token class-name">String</span> tradeStatus <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getStr</span><span class="token punctuation">(</span><span class="token string">&quot;trade_state&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">equalsAny</span><span class="token punctuation">(</span>tradeStatus<span class="token punctuation">,</span> <span class="token class-name">TradingConstant</span><span class="token punctuation">.</span><span class="token constant">WECHAT_TRADE_CLOSED</span><span class="token punctuation">,</span> <span class="token class-name">TradingConstant</span><span class="token punctuation">.</span><span class="token constant">WECHAT_TRADE_REVOKED</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                trading<span class="token punctuation">.</span><span class="token function">setTradingState</span><span class="token punctuation">(</span><span class="token class-name">TradingStateEnum</span><span class="token punctuation">.</span><span class="token constant">QXDD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">equalsAny</span><span class="token punctuation">(</span>tradeStatus<span class="token punctuation">,</span> <span class="token class-name">TradingConstant</span><span class="token punctuation">.</span><span class="token constant">WECHAT_REFUND_SUCCESS</span><span class="token punctuation">,</span> <span class="token class-name">TradingConstant</span><span class="token punctuation">.</span><span class="token constant">WECHAT_TRADE_REFUND</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                trading<span class="token punctuation">.</span><span class="token function">setTradingState</span><span class="token punctuation">(</span><span class="token class-name">TradingStateEnum</span><span class="token punctuation">.</span><span class="token constant">YJS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">equalsAny</span><span class="token punctuation">(</span>tradeStatus<span class="token punctuation">,</span> <span class="token class-name">TradingConstant</span><span class="token punctuation">.</span><span class="token constant">WECHAT_TRADE_NOTPAY</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//如果是未支付，需要判断下时间，超过2小时未知的订单需要关闭订单以及设置状态为QXDD</span>
                <span class="token keyword">long</span> between <span class="token operator">=</span> <span class="token class-name">LocalDateTimeUtil</span><span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span>trading<span class="token punctuation">.</span><span class="token function">getCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">LocalDateTimeUtil</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ChronoUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>between <span class="token operator">&gt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">closeTrading</span><span class="token punctuation">(</span>trading<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//非最终状态不处理</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//修改交易单状态</span>
            trading<span class="token punctuation">.</span><span class="token function">setResultCode</span><span class="token punctuation">(</span>tradeStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
            trading<span class="token punctuation">.</span><span class="token function">setResultMsg</span><span class="token punctuation">(</span>jsonObject<span class="token punctuation">.</span><span class="token function">getStr</span><span class="token punctuation">(</span><span class="token string">&quot;trade_state_desc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            trading<span class="token punctuation">.</span><span class="token function">setResultJson</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NATIVE_REFUND_FAIL</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NATIVE_REFUND_FAIL</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">closeTrading</span><span class="token punctuation">(</span><span class="token class-name">TradingEntity</span> trading<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SLException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取微信支付的client对象</span>
        <span class="token class-name">WechatPayHttpClient</span> client <span class="token operator">=</span> <span class="token class-name">WechatPayHttpClient</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//请求地址</span>
        <span class="token class-name">String</span> apiPath <span class="token operator">=</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;/v3/pay/transactions/out-trade-no/{}/close&quot;</span><span class="token punctuation">,</span> trading<span class="token punctuation">.</span><span class="token function">getTradingOrderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//请求参数</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;mchid&quot;</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">getMchId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">WeChatResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">doPost</span><span class="token punctuation">(</span>apiPath<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">204</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                trading<span class="token punctuation">.</span><span class="token function">setTradingState</span><span class="token punctuation">(</span><span class="token class-name">TradingStateEnum</span><span class="token punctuation">.</span><span class="token constant">QXDD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span><span class="token constant">CLOSE_FAIL</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">refundTrading</span><span class="token punctuation">(</span><span class="token class-name">RefundRecordEntity</span> refundRecord<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SLException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取微信支付的client对象</span>
        <span class="token class-name">WechatPayHttpClient</span> client <span class="token operator">=</span> <span class="token class-name">WechatPayHttpClient</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//请求地址</span>
        <span class="token class-name">String</span> apiPath <span class="token operator">=</span> <span class="token string">&quot;/v3/refund/domestic/refunds&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">//请求参数</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;out_refund_no&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toStr</span><span class="token punctuation">(</span>refundRecord<span class="token punctuation">.</span><span class="token function">getRefundNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toStr</span><span class="token punctuation">(</span>refundRecord<span class="token punctuation">.</span><span class="token function">getTradingOrderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;amount&quot;</span><span class="token punctuation">,</span> <span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;refund&quot;</span><span class="token punctuation">,</span> <span class="token class-name">NumberUtil</span><span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>refundRecord<span class="token punctuation">.</span><span class="token function">getRefundAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//本次退款金额</span>
                        <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;total&quot;</span><span class="token punctuation">,</span> <span class="token class-name">NumberUtil</span><span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>refundRecord<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//原订单金额</span>
                        <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;currency&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;CNY&quot;</span><span class="token punctuation">)</span> <span class="token comment">//币种</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WeChatResponse</span> response<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">doPost</span><span class="token punctuation">(</span>apiPath<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;调用微信接口出错！apiPath = {}, params = {}&quot;</span><span class="token punctuation">,</span> apiPath<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span><span class="token constant">NATIVE_REFUND_FAIL</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        refundRecord<span class="token punctuation">.</span><span class="token function">setRefundCode</span><span class="token punctuation">(</span><span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toStr</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        refundRecord<span class="token punctuation">.</span><span class="token function">setRefundMsg</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">parseObj</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// SUCCESS：退款成功</span>
            <span class="token comment">// CLOSED：退款关闭</span>
            <span class="token comment">// PROCESSING：退款处理中</span>
            <span class="token comment">// ABNORMAL：退款异常</span>
            <span class="token class-name">String</span> status <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getStr</span><span class="token punctuation">(</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> <span class="token class-name">TradingConstant</span><span class="token punctuation">.</span><span class="token constant">WECHAT_REFUND_PROCESSING</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                refundRecord<span class="token punctuation">.</span><span class="token function">setRefundStatus</span><span class="token punctuation">(</span><span class="token class-name">RefundStatusEnum</span><span class="token punctuation">.</span><span class="token constant">SENDING</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> <span class="token class-name">TradingConstant</span><span class="token punctuation">.</span><span class="token constant">WECHAT_REFUND_SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                refundRecord<span class="token punctuation">.</span><span class="token function">setRefundStatus</span><span class="token punctuation">(</span><span class="token class-name">RefundStatusEnum</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                refundRecord<span class="token punctuation">.</span><span class="token function">setRefundStatus</span><span class="token punctuation">(</span><span class="token class-name">RefundStatusEnum</span><span class="token punctuation">.</span><span class="token constant">FAIL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span>refundRecord<span class="token punctuation">.</span><span class="token function">getRefundMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NATIVE_REFUND_FAIL</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NATIVE_REFUND_FAIL</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">queryRefundTrading</span><span class="token punctuation">(</span><span class="token class-name">RefundRecordEntity</span> refundRecord<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SLException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取微信支付的client对象</span>
        <span class="token class-name">WechatPayHttpClient</span> client <span class="token operator">=</span> <span class="token class-name">WechatPayHttpClient</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//请求地址</span>
        <span class="token class-name">String</span> apiPath <span class="token operator">=</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;/v3/refund/domestic/refunds/{}&quot;</span><span class="token punctuation">,</span> refundRecord<span class="token punctuation">.</span><span class="token function">getRefundNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">WeChatResponse</span> response<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">doGet</span><span class="token punctuation">(</span>apiPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;调用微信接口出错！apiPath = {}&quot;</span><span class="token punctuation">,</span> apiPath<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span><span class="token constant">NATIVE_QUERY_REFUND_FAIL</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        refundRecord<span class="token punctuation">.</span><span class="token function">setRefundCode</span><span class="token punctuation">(</span><span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toStr</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        refundRecord<span class="token punctuation">.</span><span class="token function">setRefundMsg</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">parseObj</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// SUCCESS：退款成功</span>
            <span class="token comment">// CLOSED：退款关闭</span>
            <span class="token comment">// PROCESSING：退款处理中</span>
            <span class="token comment">// ABNORMAL：退款异常</span>
            <span class="token class-name">String</span> status <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getStr</span><span class="token punctuation">(</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> <span class="token class-name">TradingConstant</span><span class="token punctuation">.</span><span class="token constant">WECHAT_REFUND_PROCESSING</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                refundRecord<span class="token punctuation">.</span><span class="token function">setRefundStatus</span><span class="token punctuation">(</span><span class="token class-name">RefundStatusEnum</span><span class="token punctuation">.</span><span class="token constant">SENDING</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> <span class="token class-name">TradingConstant</span><span class="token punctuation">.</span><span class="token constant">WECHAT_REFUND_SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                refundRecord<span class="token punctuation">.</span><span class="token function">setRefundStatus</span><span class="token punctuation">(</span><span class="token class-name">RefundStatusEnum</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                refundRecord<span class="token punctuation">.</span><span class="token function">setRefundStatus</span><span class="token punctuation">(</span><span class="token class-name">RefundStatusEnum</span><span class="token punctuation">.</span><span class="token constant">FAIL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NATIVE_QUERY_REFUND_FAIL</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NATIVE_QUERY_REFUND_FAIL</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试用例：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>wechat</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">RefundRecordEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">TradingEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>handler<span class="token punctuation">.</span></span><span class="token class-name">BasicPayHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span></span><span class="token class-name">AliBasicPayHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTime</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">class</span> <span class="token class-name">WechatBasicPayHandlerTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;weChatBasicPayHandler&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">BasicPayHandler</span> basicPayHandler<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">queryTrading</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TradingEntity</span> tradingEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TradingEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tradingEntity<span class="token punctuation">.</span><span class="token function">setTradingOrderNo</span><span class="token punctuation">(</span><span class="token number">11223388L</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//交易单号</span>
        tradingEntity<span class="token punctuation">.</span><span class="token function">setCreated</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>basicPayHandler<span class="token punctuation">.</span><span class="token function">queryTrading</span><span class="token punctuation">(</span>tradingEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;执行是否成功：&quot;</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>tradingEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">closeTrading</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TradingEntity</span> tradingEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TradingEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tradingEntity<span class="token punctuation">.</span><span class="token function">setTradingOrderNo</span><span class="token punctuation">(</span><span class="token number">11223377L</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//交易单号</span>
        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>basicPayHandler<span class="token punctuation">.</span><span class="token function">closeTrading</span><span class="token punctuation">(</span>tradingEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;执行是否成功：&quot;</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>tradingEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">refundTrading</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RefundRecordEntity</span> refundRecordEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RefundRecordEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        refundRecordEntity<span class="token punctuation">.</span><span class="token function">setTradingOrderNo</span><span class="token punctuation">(</span><span class="token number">11223388L</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//交易单号</span>
        refundRecordEntity<span class="token punctuation">.</span><span class="token function">setRefundNo</span><span class="token punctuation">(</span><span class="token number">11223380L</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//退款单号</span>
        refundRecordEntity<span class="token punctuation">.</span><span class="token function">setRefundAmount</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//退款金额</span>
        refundRecordEntity<span class="token punctuation">.</span><span class="token function">setTotal</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//原金额</span>
        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>basicPayHandler<span class="token punctuation">.</span><span class="token function">refundTrading</span><span class="token punctuation">(</span>refundRecordEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;执行是否成功：&quot;</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>refundRecordEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">queryRefundTrading</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RefundRecordEntity</span> refundRecordEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RefundRecordEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        refundRecordEntity<span class="token punctuation">.</span><span class="token function">setTradingOrderNo</span><span class="token punctuation">(</span><span class="token number">11223388L</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//交易单号</span>
        refundRecordEntity<span class="token punctuation">.</span><span class="token function">setRefundNo</span><span class="token punctuation">(</span><span class="token number">11223388L</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//退款单号</span>
        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>basicPayHandler<span class="token punctuation">.</span><span class="token function">queryRefundTrading</span><span class="token punctuation">(</span>refundRecordEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;执行是否成功：&quot;</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>refundRecordEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="_6、分布式锁" tabindex="-1"><a class="header-anchor" href="#_6、分布式锁" aria-hidden="true">#</a> 6、分布式锁</h1><p>想象一下这样的场景，快递员提交了支付请求，由于网络等原因一直没有返回二维码，此时快递员针对该订单又发起了一次请求，这样的话就可能针对于一个订单生成了2个交易单，这样就重复了，所以我们需要在处理请求生成交易单时对该订单锁定，如果获取到锁就执行，否则就抛出异常。<br> 实际上，在这里我们是需要使用分布式锁来实现，首先要解释下为什么是用分布式锁，不是用本地锁，是因为微服务在生产部署时一般都是集群的，而我们需要的在多个节点之间锁定，并不是在一个节点内锁定，所以就要用到分布式锁，如何实现分布式锁呢，下面我们一起来学习下。</p><h2 id="_6-1、核心思想" tabindex="-1"><a class="header-anchor" href="#_6-1、核心思想" aria-hidden="true">#</a> 6.1、核心思想</h2><p>实现分布式锁，可以借助redis的SETNX命令完成，该命令设置值时，如果key不存在，为key设置指定的值，返回1，如果存在返回0，也就意味着相同的key只能设置成功一次，假设有多个线程同时设置值，只能有一个设置成功，这样就得到互斥的效果，也就可以达到锁的效果。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">192.168</span>.150.101:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>SETNX abc <span class="token number">123</span>
<span class="token string">&quot;1&quot;</span>  ---设置成功
<span class="token number">192.168</span>.150.101:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>SETNX abc <span class="token number">123</span>
<span class="token string">&quot;0&quot;</span>  ---设置失败
<span class="token number">192.168</span>.150.101:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>SETNX abc <span class="token number">123</span>
<span class="token string">&quot;0&quot;</span>  ---设置失败
<span class="token number">192.168</span>.150.101:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>get abc
<span class="token string">&quot;123&quot;</span>  ---可以正常查询值
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里举个例子，商品服务的并发操作：<br><img src="`+I+`" alt="" loading="lazy"></p><h2 id="_6-2、业务功能" tabindex="-1"><a class="header-anchor" href="#_6-2、业务功能" aria-hidden="true">#</a> 6.2、业务功能</h2><p>下面我们基于并发创建交易这样的业务场景进行测试。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>lock</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>convert<span class="token punctuation">.</span></span><span class="token class-name">Convert</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">IdUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">TradingEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>handler<span class="token punctuation">.</span></span><span class="token class-name">NativePayHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTime</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NativePayService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;aliNativePayHandler&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">NativePayHandler</span> nativePayHandler<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 创建交易单示例代码
     *
     * <span class="token keyword">@param</span> <span class="token parameter">productOrderNo</span> 订单号
     * <span class="token keyword">@return</span> 交易单对象
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">TradingEntity</span> <span class="token function">createDownLineTrading</span><span class="token punctuation">(</span><span class="token class-name">Long</span> productOrderNo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TradingEntity</span> tradingEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TradingEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tradingEntity<span class="token punctuation">.</span><span class="token function">setProductOrderNo</span><span class="token punctuation">(</span>productOrderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//基于订单创建交易单</span>
        tradingEntity<span class="token punctuation">.</span><span class="token function">setTradingOrderNo</span><span class="token punctuation">(</span><span class="token class-name">IdUtil</span><span class="token punctuation">.</span><span class="token function">getSnowflakeNextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tradingEntity<span class="token punctuation">.</span><span class="token function">setCreated</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tradingEntity<span class="token punctuation">.</span><span class="token function">setTradingAmount</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tradingEntity<span class="token punctuation">.</span><span class="token function">setMemo</span><span class="token punctuation">(</span><span class="token string">&quot;运费&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//调用三方支付创建交易</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>nativePayHandler<span class="token punctuation">.</span><span class="token function">createDownLineTrading</span><span class="token punctuation">(</span>tradingEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> tradingEntity<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用多线程模拟并发测试：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>lock</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">TradingEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">class</span> <span class="token class-name">NativePayServiceTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token class-name">NativePayService</span> nativePayService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">createDownLineTrading</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> productOrderNo <span class="token operator">=</span> <span class="token number">1122334455L</span><span class="token punctuation">;</span>

        <span class="token comment">//多线程模拟并发</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">TradingEntity</span> tradingEntity <span class="token operator">=</span> nativePayService<span class="token punctuation">.</span><span class="token function">createDownLineTrading</span><span class="token punctuation">(</span>productOrderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;交易单：&quot;</span> <span class="token operator">+</span> tradingEntity <span class="token operator">+</span> <span class="token string">&quot;, 线程id = &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

		<span class="token comment">//睡眠20秒，等待所有子线程的完成</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行结果：<br><img src="`+L+`" alt="" loading="lazy"><br> 可见，对同一个订单号创建了多个交易单对象，这就是并发常见下的数据重复问题。</p><h2 id="_6-3、基于redis实现分布式锁" tabindex="-1"><a class="header-anchor" href="#_6-3、基于redis实现分布式锁" aria-hidden="true">#</a> 6.3、基于Redis实现分布式锁</h2><p>定义锁接口：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>lock</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ILock</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 尝试获取锁
     *
     * <span class="token keyword">@param</span> <span class="token parameter">name</span>       锁的名称
     * <span class="token keyword">@param</span> <span class="token parameter">timeoutSec</span> 锁持有的超时时间，过期后自动释放
     * <span class="token keyword">@return</span> true表示获取锁成功，false表示获取锁失败
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Long</span> timeoutSec<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 释放锁
     */</span>
    <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>基本的实现：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>lock</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">StringRedisTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleRedisLock</span> <span class="token keyword">implements</span> <span class="token class-name">ILock</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">KEY_PREFIX</span> <span class="token operator">=</span> <span class="token string">&quot;lock:&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Long</span> timeoutSec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取线程标示</span>
        <span class="token class-name">String</span> threadId <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取锁 setIfAbsent()是SETNX命令在java中的体现</span>
        <span class="token class-name">Boolean</span> success <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token constant">KEY_PREFIX</span> <span class="token operator">+</span> name<span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> timeoutSec<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//通过del删除锁</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token constant">KEY_PREFIX</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>业务中使用（createDownLineTradingLock()方法）：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>lock</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>convert<span class="token punctuation">.</span></span><span class="token class-name">Convert</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">IdUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">TradingEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>handler<span class="token punctuation">.</span></span><span class="token class-name">NativePayHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTime</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NativePayService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;aliNativePayHandler&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">NativePayHandler</span> nativePayHandler<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">SimpleRedisLock</span> simpleRedisLock<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 创建交易单示例代码
     *
     * <span class="token keyword">@param</span> <span class="token parameter">productOrderNo</span> 订单号
     * <span class="token keyword">@return</span> 交易单对象
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">TradingEntity</span> <span class="token function">createDownLineTrading</span><span class="token punctuation">(</span><span class="token class-name">Long</span> productOrderNo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TradingEntity</span> tradingEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TradingEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tradingEntity<span class="token punctuation">.</span><span class="token function">setProductOrderNo</span><span class="token punctuation">(</span>productOrderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//基于订单创建交易单</span>
        tradingEntity<span class="token punctuation">.</span><span class="token function">setTradingOrderNo</span><span class="token punctuation">(</span><span class="token class-name">IdUtil</span><span class="token punctuation">.</span><span class="token function">getSnowflakeNextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tradingEntity<span class="token punctuation">.</span><span class="token function">setCreated</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tradingEntity<span class="token punctuation">.</span><span class="token function">setTradingAmount</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tradingEntity<span class="token punctuation">.</span><span class="token function">setMemo</span><span class="token punctuation">(</span><span class="token string">&quot;运费&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//调用三方支付创建交易</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>nativePayHandler<span class="token punctuation">.</span><span class="token function">createDownLineTrading</span><span class="token punctuation">(</span>tradingEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> tradingEntity<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 创建交易单示例代码
     *
     * <span class="token keyword">@param</span> <span class="token parameter">productOrderNo</span> 订单号
     * <span class="token keyword">@return</span> 交易单对象
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">TradingEntity</span> <span class="token function">createDownLineTradingLock</span><span class="token punctuation">(</span><span class="token class-name">Long</span> productOrderNo<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">//获取锁</span>
        <span class="token class-name">String</span> lockName <span class="token operator">=</span> <span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toStr</span><span class="token punctuation">(</span>productOrderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>simpleRedisLock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span>lockName<span class="token punctuation">,</span> <span class="token number">5L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;没有获取到锁，线程id = &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;获取到锁，线程id = &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">TradingEntity</span> tradingEntity <span class="token operator">=</span> <span class="token function">createDownLineTrading</span><span class="token punctuation">(</span>productOrderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//释放锁</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>simpleRedisLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span>lockName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> tradingEntity<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">createDownLineTradingLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> productOrderNo <span class="token operator">=</span> <span class="token number">1122334455L</span><span class="token punctuation">;</span>

        <span class="token comment">//多线程模拟并发</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">TradingEntity</span> tradingEntity <span class="token operator">=</span> nativePayService<span class="token punctuation">.</span><span class="token function">createDownLineTradingLock</span><span class="token punctuation">(</span>productOrderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;交易单：&quot;</span> <span class="token operator">+</span> tradingEntity <span class="token operator">+</span> <span class="token string">&quot;, 线程id = &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//睡眠20秒，等待所有子线程的完成</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试结果：<br><img src="`+x+`" alt="" loading="lazy"><br> 可以看到，线程23、24没有获取到锁，只要线程25获取到了锁，最终一个订单只会对应一个交易单，这样才符合需求。</p><h2 id="_6-4、问题分析" tabindex="-1"><a class="header-anchor" href="#_6-4、问题分析" aria-hidden="true">#</a> 6.4、问题分析</h2><p>自己基于Redis实现基本上是ok的，但是仔细分析会发现一些问题，比如：设置持有锁的时间为5秒，而程序所运行的时间大于5秒，这样就会出现，程序还没结束锁已经释放了，其他线程就可以获取到这个锁，而当前线程在释放锁时，就会把其他线程的锁删除了，最终可能会导致脏数据。<br> 为了解决这个问题，我们可以在删除时判断一下，看是存储的值是否是当前线程的id，是就删除，不是就不删除。<br> 代码实现：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取线程标示</span>
        <span class="token class-name">String</span> threadId <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取锁中的标示</span>
        <span class="token class-name">String</span> id <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">KEY_PREFIX</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 判断标示是否一致</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>threadId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 释放锁</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token constant">KEY_PREFIX</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下图展现了多线时间之间获取锁以及释放锁的过程：<br><img src="`+U+'" alt="" loading="lazy"><br> 这样是不是就没问题了呢？并不是，其实还是存在问题的。<br> 问题就是，释放锁时查询与删除并不是一个原子性操作，这样带来的问题就是，查询时有数据，删除时数据可能被其他线程删除了。<br> 除了这个问题外还有其他问题：<br><img src="'+D+'" alt="" loading="lazy"><br> 总结一句话，就是自己基于Redis实现分布式锁需要解决的问题非常多，实现非常的复杂，而Redisson已经完美的实现并且解决了这些问题，我们可以直接使用。</p><h2 id="_6-5、redisson快速入门" tabindex="-1"><a class="header-anchor" href="#_6-5、redisson快速入门" aria-hidden="true">#</a> 6.5、Redisson快速入门</h2><p>Redisson是一个在Redis的基础上实现的Java驻内存数据网格（In-Memory Data Grid）。它不仅提供了一系列的分布式的Java常用对象，还提供了许多分布式服务，其中就包含了各种分布式锁的实现。<br><img src="'+H+`" alt="" loading="lazy"><br> 官网地址：<br> GitHub地址：<br> 导入依赖：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>convert<span class="token punctuation">.</span></span><span class="token class-name">Convert</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">StrUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>redisson<span class="token punctuation">.</span></span><span class="token class-name">Redisson</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>redisson<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">RedissonClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>redisson<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">Config</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>redisson<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">SingleServerConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span></span><span class="token class-name">RedisProperties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">EnableConfigurationProperties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">RedisProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedissonConfiguration</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisProperties</span> redisProperties<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedissonClient</span> <span class="token function">redissonSingle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SingleServerConfig</span> serverConfig <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">&quot;redis://&quot;</span> <span class="token operator">+</span> redisProperties<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> redisProperties<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//设置持有时间</span>
            serverConfig<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//设置密码</span>
            serverConfig<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//创建RedissonClient</span>
        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>项目中使用：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>

     <span class="token doc-comment comment">/**
     * 创建交易单示例代码
     *
     * <span class="token keyword">@param</span> <span class="token parameter">productOrderNo</span> 订单号
     * <span class="token keyword">@return</span> 交易单对象
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">TradingEntity</span> <span class="token function">createDownLineTradingRedissonLock</span><span class="token punctuation">(</span><span class="token class-name">Long</span> productOrderNo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取锁</span>
        <span class="token class-name">String</span> lockName <span class="token operator">=</span> <span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toStr</span><span class="token punctuation">(</span>productOrderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取公平锁,优先分配给先发出请求的线程</span>
        <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getFairLock</span><span class="token punctuation">(</span>lockName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//尝试获取锁，最长等待获取锁的时间为5秒</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">5L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;获取到锁，线程id = &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//休眠5s目的是让线程执行慢一些，容易测试出并发效果</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">createDownLineTrading</span><span class="token punctuation">(</span>productOrderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;没有获取到锁，线程id = &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">//释放锁，需要判断当前线程是否获取到锁</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">isLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> lock<span class="token punctuation">.</span><span class="token function">isHeldByCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试用例：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">createDownLineTradingRedissonLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> productOrderNo <span class="token operator">=</span> <span class="token number">1122334455L</span><span class="token punctuation">;</span>

        <span class="token comment">//多线程模拟并发</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">TradingEntity</span> tradingEntity <span class="token operator">=</span> nativePayService<span class="token punctuation">.</span><span class="token function">createDownLineTradingRedissonLock</span><span class="token punctuation">(</span>productOrderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;交易单：&quot;</span> <span class="token operator">+</span> tradingEntity <span class="token operator">+</span> <span class="token string">&quot;, 线程id = &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//睡眠20秒，等待所有子线程的完成</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试结果：<br><img src="`+B+'" alt="" loading="lazy"><br> 可以看到，与我们自己实现的效果是一样的，可见使用Redisson是非常方便实现分布式锁的。</p><h2 id="_6-6、看门狗机制" tabindex="-1"><a class="header-anchor" href="#_6-6、看门狗机制" aria-hidden="true">#</a> 6.6、看门狗机制</h2><p>在使用Redisson分布式锁时，我们有没有指定存储到Redis中锁的有效期时间？如果有的话是多久？如果程序执行时间超出这个时间会怎么样？<br> 其实，在程序中我们并没有指定存储到Redis中锁的有效期时间，而是Redisson的默认存储时间，默认时间是30秒。如果程序的执行时间超出30秒，锁是自动删除吗，是不会的，Redisson一旦加锁成功就会启动一个watch dog【看门狗】，当时间每过期1/3时，就检查一下，如果当前线程还继续持有锁，就会重新刷新到30秒，直到最后的锁释放。<br><img src="'+F+'" alt="" loading="lazy"><br> 可以看到，通过watch dog机制确保不会在业务程序结束之前存储到Redis的锁过期。<br> 可以在Redisson的Config对象中设置锁的默认存时间：<code>config.setLockWatchdogTimeout(10 * 1000);</code><br> 需要注意的是，如果在获取锁时指定了<code>leaseTime</code>参数，看门狗程序是不会生效的，如下：<br><img src="'+M+'" alt="" loading="lazy"><br> 上述的配置，锁的有效期时间为10秒，10秒后锁会自动释放，不会续期。</p><h1 id="_7、面试连环问" tabindex="-1"><a class="header-anchor" href="#_7、面试连环问" aria-hidden="true">#</a> 7、面试连环问</h1><div class="hint-container info"><p class="hint-container-title">相关信息</p><p>面试官问：</p><ul><li>在项目中，用户登录成功后的token你们是怎么生成的？有效期是多久？有考虑过双token模式吗？谈谈你的想法。</li><li>如何让token提前失效？</li><li>对接支付宝你们是怎么做的？什么是EasySDK？</li><li>微信支付与支付宝支付的接口有什么区别？微信支付你们用的是v2还是v3版本？有什么区别？</li><li>来，聊聊分布式锁的原理？自己实现分布式锁的难点在哪里？</li><li>使用Redisson实现分布式锁具体是怎么使用的？聊聊看门狗是个啥，它有什么用？</li></ul></div>',59);function Ys(Js,Qs){const a=o("ExternalLinkIcon");return c(),l("div",null,[V,n("p",null,[s("首先参考"),n("a",z,[s("前端部署文档"),t(a)]),s(" 中的用户端部署步骤进行部署。"),K,s(" 用户端是采用微信小程序开发的，所以需要整合小程序的登录，具体的登录流程如下："),G,Y,J,s(" 更多内容参考微信小程序官方文档："),n("a",Q,[s("点击查看"),t(a)])]),Z,n("p",null,[s("对接支付宝支付是通过支付宝的开放平台对接的，地址："),n("a",X,[s("https://open.alipay.com/"),t(a)]),$,s(" 通过开放平台可以基于支付宝完成各种应用开发："),nn,sn,an,s(" 我们主要关注的是API，地址："),n("a",tn,[s("https://open.alipay.com/api"),t(a)]),pn,en,on,s(" 在支付API中，我们重点关注【当面付】这个API。"),cn,s(" 在当面付中，有两种支付场景，一种是【付款码支付】，另一种是【扫码支付】："),ln,un,kn,rn,dn,s(" 在这两种支付中，我们更关注【扫码支付】，因为在我们项目的业务场景中使用的就是【扫码支付】，业务场景是这样的：用户下单 → 快递员上门取件 → 取件成功 → 快递员出示收款二维码 → 用户拿出手机，打开支付宝APP，扫一扫进行支付"),mn,s(" 更多关于【当面付】内容请参阅"),n("a",vn,[s("开发文档"),t(a)]),s("。")]),bn,n("p",null,[s("对接支付宝，首先需要支付账号，而申请账号是有条件的："),gn,yn,fn,s(" 所以，对于学生而言是比较难申请自己账号的。"),hn,s(" 支付宝为开发者提供了【沙箱环境】，沙箱环境是支付宝开放平台为开发者提供的与生产环境完全隔离的联调测试环境，开发者在沙箱环境中完成的接口调用不会对生产环境中的数据造成任何影响。"),wn,s(" 按照"),n("a",_n,[s("开发文档"),t(a)]),s("配置沙箱环境账号。"),En,s(" 设置完成后的账号信息（开启公钥加密模式）："),qn,Sn,Tn,s(" 沙箱环境对应的APP，自行下载并安装到手机中使用。"),Rn,Pn]),Cn,n("p",null,[s("参考"),n("a",On,[s("扫码支付快速接入"),t(a)]),s("文档。"),jn,s(" 接入流程："),Nn,An,In,s(" 系统交互流程："),Ln,xn]),n("ol",null,[n("li",null,[s("商家系统调用"),n("a",Un,[s(" alipay.trade.precreate"),t(a)]),s("（统一收单线下交易预创建接口），获得该订单的二维码串 qr_code，开发者需要利用二维码生成工具获得最终的订单二维码图片。")]),n("li",null,[s("发起轮询获得支付结果：等待 5 秒后调用 "),n("a",Dn,[s("alipay.trade.query"),t(a)]),s("（统一收单线下交易查询接口），通过支付时传入的商户订单号（out_trade_no）查询支付结果（返回参数 TRADE_STATUS）。 "),n("ol",null,[Hn,n("li",null,[s("在最后一次查询仍然返回等待用户付款的情况下，必须立即调用 "),n("a",Bn,[s("alipay.trade.cancel"),t(a)]),s("（统一收单交易撤销接口）将这笔交易撤销，避免用户继续支付。")])])]),n("li",null,[s("除了主动轮询，当订单支付成功时，商家也可以通过设置异步通知（notify_url）来获得支付宝服务端返回的支付结果，详情可查看 "),n("a",Fn,[s("扫码异步通知"),t(a)]),s("，注意一定要对异步通知验签，确保通知是支付宝发出的。"),Mn,s(" 注意：如商家由于客观原因（如无公网服务器接受支付宝请求等）无法接受异步支付通知，则忽略上图中的步骤 3.4 和 3.4.1。更多注意事项可点击查看 "),n("a",Wn,[s("异常处理"),t(a)]),s("。")])]),Vn,n("p",null,[s("对接支付宝的扫码支付，需要使用到支付宝提供的SDK，SDK有两种，分别是通用版和Easy版，其中Easy版使用起来更加的简单，我们在项目中将采用Easy版进行开发。"),zn,Kn,Gn,s(" 更多信息查看"),n("a",Yn,[s("文档"),t(a)]),s("。"),Jn,s(" 通过maven坐标导入依赖：")]),Qn,n("p",null,[s("拉取【sl-express-pay】工程，地址："),n("a",Zn,[s("http://git.sl-express.com/sl/sl-express-pay.git"),t(a)]),Xn,s(" 编写"),$n,s("支付宝实现类，在此类中，完成与支付宝的对接，进行预下单，获取二维码链接，通过二维码生成工具生成二维码，通过沙箱版支付宝APP进行扫码支付。")]),ns,n("p",null,[s("可以通过交易单号进行查询，需要注意的是只有通过支付宝APP扫码之后才能查询到交易单。"),n("a",ss,[s("点击查看文档"),t(a)]),as,s(" 代码实现如下：")]),ts,n("p",null,[s("用于交易创建后，用户在一定时间内未进行支付，可调用该接口直接将未付款的交易进行关闭。"),n("a",ps,[s("点击查看文档"),t(a)]),es,s(" 代码实现如下：")]),os,n("p",null,[s("当交易发生之后一段时间内，由于买家或者卖家的原因需要退款时，卖家可以通过退款接口将支付款退还给买家，支付宝将在收到退款请求并且验证成功之后，按照退款规则将支付款按原路退到买家帐号上。"),n("a",cs,[s("点击查看文档"),t(a)]),ls,s(" 代码实现：")]),is,n("p",null,[s("商户可使用该接口查询自已通过alipay.trade.refund提交的退款请求是否执行成功。"),n("a",us,[s("点击查看文档"),t(a)]),ks,s(" 代码实现：")]),rs,n("table",null,[ds,n("tbody",null,[n("tr",null,[ms,n("td",null,[n("a",vs,[s("Native下单"),t(a)])]),bs]),n("tr",null,[gs,n("td",null,[n("a",ys,[s("查询订单"),t(a)])]),fs]),n("tr",null,[hs,n("td",null,[n("a",ws,[s("关闭订单"),t(a)])]),_s]),n("tr",null,[Es,n("td",null,[n("a",qs,[s("Native调起支付"),t(a)])]),Ss]),n("tr",null,[Ts,n("td",null,[n("a",Rs,[s("支付结果通知"),t(a)])]),Ps]),n("tr",null,[Cs,n("td",null,[n("a",Os,[s("申请退款"),t(a)])]),js]),n("tr",null,[Ns,n("td",null,[n("a",As,[s("查询单笔退款"),t(a)])]),Is]),n("tr",null,[Ls,n("td",null,[n("a",xs,[s("退款结果通知"),t(a)])]),Us]),n("tr",null,[Ds,n("td",null,[n("a",Hs,[s("申请交易账单"),t(a)])]),Bs]),n("tr",null,[Fs,n("td",null,[n("a",Ms,[s("申请资金账单"),t(a)])]),Ws]),n("tr",null,[Vs,n("td",null,[n("a",zs,[s("下载账单"),t(a)])]),Ks])])]),Gs])}const $s=e(W,[["render",Ys],["__file","day02-网关与支付.html.vue"]]);export{$s as default};
