import{_ as n}from"./plugin-vue_export-helper-c27b6911.js";import{o as s,c as a,e as t}from"./app-5f6064b2.js";const p="/assets/image-20240407192427936-275-66bfe548.png",e="/assets/image-20240407192427951-293-de6eb7c0.png",c="/assets/image-20240407192427951-294-040840d4.png",o="/assets/image-20240407192427951-295-a3815a6e.png",i="/assets/image-20240407192427951-296-41300779.gif",l="/assets/image-20240407192427951-297-082d633e.png",u="/assets/image-20240407192427951-298-ab3ee92b.png",k="/assets/image-20240407192427951-299-8af5558b.gif",r="/assets/image-20240407192427951-300-7b25ae7c.png",d="/assets/image-20240407192427952-301-97166e79.png",v="/assets/image-20240407192427935-268-676f8965.png",m="/assets/image-20240407192427952-303-d1acf651.png",b="/assets/image-20240407192427952-304-db6300c5.png",g="/assets/image-20240407192427952-305-38a7b956.png",f="/assets/image-20240407192427952-306-9cbbee74.png",h="/assets/image-20240407192427952-307-e775a774.png",y="/assets/image-20240407192427952-308-ddf3a66b.png",I="/assets/image-20240407192427952-309-2277244d.png",q="/assets/image-20240407192427952-310-38ee8dc4.png",w="/assets/image-20240407192427952-311-d9bfda26.png",S="/assets/image-20240407192427952-312-79141498.png",C="/assets/image-20240407192427952-313-4daac9c9.png",_="/assets/image-20240407192427952-314-0f767e3b.png",R={},A=t(`<h1 id="协同-入住申请" tabindex="-1"><a class="header-anchor" href="#协同-入住申请" aria-hidden="true">#</a> 协同-入住申请</h1><h2 id="_1-目标" tabindex="-1"><a class="header-anchor" href="#_1-目标" aria-hidden="true">#</a> 1 目标</h2><p>在前两天中，我们已经对入住的整体业务分析完毕了，并且创建了对应的表结构，也开发了其中的部分接口，今天我们会继续开发入住相关的接口。</p><p>今日的目标是：</p><ul><li>独立完成副院长审批的驳回、撤回接口的开发</li><li>独立完成养老顾问-入住配置的接口开发</li><li>独立完成法务-签约办理的接口开发</li><li>独立完成入住管理查询的接口开发</li></ul><h2 id="_2-接口分析" tabindex="-1"><a class="header-anchor" href="#_2-接口分析" aria-hidden="true">#</a> 2 接口分析</h2><p>我们今天会开发6个接口，分别是</p><ul><li>副院长-驳回</li><li>副院长-撤回</li><li>申请人-撤销</li><li>养老顾问-入住配置</li><li>法务-签约办理</li><li>入住管理查询</li></ul><h3 id="_2-1-副院长-驳回" tabindex="-1"><a class="header-anchor" href="#_2-1-副院长-驳回" aria-hidden="true">#</a> 2.1 副院长-驳回</h3><p><strong>接口地址</strong>:<code>/checkIn</code></p><p><strong>请求方式</strong>:<code>PUT</code></p><p><strong>请求参数</strong>:</p><table><thead><tr><th>参数名称</th><th>参数说明</th><th>数据类型</th></tr></thead><tbody><tr><td>id</td><td>入住Id</td><td>long</td></tr><tr><td>message</td><td>驳回消息</td><td>string</td></tr><tr><td>taskId</td><td>任务Id</td><td>string</td></tr></tbody></table><p><strong>响应示例</strong>:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token string-property property">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;msg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;操作成功&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-副院长-撤回" tabindex="-1"><a class="header-anchor" href="#_2-2-副院长-撤回" aria-hidden="true">#</a> 2.2 副院长-撤回</h3><p><strong>接口地址</strong>:<code>/checkIn/revocation</code></p><p><strong>请求方式</strong>:<code>PUT</code></p><p><strong>请求参数</strong>:</p><table><thead><tr><th>参数名称</th><th>参数说明</th><th>数据类型</th></tr></thead><tbody><tr><td>flowStatus</td><td>流程状态</td><td>int</td></tr><tr><td>id</td><td>入住Id</td><td>long</td></tr><tr><td>taskId</td><td>任务Id</td><td>string</td></tr></tbody></table><p><strong>响应示例</strong>:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token string-property property">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;msg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;操作成功&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-申请人-撤销" tabindex="-1"><a class="header-anchor" href="#_2-3-申请人-撤销" aria-hidden="true">#</a> 2.3 申请人-撤销</h3><p><strong>接口地址</strong>:<code>/checkIn/cancel</code></p><p><strong>请求方式</strong>:<code>PUT</code></p><p><strong>请求参数</strong>:</p><table><thead><tr><th>参数名称</th><th>参数说明</th><th>数据类型</th></tr></thead><tbody><tr><td>id</td><td>入住Id</td><td>long</td></tr><tr><td>taskId</td><td>任务ID</td><td>string</td></tr></tbody></table><p><strong>响应示例</strong>:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token string-property property">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;msg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;操作成功&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-养老顾问-入住配置" tabindex="-1"><a class="header-anchor" href="#_2-4-养老顾问-入住配置" aria-hidden="true">#</a> 2.4 养老顾问-入住配置</h3><p><strong>接口地址</strong>:<code>/checkIn</code></p><p><strong>请求方式</strong>:<code>POST</code></p><p><strong>请求示例</strong>:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token string-property property">&quot;bedCost&quot;</span><span class="token operator">:</span> <span class="token number">4500</span><span class="token punctuation">,</span><span class="token comment">//床位费用</span>
  <span class="token string-property property">&quot;bedId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;6&quot;</span><span class="token punctuation">,</span><span class="token comment">//床位Id</span>
  <span class="token string-property property">&quot;bedNumber&quot;</span><span class="token operator">:</span> <span class="token string">&quot;104-2&quot;</span><span class="token punctuation">,</span><span class="token comment">//床位编号</span>
  <span class="token string-property property">&quot;checkInEndTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2024-10-20 00:00:00&quot;</span><span class="token punctuation">,</span><span class="token comment">//入住结束时间</span>
  <span class="token string-property property">&quot;checkInId&quot;</span><span class="token operator">:</span> <span class="token number">182</span><span class="token punctuation">,</span><span class="token comment">//入住id</span>
  <span class="token string-property property">&quot;checkInStartTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-10-20 00:00:00&quot;</span><span class="token punctuation">,</span><span class="token comment">//入住开始时间</span>
  <span class="token string-property property">&quot;code&quot;</span><span class="token operator">:</span> <span class="token string">&quot;104&quot;</span><span class="token punctuation">,</span><span class="token comment">//房间编号</span>
  <span class="token string-property property">&quot;costEndTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-11-20 00:00:00&quot;</span><span class="token comment">//,费用开始时间</span>
  <span class="token string-property property">&quot;costStartTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-10-20 00:00:00&quot;</span><span class="token punctuation">,</span><span class="token comment">//费用结束时间</span>
  <span class="token string-property property">&quot;depositAmount&quot;</span><span class="token operator">:</span> <span class="token string">&quot;3000.00&quot;</span><span class="token punctuation">,</span><span class="token comment">//押金金额</span>
  <span class="token string-property property">&quot;elderId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;143&quot;</span><span class="token punctuation">,</span><span class="token comment">//老人id</span>
  <span class="token string-property property">&quot;floorId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span><span class="token comment">//楼层id</span>
  <span class="token string-property property">&quot;floorName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1楼&quot;</span><span class="token punctuation">,</span><span class="token comment">//楼层名称</span>
  <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;nursingCost&quot;</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span><span class="token comment">//护理费用</span>
  <span class="token string-property property">&quot;nursingLevelId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">,</span><span class="token comment">//护理等级Id</span>
  <span class="token string-property property">&quot;roomId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">,</span><span class="token comment">//房间id</span>
  <span class="token string-property property">&quot;taskId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;a1ceddf0-6f5b-11ee-bda6-5405db5be13e&quot;</span><span class="token comment">//任务id</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>响应示例</strong>:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span><span class="token string-property property">&quot;code&quot;</span><span class="token operator">:</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token string-property property">&quot;msg&quot;</span><span class="token operator">:</span><span class="token string">&quot;操作成功&quot;</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_2-5-法务-签约办理" tabindex="-1"><a class="header-anchor" href="#_2-5-法务-签约办理" aria-hidden="true">#</a> 2.5 法务-签约办理</h3><p><strong>接口地址</strong>:<code>/checkIn/sign</code></p><p><strong>请求方式</strong>:<code>POST</code></p><p><strong>请求示例</strong>:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token string-property property">&quot;checkInId&quot;</span><span class="token operator">:</span> <span class="token number">182</span><span class="token punctuation">,</span><span class="token comment">//入住id</span>
  <span class="token string-property property">&quot;contractNo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HT202310202317241&quot;</span><span class="token punctuation">,</span><span class="token comment">//合同编号</span>
  <span class="token string-property property">&quot;endTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2024-10-20 00:00:00&quot;</span><span class="token punctuation">,</span><span class="token comment">//入住结束时间</span>
  <span class="token string-property property">&quot;memberName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;仁爱&quot;</span><span class="token punctuation">,</span><span class="token comment">//签约人（家属）</span>
  <span class="token string-property property">&quot;memberPhone&quot;</span><span class="token operator">:</span> <span class="token string">&quot;13211222333&quot;</span><span class="token punctuation">,</span><span class="token comment">//家属手机号</span>
  <span class="token string-property property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;仁和的入住合同&quot;</span><span class="token punctuation">,</span><span class="token comment">//合同名称</span>
  <span class="token string-property property">&quot;pdfUrl&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://itheim.oss-cn-beijing.aliyuncs.com/70c3a212-7b61-4476-9d13-c47a09babb2d.pdf&quot;</span><span class="token punctuation">,</span><span class="token comment">//合同链接</span>
  <span class="token string-property property">&quot;signDate&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-10-20 00:00:00&quot;</span><span class="token punctuation">,</span><span class="token comment">//签约时间</span>
  <span class="token string-property property">&quot;startTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-10-20 00:00:00&quot;</span><span class="token punctuation">,</span><span class="token comment">//入住开始时间</span>
  <span class="token string-property property">&quot;taskId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;c57f5f43-6f5b-11ee-bda6-5405db5be13e&quot;</span><span class="token comment">//任务id</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>响应示例</strong>:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span><span class="token string-property property">&quot;code&quot;</span><span class="token operator">:</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token string-property property">&quot;msg&quot;</span><span class="token operator">:</span><span class="token string">&quot;操作成功&quot;</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_2-6-入住管理查询" tabindex="-1"><a class="header-anchor" href="#_2-6-入住管理查询" aria-hidden="true">#</a> 2.6 入住管理查询</h3><p><strong>接口地址</strong>:<code>/checkIn/selectByPage</code></p><p><strong>请求方式</strong>:<code>GET</code></p><p><strong>请求参数</strong>:</p><table><thead><tr><th>参数名称</th><th>参数说明</th><th>数据类型</th></tr></thead><tbody><tr><td>checkInCode</td><td>入住编码</td><td>string</td></tr><tr><td>endTime</td><td>结束时间</td><td>long</td></tr><tr><td>idCardNo</td><td>身份证号</td><td>string</td></tr><tr><td>name</td><td>姓名</td><td>string</td></tr><tr><td>pageNum</td><td>页码</td><td>int</td></tr><tr><td>pageSize</td><td>每页数量</td><td>int</td></tr><tr><td>startTime</td><td>开始时间</td><td>long</td></tr></tbody></table><p><strong>响应示例</strong>:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token string-property property">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;msg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;操作成功&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;total&quot;</span><span class="token operator">:</span> <span class="token string">&quot;9&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;pageSize&quot;</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;pages&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;page&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;records&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;182&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;createTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-10-20 23:15:20&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;remark&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HT202310202317241&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;checkInCode&quot;</span><span class="token operator">:</span> <span class="token string">&quot;RZ202310202315191&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;仁和的入住申请&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;elderDto&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;182&quot;</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;仁和&quot;</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;idCardNo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;132123196612091234&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;elderId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;143&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;counselor&quot;</span><span class="token operator">:</span> <span class="token string">&quot;养老顾问&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;checkInTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-10-20 00:00:00&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;applicat&quot;</span><span class="token operator">:</span> <span class="token string">&quot;养老顾问&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;deptNo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;100001006000000&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;applicatId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1671403256519078161&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;flowStatus&quot;</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;bedVo&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;182&quot;</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;bedNumber&quot;</span><span class="token operator">:</span> <span class="token string">&quot;104-2&quot;</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-接口功能开发" tabindex="-1"><a class="header-anchor" href="#_3-接口功能开发" aria-hidden="true">#</a> 3 接口功能开发</h2><h3 id="_3-1-副院长-驳回" tabindex="-1"><a class="header-anchor" href="#_3-1-副院长-驳回" aria-hidden="true">#</a> 3.1 副院长-驳回</h3><h4 id="_3-1-1-思路分析" tabindex="-1"><a class="header-anchor" href="#_3-1-1-思路分析" aria-hidden="true">#</a> 3.1.1 思路分析</h4><p>工作流程</p><figure><img src="`+p+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>实现流程</p><figure><img src="'+e+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="_3-1-2-接口定义" tabindex="-1"><a class="header-anchor" href="#_3-1-2-接口定义" aria-hidden="true">#</a> 3.1.2 接口定义</h4><p>在CheckInController中新增方法，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PutMapping</span>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;驳回&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseResult</span> <span class="token function">disapprove</span><span class="token punctuation">(</span>
        <span class="token annotation punctuation">@RequestParam</span> <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;入住Id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span> <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;驳回消息&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> message<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span> <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;任务Id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> taskId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-1-3-业务层开发" tabindex="-1"><a class="header-anchor" href="#_3-1-3-业务层开发" aria-hidden="true">#</a> 3.1.3 业务层开发</h4><p>在CheckInService中新增方法，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 驳回
 * <span class="token keyword">@param</span> <span class="token parameter">id</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token class-name">ResponseResult</span> <span class="token function">disapprove</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">,</span> <span class="token class-name">String</span> taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实现方法：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
     * 驳回
     * <span class="token keyword">@param</span> <span class="token parameter">id</span>
     * <span class="token keyword">@param</span> <span class="token parameter">message</span>
     * <span class="token keyword">@param</span> <span class="token parameter">taskId</span>
     * <span class="token keyword">@return</span>
     */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseResult</span> <span class="token function">disapprove</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">,</span> <span class="token class-name">String</span> taskId<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 流程状态 操作记录</span>
    <span class="token class-name">CheckIn</span> checkIn <span class="token operator">=</span> checkInMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置流程状态</span>
    checkIn<span class="token punctuation">.</span><span class="token function">setFlowStatus</span><span class="token punctuation">(</span><span class="token class-name">CheckIn<span class="token punctuation">.</span>FlowStatus</span><span class="token punctuation">.</span><span class="token constant">APPLY</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//清除健康评估数据</span>
    checkIn<span class="token punctuation">.</span><span class="token function">setReviewInfo</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkInMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKeySelective</span><span class="token punctuation">(</span>checkIn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//清理老人数据</span>
    <span class="token function">close</span><span class="token punctuation">(</span>checkIn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//  操作记录</span>
    <span class="token comment">//从当前线程中获取用户数据</span>
    <span class="token class-name">String</span> subject <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//完成任务</span>
    actFlowCommService<span class="token punctuation">.</span><span class="token function">completeProcess</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> taskId<span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//保存审核记录</span>
    <span class="token class-name">RecordVo</span> recoreVo <span class="token operator">=</span> <span class="token function">getRecordVo</span><span class="token punctuation">(</span>checkIn<span class="token punctuation">,</span>
                                    user<span class="token punctuation">,</span>
                                    <span class="token class-name">AccraditationRecordConstant</span><span class="token punctuation">.</span><span class="token constant">AUDIT_STATUS_DISAPPROVE</span><span class="token punctuation">,</span>
                                    message<span class="token punctuation">,</span> <span class="token string">&quot;驳回申请-入住审批&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;养老顾问处理-入住申请&quot;</span><span class="token punctuation">,</span>
                                    checkIn<span class="token punctuation">.</span><span class="token function">getApplicatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    <span class="token class-name">AccraditationRecordConstant</span><span class="token punctuation">.</span><span class="token constant">RECORD_HANDLE_TYPE_PROCESSED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    accraditationRecordService<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>recoreVo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token class-name">ResponseResult</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里的完成任务以后，回到了首页点，需要删除之前遗留的历史记录，所以在完成任务的代码中需要添加删除的逻辑</p><p>修改completeProcess方法，在任务之心之前添加如下代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//任务对象  获取流程实例Id</span>
<span class="token class-name">String</span> processInstanceId <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">getProcessInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Authentication</span><span class="token punctuation">.</span><span class="token function">setAuthenticatedUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//如果是驳回，则需要删除流程实例的任务记录</span>
<span class="token class-name">HistoricTaskInstanceQuery</span> historicTaskInstanceQuery <span class="token operator">=</span> historyService<span class="token punctuation">.</span><span class="token function">createHistoricTaskInstanceQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">processInstanceId</span><span class="token punctuation">(</span>processInstanceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HistoricTaskInstance</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> historicTaskInstanceQuery<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>v <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//删除当前任务之后的任务记录，不然可能会存在多条数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getFormKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getFormKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            historyService<span class="token punctuation">.</span><span class="token function">deleteHistoricTaskInstance</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//如果状态为驳回，则删除第一个节点的任务记录，因为完成任务后，会重新分配一个任务</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>code<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getFormKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            historyService<span class="token punctuation">.</span><span class="token function">deleteHistoricTaskInstance</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-1-4-申请入住修正-添加修改逻辑" tabindex="-1"><a class="header-anchor" href="#_3-1-4-申请入住修正-添加修改逻辑" aria-hidden="true">#</a> 3.1.4 申请入住修正，添加修改逻辑</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 入住申请
 *
 * <span class="token keyword">@param</span> <span class="token parameter">checkInDto</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseResult</span> <span class="token function">createCheckIn</span><span class="token punctuation">(</span><span class="token class-name">CheckInDto</span> checkInDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//1.检验老人是否是入住中</span>
    <span class="token class-name">ElderVo</span> elderVo <span class="token operator">=</span> elderService<span class="token punctuation">.</span><span class="token function">selectByIdCardAndName</span><span class="token punctuation">(</span>checkInDto<span class="token punctuation">.</span><span class="token function">getElderDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIdCardNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> checkInDto<span class="token punctuation">.</span><span class="token function">getElderDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> elderVo <span class="token operator">&amp;&amp;</span> elderVo<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>checkInDto<span class="token punctuation">.</span><span class="token function">getElderDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;已经发起了入住申请&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//2.保存老人数据</span>
    <span class="token class-name">ElderDto</span> elderDto <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>checkInDto<span class="token punctuation">.</span><span class="token function">getElderDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ElderDto</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//年龄、性别、头像</span>
    elderDto<span class="token punctuation">.</span><span class="token function">setImage</span><span class="token punctuation">(</span>checkInDto<span class="token punctuation">.</span><span class="token function">getUrl1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* JSONObject jsonObject = BeanUtil.toBean(checkInDto.getOtherApplyInfo(), JSONObject.class);*/</span>
    <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>checkInDto<span class="token punctuation">.</span><span class="token function">getOtherApplyInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    elderDto<span class="token punctuation">.</span><span class="token function">setSex</span><span class="token punctuation">(</span>jsonObject<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span><span class="token string">&quot;sex&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    elderDto<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span>jsonObject<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//保存老人数据</span>
    <span class="token class-name">Elder</span> elder <span class="token operator">=</span> elderService<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>elderDto<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> subject <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">CheckIn</span> checkIn <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">//如果入住id不为空，则需要修改，否则是保存</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>checkInDto<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//修改</span>
        checkIn <span class="token operator">=</span> checkInMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>checkInDto<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//其他信息</span>
        checkInDto<span class="token punctuation">.</span><span class="token function">setElderDto</span><span class="token punctuation">(</span>elderDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
        checkIn<span class="token punctuation">.</span><span class="token function">setOtherApplyInfo</span><span class="token punctuation">(</span><span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>checkInDto<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//标题</span>
        checkIn<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>elder<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;的入住申请&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        checkIn<span class="token punctuation">.</span><span class="token function">setElderId</span><span class="token punctuation">(</span>elder<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//状态</span>
        checkIn<span class="token punctuation">.</span><span class="token function">setFlowStatus</span><span class="token punctuation">(</span><span class="token class-name">CheckIn<span class="token punctuation">.</span>FlowStatus</span><span class="token punctuation">.</span><span class="token constant">REVIEW</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        checkInMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKeySelective</span><span class="token punctuation">(</span>checkIn<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//保存</span>
        checkIn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CheckIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//编号</span>
        <span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token class-name">CodeUtil</span><span class="token punctuation">.</span><span class="token function">generateCode</span><span class="token punctuation">(</span><span class="token constant">CHECK_IN_CODE_PREFIX</span><span class="token punctuation">,</span> redisTemplate<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        checkIn<span class="token punctuation">.</span><span class="token function">setCheckInCode</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//标题</span>
        checkIn<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>elder<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;的入住申请&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        checkIn<span class="token punctuation">.</span><span class="token function">setElderId</span><span class="token punctuation">(</span>elder<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取当前登录人的信息</span>
        checkIn<span class="token punctuation">.</span><span class="token function">setCounselor</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getRealName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        checkIn<span class="token punctuation">.</span><span class="token function">setApplicat</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getRealName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        checkIn<span class="token punctuation">.</span><span class="token function">setApplicatId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        checkIn<span class="token punctuation">.</span><span class="token function">setDeptNo</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getDeptNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//状态</span>
        checkIn<span class="token punctuation">.</span><span class="token function">setFlowStatus</span><span class="token punctuation">(</span><span class="token class-name">CheckIn<span class="token punctuation">.</span>FlowStatus</span><span class="token punctuation">.</span><span class="token constant">REVIEW</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        checkIn<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">CheckIn<span class="token punctuation">.</span>Status</span><span class="token punctuation">.</span><span class="token constant">APPLICATION</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//其他信息</span>
        checkInDto<span class="token punctuation">.</span><span class="token function">setElderDto</span><span class="token punctuation">(</span>elderDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
        checkIn<span class="token punctuation">.</span><span class="token function">setOtherApplyInfo</span><span class="token punctuation">(</span><span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>checkInDto<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        checkInMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>checkIn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>



    <span class="token comment">//5.启动流程实例 或者 完成流程</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>checkInDto<span class="token punctuation">.</span><span class="token function">getTaskId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//完成任务</span>
        actFlowCommService<span class="token punctuation">.</span><span class="token function">completeProcess</span><span class="token punctuation">(</span>checkIn<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>checkInDto<span class="token punctuation">.</span><span class="token function">getTaskId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>checkIn<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//4.准备流程变量的参数 map</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> variables <span class="token operator">=</span> <span class="token function">setVariables</span><span class="token punctuation">(</span>checkIn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 业务相关，登录用户相关、processDefinitionKey(checkIn-new)、首节点是否自动执行</span>
        actFlowCommService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>checkIn<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">,</span> <span class="token string">&quot;checkIn-new&quot;</span><span class="token punctuation">,</span> variables<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">//获取下一个审核人</span>
    <span class="token class-name">Long</span> nextAssignee <span class="token operator">=</span> actFlowCommService<span class="token punctuation">.</span><span class="token function">getNextAssignee</span><span class="token punctuation">(</span><span class="token string">&quot;checkIn-new&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;checkIn-new:&quot;</span> <span class="token operator">+</span> checkIn<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//6.保存操作记录</span>
    <span class="token class-name">RecordVo</span> recordVo <span class="token operator">=</span> <span class="token function">getRecordVo</span><span class="token punctuation">(</span>
            checkIn<span class="token punctuation">,</span> user<span class="token punctuation">,</span> <span class="token class-name">AccraditationRecordConstant</span><span class="token punctuation">.</span><span class="token constant">AUDIT_STATUS_PASS</span><span class="token punctuation">,</span>
            <span class="token string">&quot;同意&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;发起申请-申请入住&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;护理组组长处理-入住评估&quot;</span><span class="token punctuation">,</span>
            nextAssignee
            <span class="token punctuation">,</span> <span class="token class-name">AccraditationRecordConstant</span><span class="token punctuation">.</span><span class="token constant">RECORD_HANDLE_TYPE_PROCESSED</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    accraditationRecordService<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>recordVo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token class-name">ResponseResult</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-1-5-控制层开发" tabindex="-1"><a class="header-anchor" href="#_3-1-5-控制层开发" aria-hidden="true">#</a> 3.1.5 控制层开发</h4><p>在控制层中补全代码，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PutMapping</span>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;驳回&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseResult</span> <span class="token function">disapprove</span><span class="token punctuation">(</span>
        <span class="token annotation punctuation">@RequestParam</span> <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;入住Id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span> <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;驳回消息&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> message<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span> <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;任务Id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> taskId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> checkInService<span class="token punctuation">.</span><span class="token function">disapprove</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> message<span class="token punctuation">,</span> taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-1-6-测试" tabindex="-1"><a class="header-anchor" href="#_3-1-6-测试" aria-hidden="true">#</a> 3.1.6 测试</h4><p>使用申请人（养老顾问）账号登录，查看我的申请，可以看到单子已经回到第一步，重新开始</p><h3 id="_3-2-副院长-撤回" tabindex="-1"><a class="header-anchor" href="#_3-2-副院长-撤回" aria-hidden="true">#</a> 3.2 副院长-撤回</h3><h4 id="_3-2-1-思路分析" tabindex="-1"><a class="header-anchor" href="#_3-2-1-思路分析" aria-hidden="true">#</a> 3.2.1 思路分析</h4><p>我们先来搞明白什么是撤回？</p><p>我们现在有这么一个流程，如下图：</p><figure><img src="`+c+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>在这个图中，申请人填写申请单，不是审批操作不能撤回</li><li>经理审批属于审批操作，可以撤回，撤回的条件是：<strong>第二步审核完成，第三步还没有开始审核</strong></li><li>总经理审批完成后会自动完成流程，也不能撤回</li></ul><p>那现在我们分析入住的流程图：</p><figure><img src="'+o+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>在当前的流程图中，只有<strong>副院长审批-处理</strong>是审批操作，也只能这一步有撤回的操作。从上面流程图中，我们可以看出，并不能使用流程变量或网关来实现撤回的操作，那该怎么实现呢？</p><p>我们都知道，流程图的执行，都是基于bpmn文件来按照流程执行的，bpmn文件其实就是一个xml文件。所以我们的实现思路是，在启动的流程实例中，<strong>动态的去改变连线的指向</strong>来实现撤回，如下图：</p><figure><img src="'+i+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>首先找到当前待执行的节点（入住选配-处理），再找到要撤回到的节点（副院长审批-处理）</li><li>把<strong>入住评估-处理</strong>和<strong>副院长审批-处理</strong>的<strong>连线</strong>的入口节点设置为<strong>入住选配-处理</strong></li><li>完成当前节点任务（入住选配-处理）</li><li>恢复之前的两个连线（连线重新指向后会替换之前的指向）</li></ul><h4 id="_3-2-2-撤回按钮的显示" tabindex="-1"><a class="header-anchor" href="#_3-2-2-撤回按钮的显示" aria-hidden="true">#</a> 3.2.2 撤回按钮的显示</h4><p>目前只有副院长审核之后，养老顾问审核之前，才会显示撤回按钮，我们需要在之前定义的<strong>查询入住信息</strong>的业务层代码中添加如下代码：</p><p>修改ActFlowCommServiceImpl中的isCurrentUserAndStep方法，添加返回2的逻辑</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">isCurrentUserAndStep</span><span class="token punctuation">(</span><span class="token class-name">String</span> taskId<span class="token punctuation">,</span><span class="token class-name">Integer</span> flowStatus<span class="token punctuation">,</span> <span class="token class-name">Integer</span> dbFlowStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">HistoricTaskInstance</span> historicTaskInstance <span class="token operator">=</span> historyService<span class="token punctuation">.</span><span class="token function">createHistoricTaskInstanceQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">taskId</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> formKey <span class="token operator">=</span> historicTaskInstance<span class="token punctuation">.</span><span class="token function">getFormKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//前端传递的流程状态与数据库中一致，有两种情况，是不是当前人的任务，如果是，则返回1，不是返回0</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flowStatus<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>dbFlowStatus<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>formKey<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>dbFlowStatus<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>formKey<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dbFlowStatus <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改CheckInServiceImpl中的getCheckIn方法，添加如下代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//是否显示撤回按钮</span>
<span class="token keyword">boolean</span> isRevocation <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>isShow <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> checkIn<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">CheckIn<span class="token punctuation">.</span>Status</span><span class="token punctuation">.</span><span class="token constant">APPLICATION</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    isRevocation <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>isShow <span class="token operator">==</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
    isShow <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

tasVo<span class="token punctuation">.</span><span class="token function">setIsShow</span><span class="token punctuation">(</span>isShow<span class="token punctuation">)</span><span class="token punctuation">;</span>
tasVo<span class="token punctuation">.</span><span class="token function">setIsRevocation</span><span class="token punctuation">(</span>isRevocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>目前已经跟前端开发沟通完毕，是否显示撤回按钮的标识就是TasVo中的属性isRevocation</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 是否显示撤回
 */</span>
<span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;是否显示撤回&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">Boolean</span> isRevocation<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>展示效果：</p><figure><img src="`+l+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="_3-2-3-接口定义" tabindex="-1"><a class="header-anchor" href="#_3-2-3-接口定义" aria-hidden="true">#</a> 3.2.3 接口定义</h4><p>在CheckInController中新增方法，</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/revocation&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;撤回&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseResult</span> <span class="token function">revocation</span><span class="token punctuation">(</span>
        <span class="token annotation punctuation">@RequestParam</span> <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;入住Id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span> <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;流程状态&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> flowStatus<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span> <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;任务Id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> taskId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-2-4-业务层开发" tabindex="-1"><a class="header-anchor" href="#_3-2-4-业务层开发" aria-hidden="true">#</a> 3.2.4 业务层开发</h4><p>在CheckInService中新增方法，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 撤回
 * <span class="token keyword">@param</span> <span class="token parameter">id</span>
 * <span class="token keyword">@param</span> <span class="token parameter">flowStatus</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token class-name">ResponseResult</span> <span class="token function">revocation</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token class-name">Integer</span> flowStatus<span class="token punctuation">,</span> <span class="token class-name">String</span> taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实现方法：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
     * 撤回
     * <span class="token keyword">@param</span> <span class="token parameter">id</span>
     * <span class="token keyword">@param</span> <span class="token parameter">flowStatus</span>
     * <span class="token keyword">@param</span> <span class="token parameter">taskId</span>
     * <span class="token keyword">@return</span>
     */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseResult</span> <span class="token function">revocation</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">,</span> <span class="token keyword">int</span> flowStatus<span class="token punctuation">,</span> <span class="token class-name">String</span> taskId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//查询流程</span>
    <span class="token class-name">CheckIn</span> checkIn <span class="token operator">=</span> checkInMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkIn<span class="token punctuation">.</span><span class="token function">setFlowStatus</span><span class="token punctuation">(</span>checkIn<span class="token punctuation">.</span><span class="token function">getFlowStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkInMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKeySelective</span><span class="token punctuation">(</span>checkIn<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//  操作记录</span>
    <span class="token comment">//从当前线程中获取用户数据</span>
    <span class="token class-name">String</span> subject <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//获取枚举中的数据</span>
    <span class="token comment">//第一个参数是条件，第二个参数为匹配到的值</span>
    <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token class-name">EnumUtil</span><span class="token punctuation">.</span><span class="token function">getBy</span><span class="token punctuation">(</span><span class="token class-name">CheckIn<span class="token punctuation">.</span>FlowStatus</span><span class="token operator">::</span><span class="token function">getCode</span><span class="token punctuation">,</span> checkIn<span class="token punctuation">.</span><span class="token function">getFlowStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">RecordVo</span> recoreVo <span class="token operator">=</span> <span class="token function">getRecordVo</span><span class="token punctuation">(</span>checkIn<span class="token punctuation">,</span>
                                    user<span class="token punctuation">,</span>
                                    <span class="token class-name">AccraditationRecordConstant</span><span class="token punctuation">.</span><span class="token constant">AUDIT_STATUS_WITHDRAWS</span><span class="token punctuation">,</span>
                                    <span class="token string">&quot;撤回&quot;</span><span class="token punctuation">,</span>
                                    <span class="token string">&quot;撤回申请-&quot;</span> <span class="token operator">+</span> name<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
                                    user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    <span class="token class-name">AccraditationRecordConstant</span><span class="token punctuation">.</span><span class="token constant">RECORD_HANDLE_TYPE_PROCESSED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    accraditationRecordService<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>recoreVo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//撤回</span>
    actFlowCommService<span class="token punctuation">.</span><span class="token function">withdrawTask</span><span class="token punctuation">(</span>taskId<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">return</span> <span class="token class-name">ResponseResult</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>actFlowCommService中的方法withdrawTask，我们直接从讲义中<strong>拷贝</strong>过来即可，<strong>无需大家编写</strong>，因为里面都是对节点的连线的操作，原理就是对bpmn文件xml的操作</p><p>新增撤回方法</p><p>在ActFlowCommService新增一个方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 撤回任务
 *
 * <span class="token keyword">@param</span> <span class="token parameter">taskId</span>
 * <span class="token keyword">@param</span> <span class="token parameter">first</span>  是否默认退回流程第一个节点，true 是,false默认是上一个节点，
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">withdrawTask</span><span class="token punctuation">(</span><span class="token class-name">String</span> taskId<span class="token punctuation">,</span> <span class="token keyword">boolean</span> first<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实现方法，注意导包的时候，全部选择与activti有关联的包进行导入</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 撤回任务
 *
 * <span class="token keyword">@param</span> <span class="token parameter">taskId</span>
 * <span class="token keyword">@param</span> <span class="token parameter">first</span>  是否默认退回流程第一个节点，true 是,false默认是上一个节点，
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">withdrawTask</span><span class="token punctuation">(</span><span class="token class-name">String</span> taskId<span class="token punctuation">,</span> <span class="token keyword">boolean</span> first<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">anyJump</span><span class="token punctuation">(</span>taskId<span class="token punctuation">,</span> first<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 跳转任意节点
 *
 * <span class="token keyword">@param</span> <span class="token parameter">taskId</span> 当前操作节点
 * <span class="token keyword">@param</span> <span class="token parameter">first</span>  是否默认第一 是否驳回
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">anyJump</span><span class="token punctuation">(</span><span class="token class-name">String</span> taskId<span class="token punctuation">,</span> <span class="token keyword">boolean</span> first<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">HistoricTaskInstance</span> historicTaskInstance <span class="token operator">=</span> historyService<span class="token punctuation">.</span><span class="token function">createHistoricTaskInstanceQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">taskId</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//实例定义id：checkIn:1:0f97a26d-5697-11ee-bf3f-5405db5be13e</span>
    <span class="token class-name">String</span> processDefinitionId <span class="token operator">=</span> historicTaskInstance<span class="token punctuation">.</span><span class="token function">getProcessDefinitionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//实例id：16ea626d-5755-11ee-849a-5405db5be13e</span>
    <span class="token class-name">String</span> processInstanceId <span class="token operator">=</span> historicTaskInstance<span class="token punctuation">.</span><span class="token function">getProcessInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 对上一个节点和发起节点的支持:Activity_0pnd103</span>
    <span class="token class-name">String</span> activityId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">//找到需要驳回的节点中，比如：现在是：养老顾问-入住配置，那么要找的就是上一个节点：副院长-审批</span>
    <span class="token class-name">HistoricActivityInstance</span> targetActivity <span class="token operator">=</span> <span class="token function">getRejectTargetActivity</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> processInstanceId<span class="token punctuation">,</span> first<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>targetActivity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        activityId <span class="token operator">=</span> targetActivity<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>activityId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取流程中的bpmn文件</span>
        <span class="token class-name">BpmnModel</span> bpmnModel <span class="token operator">=</span> repositoryService<span class="token punctuation">.</span><span class="token function">getBpmnModel</span><span class="token punctuation">(</span>processDefinitionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//流程实例</span>
        <span class="token class-name">Process</span> process <span class="token operator">=</span> bpmnModel<span class="token punctuation">.</span><span class="token function">getMainProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 解析调整的目标节点</span>
        <span class="token comment">//找到目标节点  --&gt;  副院长-审批</span>
        <span class="token class-name">FlowNode</span> targetFlowNode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FlowNode</span><span class="token punctuation">)</span> process<span class="token punctuation">.</span><span class="token function">getFlowElement</span><span class="token punctuation">(</span>activityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//找到当前节点的所有连线</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SequenceFlow</span><span class="token punctuation">&gt;</span></span> incomingFlows <span class="token operator">=</span> targetFlowNode<span class="token punctuation">.</span><span class="token function">getIncomingFlows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SequenceFlow</span><span class="token punctuation">&gt;</span></span> targetSequenceFlow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//遍历所有连线</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SequenceFlow</span> incomingFlow <span class="token operator">:</span> incomingFlows<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//连线的入节点</span>
            <span class="token class-name">FlowNode</span> source <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FlowNode</span><span class="token punctuation">)</span> incomingFlow<span class="token punctuation">.</span><span class="token function">getSourceFlowElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SequenceFlow</span><span class="token punctuation">&gt;</span></span> sequenceFlows<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>source <span class="token keyword">instanceof</span> <span class="token class-name">ParallelGateway</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 如果是并行网关同级节点，则跳转到所有节点</span>
                sequenceFlows <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">getOutgoingFlows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                sequenceFlows <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">getOutgoingFlows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 否则直接跳转到对应节点，包括为执行过的节点</span>
            <span class="token punctuation">}</span>
            targetSequenceFlow<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>sequenceFlows<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//获取当前任务中的所有待执行的任务</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> taskService<span class="token punctuation">.</span><span class="token function">createTaskQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">processInstanceId</span><span class="token punctuation">(</span>processInstanceId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Task</span> t <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//把一个任务动态转向目标节点</span>
            <span class="token comment">//参数1：目标节点   参数2：当前任务   参数3：当前任务id    参数4:目标节点所有连线   参数5：默认flase，找上一个节点</span>
            <span class="token function">trunToTarget</span><span class="token punctuation">(</span>process<span class="token punctuation">,</span> t<span class="token punctuation">,</span> first <span class="token operator">?</span> taskId <span class="token operator">:</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> targetSequenceFlow<span class="token punctuation">,</span> first<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>first<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 撤回 删除最后的节点</span>
            historyService<span class="token punctuation">.</span><span class="token function">deleteHistoricTaskInstance</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            hiActinstMapper<span class="token punctuation">.</span><span class="token function">deleteHiActivityInstByTaskId</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 撤回 删除第一个</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HistoricTaskInstance</span><span class="token punctuation">&gt;</span></span> list1 <span class="token operator">=</span> historyService<span class="token punctuation">.</span><span class="token function">createHistoricTaskInstanceQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">processInstanceId</span><span class="token punctuation">(</span>processInstanceId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orderByTaskCreateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>list1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">HistoricTaskInstance</span> firstTask <span class="token operator">=</span> list1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                historyService<span class="token punctuation">.</span><span class="token function">deleteHistoricTaskInstance</span><span class="token punctuation">(</span>firstTask<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 把一个任务动态转向目标节点
 * <span class="token keyword">@param</span> <span class="token parameter">process</span>   目标节点
 * <span class="token keyword">@param</span> <span class="token parameter">task</span>  当前任务
 * <span class="token keyword">@param</span> <span class="token parameter">taskId</span>             当前任务id
 * <span class="token keyword">@param</span> <span class="token parameter">targetSequenceFlow</span>  目标节点所有连线
 * <span class="token keyword">@param</span> <span class="token parameter">first</span>  默认flase，找上一个节点
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">trunToTarget</span><span class="token punctuation">(</span><span class="token class-name">Process</span> process<span class="token punctuation">,</span> <span class="token class-name">TaskInfo</span> task<span class="token punctuation">,</span> <span class="token class-name">String</span>
        taskId<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SequenceFlow</span><span class="token punctuation">&gt;</span></span> targetSequenceFlow<span class="token punctuation">,</span> <span class="token keyword">boolean</span> first<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//当前节点:入住选配-处理</span>
    <span class="token class-name">FlowNode</span> curFlowNode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FlowNode</span><span class="token punctuation">)</span> process<span class="token punctuation">.</span><span class="token function">getFlowElement</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getTaskDefinitionKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>curFlowNode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//遍历节点中的所有子模块</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">FlowElement</span> flowElement <span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token function">getFlowElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>flowElement <span class="token keyword">instanceof</span> <span class="token class-name">SubProcess</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">SubProcess</span> subProcess <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SubProcess</span><span class="token punctuation">)</span> flowElement<span class="token punctuation">;</span>
                <span class="token class-name">FlowElement</span> fe <span class="token operator">=</span> subProcess<span class="token punctuation">.</span><span class="token function">getFlowElement</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getTaskDefinitionKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>fe <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    curFlowNode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FlowNode</span><span class="token punctuation">)</span> fe<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//备份原始连线</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SequenceFlow</span><span class="token punctuation">&gt;</span></span> tempOutgoingSequenceFlows <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>curFlowNode<span class="token punctuation">.</span><span class="token function">getOutgoingFlows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//最新任务id与要删除的id一致</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>taskId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//当前节点设置流出的连线</span>
        curFlowNode<span class="token punctuation">.</span><span class="token function">setOutgoingFlows</span><span class="token punctuation">(</span>targetSequenceFlow<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//完成当前任务</span>
        taskService<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>first<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//删除任务实例</span>
            historyService<span class="token punctuation">.</span><span class="token function">deleteHistoricTaskInstance</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//删除历史任务</span>
            hiActinstMapper<span class="token punctuation">.</span><span class="token function">deleteHiActivityInstByTaskId</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//恢复之前的连线</span>
    curFlowNode<span class="token punctuation">.</span><span class="token function">setOutgoingFlows</span><span class="token punctuation">(</span>tempOutgoingSequenceFlows<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 获取历史撤回或回退目标节点,支持上一节点，第一个节点
 *
 * <span class="token keyword">@param</span> <span class="token parameter">taskId</span>            要回退的taskId
 * <span class="token keyword">@param</span> <span class="token parameter">processInstanceId</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token keyword">private</span> <span class="token class-name">HistoricActivityInstance</span> <span class="token function">getRejectTargetActivity</span><span class="token punctuation">(</span><span class="token class-name">String</span> taskId<span class="token punctuation">,</span> <span class="token class-name">String</span> processInstanceId<span class="token punctuation">,</span> <span class="token keyword">boolean</span> first<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">HistoricActivityInstance</span> targetActivity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">HistoricActivityInstanceQuery</span> query <span class="token operator">=</span> historyService<span class="token punctuation">.</span><span class="token function">createHistoricActivityInstanceQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">processInstanceId</span><span class="token punctuation">(</span>processInstanceId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">activityType</span><span class="token punctuation">(</span><span class="token string">&quot;userTask&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 取得所有历史任务按时间降序排序</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HistoricActivityInstance</span><span class="token punctuation">&gt;</span></span> historicActivityInstances <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>first<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 退到第一个节点</span>
        historicActivityInstances <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">orderByHistoricActivityInstanceStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> historicActivityInstances<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 找到最近一个节点</span>
        historicActivityInstances <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">orderByHistoricActivityInstanceStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>historicActivityInstances<span class="token punctuation">)</span> <span class="token operator">||</span> historicActivityInstances<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> targetActivity<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 不传活动id的情况直接找第一个任务</span>
    <span class="token comment">// 最后一条是当前正在进行的任务 需要找到最近的但是名称和当前任务不一样的任务去撤回</span>
    <span class="token class-name">HistoricActivityInstance</span> current <span class="token operator">=</span> historicActivityInstances<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">HistoricActivityInstance</span> historicActivityInstance <span class="token operator">:</span> historicActivityInstances<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>current<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>historicActivityInstance<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>historicActivityInstance<span class="token punctuation">.</span><span class="token function">getActivityType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;userTask&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                targetActivity <span class="token operator">=</span> historicActivityInstance<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> targetActivity<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-2-5-控制层开发" tabindex="-1"><a class="header-anchor" href="#_3-2-5-控制层开发" aria-hidden="true">#</a> 3.2.5 控制层开发</h4><p>补全控制层的代码，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/revocation&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;撤回&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseResult</span> <span class="token function">revocation</span><span class="token punctuation">(</span>
        <span class="token annotation punctuation">@RequestParam</span> <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;入住Id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span> <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;流程状态&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> flowStatus<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span> <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;任务Id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> taskId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> checkInService<span class="token punctuation">.</span><span class="token function">revocation</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> flowStatus<span class="token punctuation">,</span> taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-2-6-测试" tabindex="-1"><a class="header-anchor" href="#_3-2-6-测试" aria-hidden="true">#</a> 3.2.6 测试</h4><p>副院长审批-处理节点处理完成之后，我们回到审核页面，点击撤回按钮，入住单就由已处理变为了未处理</p><h3 id="_3-3-申请人-撤销" tabindex="-1"><a class="header-anchor" href="#_3-3-申请人-撤销" aria-hidden="true">#</a> 3.3 申请人-撤销</h3><h4 id="_3-3-1-思路分析" tabindex="-1"><a class="header-anchor" href="#_3-3-1-思路分析" aria-hidden="true">#</a> 3.3.1 思路分析</h4><p>在我的申请列表中，当单子还是申请中，申请人是可以撤销的，如下图</p><figure><img src="`+u+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li></li></ul><p>当点击了撤销之后，此流程结束</p><ul><li></li></ul><p>撤销后的申请，发起人和审批人无法对表单和审批结果进行任何操作</p><ul><li></li></ul><p>若部分审批人已通过，发起人撤销了，在数据在已审批列表中，不消失</p><p>我们的整体实现思路是这样，如下面动图</p><figure><img src="'+k+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li></li></ul><p>假如这个单子已经走到了”副院长审批-处理”，还未处理</p><ul><li></li></ul><p>申请人发起了撤销操作</p><ul><li></li></ul><p>没有执行的节点有三个，分别是：副院长审批-处理、入住选配-处理、签约办理-处理</p><ul><li></li></ul><p>先设置流程变量为3，表示入住单已经结束，方便查询</p><ul><li></li></ul><p>删除流程实例，效果就是：没执行的节点直接不会执行，已执行的节点会保留历史记录</p><h4 id="_3-3-2-接口定义" tabindex="-1"><a class="header-anchor" href="#_3-3-2-接口定义" aria-hidden="true">#</a> 3.3.2 接口定义</h4><p>在CheckInController中新增方法，如下</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/cancel&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;撤销&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseResult</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;入住Id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">,</span>
                         <span class="token annotation punctuation">@RequestParam</span> <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;任务ID&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> taskId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-3-3-业务层开发" tabindex="-1"><a class="header-anchor" href="#_3-3-3-业务层开发" aria-hidden="true">#</a> 3.3.3 业务层开发</h4><p>在CheckInService中新增方法，如下</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 撤销
 * <span class="token keyword">@param</span> <span class="token parameter">checkInCode</span>   入住编码
 * <span class="token keyword">@return</span>
 */</span>
<span class="token class-name">ResponseResult</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token class-name">Long</span> checkInCode<span class="token punctuation">,</span> <span class="token class-name">String</span> taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实现方法：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
     * 撤销
     * <span class="token keyword">@param</span> <span class="token parameter">id</span>
     * <span class="token keyword">@param</span> <span class="token parameter">taskId</span>
     * <span class="token keyword">@return</span>
     */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseResult</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token class-name">String</span> taskId<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">CheckIn</span> checkIn <span class="token operator">=</span> checkInMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkIn<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">CheckIn<span class="token punctuation">.</span>Status</span><span class="token punctuation">.</span><span class="token constant">CLOSED</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//删除老人数据</span>
    <span class="token function">close</span><span class="token punctuation">(</span>checkIn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//  操作记录</span>
    <span class="token comment">//从当前线程中获取用户数据</span>
    <span class="token class-name">String</span> subject <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//记录操作记录</span>
    <span class="token class-name">RecordVo</span> recoreVo <span class="token operator">=</span> <span class="token function">getRecordVo</span><span class="token punctuation">(</span>checkIn<span class="token punctuation">,</span> user<span class="token punctuation">,</span>
                                    <span class="token class-name">AccraditationRecordConstant</span><span class="token punctuation">.</span><span class="token constant">AUDIT_STATUS_CANCEL</span><span class="token punctuation">,</span> <span class="token string">&quot;撤销&quot;</span><span class="token punctuation">,</span>
                                    <span class="token string">&quot;撤销申请-入住申请&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
                                    <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">AccraditationRecordConstant</span><span class="token punctuation">.</span><span class="token constant">RECORD_HANDLE_TYPE_PROCESSED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    accraditationRecordService<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>recoreVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//撤销操作</span>
    actFlowCommService<span class="token punctuation">.</span><span class="token function">closeProcess</span><span class="token punctuation">(</span>taskId<span class="token punctuation">,</span><span class="token class-name">CheckIn<span class="token punctuation">.</span>Status</span><span class="token punctuation">.</span><span class="token constant">CLOSED</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token class-name">ResponseResult</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在actFlowCommService中新增closeProcess方法，代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
     * 撤销思路
     *  - 设置流程变量为已结束
     *  - 删除流程实例
     *
     * <span class="token keyword">@param</span> <span class="token parameter">taskId</span> 任务id
     * <span class="token keyword">@param</span> <span class="token parameter">status</span> 状态 1申请中 2已完成 3已关闭
     */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">closeProcess</span><span class="token punctuation">(</span><span class="token class-name">String</span> taskId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">HistoricTaskInstance</span> historicTaskInstance <span class="token operator">=</span> historyService<span class="token punctuation">.</span><span class="token function">createHistoricTaskInstanceQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">taskId</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 从任务中拿到流程实例id</span>
    <span class="token class-name">String</span> processInstanceId <span class="token operator">=</span> historicTaskInstance<span class="token punctuation">.</span><span class="token function">getProcessInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置参数</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> variable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    variable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;processStatus&quot;</span><span class="token punctuation">,</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    variable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;finishTime&quot;</span><span class="token punctuation">,</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//记录流程变量</span>
    runtimeService<span class="token punctuation">.</span><span class="token function">setVariables</span><span class="token punctuation">(</span>processInstanceId<span class="token punctuation">,</span> variable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//删除流程实例</span>
    runtimeService<span class="token punctuation">.</span><span class="token function">deleteProcessInstance</span><span class="token punctuation">(</span>processInstanceId<span class="token punctuation">,</span><span class="token string">&quot;申请人撤销&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-3-4-控制层开发" tabindex="-1"><a class="header-anchor" href="#_3-3-4-控制层开发" aria-hidden="true">#</a> 3.3.4 控制层开发</h4><p>补全控制层代码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/cancel&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;撤销&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseResult</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;入住Id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">,</span>
                         <span class="token annotation punctuation">@RequestParam</span> <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;任务ID&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> taskId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> checkInService<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-3-5-问题修复" tabindex="-1"><a class="header-anchor" href="#_3-3-5-问题修复" aria-hidden="true">#</a> 3.3.5 问题修复</h4><p>在测试的时候发现，没有入住id，因为当前任务查询的时候，并没有返回，我们需要设置入住id的返回</p><p>第一：在启动流程时候的设置一个流程变量为businessKey</p><figure><img src="`+r+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>第二：查询任务列表数据时取出，并返回(ActFlowCommServiceImpl的getMyTaskList方法)</p><figure><img src="'+d+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Long</span> businessId <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>processVariables<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;bussinessKey&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pendingTasks<span class="token punctuation">.</span><span class="token function">setCheckInId</span><span class="token punctuation">(</span>businessId<span class="token punctuation">)</span><span class="token punctuation">;</span>

pendingTasksList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pendingTasks<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-3-5-测试" tabindex="-1"><a class="header-anchor" href="#_3-3-5-测试" aria-hidden="true">#</a> 3.3.5 测试</h4><p>在我的申请列表中，点击可以撤销的单子，撤销之后</p><ul><li>入住单关闭</li><li>已经执行任务可以正常查看</li></ul><h3 id="_3-4-养老顾问-入住配置" tabindex="-1"><a class="header-anchor" href="#_3-4-养老顾问-入住配置" aria-hidden="true">#</a> 3.4 养老顾问-入住配置</h3><p>我们先查看下原型图，如下效果</p><figure><img src="`+v+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="_3-4-1-思路分析" tabindex="-1"><a class="header-anchor" href="#_3-4-1-思路分析" aria-hidden="true">#</a> 3.4.1 思路分析</h4><figure><img src="'+m+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="_3-4-2-接口定义" tabindex="-1"><a class="header-anchor" href="#_3-4-2-接口定义" aria-hidden="true">#</a> 3.4.2 接口定义</h4><p>在CheckInController中新增方法，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 入住配置
 * <span class="token keyword">@param</span> <span class="token parameter">checkInConfigDto</span> 入住配置
 * <span class="token keyword">@return</span> 操作结果
 */</span>
<span class="token annotation punctuation">@PostMapping</span>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;入住配置&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseResult</span> <span class="token function">checkIn</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">CheckInConfigDto</span> checkInConfigDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-4-3-业务层开发" tabindex="-1"><a class="header-anchor" href="#_3-4-3-业务层开发" aria-hidden="true">#</a> 3.4.3 业务层开发</h4><p>新增checkInConfigService类，定义方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CheckInConfigService</span> <span class="token punctuation">{</span>

     <span class="token doc-comment comment">/**
     * 入住选择配置
     * <span class="token keyword">@param</span> <span class="token parameter">checkInConfigDto</span> 入住选择配置
     */</span>
    <span class="token class-name">ResponseResult</span> <span class="token function">checkIn</span><span class="token punctuation">(</span><span class="token class-name">CheckInConfigDto</span> checkInConfigDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实现类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>zzyl<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> sjqn
 */</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CheckInConfigServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">CheckInConfigService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">CheckInConfigMapper</span> checkInConfigMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">BedService</span> bedService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ElderMapper</span> elderMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">CheckInMapper</span> checkInMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ActFlowCommService</span> actFlowCommService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AccraditationRecordService</span> accraditationRecordService<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 入住选择配置
     * <span class="token keyword">@param</span> <span class="token parameter">checkInConfigDto</span> 入住选择配置
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseResult</span> <span class="token function">checkIn</span><span class="token punctuation">(</span><span class="token class-name">CheckInConfigDto</span> checkInConfigDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>


        <span class="token comment">//判断费用期限是否在入住期限内</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>checkInConfigDto<span class="token punctuation">.</span><span class="token function">getCheckInStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span>checkInConfigDto<span class="token punctuation">.</span><span class="token function">getCostStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">||</span> checkInConfigDto<span class="token punctuation">.</span><span class="token function">getCheckInEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span>checkInConfigDto<span class="token punctuation">.</span><span class="token function">getCostEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BaseException</span><span class="token punctuation">(</span><span class="token string">&quot;费用期限应该在入住期限内&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//保存入住配置</span>
        <span class="token class-name">CheckInConfig</span> checkInConfig <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>checkInConfigDto<span class="token punctuation">,</span> <span class="token class-name">CheckInConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//设置床位编号</span>
        <span class="token class-name">BedVo</span> bedVo <span class="token operator">=</span> bedService<span class="token punctuation">.</span><span class="token function">getBedById</span><span class="token punctuation">(</span>checkInConfigDto<span class="token punctuation">.</span><span class="token function">getBedId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        checkInConfig<span class="token punctuation">.</span><span class="token function">setBedNo</span><span class="token punctuation">(</span>bedVo<span class="token punctuation">.</span><span class="token function">getBedNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//组装床位信息，方便前端展示和回显</span>
        <span class="token comment">//拼接规则---&gt;  楼层id:房间id:床位id:楼层名称:入住编码</span>
        <span class="token class-name">String</span> remark <span class="token operator">=</span> checkInConfigDto<span class="token punctuation">.</span><span class="token function">getFloorId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;:&quot;</span><span class="token operator">+</span>checkInConfigDto<span class="token punctuation">.</span><span class="token function">getRoomId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;:&quot;</span><span class="token operator">+</span>checkInConfigDto<span class="token punctuation">.</span><span class="token function">getBedId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">+</span><span class="token string">&quot;:&quot;</span><span class="token operator">+</span>checkInConfigDto<span class="token punctuation">.</span><span class="token function">getFloorName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;:&quot;</span><span class="token operator">+</span>checkInConfigDto<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        checkInConfig<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span>remark<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//保存</span>
        checkInConfigMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>checkInConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//修改床位状态</span>
        bedVo<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BedDto</span> bedDto <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>bedVo<span class="token punctuation">,</span> <span class="token class-name">BedDto</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bedService<span class="token punctuation">.</span><span class="token function">updateBed</span><span class="token punctuation">(</span>bedDto<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//床位与老人的关系</span>
        <span class="token class-name">Elder</span> elder <span class="token operator">=</span> elderMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>checkInConfig<span class="token punctuation">.</span><span class="token function">getElderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        elder<span class="token punctuation">.</span><span class="token function">setBedId</span><span class="token punctuation">(</span>bedVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        elder<span class="token punctuation">.</span><span class="token function">setBedNumber</span><span class="token punctuation">(</span>bedVo<span class="token punctuation">.</span><span class="token function">getBedNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        elderMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKeySelective</span><span class="token punctuation">(</span>elder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//设置流程状态</span>
        <span class="token class-name">CheckIn</span> checkIn <span class="token operator">=</span> checkInMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>checkInConfigDto<span class="token punctuation">.</span><span class="token function">getCheckInId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置流程状态</span>
        checkIn<span class="token punctuation">.</span><span class="token function">setFlowStatus</span><span class="token punctuation">(</span><span class="token class-name">CheckIn<span class="token punctuation">.</span>FlowStatus</span><span class="token punctuation">.</span><span class="token constant">SIGN</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//生成合同编号，备用，下一步要使用</span>
        <span class="token class-name">String</span> htCode <span class="token operator">=</span> <span class="token class-name">CodeUtil</span><span class="token punctuation">.</span><span class="token function">generateCode</span><span class="token punctuation">(</span><span class="token string">&quot;HT&quot;</span><span class="token punctuation">,</span> redisTemplate<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        checkIn<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span>htCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//更新入住时间</span>
        checkIn<span class="token punctuation">.</span><span class="token function">setCheckInTime</span><span class="token punctuation">(</span>checkInConfigDto<span class="token punctuation">.</span><span class="token function">getCheckInStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        checkInMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKeySelective</span><span class="token punctuation">(</span>checkIn<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//获取用户</span>
        <span class="token class-name">String</span> subject <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//完成任务</span>
        actFlowCommService<span class="token punctuation">.</span><span class="token function">completeProcess</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>checkInConfigDto<span class="token punctuation">.</span><span class="token function">getTaskId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">,</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//保存操作记录</span>
        <span class="token class-name">Long</span> nextAssignee <span class="token operator">=</span> actFlowCommService<span class="token punctuation">.</span><span class="token function">getNextAssignee</span><span class="token punctuation">(</span><span class="token string">&quot;checkIn-new&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;checkIn-new:&quot;</span> <span class="token operator">+</span> checkIn<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">RecordVo</span> recoreVo <span class="token operator">=</span> <span class="token function">getRecordVo</span><span class="token punctuation">(</span>checkIn<span class="token punctuation">,</span>
                user<span class="token punctuation">,</span> <span class="token class-name">AccraditationRecordConstant</span><span class="token punctuation">.</span><span class="token constant">AUDIT_STATUS_PASS</span><span class="token punctuation">,</span>
                <span class="token string">&quot;同意&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;养老顾问处理-入住配置&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;法务处理-签约办理&quot;</span><span class="token punctuation">,</span> nextAssignee
                <span class="token punctuation">,</span><span class="token class-name">AccraditationRecordConstant</span><span class="token punctuation">.</span><span class="token constant">RECORD_HANDLE_TYPE_PROCESSED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        accraditationRecordService<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>recoreVo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">ResponseResult</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 封装审核记录参数
     *
     * <span class="token keyword">@param</span> <span class="token parameter">checkIn</span>      入住对象
     * <span class="token keyword">@param</span> <span class="token parameter">user</span>         当前登录用户
     * <span class="token keyword">@param</span> <span class="token parameter">status</span>       审核状态
     * <span class="token keyword">@param</span> <span class="token parameter">option</span>       操作意见
     * <span class="token keyword">@param</span> <span class="token parameter">step</span>         当前步骤
     * <span class="token keyword">@param</span> <span class="token parameter">nextSetp</span>     下一步操作人
     * <span class="token keyword">@param</span> <span class="token parameter">nextAssignee</span> 下一个审核人
     * <span class="token keyword">@param</span> <span class="token parameter">handleType</span>   处理类型（0:已审批，1：已处理）
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">RecordVo</span> <span class="token function">getRecordVo</span><span class="token punctuation">(</span><span class="token class-name">CheckIn</span> checkIn<span class="token punctuation">,</span> <span class="token class-name">User</span> user<span class="token punctuation">,</span> <span class="token class-name">Integer</span> status<span class="token punctuation">,</span> <span class="token class-name">String</span> option<span class="token punctuation">,</span> <span class="token class-name">String</span> step<span class="token punctuation">,</span> <span class="token class-name">String</span> nextSetp<span class="token punctuation">,</span> <span class="token class-name">Long</span> nextAssignee<span class="token punctuation">,</span> <span class="token class-name">Integer</span> handleType<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">RecordVo</span> recordVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RecordVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        recordVo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>checkIn<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        recordVo<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token class-name">AccraditationRecordConstant</span><span class="token punctuation">.</span><span class="token constant">RECORD_TYPE_CHECK_IN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        recordVo<span class="token punctuation">.</span><span class="token function">setFlowStatus</span><span class="token punctuation">(</span>checkIn<span class="token punctuation">.</span><span class="token function">getFlowStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        recordVo<span class="token punctuation">.</span><span class="token function">setHandleType</span><span class="token punctuation">(</span>handleType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        recordVo<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        recordVo<span class="token punctuation">.</span><span class="token function">setOption</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">;</span>
        recordVo<span class="token punctuation">.</span><span class="token function">setNextStep</span><span class="token punctuation">(</span>nextSetp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        recordVo<span class="token punctuation">.</span><span class="token function">setNextAssignee</span><span class="token punctuation">(</span>nextAssignee<span class="token punctuation">)</span><span class="token punctuation">;</span>
        recordVo<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        recordVo<span class="token punctuation">.</span><span class="token function">setStep</span><span class="token punctuation">(</span>step<span class="token punctuation">)</span><span class="token punctuation">;</span>
        recordVo<span class="token punctuation">.</span><span class="token function">setRealName</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getRealName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> recordVo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-4-4-控制层开发" tabindex="-1"><a class="header-anchor" href="#_3-4-4-控制层开发" aria-hidden="true">#</a> 3.4.4 控制层开发</h4><p>补全控制层代码，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">CheckInConfigService</span> checkInConfigService<span class="token punctuation">;</span>
<span class="token doc-comment comment">/**
 * 入住配置
 * <span class="token keyword">@param</span> <span class="token parameter">checkInConfigDto</span> 入住配置
 * <span class="token keyword">@return</span> 操作结果
 */</span>
<span class="token annotation punctuation">@PostMapping</span>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;入住配置&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseResult</span> <span class="token function">checkIn</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">CheckInConfigDto</span> checkInConfigDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> checkInConfigService<span class="token punctuation">.</span><span class="token function">checkIn</span><span class="token punctuation">(</span>checkInConfigDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-4-5-测试" tabindex="-1"><a class="header-anchor" href="#_3-4-5-测试" aria-hidden="true">#</a> 3.4.5 测试</h4><p>需要准备一个入住单，副院长已经审批完成</p><p>在前端选择入住配置、床位等信息，提交单子后</p><ul><li><p>检查数据库中的数据是否保存成功</p><ul><li>check_in_config  入住配置表</li><li>bed  床位状态是否更新</li><li>bed_elder   床位与老人的关系是否绑定</li><li>check_in 数据是否更新</li><li>操作记录是否保存成功</li></ul></li><li><p>工作流任务是否完成及分配给下一个人（法务）</p></li></ul><h4 id="_3-4-6-入住配置数据回显" tabindex="-1"><a class="header-anchor" href="#_3-4-6-入住配置数据回显" aria-hidden="true">#</a> 3.4.6 入住配置数据回显</h4><p>当已经提交了入住配置之后，假如提交人想要查看自己提交的数据，或者是单子审批完成后，检查每一步的数据，需要在入住单详情查询中显示入住的配置</p><p>所以需要修改前一天开发的接口：<strong>入住表单查询</strong>接口中的逻辑</p><p>在CheckInServiceImpl中的getCheckIn方法上添加如下代码</p><p>需要注入：CheckInConfigService和NursingLevelService</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">CheckInConfig</span> checkInConfig <span class="token operator">=</span> checkInConfigService<span class="token punctuation">.</span><span class="token function">findCurrentConfigByElderId</span><span class="token punctuation">(</span>checkIn<span class="token punctuation">.</span><span class="token function">getElderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//数据拷贝</span>
<span class="token class-name">CheckInConfigVo</span> checkInConfigVo <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>checkInConfig<span class="token punctuation">,</span> <span class="token class-name">CheckInConfigVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>checkInConfig<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>checkInConfig<span class="token punctuation">.</span><span class="token function">getRemark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">NursingLevelVo</span> nursingLevelVo <span class="token operator">=</span> nursingLevelService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>checkInConfig<span class="token punctuation">.</span><span class="token function">getNursingLevelId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkInVo<span class="token punctuation">.</span><span class="token function">setNursingLevelVo</span><span class="token punctuation">(</span>nursingLevelVo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//取出楼层房间床位等数据</span>
    <span class="token class-name">String</span> remark <span class="token operator">=</span> checkInConfig<span class="token punctuation">.</span><span class="token function">getRemark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> split <span class="token operator">=</span> remark<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkInConfigVo<span class="token punctuation">.</span><span class="token function">setFloorId</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkInConfigVo<span class="token punctuation">.</span><span class="token function">setRoomId</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkInConfigVo<span class="token punctuation">.</span><span class="token function">setBedId</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkInConfigVo<span class="token punctuation">.</span><span class="token function">setFloorName</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkInConfigVo<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    checkInVo<span class="token punctuation">.</span><span class="token function">setCheckInConfigVo</span><span class="token punctuation">(</span>checkInConfigVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述代码中需要使用checkInConfigService来入住配置，其中的入住配置详细详细，我们还需要查询<strong>护理等级</strong></p><p>在CheckInConfigService中新增方法，根据老人id查询入住配置</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 根据老人id查询入住配置
 * <span class="token keyword">@param</span> <span class="token parameter">elderId</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token class-name">CheckInConfig</span> <span class="token function">findCurrentConfigByElderId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> elderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实现类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 根据老人ID查询当前入住配置
 * <span class="token keyword">@param</span> <span class="token parameter">elderId</span> 老人ID
 * <span class="token keyword">@return</span> CheckInConfig
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">CheckInConfig</span> <span class="token function">findCurrentConfigByElderId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> elderId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> checkInConfigMapper<span class="token punctuation">.</span><span class="token function">findCurrentConfigByElderId</span><span class="token punctuation">(</span>elderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试：养老顾问在已处理的任务中查询入住配置单，是否可以正常展示</p><figure><img src="`+b+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_3-5-法务-签约办理" tabindex="-1"><a class="header-anchor" href="#_3-5-法务-签约办理" aria-hidden="true">#</a> 3.5 法务-签约办理</h3><h4 id="_3-5-1-思路分析" tabindex="-1"><a class="header-anchor" href="#_3-5-1-思路分析" aria-hidden="true">#</a> 3.5.1 思路分析</h4><figure><img src="'+g+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="_3-5-2-接口定义" tabindex="-1"><a class="header-anchor" href="#_3-5-2-接口定义" aria-hidden="true">#</a> 3.5.2 接口定义</h4><p>在CheckInController中新增方法，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/sign&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;签约办理&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseResult</span> <span class="token function">sign</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">ContractDto</span> contractDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-5-3-业务层开发" tabindex="-1"><a class="header-anchor" href="#_3-5-3-业务层开发" aria-hidden="true">#</a> 3.5.3 业务层开发</h4><p>在ContractService中新增方法，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
     * 签约办理
     * <span class="token keyword">@param</span> <span class="token parameter">contractDto</span>
     * <span class="token keyword">@return</span>
     */</span>
<span class="token class-name">ResponseResult</span> <span class="token function">sign</span><span class="token punctuation">(</span><span class="token class-name">ContractDto</span> contractDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实现方法：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">CheckInMapper</span> checkInMapper<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">ElderMapper</span> elderMapper<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">BalanceMapper</span> balanceMapper<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">CheckInConfigService</span> checkInConfigService<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">BedMapper</span> bedMapper<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">BillService</span> billService<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">NursingTaskService</span> nursingTaskService<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">ActFlowCommService</span> actFlowCommService<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">AccraditationRecordService</span> accraditationRecordService<span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
     * 签约办理
     * <span class="token keyword">@param</span> <span class="token parameter">contractDto</span>
     * <span class="token keyword">@return</span>
     */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseResult</span> <span class="token function">sign</span><span class="token punctuation">(</span><span class="token class-name">ContractDto</span> contractDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//更新入住状态  流程状态和审核状态</span>
    <span class="token class-name">CheckIn</span> checkIn <span class="token operator">=</span> checkInMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>contractDto<span class="token punctuation">.</span><span class="token function">getCheckInId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkIn<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">CheckIn<span class="token punctuation">.</span>Status</span><span class="token punctuation">.</span><span class="token constant">FINISHED</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkIn<span class="token punctuation">.</span><span class="token function">setFlowStatus</span><span class="token punctuation">(</span><span class="token class-name">CheckIn<span class="token punctuation">.</span>FlowStatus</span><span class="token punctuation">.</span><span class="token constant">SIGN</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkInMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKeySelective</span><span class="token punctuation">(</span>checkIn<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//获取用户数据</span>
    <span class="token class-name">String</span> subject <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//更新老人状态</span>
    <span class="token class-name">Elder</span> elder <span class="token operator">=</span> elderMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>checkIn<span class="token punctuation">.</span><span class="token function">getElderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    elder<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    elderMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKeySelective</span><span class="token punctuation">(</span>elder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//初始化老人的余额</span>
    <span class="token class-name">Balance</span> balance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Balance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    balance<span class="token punctuation">.</span><span class="token function">setElderId</span><span class="token punctuation">(</span>checkIn<span class="token punctuation">.</span><span class="token function">getElderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    balance<span class="token punctuation">.</span><span class="token function">setElderName</span><span class="token punctuation">(</span>elder<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    balance<span class="token punctuation">.</span><span class="token function">setBedNo</span><span class="token punctuation">(</span>elder<span class="token punctuation">.</span><span class="token function">getBedNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    balance<span class="token punctuation">.</span><span class="token function">setPrepaidBalance</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    balance<span class="token punctuation">.</span><span class="token function">setArrearsAmount</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    balance<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">CheckInConfig</span> checkInConfig <span class="token operator">=</span> checkInConfigService<span class="token punctuation">.</span><span class="token function">findCurrentConfigByElderId</span><span class="token punctuation">(</span>elder<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    balance<span class="token punctuation">.</span><span class="token function">setDepositAmount</span><span class="token punctuation">(</span>checkInConfig<span class="token punctuation">.</span><span class="token function">getDepositAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    balanceMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>balance<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//床位状态</span>
    <span class="token class-name">Bed</span> bed <span class="token operator">=</span> bedMapper<span class="token punctuation">.</span><span class="token function">getBedByNum</span><span class="token punctuation">(</span>checkInConfig<span class="token punctuation">.</span><span class="token function">getBedNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bed<span class="token punctuation">.</span><span class="token function">setBedStatus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bedMapper<span class="token punctuation">.</span><span class="token function">updateBed</span><span class="token punctuation">(</span>bed<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//保存老人合同</span>
    <span class="token class-name">Contract</span> contract <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Contract</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>contractDto<span class="token punctuation">,</span> contract<span class="token punctuation">)</span><span class="token punctuation">;</span>
    contract<span class="token punctuation">.</span><span class="token function">setElderId</span><span class="token punctuation">(</span>elder<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    contract<span class="token punctuation">.</span><span class="token function">setElderName</span><span class="token punctuation">(</span>elder<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    contract<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">ContractStatusEnum</span><span class="token punctuation">.</span><span class="token constant">PENDING_EFFECTIVE</span><span class="token punctuation">.</span><span class="token function">getOrdinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    contractMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>contract<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//生成首月账单</span>
    <span class="token class-name">BillDto</span> billDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BillDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    billDto<span class="token punctuation">.</span><span class="token function">setElderId</span><span class="token punctuation">(</span>elder<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">LocalDateTime</span> costStartTime <span class="token operator">=</span> checkInConfig<span class="token punctuation">.</span><span class="token function">getCostStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> dateStr <span class="token operator">=</span> <span class="token class-name">LocalDateTimeUtil</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>costStartTime<span class="token punctuation">,</span> <span class="token string">&quot;yyyy-MM&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    billDto<span class="token punctuation">.</span><span class="token function">setBillMonth</span><span class="token punctuation">(</span>dateStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    billService<span class="token punctuation">.</span><span class="token function">createMonthBill</span><span class="token punctuation">(</span>billDto<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//生成护理任务</span>
    <span class="token class-name">ElderVo</span> elderVo <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>elder<span class="token punctuation">,</span> <span class="token class-name">ElderVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nursingTaskService<span class="token punctuation">.</span><span class="token function">createMonthTask</span><span class="token punctuation">(</span>elderVo<span class="token punctuation">,</span>contract<span class="token punctuation">.</span><span class="token function">getSignDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//完成任务</span>
    actFlowCommService<span class="token punctuation">.</span><span class="token function">completeProcess</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>contractDto<span class="token punctuation">.</span><span class="token function">getTaskId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                       <span class="token punctuation">,</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token class-name">CheckIn<span class="token punctuation">.</span>Status</span><span class="token punctuation">.</span><span class="token constant">FINISHED</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//保存操作记录</span>
    <span class="token class-name">RecordVo</span> recoreVo <span class="token operator">=</span> <span class="token function">getRecordVo</span><span class="token punctuation">(</span>
        checkIn<span class="token punctuation">,</span>
        user<span class="token punctuation">,</span>
        <span class="token class-name">AccraditationRecordConstant</span><span class="token punctuation">.</span><span class="token constant">AUDIT_STATUS_PASS</span><span class="token punctuation">,</span>
        <span class="token string">&quot;同意&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;法务处理-签约办理&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
        <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token class-name">AccraditationRecordConstant</span><span class="token punctuation">.</span><span class="token constant">RECORD_HANDLE_TYPE_PROCESSED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    accraditationRecordService<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>recoreVo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token class-name">ResponseResult</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
     * 封装审核记录参数
     *
     * <span class="token keyword">@param</span> <span class="token parameter">checkIn</span>      入住对象
     * <span class="token keyword">@param</span> <span class="token parameter">user</span>         当前登录用户
     * <span class="token keyword">@param</span> <span class="token parameter">status</span>       审核状态
     * <span class="token keyword">@param</span> <span class="token parameter">option</span>       操作意见
     * <span class="token keyword">@param</span> <span class="token parameter">step</span>         当前步骤
     * <span class="token keyword">@param</span> <span class="token parameter">nextSetp</span>     下一步操作人
     * <span class="token keyword">@param</span> <span class="token parameter">nextAssignee</span> 下一个审核人
     * <span class="token keyword">@param</span> <span class="token parameter">handleType</span>   处理类型（0:已审批，1：已处理）
     * <span class="token keyword">@return</span>
     */</span>
<span class="token keyword">private</span> <span class="token class-name">RecordVo</span> <span class="token function">getRecordVo</span><span class="token punctuation">(</span><span class="token class-name">CheckIn</span> checkIn<span class="token punctuation">,</span> <span class="token class-name">User</span> user<span class="token punctuation">,</span> <span class="token class-name">Integer</span> status<span class="token punctuation">,</span> <span class="token class-name">String</span> option<span class="token punctuation">,</span> <span class="token class-name">String</span> step<span class="token punctuation">,</span> <span class="token class-name">String</span> nextSetp<span class="token punctuation">,</span> <span class="token class-name">Long</span> nextAssignee<span class="token punctuation">,</span> <span class="token class-name">Integer</span> handleType<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">RecordVo</span> recordVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RecordVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    recordVo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>checkIn<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    recordVo<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token class-name">AccraditationRecordConstant</span><span class="token punctuation">.</span><span class="token constant">RECORD_TYPE_CHECK_IN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    recordVo<span class="token punctuation">.</span><span class="token function">setFlowStatus</span><span class="token punctuation">(</span>checkIn<span class="token punctuation">.</span><span class="token function">getFlowStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    recordVo<span class="token punctuation">.</span><span class="token function">setHandleType</span><span class="token punctuation">(</span>handleType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    recordVo<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
    recordVo<span class="token punctuation">.</span><span class="token function">setOption</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">;</span>
    recordVo<span class="token punctuation">.</span><span class="token function">setNextStep</span><span class="token punctuation">(</span>nextSetp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    recordVo<span class="token punctuation">.</span><span class="token function">setNextAssignee</span><span class="token punctuation">(</span>nextAssignee<span class="token punctuation">)</span><span class="token punctuation">;</span>
    recordVo<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    recordVo<span class="token punctuation">.</span><span class="token function">setStep</span><span class="token punctuation">(</span>step<span class="token punctuation">)</span><span class="token punctuation">;</span>
    recordVo<span class="token punctuation">.</span><span class="token function">setRealName</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getRealName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> recordVo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-5-4-控制层开发" tabindex="-1"><a class="header-anchor" href="#_3-5-4-控制层开发" aria-hidden="true">#</a> 3.5.4 控制层开发</h4><p>补全控制层代码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 签约办理
 * <span class="token keyword">@param</span> <span class="token parameter">contractDto</span> 合同信息
 * <span class="token keyword">@return</span> 操作结果
 */</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/sign&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;签约办理&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseResult</span> <span class="token function">sign</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">ContractDto</span> contractDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> contractService<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>contractDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-5-5-测试" tabindex="-1"><a class="header-anchor" href="#_3-5-5-测试" aria-hidden="true">#</a> 3.5.5 测试</h4><p>当签约成功以后，测试如下：</p><ul><li>入住流程状态为已完成</li><li>新增老人余额  balance表</li><li>更新老人状态  elder表</li><li>床位状态更新为已入住</li><li>生成首月账单</li><li>生成护理任务</li><li>保存操作记录</li></ul><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> balance 

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> elder

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> bed

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> bill

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> nursing_task
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-5-6-入住单详情查询-合同部分" tabindex="-1"><a class="header-anchor" href="#_3-5-6-入住单详情查询-合同部分" aria-hidden="true">#</a> 3.5.6 入住单详情查询（合同部分）</h4><p>当入住流程结束以后，流程上节点的任务人可以继续查看单子的审核过程和详情，如果签订合同以后就需要查看合同相关的信息，效果如下：</p><figure><img src="`+f+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>所以需要修改前一天开发的接口：<strong>入住表单查询</strong>接口中的逻辑</p><p>在CheckInServiceImpl中的getCheckIn方法上添加如下代码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//合同信息</span>
<span class="token class-name">Contract</span> contract <span class="token operator">=</span> contractMapper<span class="token punctuation">.</span><span class="token function">selectByElderId</span><span class="token punctuation">(</span>checkIn<span class="token punctuation">.</span><span class="token function">getElderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ContractVo</span> contractVo <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>contract<span class="token punctuation">,</span> <span class="token class-name">ContractVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
checkInVo<span class="token punctuation">.</span><span class="token function">setContractVo</span><span class="token punctuation">(</span>contractVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-5-7-合同状态自动更新" tabindex="-1"><a class="header-anchor" href="#_3-5-7-合同状态自动更新" aria-hidden="true">#</a> 3.5.7 合同状态自动更新</h4><p>每天凌晨1点检查合同状态，如果到了入住时间则把状态改为生效，要求使用xxl-job实现</p><h3 id="_3-6-入住管理查询" tabindex="-1"><a class="header-anchor" href="#_3-6-入住管理查询" aria-hidden="true">#</a> 3.6 入住管理查询</h3><h4 id="_3-6-1-思路分析" tabindex="-1"><a class="header-anchor" href="#_3-6-1-思路分析" aria-hidden="true">#</a> 3.6.1 思路分析</h4><figure><img src="`+h+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li><p>请详细阅读原型和PRD</p></li><li><p>其他注意事项</p><ul><li><p>在显示的字段列表中，需要从多个表中获取</p><ul><li>入住表    check_in</li><li>老人表   elder</li></ul></li></ul></li></ul><h4 id="_3-6-2-接口定义" tabindex="-1"><a class="header-anchor" href="#_3-6-2-接口定义" aria-hidden="true">#</a> 3.6.2 接口定义</h4><p>基于接口文档编写</p><h4 id="_3-6-3-业务层开发" tabindex="-1"><a class="header-anchor" href="#_3-6-3-业务层开发" aria-hidden="true">#</a> 3.6.3 业务层开发</h4><p>自己实现</p><h4 id="_3-6-4-控制层开发" tabindex="-1"><a class="header-anchor" href="#_3-6-4-控制层开发" aria-hidden="true">#</a> 3.6.4 控制层开发</h4><p>自己实现</p><h4 id="_3-6-5-测试" tabindex="-1"><a class="header-anchor" href="#_3-6-5-测试" aria-hidden="true">#</a> 3.6.5 测试</h4><h3 id="_3-7-入住成功关联业务介绍" tabindex="-1"><a class="header-anchor" href="#_3-7-入住成功关联业务介绍" aria-hidden="true">#</a> 3.7 入住成功关联业务介绍</h3><h4 id="_3-7-1-放开注释的代码" tabindex="-1"><a class="header-anchor" href="#_3-7-1-放开注释的代码" aria-hidden="true">#</a> 3.7.1 放开注释的代码</h4><p>找到BillServiceImpl和NursingTaskServiceImpl，放开里面所有注释掉的代码</p><h4 id="_3-7-2-入住流程走通的效果" tabindex="-1"><a class="header-anchor" href="#_3-7-2-入住流程走通的效果" aria-hidden="true">#</a> 3.7.2 入住流程走通的效果</h4><p>（1）合同生成</p><figure><img src="'+y+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>（2）老人与楼层房间床位绑定</p><figure><img src="'+I+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>（3）老人护理任务自动生成</p><p>任务列表可以查看老人当月的护理任务节点，可以给老人绑定护理员，由绑定的护理员去按照时间去执行任务</p><figure><img src="'+q+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>（4）自动老人的月度账单数据</p><p>可以给老人缴费（线下缴费，需上传凭证）</p><figure><img src="'+w+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>（5）小程序端查看老人的月度账单和合同</p><p>需要先绑定老人，输入老人的姓名和身份号</p><figure><img src="'+S+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>查看合同和账单</p><p>其中合同的展示查询条件是与入住中签约办理的丙方联系方式一致</p><p>简单说：现在测试，需要使用自己的手机号在小程序登录，那这个丙方联系方式就是自己的手机号</p><figure><img src="'+C+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>展示效果如下：</p><figure><img src="'+_+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>',254),j=[A];function T(x,D){return s(),a("div",null,j)}const V=n(R,[["render",T],["__file","day10-入退管理-入住-3.html.vue"]]);export{V as default};
