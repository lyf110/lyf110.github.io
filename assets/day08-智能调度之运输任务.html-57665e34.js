import{_ as p}from"./plugin-vue_export-helper-c27b6911.js";import{r as e,o,c,a as n,b as s,d as l,e as a}from"./app-5f6064b2.js";const i="/assets/image-20240407183435258-280-fa4b6073.gif",u="/assets/image-20240407183435261-281-671310ee.png",k="/assets/image-20240407183435262-282-93efbdd7.png",r="/assets/image-20240407183435262-283-8196dbbd.png",d="/assets/image-20240407183435262-284-6d6cfb73.png",m="/assets/image-20240407183435262-285-05428236.png",v="/assets/image-20240407183435262-286-ffc7df07.png",b="/assets/image-20240407183435262-287-f3ffbd84.png",g="/assets/image-20240407183435262-288-ab536062.png",y="/assets/image-20240407183435262-289-9a1bd04c.png",T="/assets/image-20240407183435262-290-9476077a.png",f="/assets/image-20240407183435262-291-6023eb74.png",w="/assets/image-20240407183435263-292-4a2ae546.png",O="/assets/image-20240407183435263-293-75afa6a1.png",h="/assets/image-20240407183435263-294-05f69195.png",L="/assets/image-20240407183435263-295-ea7a25d6.png",_="/assets/image-20240407183435263-296-9110996c.png",E="/assets/image-20240407183435263-297-00243297.png",D="/assets/image-20240407183435263-298-765eb203.png",I="/assets/image-20240407183435263-299-0345bbf2.png",N="/assets/image-20240407183435263-300-20ed75a1.png",S="/assets/image-20240407183435263-301-da5cc8e4.png",M="/assets/image-20240407183435263-302-b3d66778.png",A="/assets/image-20240407183435263-303-d00e5dff.png",C="/assets/image-20240407183435263-304-7b0ae662.png",R="/assets/image-20240407183435264-305-a0ff4296.png",U="/assets/image-20240407183435264-306-95f3d6a2.png",q="/assets/image-20240407183435264-307-4e773e7a.png",x={},j=a('<h1 id="课程安排" tabindex="-1"><a class="header-anchor" href="#课程安排" aria-hidden="true">#</a> 课程安排</h1><ul><li>智能调度生成运输任务</li><li>实现运输任务相关业务</li><li>实现司机入库业务</li></ul><h1 id="_1、背景说明" tabindex="-1"><a class="header-anchor" href="#_1、背景说明" aria-hidden="true">#</a> 1、背景说明</h1><p>通过前面的学习，已经可以将相同转运节点的运单合并，合并之后就需要进行调度计算，按照车辆的运力生成运输任务，以及司机的作业单，这样的话就可以进入到司机与车辆的运输环节了。<br><img src="'+i+'" alt="" loading="lazy"></p><h1 id="_2、任务调度" tabindex="-1"><a class="header-anchor" href="#_2、任务调度" aria-hidden="true">#</a> 2、任务调度</h1><h2 id="_2-1、分析" tabindex="-1"><a class="header-anchor" href="#_2-1、分析" aria-hidden="true">#</a> 2.1、分析</h2><p>通过前面的实现，已经将相同转运节点的写入到了Redis的队列中，谁来处理呢？这就需要调度任务进行处理了，基本的思路是：</p><blockquote><p>查询待分配任务的车辆 -&gt; 计算运力 -&gt; 分配运单 -&gt; 生成运输任务 -&gt; 生成司机作业单<br><strong>也就是说，调度是站在车辆角度推进的。</strong></p></blockquote><p>处理具体的处理业务流程如下：<br><img src="'+u+`" alt="" loading="lazy"></p><div class="hint-container info"><p class="hint-container-title">相关信息</p><p>线路、车辆、车次操作关系查看文档：</p></div><h2 id="_2-2、实现" tabindex="-1"><a class="header-anchor" href="#_2-2、实现" aria-hidden="true">#</a> 2.2、实现</h2><p>这里采用的是xxl-job的分片式任务调度，主要目的是为了并行多处理车辆，提升调度处理效率。</p><h3 id="_2-2-1、调度入口" tabindex="-1"><a class="header-anchor" href="#_2-2-1、调度入口" aria-hidden="true">#</a> 2.2.1、调度入口</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">TransportOrderDispatchMQListener</span> transportOrderDispatchMQListener<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">TruckPlanFeign</span> truckPlanFeign<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">MQFeign</span> mqFeign<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${sl.volume.ratio:0.95}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Double</span> volumeRatio<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${sl.weight.ratio:0.95}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Double</span> weightRatio<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 分片广播方式处理运单，生成运输任务
     */</span>
    <span class="token annotation punctuation">@XxlJob</span><span class="token punctuation">(</span><span class="token string">&quot;transportTask&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transportTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 分片参数</span>
        <span class="token keyword">int</span> shardIndex <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> shardTotal <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//根据分片参数 2小时内并且可用状态车辆</span>
        <span class="token comment">// List&lt;TruckPlanDto&gt; truckDtoList = this.queryTruckPlanDtoList(shardIndex, shardTotal);</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TruckPlanDto</span><span class="token punctuation">&gt;</span></span> truckDtoList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>truckPlanFeign<span class="token punctuation">.</span><span class="token function">pullUnassignedPlan</span><span class="token punctuation">(</span>shardTotal<span class="token punctuation">,</span> shardIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>truckDtoList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 对每一个车辆都进行处理</span>
        <span class="token comment">// 为了相同目的地的运单尽可能的分配在一个运输任务中，所以需要在读取数据时进行锁定，一个车辆处理完成后再开始下一个车辆处理</span>
        <span class="token comment">// 在这里，使用redis的分布式锁实现</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TruckPlanDto</span> truckPlanDto <span class="token operator">:</span> truckDtoList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//校验车辆计划对象</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">hasEmpty</span><span class="token punctuation">(</span>truckPlanDto<span class="token punctuation">.</span><span class="token function">getStartOrganId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> truckPlanDto<span class="token punctuation">.</span><span class="token function">getEndOrganId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    truckPlanDto<span class="token punctuation">.</span><span class="token function">getTransportTripsId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> truckPlanDto<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;车辆计划对象数据不符合要求， truckPlanDto -&gt; {}&quot;</span><span class="token punctuation">,</span> truckPlanDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//根据该车辆的开始、结束机构id，来确定要处理的运单数据集合</span>
            <span class="token class-name">Long</span> startOrganId <span class="token operator">=</span> truckPlanDto<span class="token punctuation">.</span><span class="token function">getStartOrganId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Long</span> endOrganId <span class="token operator">=</span> truckPlanDto<span class="token punctuation">.</span><span class="token function">getEndOrganId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>transportOrderDispatchMQListener<span class="token punctuation">.</span><span class="token function">getListRedisKey</span><span class="token punctuation">(</span>startOrganId<span class="token punctuation">,</span> endOrganId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> lockRedisKey <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">LOCKS</span><span class="token punctuation">.</span><span class="token constant">DISPATCH_LOCK_PREFIX</span> <span class="token operator">+</span> redisKey<span class="token punctuation">;</span>
            <span class="token comment">//获取锁</span>
            <span class="token class-name">RLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redissonClient<span class="token punctuation">.</span><span class="token function">getFairLock</span><span class="token punctuation">(</span>lockRedisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DispatchMsgDTO</span><span class="token punctuation">&gt;</span></span> dispatchMsgDTOList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//锁定，一直等待锁，一定要获取到锁，因为查询到车辆的调度状态设置为：已分配</span>
                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//计算车辆运力、合并运单</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executeTransportTask</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> truckPlanDto<span class="token punctuation">.</span><span class="token function">getTruckDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dispatchMsgDTOList<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//生成运输任务</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createTransportTask</span><span class="token punctuation">(</span>truckPlanDto<span class="token punctuation">,</span> startOrganId<span class="token punctuation">,</span> endOrganId<span class="token punctuation">,</span> dispatchMsgDTOList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//发送消息通过车辆已经完成调度</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">completeTruckPlan</span><span class="token punctuation">(</span>truckDtoList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-2、运单处理" tabindex="-1"><a class="header-anchor" href="#_2-2-2、运单处理" aria-hidden="true">#</a> 2.2.2、运单处理</h3><p>递归处理运单，需要考虑到车辆的运力：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">executeTransportTask</span><span class="token punctuation">(</span><span class="token class-name">String</span> redisKey<span class="token punctuation">,</span> <span class="token class-name">TruckDto</span> truckDto<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DispatchMsgDTO</span><span class="token punctuation">&gt;</span></span> dispatchMsgDTOList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> redisData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightPop</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>redisData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//该车辆没有运单需要运输</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">DispatchMsgDTO</span> dispatchMsgDTO <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>redisData<span class="token punctuation">,</span> <span class="token class-name">DispatchMsgDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//计算该车辆已经分配的运单，是否超出其运力，载重 或 体积超出，需要将新拿到的运单加进去后进行比较</span>
        <span class="token class-name">BigDecimal</span> totalWeight <span class="token operator">=</span> <span class="token class-name">NumberUtil</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">NumberUtil</span><span class="token punctuation">.</span><span class="token function">toBigDecimal</span><span class="token punctuation">(</span>dispatchMsgDTOList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">mapToDouble</span><span class="token punctuation">(</span><span class="token class-name">DispatchMsgDTO</span><span class="token operator">::</span><span class="token function">getTotalWeight</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dispatchMsgDTO<span class="token punctuation">.</span><span class="token function">getTotalWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">BigDecimal</span> totalVolume <span class="token operator">=</span> <span class="token class-name">NumberUtil</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">NumberUtil</span><span class="token punctuation">.</span><span class="token function">toBigDecimal</span><span class="token punctuation">(</span>dispatchMsgDTOList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">mapToDouble</span><span class="token punctuation">(</span><span class="token class-name">DispatchMsgDTO</span><span class="token operator">::</span><span class="token function">getTotalVolume</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dispatchMsgDTO<span class="token punctuation">.</span><span class="token function">getTotalVolume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//车辆最大的容积和载重要留有余量，否则可能会超重 或 装不下</span>
        <span class="token class-name">BigDecimal</span> maxAllowableLoad <span class="token operator">=</span> <span class="token class-name">NumberUtil</span><span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>truckDto<span class="token punctuation">.</span><span class="token function">getAllowableLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> weightRatio<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BigDecimal</span> maxAllowableVolume <span class="token operator">=</span> <span class="token class-name">NumberUtil</span><span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>truckDto<span class="token punctuation">.</span><span class="token function">getAllowableVolume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> volumeRatio<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">NumberUtil</span><span class="token punctuation">.</span><span class="token function">isGreaterOrEqual</span><span class="token punctuation">(</span>totalWeight<span class="token punctuation">,</span> maxAllowableLoad<span class="token punctuation">)</span>
                <span class="token operator">||</span> <span class="token class-name">NumberUtil</span><span class="token punctuation">.</span><span class="token function">isGreaterOrEqual</span><span class="token punctuation">(</span>totalVolume<span class="token punctuation">,</span> maxAllowableVolume<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//超出车辆运力，需要取货的运单再放回去，放到最右边，以便保证运单处理的顺序</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightPush</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> redisData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//没有超出运力，将该运单加入到集合中</span>
        dispatchMsgDTOList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dispatchMsgDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//递归处理运单</span>
        <span class="token function">executeTransportTask</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> truckDto<span class="token punctuation">,</span> dispatchMsgDTOList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-3、消息通知生成运输任务" tabindex="-1"><a class="header-anchor" href="#_2-2-3、消息通知生成运输任务" aria-hidden="true">#</a> 2.2.3、消息通知生成运输任务</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createTransportTask</span><span class="token punctuation">(</span><span class="token class-name">TruckPlanDto</span> truckPlanDto<span class="token punctuation">,</span> <span class="token class-name">Long</span> startOrganId<span class="token punctuation">,</span> <span class="token class-name">Long</span> endOrganId<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DispatchMsgDTO</span><span class="token punctuation">&gt;</span></span> dispatchMsgDTOList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//将运单合并的结果以消息的方式发送出去</span>
        <span class="token comment">//key-&gt; 车辆id，value -&gt;  运单id列表</span>
        <span class="token comment">//{&quot;driverId&quot;:123, &quot;truckPlanId&quot;:456, &quot;truckId&quot;:1210114964812075008,&quot;totalVolume&quot;:4.2,&quot;endOrganId&quot;:90001,&quot;totalWeight&quot;:7,&quot;transportOrderIdList&quot;:[320733749248,420733749248],&quot;startOrganId&quot;:100280}</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> transportOrderIdList <span class="token operator">=</span> <span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">getFieldValues</span><span class="token punctuation">(</span>dispatchMsgDTOList<span class="token punctuation">,</span> <span class="token string">&quot;transportOrderId&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//司机列表确保不为null</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> driverIds <span class="token operator">=</span> <span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>truckPlanDto<span class="token punctuation">.</span><span class="token function">getDriverIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> truckPlanDto<span class="token punctuation">.</span><span class="token function">getDriverIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token class-name">ListUtil</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> msgResult <span class="token operator">=</span> <span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;truckId&quot;</span><span class="token punctuation">,</span> truckPlanDto<span class="token punctuation">.</span><span class="token function">getTruckId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//车辆id</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;driverIds&quot;</span><span class="token punctuation">,</span> driverIds<span class="token punctuation">)</span> <span class="token comment">//司机id</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;truckPlanId&quot;</span><span class="token punctuation">,</span> truckPlanDto<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//车辆计划id</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;transportTripsId&quot;</span><span class="token punctuation">,</span> truckPlanDto<span class="token punctuation">.</span><span class="token function">getTransportTripsId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//车次id</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;startOrganId&quot;</span><span class="token punctuation">,</span> startOrganId<span class="token punctuation">)</span> <span class="token comment">//开始机构id</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;endOrganId&quot;</span><span class="token punctuation">,</span> endOrganId<span class="token punctuation">)</span> <span class="token comment">//结束机构id</span>
                <span class="token comment">//运单id列表</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;transportOrderIdList&quot;</span><span class="token punctuation">,</span> transportOrderIdList<span class="token punctuation">)</span>
                <span class="token comment">//总重量</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;totalWeight&quot;</span><span class="token punctuation">,</span> dispatchMsgDTOList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">mapToDouble</span><span class="token punctuation">(</span><span class="token class-name">DispatchMsgDTO</span><span class="token operator">::</span><span class="token function">getTotalWeight</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">//总体积</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;totalVolume&quot;</span><span class="token punctuation">,</span> dispatchMsgDTOList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">mapToDouble</span><span class="token punctuation">(</span><span class="token class-name">DispatchMsgDTO</span><span class="token operator">::</span><span class="token function">getTotalVolume</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//发送消息</span>
        <span class="token class-name">String</span> jsonMsg <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>msgResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mqFeign<span class="token punctuation">.</span><span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>MQ<span class="token punctuation">.</span>Exchanges</span><span class="token punctuation">.</span><span class="token constant">TRANSPORT_TASK</span><span class="token punctuation">,</span>
                <span class="token class-name">Constants<span class="token punctuation">.</span>MQ<span class="token punctuation">.</span>RoutingKeys</span><span class="token punctuation">.</span><span class="token constant">TRANSPORT_TASK_CREATE</span><span class="token punctuation">,</span> jsonMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>transportOrderIdList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//删除redis中set存储的运单数据</span>
            <span class="token class-name">String</span> setRedisKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>transportOrderDispatchMQListener<span class="token punctuation">.</span><span class="token function">getSetRedisKey</span><span class="token punctuation">(</span>startOrganId<span class="token punctuation">,</span> endOrganId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>setRedisKey<span class="token punctuation">,</span> transportOrderIdList<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-4、消息通知完成车辆计划" tabindex="-1"><a class="header-anchor" href="#_2-2-4、消息通知完成车辆计划" aria-hidden="true">#</a> 2.2.4、消息通知完成车辆计划</h3><p>通过消息的方式通知base微服务，完成车辆计划。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">completeTruckPlan</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TruckPlanDto</span><span class="token punctuation">&gt;</span></span> truckDtoList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//{&quot;ids&quot;:[1,2,3], &quot;created&quot;:123456}</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> msg <span class="token operator">=</span> <span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;ids&quot;</span><span class="token punctuation">,</span> <span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">getFieldValues</span><span class="token punctuation">(</span>truckDtoList<span class="token punctuation">,</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;created&quot;</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> jsonMsg <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//发送消息</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mqFeign<span class="token punctuation">.</span><span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>MQ<span class="token punctuation">.</span>Exchanges</span><span class="token punctuation">.</span><span class="token constant">TRUCK_PLAN</span><span class="token punctuation">,</span>
                <span class="token class-name">Constants<span class="token punctuation">.</span>MQ<span class="token punctuation">.</span>RoutingKeys</span><span class="token punctuation">.</span><span class="token constant">TRUCK_PLAN_COMPLETE</span><span class="token punctuation">,</span> jsonMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-3、xxl-job任务" tabindex="-1"><a class="header-anchor" href="#_2-3、xxl-job任务" aria-hidden="true">#</a> 2.3、xxl-job任务</h2>`,23),P={href:"http://xxl-job.sl-express.com/xxl-job-admin/",target:"_blank",rel:"noopener noreferrer"},F=n("br",null,null,-1),B=n("code",null,"sl-express-ms-dispatch",-1),J=n("br",null,null,-1),K=n("img",{src:k,alt:"",loading:"lazy"},null,-1),z=n("br",null,null,-1),V=n("br",null,null,-1),W=n("img",{src:r,alt:"",loading:"lazy"},null,-1),H=n("br",null,null,-1),Q=n("br",null,null,-1),G=n("img",{src:d,alt:"",loading:"lazy"},null,-1),Y=a('<h2 id="_2-4、测试" tabindex="-1"><a class="header-anchor" href="#_2-4、测试" aria-hidden="true">#</a> 2.4、测试</h2><h3 id="_2-4-1、测试xxl-job" tabindex="-1"><a class="header-anchor" href="#_2-4-1、测试xxl-job" aria-hidden="true">#</a> 2.4.1、测试xxl-job</h3><p>将<code>sl-express-ms-dispatch</code>服务启动，发现在xxl-job中已经注册了服务：<br><img src="'+m+`" alt="" loading="lazy"></p><div class="hint-container danger"><p class="hint-container-title">警告</p><p>在这里一定要注意，注册的这个ip地址与101机器是否能通信，就上面的情况，显然是不能通信的，所以需要需要在配置文件中指定注册的ip地址。<br> 如果可以通信就不需要指定。</p></div><p>指定xxl-job中注册任务的ip地址：</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">xxl</span><span class="token punctuation">:</span>
<span class="token key attr-name">  job</span><span class="token punctuation">:</span>
<span class="token key attr-name">    executor</span><span class="token punctuation">:</span>
<span class="token key attr-name">      ip</span><span class="token punctuation">:</span> <span class="token value attr-value">192.168.150.1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重新启动，这样就可以通信了，如下：<br><img src="`+v+'" alt="" loading="lazy"><br> 点击执行一次，进行测试看是否会触发代码的执行：<br><img src="'+b+'" alt="" loading="lazy"><br> 可以看到已经执行了：<br><img src="'+g+'" alt="" loading="lazy"></p><h3 id="_2-4-2、添加车辆车次" tabindex="-1"><a class="header-anchor" href="#_2-4-2、添加车辆车次" aria-hidden="true">#</a> 2.4.2、添加车辆车次</h3><p>在前面的测试中，查询可用车辆是空的，所以我们需要添加车辆、车次。</p><div class="hint-container info"><p class="hint-container-title">相关信息</p><p>需要将必要的微服务启动，如果已经启动请忽略。如果没有服务，请先在Jenkins中进行部署。<br> docker start sl-express-gateway<br> docker start sl-express-ms-base-service<br> docker start sl-express-ms-transport-service<br> docker start sl-express-ms-web-manager<br> docker start sl-express-ms-driver-service</p></div><p>首先需要在权限系统中添加司机，系统中要求一个车辆至少配置2个司机，所以至少要创建2个司机，为司机完善好排班之后，还需要完善司机的驾驶证信息：</p><blockquote><p>完善司机驾驶证信息需要上传图片，上传图片需要先nacos中的<code>sl-express-ms-web-manager.properties</code>配置oss相关的配置项，否则不能正常上传图片。</p></blockquote><p><img src="'+y+'" alt="" loading="lazy"><br> 为司机设置排班，如果司机休息也是不可以进行调度的：<br><img src="'+T+'" alt="" loading="lazy"><br> 排班：<br><img src="'+f+'" alt="" loading="lazy"><br> 创建车型：<br><img src="'+w+'" alt="" loading="lazy"><br> 新增车辆：<br><img src="'+O+'" alt="" loading="lazy"></p><div class="hint-container danger"><p class="hint-container-title">警告</p><p><strong>请注意：</strong><br> 添加车辆时，需要为车辆设置行驶证信息，否则是无法配置的，配置行驶证信息需要上传图片，上传图片需要先nacos中的<code>sl-express-ms-web-manager.properties</code>配置oss相关的配置项，否则不能正常上传图片。</p></div><p>为司机配置车辆：<br><img src="'+h+'" alt="" loading="lazy"></p><p>为线路添加车次与车辆（确保添加车次是测试数据中转运的路线，否则没有数据可以处理）：<br><img src="'+L+'" alt="" loading="lazy"><br> 另外，一定要注意，设置车次的时间要比当前测试时间+2小时要小才能查询到数据，否则查询不到。</p><h3 id="_2-4-3、完整测试" tabindex="-1"><a class="header-anchor" href="#_2-4-3、完整测试" aria-hidden="true">#</a> 2.4.3、完整测试</h3><p>现在就可以查询到车次数据，通过xxl-job的调度进行测试。<br> 车辆计划数据的状态要为1，调度状态为0，才能获取到车次数据。<br><img src="'+_+'" alt="" loading="lazy"><br> Redis中存在队列数据：<br><img src="'+E+'" alt="" loading="lazy"><br> 获取到数据：<br><img src="'+D+'" alt="" loading="lazy"><br> 调度执行后，redis数据被处理掉了，车辆的计划调度状态也改为了【已调度】状态：<br><img src="'+I+'" alt="" loading="lazy"><br><img src="'+N+`" alt="" loading="lazy"><br> 另外，生成运输任务的消息已经发出了，只是我们还没有监听处理消息，在后面我们将实现对该消息的处理，就可以生成运输任务了。</p><h1 id="_3、运输任务" tabindex="-1"><a class="header-anchor" href="#_3、运输任务" aria-hidden="true">#</a> 3、运输任务</h1><p>运输任务是针对于车辆的一次运输生成的，每一个运输任务都有对应的司机作业单。<br> 例如：张三发了一个从北京金燕龙营业部发往上海浦东航头营业部的快递，它的转运路线是：<code>金燕龙营业部 → 昌平区分拣中心 → 北京转运中心 → 上海转运中心 → 浦东区分拣中心 → 航头营业部</code>，在此次的转运中一共会产生5个运输任务和至少10个司机作业单（一个车辆至少配备2个司机）。<br> 需要注意的是，一个运输任务中包含了多个运单，就是一辆车拉了一车的快件，是一对多的关系。</p><h2 id="_3-1、表结构" tabindex="-1"><a class="header-anchor" href="#_3-1、表结构" aria-hidden="true">#</a> 3.1、表结构</h2><p>运输任务在work微服务中，主要涉及到2张表，分别是：<code>sl_transport_task（运输任务表）</code>、<code>sl_transport_order_task（运输任务与运单关系表）</code>。司机作业单是存储在司机微服务中的<code>sl_driver_job（司机作业单）</code>表中。</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">\`</span>sl_transport_task<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>truck_plan_id<span class="token punctuation">\`</span></span> <span class="token keyword">bigint</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;车辆计划id&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>transport_trips_id<span class="token punctuation">\`</span></span> <span class="token keyword">bigint</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;车次id&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>start_agency_id<span class="token punctuation">\`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;起始机构id&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>end_agency_id<span class="token punctuation">\`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;目的机构id&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>status<span class="token punctuation">\`</span></span> <span class="token keyword">int</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;任务状态，1为待执行（对应 未发车）、2为进行中（对应在途）、3为待确认（保留状态）、4为已完成（对应 已交付）、5为已取消&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>assigned_status<span class="token punctuation">\`</span></span> <span class="token keyword">tinyint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;任务分配状态(1未分配2已分配3待人工分配)&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>loading_status<span class="token punctuation">\`</span></span> <span class="token keyword">int</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;满载状态(1.半载2.满载3.空载)&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>truck_id<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;车辆id&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>cargo_pick_up_picture<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;提货凭证&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>cargo_picture<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;货物照片&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>transport_certificate<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;运回单凭证&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>deliver_picture<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;交付货物照片&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>delivery_latitude<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;提货纬度值&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>delivery_longitude<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;提货经度值&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>deliver_latitude<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;交付纬度值&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>deliver_longitude<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;交付经度值&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>plan_departure_time<span class="token punctuation">\`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;计划发车时间&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>actual_departure_time<span class="token punctuation">\`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;实际发车时间&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>plan_arrival_time<span class="token punctuation">\`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;计划到达时间&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>actual_arrival_time<span class="token punctuation">\`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;实际到达时间&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>mark<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;备注&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>distance<span class="token punctuation">\`</span></span> <span class="token keyword">double</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;距离，单位：米&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>created<span class="token punctuation">\`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;创建时间&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>updated<span class="token punctuation">\`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;更新时间&#39;</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">\`</span>transport_trips_id<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>truck_plan_id<span class="token punctuation">\`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">\`</span>status<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>status<span class="token punctuation">\`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">\`</span>created<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>created<span class="token punctuation">\`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8mb4_general_ci ROW_FORMAT<span class="token operator">=</span>DYNAMIC <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">&#39;运输任务表&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">\`</span>sl_transport_order_task<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>transport_order_id<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;运单id&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>transport_task_id<span class="token punctuation">\`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;运输任务id&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>created<span class="token punctuation">\`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;创建时间&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>updated<span class="token punctuation">\`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;更新时间&#39;</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">\`</span>transport_order_id<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>transport_order_id<span class="token punctuation">\`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">\`</span>transport_task_id<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>transport_task_id<span class="token punctuation">\`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8mb4_general_ci ROW_FORMAT<span class="token operator">=</span>DYNAMIC <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">&#39;运单与运输任务关联表&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">\`</span>sl_driver_job<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>start_agency_id<span class="token punctuation">\`</span></span> <span class="token keyword">bigint</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;起始机构id&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>end_agency_id<span class="token punctuation">\`</span></span> <span class="token keyword">bigint</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;目的机构id&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>status<span class="token punctuation">\`</span></span> <span class="token keyword">int</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;作业状态，1为待执行（对应 待提货）、2为进行中（对应在途）、3为改派（对应 已交付）、4为已完成（对应 已交付）、5为已作废&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>driver_id<span class="token punctuation">\`</span></span> <span class="token keyword">bigint</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;司机id&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>transport_task_id<span class="token punctuation">\`</span></span> <span class="token keyword">bigint</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;运输任务id&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>start_handover<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;提货对接人&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>finish_handover<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;交付对接人&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>plan_departure_time<span class="token punctuation">\`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;计划发车时间&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>actual_departure_time<span class="token punctuation">\`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;实际发车时间&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>plan_arrival_time<span class="token punctuation">\`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;计划到达时间&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>actual_arrival_time<span class="token punctuation">\`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;实际到达时间&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>created<span class="token punctuation">\`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;创建时间&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>updated<span class="token punctuation">\`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;更新时间&#39;</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">\`</span>task_transport_id<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>transport_task_id<span class="token punctuation">\`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">\`</span>created<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>created<span class="token punctuation">\`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8mb4_general_ci ROW_FORMAT<span class="token operator">=</span>DYNAMIC <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">&#39;司机作业单&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-2、编码实现" tabindex="-1"><a class="header-anchor" href="#_3-2、编码实现" aria-hidden="true">#</a> 3.2、编码实现</h2><h3 id="_3-2-1、监听消息" tabindex="-1"><a class="header-anchor" href="#_3-2-1、监听消息" aria-hidden="true">#</a> 3.2.1、监听消息</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">DriverJobFeign</span> driverJobFeign<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">TruckPlanFeign</span> truckPlanFeign<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">TransportLineFeign</span> transportLineFeign<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">TransportTaskService</span> transportTaskService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">TransportOrderTaskService</span> transportOrderTaskService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">TransportOrderService</span> transportOrderService<span class="token punctuation">;</span>

	<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
            value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token class-name">Constants<span class="token punctuation">.</span>MQ<span class="token punctuation">.</span>Queues</span><span class="token punctuation">.</span><span class="token constant">WORK_TRANSPORT_TASK_CREATE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token class-name">Constants<span class="token punctuation">.</span>MQ<span class="token punctuation">.</span>Exchanges</span><span class="token punctuation">.</span><span class="token constant">TRANSPORT_TASK</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">ExchangeTypes</span><span class="token punctuation">.</span><span class="token constant">TOPIC</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            key <span class="token operator">=</span> <span class="token class-name">Constants<span class="token punctuation">.</span>MQ<span class="token punctuation">.</span>RoutingKeys</span><span class="token punctuation">.</span><span class="token constant">TRANSPORT_TASK_CREATE</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenTransportTaskMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//解析消息 {&quot;driverIds&quot;:[123,345], &quot;truckPlanId&quot;:456, &quot;truckId&quot;:1210114964812075008,&quot;totalVolume&quot;:4.2,&quot;endOrganId&quot;:90001,&quot;totalWeight&quot;:7,&quot;transportOrderIdList&quot;:[320733749248,420733749248],&quot;startOrganId&quot;:100280}</span>
        <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">parseObj</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取到司机id列表</span>
        <span class="token class-name">JSONArray</span> driverIds <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getJSONArray</span><span class="token punctuation">(</span><span class="token string">&quot;driverIds&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 分配状态</span>
        <span class="token class-name">TransportTaskAssignedStatus</span> assignedStatus <span class="token operator">=</span> <span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>driverIds<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">TransportTaskAssignedStatus</span><span class="token punctuation">.</span><span class="token constant">MANUAL_DISTRIBUTED</span> <span class="token operator">:</span> <span class="token class-name">TransportTaskAssignedStatus</span><span class="token punctuation">.</span><span class="token constant">DISTRIBUTED</span><span class="token punctuation">;</span>
        <span class="token comment">//创建运输任务</span>
        <span class="token class-name">Long</span> transportTaskId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createTransportTask</span><span class="token punctuation">(</span>jsonObject<span class="token punctuation">,</span> assignedStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>driverIds<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;生成司机作业单，司机列表为空，需要手动设置司机作业单 -&gt; msg = {}&quot;</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> driverId <span class="token operator">:</span> driverIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//生成司机作业单</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>driverJobFeign<span class="token punctuation">.</span><span class="token function">createDriverJob</span><span class="token punctuation">(</span>transportTaskId<span class="token punctuation">,</span> <span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span>driverId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-2、创建运输任务" tabindex="-1"><a class="header-anchor" href="#_3-2-2、创建运输任务" aria-hidden="true">#</a> 3.2.2、创建运输任务</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">createTransportTask</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span> jsonObject<span class="token punctuation">,</span> <span class="token class-name">TransportTaskAssignedStatus</span> assignedStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//根据车辆计划id查询预计发车时间和预计到达时间</span>
        <span class="token class-name">Long</span> truckPlanId <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token string">&quot;truckPlanId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TruckPlanDto</span> truckPlanDto <span class="token operator">=</span> truckPlanFeign<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>truckPlanId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//创建运输任务</span>
        <span class="token class-name">TransportTaskEntity</span> transportTaskEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransportTaskEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        transportTaskEntity<span class="token punctuation">.</span><span class="token function">setTruckPlanId</span><span class="token punctuation">(</span>jsonObject<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token string">&quot;truckPlanId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        transportTaskEntity<span class="token punctuation">.</span><span class="token function">setTruckId</span><span class="token punctuation">(</span>jsonObject<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token string">&quot;truckId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        transportTaskEntity<span class="token punctuation">.</span><span class="token function">setStartAgencyId</span><span class="token punctuation">(</span>jsonObject<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token string">&quot;startOrganId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        transportTaskEntity<span class="token punctuation">.</span><span class="token function">setEndAgencyId</span><span class="token punctuation">(</span>jsonObject<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token string">&quot;endOrganId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        transportTaskEntity<span class="token punctuation">.</span><span class="token function">setTransportTripsId</span><span class="token punctuation">(</span>jsonObject<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token string">&quot;transportTripsId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        transportTaskEntity<span class="token punctuation">.</span><span class="token function">setAssignedStatus</span><span class="token punctuation">(</span>assignedStatus<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//任务分配状态</span>
        transportTaskEntity<span class="token punctuation">.</span><span class="token function">setPlanDepartureTime</span><span class="token punctuation">(</span>truckPlanDto<span class="token punctuation">.</span><span class="token function">getPlanDepartureTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//计划发车时间</span>
        transportTaskEntity<span class="token punctuation">.</span><span class="token function">setPlanArrivalTime</span><span class="token punctuation">(</span>truckPlanDto<span class="token punctuation">.</span><span class="token function">getPlanArrivalTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//计划到达时间</span>
        transportTaskEntity<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">TransportTaskStatus</span><span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置运输任务状态</span>

        <span class="token comment">// TODO 完善满载状态</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>jsonObject<span class="token punctuation">.</span><span class="token function">getJSONArray</span><span class="token punctuation">(</span><span class="token string">&quot;transportOrderIdList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            transportTaskEntity<span class="token punctuation">.</span><span class="token function">setLoadingStatus</span><span class="token punctuation">(</span><span class="token class-name">TransportTaskLoadingStatus</span><span class="token punctuation">.</span><span class="token constant">EMPTY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            transportTaskEntity<span class="token punctuation">.</span><span class="token function">setLoadingStatus</span><span class="token punctuation">(</span><span class="token class-name">TransportTaskLoadingStatus</span><span class="token punctuation">.</span><span class="token constant">FULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//查询路线距离</span>
        <span class="token class-name">TransportLineSearchDTO</span> transportLineSearchDTO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransportLineSearchDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        transportLineSearchDTO<span class="token punctuation">.</span><span class="token function">setPage</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        transportLineSearchDTO<span class="token punctuation">.</span><span class="token function">setPageSize</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        transportLineSearchDTO<span class="token punctuation">.</span><span class="token function">setStartOrganId</span><span class="token punctuation">(</span>transportTaskEntity<span class="token punctuation">.</span><span class="token function">getStartAgencyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        transportLineSearchDTO<span class="token punctuation">.</span><span class="token function">setEndOrganId</span><span class="token punctuation">(</span>transportTaskEntity<span class="token punctuation">.</span><span class="token function">getEndAgencyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PageResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TransportLineDTO</span><span class="token punctuation">&gt;</span></span> transportLineResponse <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>transportLineFeign<span class="token punctuation">.</span><span class="token function">queryPageList</span><span class="token punctuation">(</span>transportLineSearchDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TransportLineDTO</span> transportLineDTO <span class="token operator">=</span> <span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span>transportLineResponse<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>transportLineDTO<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//设置距离</span>
            transportTaskEntity<span class="token punctuation">.</span><span class="token function">setDistance</span><span class="token punctuation">(</span>transportLineDTO<span class="token punctuation">.</span><span class="token function">getDistance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//保存数据</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>transportTaskService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>transportTaskEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//创建运输任务与运单之间的关系</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createTransportOrderTask</span><span class="token punctuation">(</span>transportTaskEntity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> jsonObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> transportTaskEntity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-3、创建运单关系" tabindex="-1"><a class="header-anchor" href="#_3-2-3、创建运单关系" aria-hidden="true">#</a> 3.2.3、创建运单关系</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createTransportOrderTask</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Long</span> transportTaskId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">JSONObject</span> jsonObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//创建运输任务与运单之间的关系</span>
        <span class="token class-name">JSONArray</span> transportOrderIdList <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getJSONArray</span><span class="token punctuation">(</span><span class="token string">&quot;transportOrderIdList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>transportOrderIdList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//将运单id列表转成运单实体列表</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TransportOrderTaskEntity</span><span class="token punctuation">&gt;</span></span> resultList <span class="token operator">=</span> transportOrderIdList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>o <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token class-name">TransportOrderTaskEntity</span> transportOrderTaskEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransportOrderTaskEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    transportOrderTaskEntity<span class="token punctuation">.</span><span class="token function">setTransportTaskId</span><span class="token punctuation">(</span>transportTaskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    transportOrderTaskEntity<span class="token punctuation">.</span><span class="token function">setTransportOrderId</span><span class="token punctuation">(</span><span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toStr</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> transportOrderTaskEntity<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//批量保存运输任务与运单的关联表</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>transportOrderTaskService<span class="token punctuation">.</span><span class="token function">batchSaveTransportOrder</span><span class="token punctuation">(</span>resultList<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//批量标记运单为已调度状态</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TransportOrderEntity</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> transportOrderIdList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>o <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token class-name">TransportOrderEntity</span> transportOrderEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransportOrderEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    transportOrderEntity<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toStr</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//状态设置为已调度</span>
                    transportOrderEntity<span class="token punctuation">.</span><span class="token function">setSchedulingStatus</span><span class="token punctuation">(</span><span class="token class-name">TransportOrderSchedulingStatus</span><span class="token punctuation">.</span><span class="token constant">SCHEDULED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> transportOrderEntity<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>transportOrderService<span class="token punctuation">.</span><span class="token function">updateBatchById</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-3、测试" tabindex="-1"><a class="header-anchor" href="#_3-3、测试" aria-hidden="true">#</a> 3.3、测试</h2><p>基于调度中心进行测试，需要<code>sl-express-ms-dispatch-service</code>、<code>sl-express-ms-work-service</code>、sl-<code>express-ms-oms-service</code>服务跑起来进行测试。<br> 可以看到队列已经绑定到交换机：<br><img src="`+S+'" alt="" loading="lazy"><br> 经过测试发现已经生成了运输任务：<br><img src="'+M+'" alt="" loading="lazy"><br> 运输任务与运单的关系数据：<br><img src="'+A+'" alt="" loading="lazy"><br> 生成的司机作业单：<br><img src="'+C+`" alt="" loading="lazy"><br> 司机作业单对应的是两条数据，每个司机会有对应的一条作业单。</p><h2 id="_3-4、根据运输任务查询运单" tabindex="-1"><a class="header-anchor" href="#_3-4、根据运输任务查询运单" aria-hidden="true">#</a> 3.4、根据运输任务查询运单</h2><p>在TransportOrderService中，需要根据运输任务id查询运单列表，下面我们来完善pageQueryByTaskId()方法：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * 根据运输任务id分页查询运单信息
     *
     * <span class="token keyword">@param</span> <span class="token parameter">page</span>             页码
     * <span class="token keyword">@param</span> <span class="token parameter">pageSize</span>         页面大小
     * <span class="token keyword">@param</span> <span class="token parameter">taskId</span>           运输任务id
     * <span class="token keyword">@param</span> <span class="token parameter">transportOrderId</span> 运单id
     * <span class="token keyword">@return</span> 运单对象分页数据
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">PageResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TransportOrderDTO</span><span class="token punctuation">&gt;</span></span> <span class="token function">pageQueryByTaskId</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> page<span class="token punctuation">,</span> <span class="token class-name">Integer</span> pageSize<span class="token punctuation">,</span> <span class="token class-name">String</span> taskId<span class="token punctuation">,</span> <span class="token class-name">String</span> transportOrderId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//构建分页查询条件</span>
        <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TransportOrderTaskEntity</span><span class="token punctuation">&gt;</span></span> transportOrderTaskPage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TransportOrderTaskEntity</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TransportOrderTaskEntity</span><span class="token operator">::</span><span class="token function">getTransportTaskId</span><span class="token punctuation">,</span> taskId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">like</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>transportOrderId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TransportOrderTaskEntity</span><span class="token operator">::</span><span class="token function">getTransportOrderId</span><span class="token punctuation">,</span> transportOrderId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orderByDesc</span><span class="token punctuation">(</span><span class="token class-name">TransportOrderTaskEntity</span><span class="token operator">::</span><span class="token function">getCreated</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//根据运输任务id、运单id查询运输任务与运单关联关系表</span>
        <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TransportOrderTaskEntity</span><span class="token punctuation">&gt;</span></span> pageResult <span class="token operator">=</span> transportOrderTaskMapper<span class="token punctuation">.</span><span class="token function">selectPage</span><span class="token punctuation">(</span>transportOrderTaskPage<span class="token punctuation">,</span> queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>pageResult<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PageResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>pageResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//根据运单id查询运单，并转化为dto</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> transportOrderIds <span class="token operator">=</span> pageResult<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">TransportOrderTaskEntity</span><span class="token operator">::</span><span class="token function">getTransportOrderId</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TransportOrderEntity</span><span class="token punctuation">&gt;</span></span> entities <span class="token operator">=</span> baseMapper<span class="token punctuation">.</span><span class="token function">selectBatchIds</span><span class="token punctuation">(</span>transportOrderIds<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//构建分页结果</span>
        <span class="token keyword">return</span> <span class="token class-name">PageResponse</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">copyToList</span><span class="token punctuation">(</span>entities<span class="token punctuation">,</span> <span class="token class-name">TransportOrderDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> page<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> pageResult<span class="token punctuation">.</span><span class="token function">getPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pageResult<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="_4、司机入库" tabindex="-1"><a class="header-anchor" href="#_4、司机入库" aria-hidden="true">#</a> 4、司机入库</h1><p>司机入库业务是非常核心的业务，司机入库就意味着车辆入库，也就是此次运输结束，需要开始下一个运输、结束此次运输任务、完成司机作业单等操作。<br> 司机入库的流程是在<code>sl-express-ms-driver-service</code>微服务中完成的，基本的逻辑已经实现，现在需要我们实现运单向下一个节点的转运，即：开始新的转运工作。</p><h2 id="_4-1、业务实现" tabindex="-1"><a class="header-anchor" href="#_4-1、业务实现" aria-hidden="true">#</a> 4.1、业务实现</h2><p>业务代码是在<code>sl-express-ms-driver-service</code>微服务中。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * 司机入库，修改运单的当前节点和下个节点 以及 修改运单为待调度状态，结束运输任务
     *
     * <span class="token keyword">@param</span> <span class="token parameter">driverDeliverDTO</span> 司机作业单id
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@GlobalTransactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">intoStorage</span><span class="token punctuation">(</span><span class="token class-name">DriverDeliverDTO</span> driverDeliverDTO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//1.司机作业单，获取运输任务id</span>
        <span class="token class-name">DriverJobEntity</span> driverJob <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>driverDeliverDTO<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>driverJob<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span><span class="token class-name">DriverExceptionEnum</span><span class="token punctuation">.</span><span class="token constant">DRIVER_JOB_NOT_FOUND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">notEqual</span><span class="token punctuation">(</span>driverJob<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DriverJobStatus</span><span class="token punctuation">.</span><span class="token constant">PROCESSING</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span><span class="token class-name">DriverExceptionEnum</span><span class="token punctuation">.</span><span class="token constant">DRIVER_JOB_STATUS_UNKNOWN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//运输任务id</span>
        <span class="token class-name">Long</span> transportTaskId <span class="token operator">=</span> driverJob<span class="token punctuation">.</span><span class="token function">getTransportTaskId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2.更新运输任务状态为完成</span>
        <span class="token comment">//加锁，只能有一个司机操作，任务已经完成的话，就不需要进行流程流转，只要完成司机自己的作业单即可</span>
        <span class="token class-name">String</span> lockRedisKey <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">LOCKS</span><span class="token punctuation">.</span><span class="token constant">DRIVER_JOB_LOCK_PREFIX</span> <span class="token operator">+</span> transportTaskId<span class="token punctuation">;</span>
        <span class="token comment">//2.1获取锁</span>
        <span class="token class-name">RLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redissonClient<span class="token punctuation">.</span><span class="token function">getFairLock</span><span class="token punctuation">(</span>lockRedisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//2.2获取到锁</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//2.3查询运输任务</span>
                <span class="token class-name">TransportTaskDTO</span> transportTask <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>transportTaskFeign<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>transportTaskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//2.4判断任务是否已结束，不能再修改流转</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">equalsAny</span><span class="token punctuation">(</span>transportTask<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TransportTaskStatus</span><span class="token punctuation">.</span><span class="token constant">CANCELLED</span><span class="token punctuation">,</span> <span class="token class-name">TransportTaskStatus</span><span class="token punctuation">.</span><span class="token constant">COMPLETED</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//2.5修改运单流转节点，修改当前节点和下一个节点</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>transportOrderFeign<span class="token punctuation">.</span><span class="token function">updateByTaskId</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>transportTaskId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">//2.6结束运输任务</span>
                    <span class="token class-name">TransportTaskCompleteDTO</span> transportTaskCompleteDTO <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>driverDeliverDTO<span class="token punctuation">,</span> <span class="token class-name">TransportTaskCompleteDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    transportTaskCompleteDTO<span class="token punctuation">.</span><span class="token function">setTransportTaskId</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>transportTaskId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>transportTaskFeign<span class="token punctuation">.</span><span class="token function">completeTransportTask</span><span class="token punctuation">(</span>transportTaskCompleteDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span><span class="token class-name">DriverExceptionEnum</span><span class="token punctuation">.</span><span class="token constant">DRIVER_JOB_INTO_STORAGE_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//3.修改所有与运输任务id相关联的司机作业单状态和实际到达时间</span>
        <span class="token class-name">LambdaUpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DriverJobEntity</span><span class="token punctuation">&gt;</span></span> updateWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaUpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        updateWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>transportTaskId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DriverJobEntity</span><span class="token operator">::</span><span class="token function">getTransportTaskId</span><span class="token punctuation">,</span> transportTaskId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">DriverJobEntity</span><span class="token operator">::</span><span class="token function">getStatus</span><span class="token punctuation">,</span> <span class="token class-name">DriverJobStatus</span><span class="token punctuation">.</span><span class="token constant">DELIVERED</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">DriverJobEntity</span><span class="token operator">::</span><span class="token function">getActualArrivalTime</span><span class="token punctuation">,</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>updateWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，大部分的业务逻辑已经时间，我们只需要实现<code>transportOrderFeign</code>中的<code>updateByTaskId()</code>方法，也就是实现work微服务中<code>com.sl.ms.work.service.impl.TransportOrderServiceImpl#updateByTaskId()</code>的方法即可。</p><h2 id="_4-2、运单流转" tabindex="-1"><a class="header-anchor" href="#_4-2、运单流转" aria-hidden="true">#</a> 4.2、运单流转</h2><p>实现的关键点：</p><ul><li>设置当前所在网点id为下一个网点id（司机入库，说明已经到达目的地）</li><li>解析完整运输链路，找出下一个转运节点，需要考虑到拒收、最后一个节点等情况</li><li>发送消息通知，参与新的调度或生成快递员的取派件任务</li><li>发送物流信息的消息（先TODO）</li></ul><p>代码实现：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">updateByTaskId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> taskId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//通过运输任务查询运单id列表</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> transportOrderIdList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>transportTaskService<span class="token punctuation">.</span><span class="token function">queryTransportOrderIdListById</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>transportOrderIdList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//查询运单列表</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TransportOrderEntity</span><span class="token punctuation">&gt;</span></span> transportOrderList <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">listByIds</span><span class="token punctuation">(</span>transportOrderIdList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TransportOrderEntity</span> transportOrder <span class="token operator">:</span> transportOrderList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//获取将发往的目的地机构</span>
            <span class="token class-name">OrganDTO</span> organDTO <span class="token operator">=</span> organFeign<span class="token punctuation">.</span><span class="token function">queryById</span><span class="token punctuation">(</span>transportOrder<span class="token punctuation">.</span><span class="token function">getNextAgencyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//构建消息实体类</span>
            <span class="token class-name">String</span> info <span class="token operator">=</span> <span class="token class-name">CharSequenceUtil</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;快件到达【{}】&quot;</span><span class="token punctuation">,</span> organDTO<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> transportInfoMsg <span class="token operator">=</span> <span class="token class-name">TransportInfoMsg</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">transportOrderId</span><span class="token punctuation">(</span>transportOrder<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//运单id</span>
                    <span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token string">&quot;运送中&quot;</span><span class="token punctuation">)</span><span class="token comment">//消息状态</span>
                    <span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token comment">//消息详情</span>
                    <span class="token punctuation">.</span><span class="token function">created</span><span class="token punctuation">(</span><span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//创建时间</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//发送运单跟踪消息</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>mqFeign<span class="token punctuation">.</span><span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>MQ<span class="token punctuation">.</span>Exchanges</span><span class="token punctuation">.</span><span class="token constant">TRANSPORT_INFO</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>MQ<span class="token punctuation">.</span>RoutingKeys</span><span class="token punctuation">.</span><span class="token constant">TRANSPORT_INFO_APPEND</span><span class="token punctuation">,</span> transportInfoMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//设置当前所在机构id为下一个机构id</span>
            transportOrder<span class="token punctuation">.</span><span class="token function">setCurrentAgencyId</span><span class="token punctuation">(</span>transportOrder<span class="token punctuation">.</span><span class="token function">getNextAgencyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//解析完整的运输链路，找到下一个机构id</span>
            <span class="token class-name">String</span> transportLine <span class="token operator">=</span> transportOrder<span class="token punctuation">.</span><span class="token function">getTransportLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">parseObj</span><span class="token punctuation">(</span>transportLine<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Long</span> nextAgencyId <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
            <span class="token class-name">JSONArray</span> nodeList <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getJSONArray</span><span class="token punctuation">(</span><span class="token string">&quot;nodeList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//这里反向循环主要是考虑到拒收的情况，路线中会存在相同的节点，始终可以查找到后面的节点</span>
            <span class="token comment">//正常：A B C D E ，拒收：A B C D E D C B A</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> nodeList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">JSONObject</span> node <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">)</span> nodeList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Long</span> agencyId <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token string">&quot;bid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>agencyId<span class="token punctuation">,</span> transportOrder<span class="token punctuation">.</span><span class="token function">getCurrentAgencyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> nodeList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">//已经是最后一个节点了，也就是到最后一个机构了</span>
                        nextAgencyId <span class="token operator">=</span> agencyId<span class="token punctuation">;</span>
                        transportOrder<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">TransportOrderStatus</span><span class="token punctuation">.</span><span class="token constant">ARRIVED_END</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//发送消息更新状态</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendUpdateStatusMsg</span><span class="token punctuation">(</span><span class="token class-name">ListUtil</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span>transportOrder<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TransportOrderStatus</span><span class="token punctuation">.</span><span class="token constant">ARRIVED_END</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment">//后面还有节点</span>
                        nextAgencyId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">)</span> nodeList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token string">&quot;bid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//设置运单状态为待调度</span>
                        transportOrder<span class="token punctuation">.</span><span class="token function">setSchedulingStatus</span><span class="token punctuation">(</span><span class="token class-name">TransportOrderSchedulingStatus</span><span class="token punctuation">.</span><span class="token constant">TO_BE_SCHEDULED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//设置下一个节点id</span>
            transportOrder<span class="token punctuation">.</span><span class="token function">setNextAgencyId</span><span class="token punctuation">(</span>nextAgencyId<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//如果运单没有到达终点，需要发送消息到运单调度的交换机中</span>
            <span class="token comment">//如果已经到达最终网点，需要发送消息，进行分配快递员作业</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">notEqual</span><span class="token punctuation">(</span>transportOrder<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TransportOrderStatus</span><span class="token punctuation">.</span><span class="token constant">ARRIVED_END</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendTransportOrderMsgToDispatch</span><span class="token punctuation">(</span>transportOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//发送消息生成派件任务</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendDispatchTaskMsgToDispatch</span><span class="token punctuation">(</span>transportOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//批量更新运单</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">updateBatchById</span><span class="token punctuation">(</span>transportOrderList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-3、测试" tabindex="-1"><a class="header-anchor" href="#_4-3、测试" aria-hidden="true">#</a> 4.3、测试</h2><p>编写测试用例：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">class</span> <span class="token class-name">TransportOrderServiceTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">TransportOrderService</span> transportOrderService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">updateByTaskId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//设置运输任务id</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>transportOrderService<span class="token punctuation">.</span><span class="token function">updateByTaskId</span><span class="token punctuation">(</span><span class="token number">1568165717632933889L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试之前，观察当前机构、下个机构：<br><img src="`+R+'" alt="" loading="lazy"><br> 测试之后，发现调度状态、当前机构、下个机构都已经更新，并且会发送消息再次进行调度：<br><img src="'+U+'" alt="" loading="lazy"><br> 消息内容（<code>sl.queue.dispatch.mergeTransportOrder</code>）：<br><img src="'+q+'" alt="" loading="lazy"></p><h1 id="_5、练习" tabindex="-1"><a class="header-anchor" href="#_5、练习" aria-hidden="true">#</a> 5、练习</h1><p>难度系数：★★★☆☆<br> 需求：阅读司机微服务中的【司机出库】业务功能，主要阅读代码逻辑如下：</p><ul><li>理解多个司机只能有一个更新运单状态，其他只是可以修改自己的作业单状态</li><li>使用分布式事务确保业务的一致性</li></ul><h1 id="_6、面试连环问" tabindex="-1"><a class="header-anchor" href="#_6、面试连环问" aria-hidden="true">#</a> 6、面试连环问</h1><div class="hint-container info"><p class="hint-container-title">相关信息</p><p>面试官问：</p><ul><li>能说一下xxl-job的分片式调度是在什么场景下使用的吗？这样做的好处是什么？</li><li>不同的运单流转节点是不一样的，你们如何将运单合并？如何确保redis的高可用？</li><li>你们系统中，车辆、车次和路线之间是什么关系？车辆有司机数量限制吗？</li></ul></div>',57);function X($,Z){const t=e("ExternalLinkIcon");return o(),c("div",null,[j,n("p",null,[s("编写完任务调度代码之后，需要在xxl-job中创建定时任务。地址："),n("a",P,[s("http://xxl-job.sl-express.com/xxl-job-admin/"),l(t)]),F,s(" 第一步，设置执行器，AppName为："),B,J,K,z,s(" 第二步，创建任务，任务的分发方式为分片式调度（每5分钟执行一次）："),V,W,H,s(" 创建完成："),Q,G]),Y])}const an=p(x,[["render",X],["__file","day08-智能调度之运输任务.html.vue"]]);export{an as default};
