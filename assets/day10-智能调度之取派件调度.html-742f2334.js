import{_ as n}from"./plugin-vue_export-helper-c27b6911.js";import{o as s,c as a,e as t}from"./app-5f6064b2.js";const p="/assets/image-20240407183435224-163-4eae522d.gif",e="/assets/image-20240407183435273-331-5a595dbc.png",c="/assets/image-20240407183435273-332-230e87b0.png",o="/assets/image-20240407183435273-333-86747eed.svg",i="/assets/image-20240407183435273-334-bded9767.svg",l="/assets/image-20240407183435273-335-df0f60b9.svg",u="/assets/image-20240407183435273-336-228d5843.svg",k="/assets/image-20240407183435274-337-ce88ac79.png",r="/assets/image-20240407183435274-338-5cacbfc1.png",d="/assets/image-20240407183435274-339-abc37b6c.png",m="/assets/image-20240407183435274-340-1b64152f.png",v="/assets/image-20240407183435274-341-f71f83cc.png",b="/assets/image-20240407183435274-342-727d9fe5.png",g="/assets/image-20240407183435274-343-4b97e72b.png",y="/assets/image-20240407183435275-344-26d9e085.png",h="/assets/image-20240407183435275-345-0749a71c.png",T="/assets/image-20240407183435275-346-9e1ac888.png",f={},D=t('<h1 id="课程安排" tabindex="-1"><a class="header-anchor" href="#课程安排" aria-hidden="true">#</a> 课程安排</h1><ul><li>了解快递员取派件任务需求</li><li>递员取派件任务相关功能开发</li><li>调度中心任务调度</li><li>整体业务功能测试</li></ul><h1 id="_1、背景说明" tabindex="-1"><a class="header-anchor" href="#_1、背景说明" aria-hidden="true">#</a> 1、背景说明</h1><p>通过前面的学习，可以通过作业范围来确定网点或快递员，下面要做的事情就是需要为快递员生成取派件任务，这样快递员才能够进行相关的取件或派件作业。<br><img src="'+p+'" alt="" loading="lazy"></p><h1 id="_2、需求分析" tabindex="-1"><a class="header-anchor" href="#_2、需求分析" aria-hidden="true">#</a> 2、需求分析</h1><p>快递员在登录到APP后，可以查看取派件任务列表：<br><img src="'+e+'" alt="" loading="lazy"><br><img src="'+c+'" alt="" loading="lazy"><br> 具体需求参见《快递员端产品》文档。</p><h1 id="_3、实现分析" tabindex="-1"><a class="header-anchor" href="#_3、实现分析" aria-hidden="true">#</a> 3、实现分析</h1><h2 id="_3-1、表结构" tabindex="-1"><a class="header-anchor" href="#_3-1、表结构" aria-hidden="true">#</a> 3.1、表结构</h2><p>对于快递员的取件和派件动作，除了类型不同外其他的属性基本都是一样的，所以我们可以将存储在一张表中。<br> 取派件任务存储在sl_work数据库中。</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>sl_pickup_dispatch_task<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>\n  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>order_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;关联订单id&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>task_type<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;任务类型，1为取件任务，2为派件任务&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span> <span class="token keyword">int</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;任务状态，1为新任务、2为已完成、3为已取消&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>sign_status<span class="token punctuation">`</span></span> <span class="token keyword">int</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;0&#39;</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;签收状态(0为未签收, 1为已签收，2为拒收)&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>sign_recipient<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;0&#39;</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;签收人，1本人，2代收&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>agency_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;网点ID&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>courier_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;快递员ID&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>estimated_start_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;预计取/派件开始时间&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>actual_start_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;实际开始时间&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>estimated_end_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;预计完成时间&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>actual_end_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;实际完成时间&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>cancel_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;取消时间&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>cancel_reason<span class="token punctuation">`</span></span> <span class="token keyword">int</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;取消原因&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>cancel_reason_description<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> armscii8 <span class="token keyword">COLLATE</span> armscii8_general_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;取消原因具体描述&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>assigned_status<span class="token punctuation">`</span></span> <span class="token keyword">int</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;任务分配状态(1未分配2已分配3待人工分配)&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>mark<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;备注&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>created<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;创建时间&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>updated<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;更新时间&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>is_deleted<span class="token punctuation">`</span></span> <span class="token keyword">int</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;0&#39;</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;删除：0-否，1-是&#39;</span><span class="token punctuation">,</span>\n  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">,</span>\n  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>order_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>order_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">,</span>\n  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>created<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>created<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">,</span>\n  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>task_type<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>task_type<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">,</span>\n  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>courier_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>courier_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>\n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8mb4_general_ci ROW_FORMAT<span class="token operator">=</span>DYNAMIC <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">&#39;取件、派件任务信息表&#39;</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-2、业务流程" tabindex="-1"><a class="header-anchor" href="#_3-2、业务流程" aria-hidden="true">#</a> 3.2、业务流程</h2><h3 id="_3-2-1、取件任务流程" tabindex="-1"><a class="header-anchor" href="#_3-2-1、取件任务流程" aria-hidden="true">#</a> 3.2.1、取件任务流程</h3><p>用户在下单后，订单微服务会发消息出来，消息会在dispatch微服务中进行调度计算，最终会向work微服务发送消息，用于生成快递员的取件任务。<br><img src="'+o+'" alt="" loading="lazy"><br><img src="'+i+'" alt="" loading="lazy"><br> 派件任务会在两个场景下生成：</p><ul><li>场景一，司机入库时，运单流转到最后一个节点，需要快递员派件</li><li>场景二，发件人与收件人的服务网点是同一个网点时，无需转运，直接生成派件任务</li></ul><p>场景一：<br><img src="'+l+'" alt="" loading="lazy"><br><img src="'+u+`" alt="" loading="lazy"><br> 针对于取派件任务进行相应的数据管理，下面我们将逐一进行实现。</p><h2 id="_4-1、新增取派件任务" tabindex="-1"><a class="header-anchor" href="#_4-1、新增取派件任务" aria-hidden="true">#</a> 4.1、新增取派件任务</h2><p>新增取派件任务不对外开放，所以在Controller中是没有方法定义的，只是在消息处理中进行调用生成任务。</p><h3 id="_4-1-1、定义方法" tabindex="-1"><a class="header-anchor" href="#_4-1-1、定义方法" aria-hidden="true">#</a> 4.1.1、定义方法</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * 新增取派件任务
     *
     * <span class="token keyword">@param</span> <span class="token parameter">taskPickupDispatch</span> 取派件任务信息
     * <span class="token keyword">@return</span> 取派件任务信息
     */</span>
    <span class="token class-name">PickupDispatchTaskEntity</span> <span class="token function">saveTaskPickupDispatch</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskEntity</span> taskPickupDispatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-1-2、实现方法" tabindex="-1"><a class="header-anchor" href="#_4-1-2、实现方法" aria-hidden="true">#</a> 4.1.2、实现方法</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">PickupDispatchTaskEntity</span> <span class="token function">saveTaskPickupDispatch</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskEntity</span> taskPickupDispatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 设置任务状态为新任务</span>
        taskPickupDispatch<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskStatus</span><span class="token punctuation">.</span><span class="token constant">NEW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>taskPickupDispatch<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//TODO 同步快递员任务到es</span>

            <span class="token comment">//TODO 生成运单跟踪消息和快递员端取件/派件消息通知</span>
            <span class="token keyword">return</span> taskPickupDispatch<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span><span class="token class-name">WorkExceptionEnum</span><span class="token punctuation">.</span><span class="token constant">PICKUP_DISPATCH_TASK_SAVE_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-2、分页查询取派件任务" tabindex="-1"><a class="header-anchor" href="#_4-2、分页查询取派件任务" aria-hidden="true">#</a> 4.2、分页查询取派件任务</h2><h3 id="_4-2-1、controller" tabindex="-1"><a class="header-anchor" href="#_4-2-1、controller" aria-hidden="true">#</a> 4.2.1、Controller</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;page&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;分页查询&quot;</span><span class="token punctuation">,</span> notes <span class="token operator">=</span> <span class="token string">&quot;获取取派件任务分页数据&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">PageResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PickupDispatchTaskDTO</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByPage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">PickupDispatchTaskPageQueryDTO</span> dto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pickupDispatchTaskService<span class="token punctuation">.</span><span class="token function">findByPage</span><span class="token punctuation">(</span>dto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-2、service" tabindex="-1"><a class="header-anchor" href="#_4-2-2、service" aria-hidden="true">#</a> 4.2.2、Service</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * 分页查询取派件任务
     *
     * <span class="token keyword">@param</span> <span class="token parameter">dto</span> 查询条件
     * <span class="token keyword">@return</span> 分页结果
     */</span>
    <span class="token class-name">PageResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PickupDispatchTaskDTO</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByPage</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskPageQueryDTO</span> dto<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-3、serviceimpl" tabindex="-1"><a class="header-anchor" href="#_4-2-3、serviceimpl" aria-hidden="true">#</a> 4.2.3、ServiceImpl</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * 分页查询取派件任务
     *
     * <span class="token keyword">@param</span> <span class="token parameter">dto</span> 查询条件
     * <span class="token keyword">@return</span> 分页结果
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">PageResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PickupDispatchTaskDTO</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByPage</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskPageQueryDTO</span> dto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//1.构造条件</span>
        <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token punctuation">&gt;</span></span> iPage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dto<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token punctuation">&gt;</span></span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">like</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">,</span> dto<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">like</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getOrderId</span><span class="token punctuation">,</span> dto<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getAgencyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getAgencyId</span><span class="token punctuation">,</span> dto<span class="token punctuation">.</span><span class="token function">getAgencyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getCourierId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getCourierId</span><span class="token punctuation">,</span> dto<span class="token punctuation">.</span><span class="token function">getCourierId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getTaskType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getTaskType</span><span class="token punctuation">,</span> dto<span class="token punctuation">.</span><span class="token function">getTaskType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getStatus</span><span class="token punctuation">,</span> dto<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getAssignedStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getAssignedStatus</span><span class="token punctuation">,</span> dto<span class="token punctuation">.</span><span class="token function">getAssignedStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getSignStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getSignStatus</span><span class="token punctuation">,</span> dto<span class="token punctuation">.</span><span class="token function">getSignStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getIsDeleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getIsDeleted</span><span class="token punctuation">,</span> dto<span class="token punctuation">.</span><span class="token function">getIsDeleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getMinEstimatedEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getEstimatedEndTime</span><span class="token punctuation">,</span> dto<span class="token punctuation">.</span><span class="token function">getMinEstimatedEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dto<span class="token punctuation">.</span><span class="token function">getMaxEstimatedEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getMinActualEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getActualEndTime</span><span class="token punctuation">,</span> dto<span class="token punctuation">.</span><span class="token function">getMinActualEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dto<span class="token punctuation">.</span><span class="token function">getMaxActualEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orderByDesc</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getUpdated</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2.分页查询</span>
        <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">page</span><span class="token punctuation">(</span>iPage<span class="token punctuation">,</span> queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3.实体类转为dto</span>
        <span class="token keyword">return</span> <span class="token class-name">PageResponse</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-3、按照时间查询任务数" tabindex="-1"><a class="header-anchor" href="#_4-3、按照时间查询任务数" aria-hidden="true">#</a> 4.3、按照时间查询任务数</h2><h3 id="_4-3-1、controller" tabindex="-1"><a class="header-anchor" href="#_4-3-1、controller" aria-hidden="true">#</a> 4.3.1、Controller</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;任务数量查询&quot;</span><span class="token punctuation">,</span> notes <span class="token operator">=</span> <span class="token string">&quot;按照当日快递员id列表查询每个快递员的取派件任务数&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiImplicitParams</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;courierIds&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;订单id列表&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;taskType&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;任务类型&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;date&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;日期，格式：yyyy-MM-dd 或 yyyyMMdd&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourierTaskCountDTO</span><span class="token punctuation">&gt;</span></span> <span class="token function">findCountByCourierIds</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;courierIds&quot;</span><span class="token punctuation">)</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> courierIds<span class="token punctuation">,</span>
                                                           <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;taskType&quot;</span><span class="token punctuation">)</span> <span class="token class-name">PickupDispatchTaskType</span> taskType<span class="token punctuation">,</span>
                                                           <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;date&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> date<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pickupDispatchTaskService<span class="token punctuation">.</span><span class="token function">findCountByCourierIds</span><span class="token punctuation">(</span>courierIds<span class="token punctuation">,</span> taskType<span class="token punctuation">,</span> date<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-2、service" tabindex="-1"><a class="header-anchor" href="#_4-3-2、service" aria-hidden="true">#</a> 4.3.2、Service</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * 按照当日快递员id列表查询每个快递员的取派件任务数
     *
     * <span class="token keyword">@param</span> <span class="token parameter">courierIds</span>             快递员id列表
     * <span class="token keyword">@param</span> <span class="token parameter">pickupDispatchTaskType</span> 任务类型
     * <span class="token keyword">@param</span> <span class="token parameter">date</span>                   日期，格式：yyyy-MM-dd 或 yyyyMMdd
     * <span class="token keyword">@return</span> 任务数
     */</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourierTaskCountDTO</span><span class="token punctuation">&gt;</span></span> <span class="token function">findCountByCourierIds</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> courierIds<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskType</span> pickupDispatchTaskType<span class="token punctuation">,</span> <span class="token class-name">String</span> date<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-3、serviceimpl-1" tabindex="-1"><a class="header-anchor" href="#_4-2-3、serviceimpl-1" aria-hidden="true">#</a> 4.2.3、ServiceImpl</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourierTaskCountDTO</span><span class="token punctuation">&gt;</span></span> <span class="token function">findCountByCourierIds</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> courierIds<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskType</span> pickupDispatchTaskType<span class="token punctuation">,</span> <span class="token class-name">String</span> date<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//计算一天的时间的边界</span>
        <span class="token class-name">DateTime</span> dateTime <span class="token operator">=</span> <span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LocalDateTime</span> startDateTime <span class="token operator">=</span> <span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">beginOfDay</span><span class="token punctuation">(</span>dateTime<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocalDateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LocalDateTime</span> endDateTime <span class="token operator">=</span> <span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">endOfDay</span><span class="token punctuation">(</span>dateTime<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocalDateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taskPickupDispatchMapper
                <span class="token punctuation">.</span><span class="token function">findCountByCourierIds</span><span class="token punctuation">(</span>courierIds<span class="token punctuation">,</span> pickupDispatchTaskType<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> startDateTime<span class="token punctuation">,</span> endDateTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-4、定义sql" tabindex="-1"><a class="header-anchor" href="#_4-2-4、定义sql" aria-hidden="true">#</a> 4.2.4、定义SQL</h3><p>此方法的实现，调用自定义Mapper中的SQL实现。</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>findCountByCourierIds<span class="token punctuation">&quot;</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.sl.ms.work.domain.dto.CourierTaskCountDTO<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        SELECT
            COUNT(1) \`count\`,
            courier_id
        FROM sl_pickup_dispatch_task t
        WHERE
            t.courier_id IN  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>foreach</span> <span class="token attr-name">collection</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>courierIds<span class="token punctuation">&quot;</span></span> <span class="token attr-name">item</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>courierId<span class="token punctuation">&quot;</span></span> <span class="token attr-name">open</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>(<span class="token punctuation">&quot;</span></span> <span class="token attr-name">close</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>)<span class="token punctuation">&quot;</span></span> <span class="token attr-name">separator</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>,<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>#{courierId}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>foreach</span><span class="token punctuation">&gt;</span></span>
        AND t.created BETWEEN #{startDateTime} AND #{endDateTime}
        AND t.task_type = #{type}
        GROUP BY courier_id
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-4、根据订单查询任务" tabindex="-1"><a class="header-anchor" href="#_4-4、根据订单查询任务" aria-hidden="true">#</a> 4.4、根据订单查询任务</h2><p>根据订单id查询取派件任务。</p><h3 id="_4-4-1、controller" tabindex="-1"><a class="header-anchor" href="#_4-4-1、controller" aria-hidden="true">#</a> 4.4.1、Controller</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/orderId/{orderId}/{taskType}&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;订单id查询&quot;</span><span class="token punctuation">,</span> notes <span class="token operator">=</span> <span class="token string">&quot;根据订单id获取取派件任务信息&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiImplicitParams</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;orderId&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;订单id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;taskType&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;任务类型&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PickupDispatchTaskDTO</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByOrderId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;orderId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> orderId<span class="token punctuation">,</span>
                                                     <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;taskType&quot;</span><span class="token punctuation">)</span> <span class="token class-name">PickupDispatchTaskType</span> taskType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token punctuation">&gt;</span></span> entities <span class="token operator">=</span> pickupDispatchTaskService<span class="token punctuation">.</span><span class="token function">findByOrderId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">,</span> taskType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">copyToList</span><span class="token punctuation">(</span>entities<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-2、service" tabindex="-1"><a class="header-anchor" href="#_4-4-2、service" aria-hidden="true">#</a> 4.4.2、Service</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * 根据订单id查询取派件任务
     *
     * <span class="token keyword">@param</span> <span class="token parameter">orderId</span>  订单id
     * <span class="token keyword">@param</span> <span class="token parameter">taskType</span> 任务类型
     * <span class="token keyword">@return</span> 任务
     */</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByOrderId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> orderId<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskType</span> taskType<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-3、serviceimpl" tabindex="-1"><a class="header-anchor" href="#_4-4-3、serviceimpl" aria-hidden="true">#</a> 4.4.3、ServiceImpl</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByOrderId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> orderId<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskType</span> taskType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token punctuation">&gt;</span></span> wrapper <span class="token operator">=</span> <span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token punctuation">&gt;</span></span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getOrderId</span><span class="token punctuation">,</span> orderId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getTaskType</span><span class="token punctuation">,</span> taskType<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orderByAsc</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getCreated</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-5、id批量删除" tabindex="-1"><a class="header-anchor" href="#_4-5、id批量删除" aria-hidden="true">#</a> 4.5、id批量删除</h2><p>根据id批量删除取派件任务信息（逻辑删除）</p><h3 id="_4-5-1、controller" tabindex="-1"><a class="header-anchor" href="#_4-5-1、controller" aria-hidden="true">#</a> 4.5.1、Controller</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@DeleteMapping</span><span class="token punctuation">(</span><span class="token string">&quot;ids&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;id批量删除&quot;</span><span class="token punctuation">,</span> notes <span class="token operator">=</span> <span class="token string">&quot;根据id批量删除取派件任务信息（逻辑删除）&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiImplicitParams</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;ids&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;任务id列表&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">deleteByIds</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;ids&quot;</span><span class="token punctuation">)</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ids<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pickupDispatchTaskService<span class="token punctuation">.</span><span class="token function">deleteByIds</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-5-2、service" tabindex="-1"><a class="header-anchor" href="#_4-5-2、service" aria-hidden="true">#</a> 4.5.2、Service</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * 根据id批量删除取派件任务信息（逻辑删除）
     *
     * <span class="token keyword">@param</span> <span class="token parameter">ids</span> id列表
     * <span class="token keyword">@return</span> 是否成功
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">deleteByIds</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-5-3、serviceimpl" tabindex="-1"><a class="header-anchor" href="#_4-5-3、serviceimpl" aria-hidden="true">#</a> 4.5.3、ServiceImpl</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">deleteByIds</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ids<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 通过id列表构造对象列表</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> ids<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>id <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">PickupDispatchTaskEntity</span> dispatchTaskEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PickupDispatchTaskEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dispatchTaskEntity<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            dispatchTaskEntity<span class="token punctuation">.</span><span class="token function">setIsDeleted</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskIsDeleted</span><span class="token punctuation">.</span><span class="token constant">IS_DELETED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//TODO 发送消息，同步更新快递员任务（ES）</span>
            <span class="token keyword">return</span> dispatchTaskEntity<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">updateBatchById</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-6、改派快递员" tabindex="-1"><a class="header-anchor" href="#_4-6、改派快递员" aria-hidden="true">#</a> 4.6、改派快递员</h2><p>场景：本来属于A快递员的取件任务，由于某种原因，A快递员不能执行，此时A快递员可以改派给其他快递员，会用到此接口。<br> 另外，派件不支持直接改派，需要客服在后台操作。</p><h3 id="_4-6-1、controller" tabindex="-1"><a class="header-anchor" href="#_4-6-1、controller" aria-hidden="true">#</a> 4.6.1、Controller</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token string">&quot;courier&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;改派快递员&quot;</span><span class="token punctuation">,</span> notes <span class="token operator">=</span> <span class="token string">&quot;改派快递员&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiImplicitParams</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;任务id&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;originalCourierId&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;原快递员id&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;targetCourierId&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;目标快递员id&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">updateCourierId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">,</span>
                                   <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;originalCourierId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> originalCourierId<span class="token punctuation">,</span>
                                   <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;targetCourierId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> targetCourierId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pickupDispatchTaskService<span class="token punctuation">.</span><span class="token function">updateCourierId</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> originalCourierId<span class="token punctuation">,</span> targetCourierId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-6-2、service" tabindex="-1"><a class="header-anchor" href="#_4-6-2、service" aria-hidden="true">#</a> 4.6.2、Service</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * 改派快递员
     *
     * <span class="token keyword">@param</span> <span class="token parameter">ids</span>               任务id列表
     * <span class="token keyword">@param</span> <span class="token parameter">originalCourierId</span> 原快递员id
     * <span class="token keyword">@param</span> <span class="token parameter">targetCourierId</span>   目标快递员id
     * <span class="token keyword">@return</span> 是否成功
     */</span>
    <span class="token class-name">Boolean</span> <span class="token function">updateCourierId</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ids<span class="token punctuation">,</span> <span class="token class-name">Long</span> originalCourierId<span class="token punctuation">,</span> <span class="token class-name">Long</span> targetCourierId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-6-3、serviceimpl" tabindex="-1"><a class="header-anchor" href="#_4-6-3、serviceimpl" aria-hidden="true">#</a> 4.6.3、ServiceImpl</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">updateCourierId</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ids<span class="token punctuation">,</span> <span class="token class-name">Long</span> originalCourierId<span class="token punctuation">,</span> <span class="token class-name">Long</span> targetCourierId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">hasEmpty</span><span class="token punctuation">(</span>ids<span class="token punctuation">,</span> targetCourierId<span class="token punctuation">,</span> originalCourierId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span><span class="token class-name">WorkExceptionEnum</span><span class="token punctuation">.</span><span class="token constant">UPDATE_COURIER_PARAM_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>originalCourierId<span class="token punctuation">,</span> targetCourierId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span><span class="token class-name">WorkExceptionEnum</span><span class="token punctuation">.</span><span class="token constant">UPDATE_COURIER_EQUAL_PARAM_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token punctuation">&gt;</span></span> entities <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">listByIds</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>entities<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span><span class="token class-name">WorkExceptionEnum</span><span class="token punctuation">.</span><span class="token constant">PICKUP_DISPATCH_TASK_NOT_FOUND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        entities<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>entity <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">//校验原快递id是否正确（本来无快递员id的情况除外）</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">getCourierId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">notEqual</span><span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">getCourierId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> originalCourierId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span><span class="token class-name">WorkExceptionEnum</span><span class="token punctuation">.</span><span class="token constant">UPDATE_COURIER_ID_PARAM_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//更改快递员id</span>
            entity<span class="token punctuation">.</span><span class="token function">setCourierId</span><span class="token punctuation">(</span>targetCourierId<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 标识已分配状态</span>
            entity<span class="token punctuation">.</span><span class="token function">setAssignedStatus</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskAssignedStatus</span><span class="token punctuation">.</span><span class="token constant">DISTRIBUTED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//批量更新</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> taskIds <span class="token operator">=</span> entities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LambdaUpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token punctuation">&gt;</span></span> updateWrapper <span class="token operator">=</span> <span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token punctuation">&gt;</span></span><span class="token function">lambdaUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">,</span> taskIds<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getCourierId</span><span class="token punctuation">,</span> targetCourierId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getAssignedStatus</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskAssignedStatus</span><span class="token punctuation">.</span><span class="token constant">DISTRIBUTED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>updateWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//TODO 发送消息，同步更新快递员任务（ES）</span>

        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-7、更新取派件状态" tabindex="-1"><a class="header-anchor" href="#_4-7、更新取派件状态" aria-hidden="true">#</a> 4.7、更新取派件状态</h2><p>实现更新取派件任务状态功能时，需要考虑如下几点：</p><ul><li>更新的状态不能为【新任务】状态</li><li>更新状态为【已完成】并且任务类型为派件任务时，必须设置签收状态和签收人</li><li>更新状态为【已取消】，是取件任务的操作，根据不同的原因有不同的处理逻辑 <ul><li>【因个人无法取件，退回到网点】，需要发送消息重新生成取件任务</li><li>【用户取消投递】，需要取消订单</li><li>其他原因（用户恶意下单、禁用品、重复下单等），需要关闭订单</li></ul></li></ul><p>快递员取消时选择的原因：<br><img src="`+k+`" alt="" loading="lazy"></p><h3 id="_4-7-1、controller" tabindex="-1"><a class="header-anchor" href="#_4-7-1、controller" aria-hidden="true">#</a> 4.7.1、Controller</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@PutMapping</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;更新取派件任务状态&quot;</span><span class="token punctuation">,</span> notes <span class="token operator">=</span> <span class="token string">&quot;更新状态，不允许 NEW 状态&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">updateStatus</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">PickupDispatchTaskDTO</span> pickupDispatchTaskDTO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pickupDispatchTaskService<span class="token punctuation">.</span><span class="token function">updateStatus</span><span class="token punctuation">(</span>pickupDispatchTaskDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-7-2、service" tabindex="-1"><a class="header-anchor" href="#_4-7-2、service" aria-hidden="true">#</a> 4.7.2、Service</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * 更新取派件状态，不允许 NEW 状态
     *
     * <span class="token keyword">@param</span> <span class="token parameter">pickupDispatchTaskDTO</span> 修改的数据
     * <span class="token keyword">@return</span> 是否成功
     */</span>
    <span class="token class-name">Boolean</span> <span class="token function">updateStatus</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskDTO</span> pickupDispatchTaskDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-7-3、serviceimpl" tabindex="-1"><a class="header-anchor" href="#_4-7-3、serviceimpl" aria-hidden="true">#</a> 4.7.3、ServiceImpl</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">updateStatus</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskDTO</span> pickupDispatchTaskDTO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">WorkExceptionEnum</span> paramError <span class="token operator">=</span> <span class="token class-name">WorkExceptionEnum</span><span class="token punctuation">.</span><span class="token constant">PICKUP_DISPATCH_TASK_PARAM_ERROR</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">hasEmpty</span><span class="token punctuation">(</span>pickupDispatchTaskDTO<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pickupDispatchTaskDTO<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span><span class="token string">&quot;更新取派件任务状态，id或status不能为空&quot;</span><span class="token punctuation">,</span> paramError<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">PickupDispatchTaskEntity</span> pickupDispatchTask <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>pickupDispatchTaskDTO<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>pickupDispatchTaskDTO<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token constant">NEW</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span><span class="token class-name">WorkExceptionEnum</span><span class="token punctuation">.</span><span class="token constant">PICKUP_DISPATCH_TASK_STATUS_NOT_NEW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">case</span> <span class="token constant">COMPLETED</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token comment">//任务完成</span>
                pickupDispatchTask<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskStatus</span><span class="token punctuation">.</span><span class="token constant">COMPLETED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//设置完成时间</span>
                pickupDispatchTask<span class="token punctuation">.</span><span class="token function">setActualEndTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskType</span><span class="token punctuation">.</span><span class="token constant">DISPATCH</span> <span class="token operator">==</span> pickupDispatchTask<span class="token punctuation">.</span><span class="token function">getTaskType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//如果是派件任务的完成，已签收需要设置签收状态和签收人，拒收只需要设置签收状态</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>pickupDispatchTaskDTO<span class="token punctuation">.</span><span class="token function">getSignStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span><span class="token string">&quot;完成派件任务，签收状态不能为空&quot;</span><span class="token punctuation">,</span> paramError<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    pickupDispatchTask<span class="token punctuation">.</span><span class="token function">setSignStatus</span><span class="token punctuation">(</span>pickupDispatchTaskDTO<span class="token punctuation">.</span><span class="token function">getSignStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskSignStatus</span><span class="token punctuation">.</span><span class="token constant">RECEIVED</span> <span class="token operator">==</span> pickupDispatchTaskDTO<span class="token punctuation">.</span><span class="token function">getSignStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>pickupDispatchTaskDTO<span class="token punctuation">.</span><span class="token function">getSignRecipient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span><span class="token string">&quot;完成派件任务，签收人不能为空&quot;</span><span class="token punctuation">,</span> paramError<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        pickupDispatchTask<span class="token punctuation">.</span><span class="token function">setSignRecipient</span><span class="token punctuation">(</span>pickupDispatchTaskDTO<span class="token punctuation">.</span><span class="token function">getSignRecipient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">case</span> <span class="token constant">CANCELLED</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token comment">//任务取消</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>pickupDispatchTaskDTO<span class="token punctuation">.</span><span class="token function">getCancelReason</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span><span class="token string">&quot;取消任务，原因不能为空&quot;</span><span class="token punctuation">,</span> paramError<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                pickupDispatchTask<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskStatus</span><span class="token punctuation">.</span><span class="token constant">CANCELLED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pickupDispatchTask<span class="token punctuation">.</span><span class="token function">setCancelReason</span><span class="token punctuation">(</span>pickupDispatchTaskDTO<span class="token punctuation">.</span><span class="token function">getCancelReason</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pickupDispatchTask<span class="token punctuation">.</span><span class="token function">setCancelReasonDescription</span><span class="token punctuation">(</span>pickupDispatchTaskDTO<span class="token punctuation">.</span><span class="token function">getCancelReasonDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pickupDispatchTask<span class="token punctuation">.</span><span class="token function">setCancelTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>pickupDispatchTaskDTO<span class="token punctuation">.</span><span class="token function">getCancelReason</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">PickupDispatchTaskCancelReason</span><span class="token punctuation">.</span><span class="token constant">RETURN_TO_AGENCY</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//发送分配快递员派件任务的消息</span>
                    <span class="token class-name">OrderMsg</span> orderMsg <span class="token operator">=</span> <span class="token class-name">OrderMsg</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">agencyId</span><span class="token punctuation">(</span>pickupDispatchTask<span class="token punctuation">.</span><span class="token function">getAgencyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">orderId</span><span class="token punctuation">(</span>pickupDispatchTask<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">created</span><span class="token punctuation">(</span><span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">taskType</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskType</span><span class="token punctuation">.</span><span class="token constant">PICKUP</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//取件任务</span>
                            <span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span>pickupDispatchTask<span class="token punctuation">.</span><span class="token function">getMark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">estimatedEndTime</span><span class="token punctuation">(</span>pickupDispatchTask<span class="token punctuation">.</span><span class="token function">getEstimatedEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">//发送消息（取消任务发生在取件之前，没有运单，参数直接填入null）</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>transportOrderService<span class="token punctuation">.</span><span class="token function">sendPickupDispatchTaskMsgToDispatch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> orderMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pickupDispatchTaskDTO<span class="token punctuation">.</span><span class="token function">getCancelReason</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">PickupDispatchTaskCancelReason</span><span class="token punctuation">.</span><span class="token constant">CANCEL_BY_USER</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//原因是用户取消，则订单状态改为取消</span>
                    orderFeign<span class="token punctuation">.</span><span class="token function">updateStatus</span><span class="token punctuation">(</span><span class="token class-name">ListUtil</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>pickupDispatchTask<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">CANCELLED</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">//其他原因则关闭订单</span>
                    orderFeign<span class="token punctuation">.</span><span class="token function">updateStatus</span><span class="token punctuation">(</span><span class="token class-name">ListUtil</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>pickupDispatchTask<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">CLOSE</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span><span class="token string">&quot;其他未知状态，不能完成更新操作&quot;</span><span class="token punctuation">,</span> paramError<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//TODO 发送消息，同步更新快递员任务</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>pickupDispatchTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-8、今日任务分类计数" tabindex="-1"><a class="header-anchor" href="#_4-8、今日任务分类计数" aria-hidden="true">#</a> 4.8、今日任务分类计数</h2><p>场景：用于统计今日的任务数量。</p><h3 id="_4-8-1、controller" tabindex="-1"><a class="header-anchor" href="#_4-8-1、controller" aria-hidden="true">#</a> 4.8.1、Controller</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;todayTasks/count&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;今日任务分类计数&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiImplicitParams</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;courierId&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;快递员id&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataTypeClass <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;taskType&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;任务类型，1为取件任务，2为派件任务&quot;</span><span class="token punctuation">,</span> dataTypeClass <span class="token operator">=</span> <span class="token class-name">PickupDispatchTaskType</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;status&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;任务状态,1新任务，2已完成，3已取消&quot;</span><span class="token punctuation">,</span> dataTypeClass <span class="token operator">=</span> <span class="token class-name">PickupDispatchTaskStatus</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;isDeleted&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;是否逻辑删除&quot;</span><span class="token punctuation">,</span> dataTypeClass <span class="token operator">=</span> <span class="token class-name">PickupDispatchTaskIsDeleted</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">todayTasksCount</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;courierId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courierId<span class="token punctuation">,</span>
                                   <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;taskType&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">PickupDispatchTaskType</span> taskType<span class="token punctuation">,</span>
                                   <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;status&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">PickupDispatchTaskStatus</span> status<span class="token punctuation">,</span>
                                   <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;isDeleted&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">PickupDispatchTaskIsDeleted</span> isDeleted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> pickupDispatchTaskService<span class="token punctuation">.</span><span class="token function">todayTasksCount</span><span class="token punctuation">(</span>courierId<span class="token punctuation">,</span> taskType<span class="token punctuation">,</span> status<span class="token punctuation">,</span> isDeleted<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-8-2、service" tabindex="-1"><a class="header-anchor" href="#_4-8-2、service" aria-hidden="true">#</a> 4.8.2、Service</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * 今日任务分类计数
     *
     * <span class="token keyword">@param</span> <span class="token parameter">courierId</span> 快递员id
     * <span class="token keyword">@param</span> <span class="token parameter">taskType</span>  任务类型，1为取件任务，2为派件任务
     * <span class="token keyword">@param</span> <span class="token parameter">status</span>    任务状态,1新任务，2已完成，3已取消
     * <span class="token keyword">@param</span> <span class="token parameter">isDeleted</span> 是否逻辑删除
     * <span class="token keyword">@return</span> 任务数量
     */</span>
    <span class="token class-name">Integer</span> <span class="token function">todayTasksCount</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courierId<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskType</span> taskType<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskStatus</span> status<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskIsDeleted</span> isDeleted<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-8-3、serviceimpl" tabindex="-1"><a class="header-anchor" href="#_4-8-3、serviceimpl" aria-hidden="true">#</a> 4.8.3、ServiceImpl</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * 今日任务分类计数
     *
     * <span class="token keyword">@param</span> <span class="token parameter">courierId</span> 快递员id
     * <span class="token keyword">@param</span> <span class="token parameter">taskType</span>  任务类型，1为取件任务，2为派件任务
     * <span class="token keyword">@param</span> <span class="token parameter">status</span>    任务状态,1新任务，2已完成，3已取消
     * <span class="token keyword">@param</span> <span class="token parameter">isDeleted</span> 是否逻辑删除
     * <span class="token keyword">@return</span> 任务数量
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">todayTasksCount</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courierId<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskType</span> taskType<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskStatus</span> status<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskIsDeleted</span> isDeleted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//构建查询条件</span>
        <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token punctuation">&gt;</span></span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courierId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getCourierId</span><span class="token punctuation">,</span> courierId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>taskType<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getTaskType</span><span class="token punctuation">,</span> taskType<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getStatus</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>isDeleted<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getIsDeleted</span><span class="token punctuation">,</span> isDeleted<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//根据任务状态限定查询的日期条件</span>
        <span class="token class-name">LocalDateTime</span> startTime <span class="token operator">=</span> <span class="token class-name">LocalDateTimeUtil</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">beginOfDay</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LocalDateTime</span> endTime <span class="token operator">=</span> <span class="token class-name">LocalDateTimeUtil</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">endOfDay</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//没有任务状态,查询任务创建时间</span>
            queryWrapper<span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getCreated</span><span class="token punctuation">,</span> startTime<span class="token punctuation">,</span> endTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token class-name">PickupDispatchTaskStatus</span><span class="token punctuation">.</span><span class="token constant">NEW</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//新任务状态，查询预计结束时间</span>
            queryWrapper<span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getEstimatedEndTime</span><span class="token punctuation">,</span> startTime<span class="token punctuation">,</span> endTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token class-name">PickupDispatchTaskStatus</span><span class="token punctuation">.</span><span class="token constant">COMPLETED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//完成状态，查询实际完成时间</span>
            queryWrapper<span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getActualEndTime</span><span class="token punctuation">,</span> startTime<span class="token punctuation">,</span> endTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token class-name">PickupDispatchTaskStatus</span><span class="token punctuation">.</span><span class="token constant">CANCELLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//取消状态，查询取消时间</span>
            queryWrapper<span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getCancelTime</span><span class="token punctuation">,</span> startTime<span class="token punctuation">,</span> endTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//结果返回integer类型值</span>
        <span class="token keyword">return</span> <span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-9、条件查询所有" tabindex="-1"><a class="header-anchor" href="#_4-9、条件查询所有" aria-hidden="true">#</a> 4.9、条件查询所有</h2><h3 id="_4-9-1、controller" tabindex="-1"><a class="header-anchor" href="#_4-9-1、controller" aria-hidden="true">#</a> 4.9.1、Controller</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/all&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;条件查询所有&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiImplicitParams</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;courierId&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;快递员id&quot;</span><span class="token punctuation">,</span> dataTypeClass <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;taskType&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;任务类型，1为取件任务，2为派件任务&quot;</span><span class="token punctuation">,</span> dataTypeClass <span class="token operator">=</span> <span class="token class-name">PickupDispatchTaskType</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;taskStatus&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;任务状态,1新任务，2已完成，3已取消&quot;</span><span class="token punctuation">,</span> dataTypeClass <span class="token operator">=</span> <span class="token class-name">PickupDispatchTaskStatus</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;isDeleted&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;是否逻辑删除&quot;</span><span class="token punctuation">,</span> dataTypeClass <span class="token operator">=</span> <span class="token class-name">PickupDispatchTaskIsDeleted</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PickupDispatchTaskDTO</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;courierId&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courierId<span class="token punctuation">,</span>
                                               <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;taskType&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">PickupDispatchTaskType</span> taskType<span class="token punctuation">,</span>
                                               <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;taskStatus&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">PickupDispatchTaskStatus</span> taskStatus<span class="token punctuation">,</span>
                                               <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;isDeleted&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">PickupDispatchTaskIsDeleted</span> isDeleted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> pickupDispatchTaskService<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span>courierId<span class="token punctuation">,</span> taskType<span class="token punctuation">,</span> taskStatus<span class="token punctuation">,</span> isDeleted<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-9-2、service" tabindex="-1"><a class="header-anchor" href="#_4-9-2、service" aria-hidden="true">#</a> 4.9.2、Service</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * 条件查询所有
     *
     * <span class="token keyword">@param</span> <span class="token parameter">courierId</span>  快递员id
     * <span class="token keyword">@param</span> <span class="token parameter">taskType</span>   任务类型，1为取件任务，2为派件任务
     * <span class="token keyword">@param</span> <span class="token parameter">taskStatus</span> 任务状态,1新任务，2已完成，3已取消
     * <span class="token keyword">@param</span> <span class="token parameter">isDeleted</span>  是否逻辑删除
     * <span class="token keyword">@return</span> 取派件任务列表
     */</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PickupDispatchTaskDTO</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courierId<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskType</span> taskType<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskStatus</span> taskStatus<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskIsDeleted</span> isDeleted<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-9-3、serviceimpl" tabindex="-1"><a class="header-anchor" href="#_4-9-3、serviceimpl" aria-hidden="true">#</a> 4.9.3、ServiceImpl</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * 条件查询所有
     *
     * <span class="token keyword">@param</span> <span class="token parameter">courierId</span>  快递员id
     * <span class="token keyword">@param</span> <span class="token parameter">taskType</span>   任务类型，1为取件任务，2为派件任务
     * <span class="token keyword">@param</span> <span class="token parameter">taskStatus</span> 任务状态,1新任务，2已完成，3已取消
     * <span class="token keyword">@param</span> <span class="token parameter">isDeleted</span>  是否逻辑删除
     * <span class="token keyword">@return</span> 取派件任务列表
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PickupDispatchTaskDTO</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courierId<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskType</span>
            taskType<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskStatus</span> taskStatus<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskIsDeleted</span> isDeleted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//构建查询条件</span>
        <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token punctuation">&gt;</span></span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courierId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getCourierId</span><span class="token punctuation">,</span> courierId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>taskType<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getTaskType</span><span class="token punctuation">,</span> taskType<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>taskStatus<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getStatus</span><span class="token punctuation">,</span> taskStatus<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>isDeleted<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskEntity</span><span class="token operator">::</span><span class="token function">getIsDeleted</span><span class="token punctuation">,</span> isDeleted<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token punctuation">&gt;</span></span> entities <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">copyToList</span><span class="token punctuation">(</span>entities<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-10、今日任务分类统计" tabindex="-1"><a class="header-anchor" href="#_4-10、今日任务分类统计" aria-hidden="true">#</a> 4.10、今日任务分类统计</h2><h3 id="_4-10-1、controller" tabindex="-1"><a class="header-anchor" href="#_4-10-1、controller" aria-hidden="true">#</a> 4.10.1、Controller</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/todayTasksStatistics&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;今日任务分类统计&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiImplicitParams</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;courierId&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;快递员id&quot;</span><span class="token punctuation">,</span> dataTypeClass <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">PickupDispatchTaskStatisticsDTO</span> <span class="token function">todayTasksStatistics</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;courierId&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courierId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> pickupDispatchTaskService<span class="token punctuation">.</span><span class="token function">todayTaskStatistics</span><span class="token punctuation">(</span>courierId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-10-2、service" tabindex="-1"><a class="header-anchor" href="#_4-10-2、service" aria-hidden="true">#</a> 4.10.2、Service</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * 今日任务分类统计
     *
     * <span class="token keyword">@param</span> <span class="token parameter">courierId</span> 快递员id
     * <span class="token keyword">@return</span> 统计结果
     */</span>
    <span class="token class-name">PickupDispatchTaskStatisticsDTO</span> <span class="token function">todayTaskStatistics</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courierId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-10-3、serviceimpl" tabindex="-1"><a class="header-anchor" href="#_4-10-3、serviceimpl" aria-hidden="true">#</a> 4.10.3、ServiceImpl</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * 今日任务分类统计
     *
     * <span class="token keyword">@param</span> <span class="token parameter">courierId</span> 快递员id
     * <span class="token keyword">@return</span> 统计结果
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">PickupDispatchTaskStatisticsDTO</span> <span class="token function">todayTaskStatistics</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courierId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">PickupDispatchTaskStatisticsDTO</span> taskStatisticsDTO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PickupDispatchTaskStatisticsDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//今日取件任务数量</span>
        taskStatisticsDTO<span class="token punctuation">.</span><span class="token function">setPickupNum</span><span class="token punctuation">(</span><span class="token function">todayTasksCount</span><span class="token punctuation">(</span>courierId<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskType</span><span class="token punctuation">.</span><span class="token constant">PICKUP</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskIsDeleted</span><span class="token punctuation">.</span><span class="token constant">NOT_DELETED</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//今日待取件任务数量</span>
        taskStatisticsDTO<span class="token punctuation">.</span><span class="token function">setNewPickUpNum</span><span class="token punctuation">(</span><span class="token function">todayTasksCount</span><span class="token punctuation">(</span>courierId<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskType</span><span class="token punctuation">.</span><span class="token constant">PICKUP</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskStatus</span><span class="token punctuation">.</span><span class="token constant">NEW</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskIsDeleted</span><span class="token punctuation">.</span><span class="token constant">NOT_DELETED</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//今日已取件任务数量</span>
        taskStatisticsDTO<span class="token punctuation">.</span><span class="token function">setCompletePickUpNum</span><span class="token punctuation">(</span><span class="token function">todayTasksCount</span><span class="token punctuation">(</span>courierId<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskType</span><span class="token punctuation">.</span><span class="token constant">PICKUP</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskStatus</span><span class="token punctuation">.</span><span class="token constant">COMPLETED</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskIsDeleted</span><span class="token punctuation">.</span><span class="token constant">NOT_DELETED</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//今日已取消取件任务数量</span>
        taskStatisticsDTO<span class="token punctuation">.</span><span class="token function">setCancelPickUpNum</span><span class="token punctuation">(</span><span class="token function">todayTasksCount</span><span class="token punctuation">(</span>courierId<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskType</span><span class="token punctuation">.</span><span class="token constant">PICKUP</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskStatus</span><span class="token punctuation">.</span><span class="token constant">CANCELLED</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskIsDeleted</span><span class="token punctuation">.</span><span class="token constant">NOT_DELETED</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//今日派件任务数量</span>
        taskStatisticsDTO<span class="token punctuation">.</span><span class="token function">setDispatchNum</span><span class="token punctuation">(</span><span class="token function">todayTasksCount</span><span class="token punctuation">(</span>courierId<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskType</span><span class="token punctuation">.</span><span class="token constant">DISPATCH</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskIsDeleted</span><span class="token punctuation">.</span><span class="token constant">NOT_DELETED</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//今日待派件任务数量</span>
        taskStatisticsDTO<span class="token punctuation">.</span><span class="token function">setNewDispatchNum</span><span class="token punctuation">(</span><span class="token function">todayTasksCount</span><span class="token punctuation">(</span>courierId<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskType</span><span class="token punctuation">.</span><span class="token constant">DISPATCH</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskStatus</span><span class="token punctuation">.</span><span class="token constant">NEW</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskIsDeleted</span><span class="token punctuation">.</span><span class="token constant">NOT_DELETED</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//今日已签收任务数量</span>
        taskStatisticsDTO<span class="token punctuation">.</span><span class="token function">setSignedNum</span><span class="token punctuation">(</span><span class="token function">todayTasksCount</span><span class="token punctuation">(</span>courierId<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskType</span><span class="token punctuation">.</span><span class="token constant">DISPATCH</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskStatus</span><span class="token punctuation">.</span><span class="token constant">COMPLETED</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskIsDeleted</span><span class="token punctuation">.</span><span class="token constant">NOT_DELETED</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//今日已取消派件任务数量</span>
        taskStatisticsDTO<span class="token punctuation">.</span><span class="token function">setCancelDispatchNum</span><span class="token punctuation">(</span><span class="token function">todayTasksCount</span><span class="token punctuation">(</span>courierId<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskType</span><span class="token punctuation">.</span><span class="token constant">DISPATCH</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskStatus</span><span class="token punctuation">.</span><span class="token constant">CANCELLED</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskIsDeleted</span><span class="token punctuation">.</span><span class="token constant">NOT_DELETED</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> taskStatisticsDTO<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-11、测试" tabindex="-1"><a class="header-anchor" href="#_4-11、测试" aria-hidden="true">#</a> 4.11、测试</h2><p>可以通过编写单元测试或swagger接口进程测试。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>ms<span class="token punctuation">.</span>work<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>ms<span class="token punctuation">.</span>work<span class="token punctuation">.</span>domain<span class="token punctuation">.</span>enums<span class="token punctuation">.</span>pickupDispatchtask<span class="token punctuation">.</span></span><span class="token class-name">PickupDispatchTaskAssignedStatus</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>ms<span class="token punctuation">.</span>work<span class="token punctuation">.</span>domain<span class="token punctuation">.</span>enums<span class="token punctuation">.</span>pickupDispatchtask<span class="token punctuation">.</span></span><span class="token class-name">PickupDispatchTaskSignStatus</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>ms<span class="token punctuation">.</span>work<span class="token punctuation">.</span>domain<span class="token punctuation">.</span>enums<span class="token punctuation">.</span>pickupDispatchtask<span class="token punctuation">.</span></span><span class="token class-name">PickupDispatchTaskType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>ms<span class="token punctuation">.</span>work<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">PickupDispatchTaskEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">class</span> <span class="token class-name">PickupDispatchTaskServiceTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">PickupDispatchTaskService</span> pickupDispatchTaskService<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 测试新增取件任务
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">saveTaskPickupDispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">PickupDispatchTaskEntity</span> pickupDispatchTaskEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PickupDispatchTaskEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pickupDispatchTaskEntity<span class="token punctuation">.</span><span class="token function">setCourierId</span><span class="token punctuation">(</span><span class="token number">1019618890088508577L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pickupDispatchTaskEntity<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token number">1564170062718373889L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pickupDispatchTaskEntity<span class="token punctuation">.</span><span class="token function">setAgencyId</span><span class="token punctuation">(</span><span class="token number">1015716681416180257L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pickupDispatchTaskEntity<span class="token punctuation">.</span><span class="token function">setTaskType</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskType</span><span class="token punctuation">.</span><span class="token constant">PICKUP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pickupDispatchTaskEntity<span class="token punctuation">.</span><span class="token function">setMark</span><span class="token punctuation">(</span><span class="token string">&quot;带包装&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pickupDispatchTaskEntity<span class="token punctuation">.</span><span class="token function">setSignStatus</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskSignStatus</span><span class="token punctuation">.</span><span class="token constant">NOT_SIGNED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pickupDispatchTaskEntity<span class="token punctuation">.</span><span class="token function">setAssignedStatus</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskAssignedStatus</span><span class="token punctuation">.</span><span class="token constant">DISTRIBUTED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PickupDispatchTaskEntity</span> pickupDispatchTask <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pickupDispatchTaskService<span class="token punctuation">.</span><span class="token function">saveTaskPickupDispatch</span><span class="token punctuation">(</span>pickupDispatchTaskEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>pickupDispatchTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>基于swagger的测试：<br><img src="`+r+'" alt="" loading="lazy"><br><img src="'+d+`" alt="" loading="lazy"></p><h1 id="_5、调度中心" tabindex="-1"><a class="header-anchor" href="#_5、调度中心" aria-hidden="true">#</a> 5、调度中心</h1><p>在调度中心中对于生成取派件任务的消息进行处理，消息内容类似这样：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;orderId&quot;</span><span class="token operator">:</span> <span class="token number">123</span><span class="token punctuation">,</span>
    <span class="token property">&quot;agencyId&quot;</span><span class="token operator">:</span> <span class="token number">8001</span><span class="token punctuation">,</span>
    <span class="token property">&quot;taskType&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;mark&quot;</span><span class="token operator">:</span> <span class="token string">&quot;带包装&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;longitude&quot;</span><span class="token operator">:</span> <span class="token number">116.111</span><span class="token punctuation">,</span>
    <span class="token property">&quot;latitude&quot;</span><span class="token operator">:</span> <span class="token number">39.00</span><span class="token punctuation">,</span>
    <span class="token property">&quot;created&quot;</span><span class="token operator">:</span> <span class="token number">1654224658728</span><span class="token punctuation">,</span>
    <span class="token property">&quot;estimatedStartTime&quot;</span><span class="token operator">:</span> <span class="token number">1654224658728</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实现的关键点：</p><ul><li>如果只查询到一个快递员，直接分配即可</li><li>如果是多个快递员，需要查询这些快递员当日的任务数，按照最少的进行分配，这样可以做到相对均衡</li><li>如果没有快递员，设置快递员id为空，可以在后台系统中，人为的进行调配快递员</li><li>对于取件任务而言，需要考虑用户选择的【期望上门时间】 <ul><li>与当前时间相比，大于2小时发送延时消息，否则发送实时消息</li></ul></li></ul><h2 id="_5-1、编码实现" tabindex="-1"><a class="header-anchor" href="#_5-1、编码实现" aria-hidden="true">#</a> 5.1、编码实现</h2><p>难度系数：★★★☆☆</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>ms<span class="token punctuation">.</span>dispatch<span class="token punctuation">.</span>mq</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>collection<span class="token punctuation">.</span></span><span class="token class-name">CollUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>convert<span class="token punctuation">.</span></span><span class="token class-name">Convert</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>date<span class="token punctuation">.</span></span><span class="token class-name">DateUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>date<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTimeUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ObjectUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>json<span class="token punctuation">.</span></span><span class="token class-name">JSONUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>ms<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">CourierFeign</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>ms<span class="token punctuation">.</span>base<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">MQFeign</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>ms<span class="token punctuation">.</span>work<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">PickupDispatchTaskFeign</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>ms<span class="token punctuation">.</span>work<span class="token punctuation">.</span>domain<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">CourierTaskCountDTO</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>ms<span class="token punctuation">.</span>work<span class="token punctuation">.</span>domain<span class="token punctuation">.</span>enums<span class="token punctuation">.</span>pickupDispatchtask<span class="token punctuation">.</span></span><span class="token class-name">PickupDispatchTaskType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>transport<span class="token punctuation">.</span>common<span class="token punctuation">.</span>constant<span class="token punctuation">.</span></span><span class="token class-name">Constants</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>transport<span class="token punctuation">.</span>common<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">CourierTaskMsg</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>transport<span class="token punctuation">.</span>common<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">OrderMsg</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">ExchangeTypes</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Exchange</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Queue</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">QueueBinding</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RabbitListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTime</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>temporal<span class="token punctuation">.</span></span><span class="token class-name">ChronoUnit</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span></span><span class="token class-name">Collectors</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 订单业务消息，接收到新订单后，根据快递员的负载情况，分配快递员
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderMQListener</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">MQFeign</span> mqFeign<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">CourierFeign</span> courierFeign<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">PickupDispatchTaskFeign</span> pickupDispatchTaskFeign<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 如果有多个快递员，需要查询快递员今日的取派件数，根据此数量进行计算
     * 计算的逻辑：优先分配取件任务少的，取件数相同的取第一个分配
     * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
     * 发送生成取件任务时需要计算时间差，如果小于2小时，实时发送；大于2小时，延时发送
     * 举例：
     * 1、现在10:30分，用户期望：11:00 ~ 12:00上门，实时发送
     * 2、现在10:30分，用户期望：13:00 ~ 14:00上门，延时发送，12点发送消息，延时1.5小时发送
     *
     * <span class="token keyword">@param</span> <span class="token parameter">msg</span> 消息内容
     */</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
            value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token class-name">Constants<span class="token punctuation">.</span>MQ<span class="token punctuation">.</span>Queues</span><span class="token punctuation">.</span><span class="token constant">DISPATCH_ORDER_TO_PICKUP_DISPATCH_TASK</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token class-name">Constants<span class="token punctuation">.</span>MQ<span class="token punctuation">.</span>Exchanges</span><span class="token punctuation">.</span><span class="token constant">ORDER_DELAYED</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">ExchangeTypes</span><span class="token punctuation">.</span><span class="token constant">TOPIC</span><span class="token punctuation">,</span> delayed <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">MQ</span><span class="token punctuation">.</span><span class="token constant">DELAYED</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            key <span class="token operator">=</span> <span class="token class-name">Constants<span class="token punctuation">.</span>MQ<span class="token punctuation">.</span>RoutingKeys</span><span class="token punctuation">.</span><span class="token constant">ORDER_CREATE</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenOrderMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//{&quot;orderId&quot;:123, &quot;agencyId&quot;: 8001, &quot;taskType&quot;:1, &quot;mark&quot;:&quot;带包装&quot;, &quot;longitude&quot;:116.111, &quot;latitude&quot;:39.00, &quot;created&quot;:1654224658728, &quot;estimatedStartTime&quot;: 1654224658728}</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;接收到订单的消息 &gt;&gt;&gt; msg = {}&quot;</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">OrderMsg</span> orderMsg <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token class-name">OrderMsg</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> agencyId <span class="token operator">=</span> orderMsg<span class="token punctuation">.</span><span class="token function">getAgencyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//网点id</span>
        <span class="token comment">// 通过快递员微服务查询 可以为发件人服务的快递员（正常上班、服务范围内）</span>
        <span class="token class-name">Double</span> longitude <span class="token operator">=</span> orderMsg<span class="token punctuation">.</span><span class="token function">getLongitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Double</span> latitude <span class="token operator">=</span> orderMsg<span class="token punctuation">.</span><span class="token function">getLatitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Long</span> selectedCourierId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> courierIds <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>courierFeign<span class="token punctuation">.</span><span class="token function">queryCourierIdListByCondition</span><span class="token punctuation">(</span>agencyId<span class="token punctuation">,</span> longitude<span class="token punctuation">,</span> latitude<span class="token punctuation">,</span> <span class="token class-name">LocalDateTimeUtil</span><span class="token punctuation">.</span><span class="token function">toEpochMilli</span><span class="token punctuation">(</span>orderMsg<span class="token punctuation">.</span><span class="token function">getEstimatedEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;快递员微服务查出的ids：{}&quot;</span><span class="token punctuation">,</span> courierIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courierIds<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//选中快递员</span>
            selectedCourierId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">selectCourier</span><span class="token punctuation">(</span>courierIds<span class="token punctuation">,</span> orderMsg<span class="token punctuation">.</span><span class="token function">getTaskType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;根据当日任务选出的快递员id：{}&quot;</span><span class="token punctuation">,</span> selectedCourierId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//发送消息</span>
        <span class="token class-name">CourierTaskMsg</span> courierTaskMsg <span class="token operator">=</span> <span class="token class-name">CourierTaskMsg</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">courierId</span><span class="token punctuation">(</span>selectedCourierId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">agencyId</span><span class="token punctuation">(</span>agencyId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">taskType</span><span class="token punctuation">(</span>orderMsg<span class="token punctuation">.</span><span class="token function">getTaskType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orderId</span><span class="token punctuation">(</span>orderMsg<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span>orderMsg<span class="token punctuation">.</span><span class="token function">getMark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">estimatedEndTime</span><span class="token punctuation">(</span>orderMsg<span class="token punctuation">.</span><span class="token function">getEstimatedEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">created</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//计算时间差</span>
        <span class="token keyword">long</span> between <span class="token operator">=</span> <span class="token class-name">LocalDateTimeUtil</span><span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderMsg<span class="token punctuation">.</span><span class="token function">getEstimatedEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ChronoUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> delay <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">MQ</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_DELAY</span><span class="token punctuation">;</span> <span class="token comment">//默认实时发送</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>between <span class="token operator">&gt;</span> <span class="token number">120</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>orderMsg<span class="token punctuation">.</span><span class="token function">getTaskType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//计算延时时间，单位毫秒</span>
            <span class="token class-name">LocalDateTime</span> sendDataTime <span class="token operator">=</span> <span class="token class-name">LocalDateTimeUtil</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span>orderMsg<span class="token punctuation">.</span><span class="token function">getEstimatedEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">ChronoUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            delay <span class="token operator">=</span> <span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTimeUtil</span><span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sendDataTime<span class="token punctuation">,</span> <span class="token class-name">ChronoUnit</span><span class="token punctuation">.</span><span class="token constant">MILLIS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mqFeign<span class="token punctuation">.</span><span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>MQ<span class="token punctuation">.</span>Exchanges</span><span class="token punctuation">.</span><span class="token constant">PICKUP_DISPATCH_TASK_DELAYED</span><span class="token punctuation">,</span>
                <span class="token class-name">Constants<span class="token punctuation">.</span>MQ<span class="token punctuation">.</span>RoutingKeys</span><span class="token punctuation">.</span><span class="token constant">PICKUP_DISPATCH_TASK_CREATE</span><span class="token punctuation">,</span> courierTaskMsg<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token doc-comment comment">/**
     * 根据当日的任务数选取快递员
     *
     * <span class="token keyword">@param</span> <span class="token parameter">courierIds</span> 快递员列个表
     * <span class="token keyword">@param</span> <span class="token parameter">taskType</span>   任务类型
     * <span class="token keyword">@return</span> 选中的快递员id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> <span class="token function">selectCourier</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> courierIds<span class="token punctuation">,</span> <span class="token class-name">Integer</span> taskType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>courierIds<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> courierIds<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">String</span> date <span class="token operator">=</span> <span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toDateStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourierTaskCountDTO</span><span class="token punctuation">&gt;</span></span> courierTaskCountDTOS <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pickupDispatchTaskFeign
                <span class="token punctuation">.</span><span class="token function">findCountByCourierIds</span><span class="token punctuation">(</span>courierIds<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskType</span><span class="token punctuation">.</span><span class="token function">codeOf</span><span class="token punctuation">(</span>taskType<span class="token punctuation">)</span><span class="token punctuation">,</span> date<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>courierTaskCountDTOS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//没有查到任务数量，默认给第一个快递员分配任务</span>
            <span class="token keyword">return</span> courierIds<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//查看任务数是否与快递员数相同，如果不相同需要补齐，设置任务数为0，这样就可以确保每个快递员都能分配到任务</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">notEqual</span><span class="token punctuation">(</span>courierIds<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> courierTaskCountDTOS<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourierTaskCountDTO</span><span class="token punctuation">&gt;</span></span> dtoList <span class="token operator">=</span> courierIds<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>courierId <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>courierTaskCountDTOS<span class="token punctuation">,</span> dto <span class="token operator">-&gt;</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>courierId<span class="token punctuation">,</span> dto<span class="token punctuation">.</span><span class="token function">getCourierId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> index <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>courierId <span class="token operator">-&gt;</span> <span class="token class-name">CourierTaskCountDTO</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">courierId</span><span class="token punctuation">(</span>courierId<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//补齐到集合中</span>
            courierTaskCountDTOS<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>dtoList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//选中任务数最小的快递员进行分配</span>
        <span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">sortByProperty</span><span class="token punctuation">(</span>courierTaskCountDTOS<span class="token punctuation">,</span> <span class="token string">&quot;count&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> courierTaskCountDTOS<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCourierId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-2、测试" tabindex="-1"><a class="header-anchor" href="#_5-2、测试" aria-hidden="true">#</a> 5.2、测试</h2><p>对于<code>OrderMQListener</code>的测试，需要启动必要的服务，因为需要查询快递员（不查询也可以，就是无快递员的逻辑），此时就需要确保有快递员数据（确保在服务范围内或有所在机构的快递员），准备完成后，先进行单元测试，后面再进行整合测试。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> start sl-express-gateway
<span class="token function">docker</span> start sl-express-ms-base-service
<span class="token function">docker</span> start sl-express-ms-courier-service
<span class="token function">docker</span> start sl-express-ms-web-manager
<span class="token function">docker</span> start sl-express-ms-service-scope-service
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动之后，可以查看快递员的排班情况：<br><img src="`+m+'" alt="" loading="lazy"><br> 快递员有所属的机构：<br><img src="'+v+`" alt="" loading="lazy"><br> 编写单元测试：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>ms<span class="token punctuation">.</span>dispatch<span class="token punctuation">.</span>mq</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>date<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTimeUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>json<span class="token punctuation">.</span></span><span class="token class-name">JSONUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sl<span class="token punctuation">.</span>transport<span class="token punctuation">.</span>common<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">OrderMsg</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDate</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token import static"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">class</span> <span class="token class-name">OrderMQListenerTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderMQListener</span> orderMQListener<span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Test</span>
	<span class="token keyword">void</span> <span class="token function">listenOrderMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token class-name">OrderMsg</span> orderMsg <span class="token operator">=</span> <span class="token class-name">OrderMsg</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	            <span class="token punctuation">.</span><span class="token function">agencyId</span><span class="token punctuation">(</span><span class="token number">1024981239465110017L</span><span class="token punctuation">)</span>
	            <span class="token punctuation">.</span><span class="token function">orderId</span><span class="token punctuation">(</span><span class="token number">1590586236289646594L</span><span class="token punctuation">)</span>
	            <span class="token punctuation">.</span><span class="token function">estimatedEndTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTimeUtil</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">&quot;2023-01-13 23:00:00&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	            <span class="token punctuation">.</span><span class="token function">longitude</span><span class="token punctuation">(</span><span class="token number">116.41338</span><span class="token punctuation">)</span>
	            <span class="token punctuation">.</span><span class="token function">latitude</span><span class="token punctuation">(</span><span class="token number">39.91092</span><span class="token punctuation">)</span>
	            <span class="token punctuation">.</span><span class="token function">created</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	            <span class="token punctuation">.</span><span class="token function">taskType</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	            <span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">&quot;带包装&quot;</span><span class="token punctuation">)</span>
	            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token keyword">this</span><span class="token punctuation">.</span>orderMQListener<span class="token punctuation">.</span><span class="token function">listenOrderMsg</span><span class="token punctuation">(</span><span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>orderMsg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查询到快递员：<br><img src="`+b+'" alt="" loading="lazy"><br> 延时发送：<br><img src="'+g+'" alt="" loading="lazy"><br><img src="'+y+'" alt="" loading="lazy"><br> wok中接收到调度中心发来的消息：<br><img src="'+h+`" alt="" loading="lazy"></p><h1 id="_6、生成任务" tabindex="-1"><a class="header-anchor" href="#_6、生成任务" aria-hidden="true">#</a> 6、生成任务</h1><p>在work微服务中可以接收到来自调度中心的消息，接下来，我们需要编写消费消息的逻辑，生成快递员的取派件任务。</p><h2 id="_6-1、消费消息" tabindex="-1"><a class="header-anchor" href="#_6-1、消费消息" aria-hidden="true">#</a> 6.1、消费消息</h2><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * 生成快递员取派件任务
     *
     * <span class="token keyword">@param</span> <span class="token parameter">msg</span> 消息
     */</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
            value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token class-name">Constants<span class="token punctuation">.</span>MQ<span class="token punctuation">.</span>Queues</span><span class="token punctuation">.</span><span class="token constant">WORK_PICKUP_DISPATCH_TASK_CREATE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token class-name">Constants<span class="token punctuation">.</span>MQ<span class="token punctuation">.</span>Exchanges</span><span class="token punctuation">.</span><span class="token constant">PICKUP_DISPATCH_TASK_DELAYED</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">ExchangeTypes</span><span class="token punctuation">.</span><span class="token constant">TOPIC</span><span class="token punctuation">,</span> delayed <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">MQ</span><span class="token punctuation">.</span><span class="token constant">DELAYED</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            key <span class="token operator">=</span> <span class="token class-name">Constants<span class="token punctuation">.</span>MQ<span class="token punctuation">.</span>RoutingKeys</span><span class="token punctuation">.</span><span class="token constant">PICKUP_DISPATCH_TASK_CREATE</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenCourierTaskMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//{&quot;taskType&quot;:1,&quot;orderId&quot;:225125208064,&quot;created&quot;:1654767899885,&quot;courierId&quot;:1001,&quot;agencyId&quot;:8001,&quot;estimatedStartTime&quot;:1654224658728,&quot;mark&quot;:&quot;带包装&quot;}</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;接收到快递员任务的消息 &gt;&gt;&gt; msg = {}&quot;</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//解析消息</span>
        <span class="token class-name">CourierTaskMsg</span> courierTaskMsg <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token class-name">CourierTaskMsg</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//幂等性处理：判断订单对应的取派件任务是否存在，判断条件：订单号+任务状态</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PickupDispatchTaskEntity</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pickupDispatchTaskService<span class="token punctuation">.</span><span class="token function">findByOrderId</span><span class="token punctuation">(</span>courierTaskMsg<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskType</span><span class="token punctuation">.</span><span class="token function">codeOf</span><span class="token punctuation">(</span>courierTaskMsg<span class="token punctuation">.</span><span class="token function">getTaskType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskEntity</span> pickupDispatchTaskEntity <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pickupDispatchTaskEntity<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">PickupDispatchTaskStatus</span><span class="token punctuation">.</span><span class="token constant">NEW</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//消息重复消费</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 订单不存在 不进行调度</span>
        <span class="token class-name">OrderDTO</span> orderDTO <span class="token operator">=</span> orderFeign<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>courierTaskMsg<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>orderDTO<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果已经取消或者删除 则不进行调度</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>orderDTO<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">CANCELLED</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> orderDTO<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">DEL</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">PickupDispatchTaskEntity</span> pickupDispatchTask <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>courierTaskMsg<span class="token punctuation">,</span> <span class="token class-name">PickupDispatchTaskEntity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//任务类型</span>
        pickupDispatchTask<span class="token punctuation">.</span><span class="token function">setTaskType</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskType</span><span class="token punctuation">.</span><span class="token function">codeOf</span><span class="token punctuation">(</span>courierTaskMsg<span class="token punctuation">.</span><span class="token function">getTaskType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//预计开始时间，结束时间向前推一小时</span>
        <span class="token class-name">LocalDateTime</span> estimatedStartTime <span class="token operator">=</span> <span class="token class-name">LocalDateTimeUtil</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span>pickupDispatchTask<span class="token punctuation">.</span><span class="token function">getEstimatedEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">ChronoUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pickupDispatchTask<span class="token punctuation">.</span><span class="token function">setEstimatedStartTime</span><span class="token punctuation">(</span>estimatedStartTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 默认未签收状态</span>
        pickupDispatchTask<span class="token punctuation">.</span><span class="token function">setSignStatus</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskSignStatus</span><span class="token punctuation">.</span><span class="token constant">NOT_SIGNED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//分配状态</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>pickupDispatchTask<span class="token punctuation">.</span><span class="token function">getCourierId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pickupDispatchTask<span class="token punctuation">.</span><span class="token function">setAssignedStatus</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskAssignedStatus</span><span class="token punctuation">.</span><span class="token constant">DISTRIBUTED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            pickupDispatchTask<span class="token punctuation">.</span><span class="token function">setAssignedStatus</span><span class="token punctuation">(</span><span class="token class-name">PickupDispatchTaskAssignedStatus</span><span class="token punctuation">.</span><span class="token constant">MANUAL_DISTRIBUTED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">PickupDispatchTaskEntity</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pickupDispatchTaskService<span class="token punctuation">.</span><span class="token function">saveTaskPickupDispatch</span><span class="token punctuation">(</span>pickupDispatchTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//保存任务失败</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SLException</span><span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;快递员任务保存失败 &gt;&gt;&gt; msg = {}&quot;</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-2、测试" tabindex="-1"><a class="header-anchor" href="#_6-2、测试" aria-hidden="true">#</a> 6.2、测试</h2><p>测试时，需要启动oms服务：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> start sl-express-ms-oms-service
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>测试方法：通过<code>com.sl.ms.dispatch.mq.OrderMQListenerTest#listenOrderMsg()</code>的测试发出消息，在work中消费消息，生成取件任务。<br> 测试结果：<br><img src="`+T+'" alt="" loading="lazy"></p><h1 id="_7、整体测试" tabindex="-1"><a class="header-anchor" href="#_7、整体测试" aria-hidden="true">#</a> 7、整体测试</h1><p>将相应的服务启动，基于四端进行测试。测试整个主流程，下单 → 取件任务 → 运输任务 → 转运 → 派件任务 → 签收。</p><h1 id="_8、练习" tabindex="-1"><a class="header-anchor" href="#_8、练习" aria-hidden="true">#</a> 8、练习</h1><h2 id="_8-1、练习1" tabindex="-1"><a class="header-anchor" href="#_8-1、练习1" aria-hidden="true">#</a> 8.1、练习1</h2><p>难度系数：★★☆☆☆<br> 描述：阅读订单微服务中下单的业务逻辑代码。</p><h2 id="_8-2、练习2" tabindex="-1"><a class="header-anchor" href="#_8-2、练习2" aria-hidden="true">#</a> 8.2、练习2</h2><p>难度系数：★★☆☆☆<br> 描述：阅读快递员微服务中查询范围内快递员的代码。</p><h1 id="_9、面试连环问" tabindex="-1"><a class="header-anchor" href="#_9、面试连环问" aria-hidden="true">#</a> 9、面试连环问</h1><div class="hint-container info"><p class="hint-container-title">相关信息</p><p>面试官问：</p><ul><li>用户下单后，是如何确认上门取件的快递员的？如果有多个快递员怎么处理？</li><li>系统分配给快递员的取件任务，快递员如果将任务取消后，该如何处理？</li><li>生成取件任务，为什么会用到延时队列？</li><li>生成取派件任务为什么不在work中直接生成，而是发消息到调度中心，再发消息到work中？</li></ul></div>',129),w=[D];function E(q,P){return s(),a("div",null,w)}const C=n(f,[["render",E],["__file","day10-智能调度之取派件调度.html.vue"]]);export{C as default};
