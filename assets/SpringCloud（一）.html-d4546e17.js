import{_ as p}from"./plugin-vue_export-helper-c27b6911.js";import{r as o,o as i,c,a as n,b as s,d as e,f as l,e as a}from"./app-5f6064b2.js";const u="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASMAAAAUCAYAAADGKFuMAAAEUklEQVR4nO2cPbKCShBGz7x6i8DklkswxIwlkIGZSyCUFUDIEsyAjCWQSegSqJvILuYF+AN6AUEUXjmnysACepqPz56Z1lJIKSUj8fv7y8/Pz1jhFArFF/HP1AkoFAoFqGKkUChmgipGCoViFqhipFAoZsHExaggsgVCCPxs2kyuZD7CjiimzuOBDF/4zEWm0SgibGETFVC/x5b7rV3Th0rMhxgz8GJf773Fqxn+IG1f56PFKPMFduUui8hhszogpWSnfzITxVjcP9P/K8qL0zPpyijPY6zlcsoUZkQ5M89mhfgpNJtIRtjam6/piPG9XpyP71TPSKFQzILJilHmC9YuxJsF4qE3UFbr2vK/tj/O8EW5vy9fleuLCLvt/WMm9Vhrt/14ZyybKPKv59e3ME2xMnyxYBODuxZP9gHqsWrjFBF25Vg56z1qWkR2o6ZjbL3qW7gy/nUGvjzPzufzB7VrujTvjvG3F3vo8afez+TW5b17+nm12xMtvktvOYsPLZsmK0b6TnLwwApPSLmjvk3XsB2POEmv4mSpi+fYaGT4Ys0xPCGlLF8HWA9q7paxOMhrrIP3eLzfWDGb3CjPPYWwcSrN2aZYOjt5IrTAO0hkZNO+A8nwRcDydMn7hJksbkVnD8F1DA937ZM9aFqQJnFF06Z4w1kuLeI8P6eccrQsjvm59KUulml03OezNGn+HI9e7KNHk95duXV5755nvNrXE02+q+dsucFHGtrz3abpBl6ckJ4fXOp6GDqQpbhWSFBtGOhbQssl7fvhOcfaViqhbngPx/uNZRFeAmoGpvVKrJa8idksLjNdObuVH3QNe2dDZD/OnlVNi5QkrmjaGG84mmFiuWm5+kiPmIHDKkkpKMiPFqYxTilq1HwovfRo0bstty7v/ZVTl1eHeOJPRtbzSeZbjNDZhpCkBUUU4HoG7V9yWHyu/zjmWANjWSEneZslpZREtnZdjjsEt5ntepGO4cWlpmkC4famaVO8V9AMTOtIXmSkRxNDW7IkIc1SEkxGq0Xv4Fk9WvX+MIM8MR9mXIzKmZVkzz7hVql1Ay/e4NT6SXs2NXMfuUxiRZoQNw1wjrW/NZiIgvuVRNdYT/KGWPvKiirzz1uDPCeurMDu71/fhldNryuTtngvoWGYkDgB7mqJdnkfJDDaFu0N9NGjQ+/nx7jzXt/zX/DEXJh1MUKzcVYubu0Dq7OTB1abRaWRB4fLflezCUKuy1UnX7XMAjq7g1c274RACAdMr368baxedMXSMEzryQa2zu4UclzfGpKpce676VtCNixEw/1rBiYu7sqpfDXeEm9Ig7k2nAlxjGfolfeMuEV7By16PJzaoXfbGK3e63v+UE/08d17EXP/C5HMFwTL0+tbBsUwMh+RGkj1S0DFm/l36gRaKSIC18ORqhBNRZEf8Yzd1GkovoDZrowuv/3wDurn+QrFNzDbYqRQKL6LeTewFQrF1/AfOjSQqacBbeUAAAAASUVORK5CYII=",r="/assets/1562658341708-87bea85a.png",d="/assets/1562657555510-f948fc38.png",k="/assets/1562657589625-e2bf08f6.png",m="/assets/1562657906176-afde2e12.png",v="/assets/1562657945336-db16e40d.png",g="/assets/1562658477029-f192851d.png",b="/assets/1562658148351-7d6f9b49.png",h="/assets/1562657038085-d5ff3a23.png",y="/assets/1562658525176-ded6196f.png",f="/assets/1562658769580-57de2bab.png",_="/assets/1562658911028-24712d2f.png",x="/assets/1562663350045-ce572a0c.png",w="/assets/1562663502072-558b0438.png",S="/assets/1562668147504-74826685.png",C="/assets/1562669312816-aee7c8f1.png",T="/assets/1562669738624-cb897ef9.png",E="/assets/1562669833216-f46f9a43.png",R="/assets/1562671100800-39843d67.png",j="/assets/1562666010564-c38392df.png",U="/assets/1562666652758-c0a860b8.png",I="/assets/1562744078358-e9bcc4ef.png",P="/assets/1562745111230-f754080f.png",A="/assets/1562745976147-28ce6c30.png",q="/assets/1562746801830-3014e941.png",H="/assets/1562746949791-37058045.png",z="/assets/1562747233867-c79b0130.png",M="/assets/1562747425846-bbcdb106.png",B="/assets/1562747824364-dc3b5c17.png",L="/assets/1562748335761-936fd060.png",N="/assets/1562749250218-9ba794e5.png",F="/assets/1562749895944-861fce3e.png",D="/assets/1563813223116-c87b186e.png",O="/assets/1563813480333-8ac1a9b5.png",G="/assets/1563813350472-9c4e9a84.png",V="/assets/1563813291614-a12d4a89.png",Z="/assets/1562753024965-bae647af.png",W="/assets/1562753327031-c6a2a580.png",K="/assets/1562772884994-5fc27048.png",X="/assets/1562773176094-5a954039.png",J="/assets/1562773278589-1b0a292e.png",Y="/assets/1562773314326-5d00d2c3.png",Q="/assets/1562773398605-3a637534.png",$="/assets/1562773465222-c38eae2d.png",nn="/assets/1562773626117-37fffeae.png",sn="/assets/1562776240473-96de83ad.png",an="/assets/1562774318479-45c0a1b4.png",tn="/assets/1562776140067-a7973a32.png",en="/assets/1562776420306-1d321812.png",pn="/assets/1562777949257-07b2d9c6.png",on="/assets/1562779660697-469519c3.png",cn="/assets/1562779475671-df83d5c1.png",ln="/assets/1562779688709-ed50b2c4.png",un="/assets/1562921641664-752fe6ed.png",rn="/assets/1562779998489-d398639a.png",dn="/assets/1562917251060-6539a0d2.png",kn="/assets/1562917970988-8706e73b.png",mn="/assets/1562918833562-6d753671.png",vn="/assets/1562920097541-070edd66.png",gn="/assets/1562920566944-967a0e04.png",bn={},hn=a('<h1 id="springcloud-一" tabindex="-1"><a class="header-anchor" href="#springcloud-一" aria-hidden="true">#</a> SpringCloud（一）</h1><p>反馈：学习表白</p><figure><img src="'+u+'" alt="1564554652886" tabindex="0" loading="lazy"><figcaption>1564554652886</figcaption></figure><p>课程回顾：springboot（构建一切：与其他的优秀的框架进行整合）</p><ul><li>java开发的阶段：略</li><li>构建springboot program <ul><li>第一种：创建一个普通的maven工程 <ul><li>添加起步依赖：spring-boot-starter-parent</li><li>添加工程需要的依赖：web、mybatis...</li></ul></li><li>第二种：通过官方的模板构建 <ul><li>启动器</li><li>配置文件</li><li>目录结构：static、templates</li></ul></li><li>配置文件： <ul><li>application.properties</li><li>application.yml/yaml</li></ul></li><li>热部署：略</li></ul></li><li>springboot集成了其他的框架 <ul><li>与mybatis的集成</li><li>与redis集成：提供的对象RedisTemplate（Spring Data XxxTemplate：对原生api的封装）</li><li>与jpa集成： <ul><li>dao接口：继承JpaRepository&lt;T, ID.Type&gt;</li><li>pojo的注解：完成表与pojo的映射关系（ORM）</li></ul></li><li>自带定时任务：corn（时间）表达式 排班表。</li></ul></li><li>打包方式： <ul><li>建议：jar</li><li>也可以：war</li></ul></li></ul><p>学习目标：应用。</p><p>1、项目架构的演变----SpringCloud介绍</p><p>2、使用RestTemplate发送请求（远程调用： 例如：微信 提供了地址）</p><ul><li>httpclient：复杂</li><li>RestTemplate：对httpclient封装</li></ul><p>3、搭建Eureka注册中心</p><p>4、使用Ribbon实现负载均衡（LB）：nginx（10w）、HaProxy（lvs）</p><p>5、使用Hystrix熔断器</p><h1 id="_1-springcloud介绍" tabindex="-1"><a class="header-anchor" href="#_1-springcloud介绍" aria-hidden="true">#</a> 1 SpringCloud介绍</h1><h2 id="_1-1-项目架构演变过程" tabindex="-1"><a class="header-anchor" href="#_1-1-项目架构演变过程" aria-hidden="true">#</a> 1.1 项目架构演变过程</h2><h3 id="_1-1-1-单一的应用架构" tabindex="-1"><a class="header-anchor" href="#_1-1-1-单一的应用架构" aria-hidden="true">#</a> 1.1.1 单一的应用架构</h3><figure><img src="'+r+'" alt="1562658341708" tabindex="0" loading="lazy"><figcaption>1562658341708</figcaption></figure><ul><li>模块之间耦合度太高，其中一个升级其他都得升级</li><li>开发困难，各个团队开发最后都要整合一起</li><li>系统的扩展性差</li><li>不能灵活的进行分布式部署</li></ul><h3 id="_1-1-2-垂直的应用架构" tabindex="-1"><a class="header-anchor" href="#_1-1-2-垂直的应用架构" aria-hidden="true">#</a> 1.1.2 垂直的应用架构</h3><p>当访问量逐渐增大，单一应用增加机器带来的加速度越来越小，<strong>将应用拆成互不相干的几个应用</strong>，以提升效率。此时，用于加速前端页面开发的Web框架(MVC)是关键。</p><h3 id="_1-1-3-系统拆分" tabindex="-1"><a class="header-anchor" href="#_1-1-3-系统拆分" aria-hidden="true">#</a> 1.1.3 系统拆分</h3><h4 id="_1-1-3-1-先看一段对话" tabindex="-1"><a class="header-anchor" href="#_1-1-3-1-先看一段对话" aria-hidden="true">#</a> 1.1.3.1 先看一段对话</h4><figure><img src="'+d+'" alt="1562657555510" tabindex="0" loading="lazy"><figcaption>1562657555510</figcaption></figure><h4 id="_1-1-3-2-系统拆分" tabindex="-1"><a class="header-anchor" href="#_1-1-3-2-系统拆分" aria-hidden="true">#</a> 1.1.3.2 系统拆分</h4><p>1） <strong>应用间耦合严重</strong>。系统内各个应用之间不通，同样一个功能在各个应用中都有实现，后果就是改一处功能，需要同时改系统中的所有应用。这种情况多存在于历史较长的系统，因各种原因，系统内的各个应用都形成了自己的业务小闭环</p><p>2） <strong>业务扩展性差</strong>。数据模型从设计之初就只支持某一类的业务，来了新类型的业务后又得重新写代码实现，结果就是项目延期，大大影响业务的接入速度；</p><p>3） <strong>代码老旧，难以维护</strong>。各种随意的if else、写死逻辑散落在应用的各个角落，处处是坑，开发维护起来战战兢兢；</p><p>4） <strong>系统扩展性差</strong>。系统支撑现有业务已是颤颤巍巍，不论是应用还是DB都已经无法承受业务快速发展带来的压力；</p><p>5） <strong>新坑越挖越多，恶性循环</strong>。不改变的话，最终的结果就是把系统做死了。</p><figure><img src="'+k+'" alt="1562657589625" tabindex="0" loading="lazy"><figcaption>1562657589625</figcaption></figure><h4 id="_1-1-3-3-拆分原则" tabindex="-1"><a class="header-anchor" href="#_1-1-3-3-拆分原则" aria-hidden="true">#</a> 1.1.3.3 拆分原则</h4><h5 id="_1-1-3-3-1-把握业务复杂度" tabindex="-1"><a class="header-anchor" href="#_1-1-3-3-1-把握业务复杂度" aria-hidden="true">#</a> 1.1.3.3.1 把握业务复杂度</h5><p>一个老生常谈的问题，系统与业务的关系？</p><figure><img src="'+m+'" alt="1562657906176" tabindex="0" loading="lazy"><figcaption>1562657906176</figcaption></figure><p>我们最期望的理想情况是第一种关系（车辆与人），业务觉得不合适，可以马上换一辆新的。但现实的情况是更像心脏起搏器与人之间的关系，不是说换就能换。一个系统接的业务越多，耦合越紧密。如果在没有真正把握住业务复杂度之前贸然行动，最终的结局就是把心脏带飞。</p><h5 id="_1-1-3-3-2-高内聚-低耦合-单一职责" tabindex="-1"><a class="header-anchor" href="#_1-1-3-3-2-高内聚-低耦合-单一职责" aria-hidden="true">#</a> 1.1.3.3.2 高内聚-低耦合-单一职责</h5><p>业务复杂度把握后，需要开始定义各个应用的服务边界。怎么才算是好的边界？像葫芦娃兄弟一样的应用就是好的！</p><p>举个例子，葫芦娃兄弟（应用）间的技能是相互独立的，遵循单一职责原则，比如水娃只能喷水，火娃只会喷火，隐形娃不会喷水喷火但能隐身。更为关键的是，葫芦娃兄弟最终可以合体为金刚葫芦娃，即这些应用虽然功能彼此独立，但又相互打通，最后合体在一起就成了我们的平台。</p><figure><img src="'+v+'" alt="1562657945336" tabindex="0" loading="lazy"><figcaption>1562657945336</figcaption></figure><p>这里很多人会有疑惑，拆分粒度怎么控制？很难有一个明确的结论，只能说是结合业务场景、目标、进度的一个折中。但总体的原则是先从一个大的服务边界开始，不要太细，因为随着架构、业务的演进，应用自然而然会再次拆分，让正确的事情自然发生才最合理。</p><h5 id="_1-1-3-3-3-确定拆分后的应用目标" tabindex="-1"><a class="header-anchor" href="#_1-1-3-3-3-确定拆分后的应用目标" aria-hidden="true">#</a> 1.1.3.3.3 确定拆分后的应用目标</h5><p>一旦系统的宏观应用拆分图出来后，就要落实到某一具体的应用拆分上了。首先要确定的就是某一应用拆分后的目标。拆分优化是没有底的，可能越做越深，越做越没结果，继而又影响自己和团队的士气。比如说可以定这期的目标就是将db、应用分拆出去，数据模型的重新设计可以在第二期。</p><h5 id="_1-1-3-3-4-拆分后应用的状态以及存在的风险" tabindex="-1"><a class="header-anchor" href="#_1-1-3-3-4-拆分后应用的状态以及存在的风险" aria-hidden="true">#</a> 1.1.3.3.4 拆分后应用的状态以及存在的风险</h5><p><strong>动手前的思考成本远远低于动手后遇到问题的解决成本</strong>。应用拆分最怕的是中途说“他*的，这块不能动，原来当时这样设计是有原因的，得想别的路子！”这时的压力可想而知，整个节奏不符合预期后，很可能会接二连三遇到同样的问题，这时不仅同事们士气下降，自己也会丧失信心，继而可能导致拆分失败。</p><h5 id="_1-1-3-3-5-留个锦囊-方案。" tabindex="-1"><a class="header-anchor" href="#_1-1-3-3-5-留个锦囊-方案。" aria-hidden="true">#</a> 1.1.3.3.5 留个锦囊-方案。</h5><p>锦囊就四个字“有备无患”，可以贴在桌面或者手机上。在以后具体实施过程中，多思考下“方案是否有多种可以选择？复杂问题能否拆解？实际操作时是否有预案？”，应用拆分在具体实践过程中比拼得就是细致二字，多一份方案，多一份预案，不仅能提升成功概率，更给自己信心。</p><h3 id="_1-1-4-soa架构" tabindex="-1"><a class="header-anchor" href="#_1-1-4-soa架构" aria-hidden="true">#</a> 1.1.4 SOA架构</h3><figure><img src="'+g+'" alt="1562658477029" tabindex="0" loading="lazy"><figcaption>1562658477029</figcaption></figure><p>典型代表有两个：流动计算架构和微服务架构；</p><p><strong>流动计算架构：</strong></p><p>当服务越来越多，容量的评估，小服务资源的浪费等问题逐渐显现，此时需增加一个调度中心基于访问压力实时管理集群容量，提高集群利用率。此时，用于提高机器利用率的资源调度和治理中心(SOA)是关键。流动计算架构的最佳实践阿里的Dubbo。</p><p><strong>微服务架构</strong></p><p>与流动计算架构很相似，除了具备流动计算架构优势外，微服务架构中的微服务可以独立部署，独立发展。且微服务的开发不会限制于任何技术栈。微服务架构的最佳实践是SpringCloud。</p><p><strong>单一的应用架构---&gt;垂直的应用架构---&gt;分布式架构---&gt;SOA面向服务---&gt;微服务架构</strong></p><figure><img src="'+b+'" alt="1562658148351" tabindex="0" loading="lazy"><figcaption>1562658148351</figcaption></figure><figure><img src="'+h+'" alt="1562657038085" tabindex="0" loading="lazy"><figcaption>1562657038085</figcaption></figure><h2 id="_1-2-springcloud" tabindex="-1"><a class="header-anchor" href="#_1-2-springcloud" aria-hidden="true">#</a> 1.2 SpringCloud</h2><figure><img src="'+y+'" alt="1562658525176" tabindex="0" loading="lazy"><figcaption>1562658525176</figcaption></figure><h3 id="_1-2-1-介绍" tabindex="-1"><a class="header-anchor" href="#_1-2-1-介绍" aria-hidden="true">#</a> 1.2.1 介绍</h3><p>Spring Cloud是在Spring Boot的基础上构建的，用于简化分布式系统构建的工具集。该工具集为微服务架构中所涉及的配置管理、服务发现、智能路由、熔断器、控制总线等操作提供了一种简单的开发方式。也就是说Spring Cloud把非常流行的微服务的技术整合到一起，方便开发。例如：</p><figure><img src="'+f+'" alt="1562658769580" tabindex="0" loading="lazy"><figcaption>1562658769580</figcaption></figure><ul><li>注册中心：Eureka</li><li>负载均衡：Ribbon</li><li>熔断器：Hystrix</li><li>服务通信：Feign</li><li>网关：Gateway</li><li>配置中心 ：config</li><li>消息总线：Bus</li></ul><h3 id="_1-2-2-版本" tabindex="-1"><a class="header-anchor" href="#_1-2-2-版本" aria-hidden="true">#</a> 1.2.2 版本</h3><p>Spring Cloud的版本号并不像其他Spring项目是通过数字来区分版本号的（如Spring 5.0.2），而是根据英文字母的顺序，采用伦敦的“地名+版本号”的方式来命名的，例如Greenwich SR2 、Finchley SR3 、Edgware SR6 、Dalston SR5等。其中Greenwich 、Finchley 等是地名，而SR是Service Releases的缩写，是固定的写法，后面的数字是小版本号。（PS：小提示：由于Spring Cloud的版本更新很快，所以在学习时可能会发现官网中正式版本的小版本号可能与书中的并不一致，这是很正常的）</p><figure><img src="'+_+`" alt="1562658911028" tabindex="0" loading="lazy"><figcaption>1562658911028</figcaption></figure><ul><li>SNAPSHOT：快照版本，尝鲜版，随时可能修改</li><li>M版本，MileStone，M1表示第一个里程碑版本，一般同时标注PRE，表示预览版</li><li>SR，Service Release，SR1表示第一个正式版本，同时标注GA(Generally Available)，稳定版</li></ul><h3 id="_1-2-3-与springboot版本匹配关系" tabindex="-1"><a class="header-anchor" href="#_1-2-3-与springboot版本匹配关系" aria-hidden="true">#</a> 1.2.3 与SpringBoot版本匹配关系</h3><p>鉴于SpringBoot与SpringCloud关系，SpringBoot建议采用2.1.x版本</p><table><thead><tr><th>SpringBoot</th><th>SpringCloud</th></tr></thead><tbody><tr><td>1.2.x</td><td>Angel版本</td></tr><tr><td>1.3.x</td><td>Brixton版本</td></tr><tr><td>1.4.x</td><td>Camden版本</td></tr><tr><td>1.5.x</td><td>Dalston版本、Edgware</td></tr><tr><td>2.0.x</td><td>Finchley版本</td></tr><tr><td>2.1.x</td><td>Greenwich GA版本 (2019年2月发布)</td></tr><tr><td>2.2.x, 2.3.x (Starting with SR5)</td><td>Hoxton</td></tr><tr><td>2.4.x, 2.5.x (Starting with 2020.0.3)</td><td>2020.0.x aka Ilford</td></tr><tr><td>2.6.x</td><td>2021.0.x aka Jubilee</td></tr></tbody></table><h1 id="_2-使用resttemplate发送请求" tabindex="-1"><a class="header-anchor" href="#_2-使用resttemplate发送请求" aria-hidden="true">#</a> 2 使用RestTemplate发送请求</h1><h2 id="_2-1-http和rpc区别" tabindex="-1"><a class="header-anchor" href="#_2-1-http和rpc区别" aria-hidden="true">#</a> 2.1 HTTP和RPC区别</h2><ul><li>传输协议 <ul><li>RPC，可以基于TCP协议，也可以基于HTTP协议</li><li>HTTP，基于HTTP协议</li></ul></li><li>传输效率 <ul><li>RPC，使用自定义的TCP协议，可以让请求报文体积更小，或者使用HTTP2协议，也可以很好的减少报文的体积，提高传输效率</li><li>HTTP，如果是基于HTTP1.1的协议，请求中会包含很多无用的内容，如果是基于HTTP2.0，那么简单的封装以下是可以作为一个RPC来使用的，这时标准RPC框架更多的是服务治理</li></ul></li><li>性能消耗，主要在于序列化和反序列化的耗时 <ul><li>RPC，可以基于thrift实现高效的二进制传输</li><li>HTTP，大部分是通过json来实现的，字节大小和序列化耗时都比thrift要更消耗性能</li></ul></li><li>负载均衡 <ul><li>RPC，基本都自带了负载均衡策略</li><li>HTTP，需要配置Nginx，HAProxy、LVS来实现</li></ul></li><li>服务治理（下游服务新增，重启，下线时如何不影响上游调用者） <ul><li>RPC，能做到自动通知（自动监听到服务的节点），不影响上游</li><li>HTTP，需要事先通知，修改Nginx/HAProxy配置 （心跳检查 keepalived 检查：pid）</li></ul></li></ul><p>总结：RPC主要用于公司内部的服务调用，性能消耗低，传输效率高，服务治理方便。HTTP主要用于对外的异构环境，浏览器接口调用，APP接口调用，第三方接口调用等。</p><h2 id="_2-2-http客户端工具" tabindex="-1"><a class="header-anchor" href="#_2-2-http客户端工具" aria-hidden="true">#</a> 2.2 HTTP客户端工具</h2><p>常见的HTTP客户端工具：<strong>HttpClient</strong>、OKHttp、URLConnection。</p><h3 id="_2-2-1-在工程中添加httpclient依赖" tabindex="-1"><a class="header-anchor" href="#_2-2-1-在工程中添加httpclient依赖" aria-hidden="true">#</a> 2.2.1 在工程中添加HttpClient依赖</h3><p>在pom文件中添加依赖：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--httpclient依赖--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.httpcomponents<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>httpclient<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-2-在工程中添加httpclient工具类" tabindex="-1"><a class="header-anchor" href="#_2-2-2-在工程中添加httpclient工具类" aria-hidden="true">#</a> 2.2.2 在工程中添加HttpClient工具类</h3><p>在src目录下添加</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>utils</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">GeneralSecurityException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>cert<span class="token punctuation">.</span></span><span class="token class-name">CertificateException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>cert<span class="token punctuation">.</span></span><span class="token class-name">X509Certificate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">ParseException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">LinkedList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span></span><span class="token class-name">SSLContext</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span></span><span class="token class-name">SSLException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span></span><span class="token class-name">SSLSession</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span></span><span class="token class-name">SSLSocket</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span></span><span class="token class-name">TrustManager</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span></span><span class="token class-name">X509TrustManager</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">Consts</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">NameValuePair</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">ClientProtocolException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>client<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">RequestConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>client<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">UrlEncodedFormEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>client<span class="token punctuation">.</span>methods<span class="token punctuation">.</span></span><span class="token class-name">CloseableHttpResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>client<span class="token punctuation">.</span>methods<span class="token punctuation">.</span></span><span class="token class-name">HttpEntityEnclosingRequestBase</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>client<span class="token punctuation">.</span>methods<span class="token punctuation">.</span></span><span class="token class-name">HttpGet</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>client<span class="token punctuation">.</span>methods<span class="token punctuation">.</span></span><span class="token class-name">HttpPost</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>client<span class="token punctuation">.</span>methods<span class="token punctuation">.</span></span><span class="token class-name">HttpPut</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>client<span class="token punctuation">.</span>methods<span class="token punctuation">.</span></span><span class="token class-name">HttpUriRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>scheme<span class="token punctuation">.</span></span><span class="token class-name">Scheme</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span></span><span class="token class-name">SSLConnectionSocketFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span></span><span class="token class-name">SSLContextBuilder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span></span><span class="token class-name">SSLSocketFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span></span><span class="token class-name">TrustStrategy</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span></span><span class="token class-name">X509HostnameVerifier</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">StringEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">CloseableHttpClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">DefaultHttpClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">HttpClients</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>conn<span class="token punctuation">.</span></span><span class="token class-name">PoolingHttpClientConnectionManager</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>message<span class="token punctuation">.</span></span><span class="token class-name">BasicNameValuePair</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">EntityUtils</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * http请求客户端
 * 
 * <span class="token keyword">@author</span> itcast
 * 
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HttpClient</span> <span class="token punctuation">{</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> url<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> param<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token keyword">int</span> statusCode<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> content<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> xmlParam<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token keyword">boolean</span> isHttps<span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isHttps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> isHttps<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setHttps</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isHttps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>isHttps <span class="token operator">=</span> isHttps<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getXmlParam</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> xmlParam<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setXmlParam</span><span class="token punctuation">(</span><span class="token class-name">String</span> xmlParam<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>xmlParam <span class="token operator">=</span> xmlParam<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token class-name">HttpClient</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> param<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> url<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>param <span class="token operator">=</span> param<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token class-name">HttpClient</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> url<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setParameter</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		param <span class="token operator">=</span> map<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addParameter</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>param <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			param <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		param<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClientProtocolException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
		<span class="token class-name">HttpPost</span> http <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpPost</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">setEntity</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">execute</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClientProtocolException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
		<span class="token class-name">HttpPut</span> http <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpPut</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">setEntity</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">execute</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClientProtocolException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>param <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">StringBuilder</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">boolean</span> isFirst <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> param<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>isFirst<span class="token punctuation">)</span><span class="token punctuation">{</span>
					url<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span><span class="token punctuation">{</span>
					url<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&amp;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				url<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;=&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token class-name">HttpGet</span> http <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpGet</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">execute</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token doc-comment comment">/**
	 * set http post,put param
	 */</span>
	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setEntity</span><span class="token punctuation">(</span><span class="token class-name">HttpEntityEnclosingRequestBase</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>param <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NameValuePair</span><span class="token punctuation">&gt;</span></span> nvps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NameValuePair</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> param<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				nvps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BasicNameValuePair</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> param<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 参数</span>
			<span class="token punctuation">}</span>

			http<span class="token punctuation">.</span><span class="token function">setEntity</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UrlEncodedFormEntity</span><span class="token punctuation">(</span>nvps<span class="token punctuation">,</span> <span class="token class-name">Consts</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置参数</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>xmlParam <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			http<span class="token punctuation">.</span><span class="token function">setEntity</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringEntity</span><span class="token punctuation">(</span>xmlParam<span class="token punctuation">,</span> <span class="token class-name">Consts</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">HttpUriRequest</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClientProtocolException</span><span class="token punctuation">,</span>
			<span class="token class-name">IOException</span> <span class="token punctuation">{</span>
		<span class="token class-name">CloseableHttpClient</span> httpClient <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>isHttps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">SSLContext</span> sslContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SSLContextBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
						<span class="token punctuation">.</span><span class="token function">loadTrustMaterial</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TrustStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token comment">// 信任所有</span>
							<span class="token annotation punctuation">@Override</span>
							<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isTrusted</span><span class="token punctuation">(</span><span class="token class-name">X509Certificate</span><span class="token punctuation">[</span><span class="token punctuation">]</span> chain<span class="token punctuation">,</span>
									<span class="token class-name">String</span> authType<span class="token punctuation">)</span>
									<span class="token keyword">throws</span> <span class="token class-name">CertificateException</span> <span class="token punctuation">{</span>
								<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
							<span class="token punctuation">}</span>
						<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">SSLConnectionSocketFactory</span> sslsf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SSLConnectionSocketFactory</span><span class="token punctuation">(</span>
						sslContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
				httpClient <span class="token operator">=</span> <span class="token class-name">HttpClients</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSSLSocketFactory</span><span class="token punctuation">(</span>sslsf<span class="token punctuation">)</span>
						<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				httpClient <span class="token operator">=</span> <span class="token class-name">HttpClients</span><span class="token punctuation">.</span><span class="token function">createDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token class-name">CloseableHttpResponse</span> response <span class="token operator">=</span> httpClient<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>response <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatusLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
						statusCode <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getStatusLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>

					<span class="token class-name">HttpEntity</span> entity <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token comment">// 响应内容</span>
					content <span class="token operator">=</span> <span class="token class-name">EntityUtils</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>entity<span class="token punctuation">,</span> <span class="token class-name">Consts</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
				response<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
			httpClient<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> statusCode<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParseException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> content<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-3-测试" tabindex="-1"><a class="header-anchor" href="#_2-2-3-测试" aria-hidden="true">#</a> 2.2.3 测试</h3><p>创建一个main方法进行测试：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HttpMain</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ParseException</span> <span class="token punctuation">{</span>
<span class="token comment">//        String url = &quot;https://ip.taobao.com/service/getIpInfo.php?ip=[14.118.128.154]&quot;;</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;http://localhost:8080/springboot_demo4_jpa-0.0.1-SNAPSHOT/user/findUsers&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">HttpClient</span> httpClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpClient</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpClient<span class="token punctuation">.</span><span class="token function">setHttps</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpClient<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> content <span class="token operator">=</span> httpClient<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-3-resttemplate入门程序" tabindex="-1"><a class="header-anchor" href="#_2-3-resttemplate入门程序" aria-hidden="true">#</a> 2.3 RestTemplate入门程序</h2><h3 id="_2-3-1-介绍" tabindex="-1"><a class="header-anchor" href="#_2-3-1-介绍" aria-hidden="true">#</a> 2.3.1 介绍</h3><ul><li>RestTemplate是Rest的HTTP客户端模板工具类</li><li>对基于Http的客户端进行封装</li><li>实现对象与JSON的序列化与反序列化</li><li>不限定客户端类型，目前常用的3种客户端都支持：HttpClient、OKHttp、JDK原生URLConnection(默认方式)</li></ul><h3 id="_2-3-2-创建工程" tabindex="-1"><a class="header-anchor" href="#_2-3-2-创建工程" aria-hidden="true">#</a> 2.3.2 创建工程</h3><p>创建工程勾选web依赖。</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-3-注入resttemplate" tabindex="-1"><a class="header-anchor" href="#_2-3-3-注入resttemplate" aria-hidden="true">#</a> 2.3.3 注入RestTemplate</h3><p>在SpringBoot引导程序中注入RestTemplate。</p><figure><img src="`+x+`" alt="1562663350045" tabindex="0" loading="lazy"><figcaption>1562663350045</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringBootDemo5Application</span> <span class="token punctuation">{</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SpringBootDemo5Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 注入RestTemplate</span>
	<span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;restTemplate&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">createRestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-4-在测试类中测试" tabindex="-1"><a class="header-anchor" href="#_2-3-4-在测试类中测试" aria-hidden="true">#</a> 2.3.4 在测试类中测试</h3><figure><img src="`+w+`" alt="1562663502072" tabindex="0" loading="lazy"><figcaption>1562663502072</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringBootDemo5ApplicationTests</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Test</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	    <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;http://localhost:8080/springboot_demo4_jpa-0.0.1-SNAPSHOT/user/findUsers&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="_3-模拟服务调用" tabindex="-1"><a class="header-anchor" href="#_3-模拟服务调用" aria-hidden="true">#</a> 3 模拟服务调用</h1><h2 id="_3-1-创建服务提供方" tabindex="-1"><a class="header-anchor" href="#_3-1-创建服务提供方" aria-hidden="true">#</a> 3.1 创建服务提供方</h2><p>作用：根据id提供用户信息。</p><p>建库（springboot）、建表略。</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 使用springcloud数据库</span>
<span class="token keyword">USE</span> springcloud<span class="token punctuation">;</span>
<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Table structure for tb_user</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">\`</span>tb_user<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>username<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;用户名&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>password<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;密码&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>name<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;姓名&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>age<span class="token punctuation">\`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;年龄&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>sex<span class="token punctuation">\`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;性别，1男，2女&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>birthday<span class="token punctuation">\`</span></span> <span class="token keyword">date</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;出生日期&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>created<span class="token punctuation">\`</span></span> <span class="token keyword">date</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;创建时间&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>updated<span class="token punctuation">\`</span></span> <span class="token keyword">date</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;更新时间&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>note<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;备注&#39;</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">2</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">&#39;用户信息表&#39;</span><span class="token punctuation">;</span>
<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Records of tb_user</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">\`</span>tb_user<span class="token punctuation">\`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;zhangsan&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;123456&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;张三&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;13&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;2006-08-01&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;2019-05-16&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;2019-05-16&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;好好学习&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">\`</span>tb_user<span class="token punctuation">\`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;2&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;lisi&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;123456&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;李四&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;13&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;2006-08-01&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;2019-05-16&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;2019-05-16&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;天天向上&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-1-1-创建工程" tabindex="-1"><a class="header-anchor" href="#_3-1-1-创建工程" aria-hidden="true">#</a> 3.1.1 创建工程</h3><p>勾选相关依赖（web、jpa、MySQL驱动）</p><figure><img src="`+S+`" alt="1562668147504" tabindex="0" loading="lazy"><figcaption>1562668147504</figcaption></figure><h3 id="_3-1-2-创建pojo" tabindex="-1"><a class="header-anchor" href="#_3-1-2-创建pojo" aria-hidden="true">#</a> 3.1.2 创建pojo</h3><p>在工程中创建User对象。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;tb_user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy <span class="token operator">=</span> <span class="token class-name">GenerationType</span><span class="token punctuation">.</span><span class="token constant">IDENTITY</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> sex<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> birthday<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> created<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> updated<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> note<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-1-3-编写dao层" tabindex="-1"><a class="header-anchor" href="#_3-1-3-编写dao层" aria-hidden="true">#</a> 3.1.3 编写Dao层</h3><p>编写UserDao接口，需要继承JpaRepository</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserDao</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-1-4-编写service层" tabindex="-1"><a class="header-anchor" href="#_3-1-4-编写service层" aria-hidden="true">#</a> 3.1.4 编写Service层</h3><p>编写UserService接口：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>

    <span class="token class-name">User</span> <span class="token function">findUserById</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编写UserServiceImpl实现类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserDao</span> userDao<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">findUserById</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> optional <span class="token operator">=</span> userDao<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> optional<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-1-5-编写controller层" tabindex="-1"><a class="header-anchor" href="#_3-1-5-编写controller层" aria-hidden="true">#</a> 3.1.5 编写Controller层</h3><p>在工程的目录下创建UserController类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/findUserById/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">findUserById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-1-6-编写application-yml文件" tabindex="-1"><a class="header-anchor" href="#_3-1-6-编写application-yml文件" aria-hidden="true">#</a> 3.1.6 编写application.yml文件</h3><p>将默认生成的application.properties文件修改成application.yml/yaml文件。</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9091</span>
<span class="token comment"># DB 配置</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/springcloud<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> root
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-1-7-发布程序并访问测试" tabindex="-1"><a class="header-anchor" href="#_3-1-7-发布程序并访问测试" aria-hidden="true">#</a> 3.1.7 发布程序并访问测试</h3>`,122),yn={href:"http://localhost:9091/user/findUserById/1",target:"_blank",rel:"noopener noreferrer"},fn=a('<figure><img src="'+C+'" alt="1562669312816" tabindex="0" loading="lazy"><figcaption>1562669312816</figcaption></figure><h2 id="_3-2-创建服务消费方" tabindex="-1"><a class="header-anchor" href="#_3-2-创建服务消费方" aria-hidden="true">#</a> 3.2 创建服务消费方</h2><h3 id="_3-2-1-创建工程" tabindex="-1"><a class="header-anchor" href="#_3-2-1-创建工程" aria-hidden="true">#</a> 3.2.1 创建工程</h3><p>勾选相关依赖（web）</p><figure><img src="'+T+'" alt="1562669738624" tabindex="0" loading="lazy"><figcaption>1562669738624</figcaption></figure><h3 id="_3-2-2-注入resttemplate" tabindex="-1"><a class="header-anchor" href="#_3-2-2-注入resttemplate" aria-hidden="true">#</a> 3.2.2 注入RestTemplate</h3><p>在启动类中注入RestTemplate。</p><figure><img src="'+E+`" alt="1562669833216" tabindex="0" loading="lazy"><figcaption>1562669833216</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceConsumerApplication</span> <span class="token punctuation">{</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ServiceConsumerApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;restTemplate&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">createRestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-3-编写controller层" tabindex="-1"><a class="header-anchor" href="#_3-2-3-编写controller层" aria-hidden="true">#</a> 3.2.3 编写Controller层</h3><p>在工程的src目录下创建Controller类。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/customer&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>

    <span class="token comment">// @RequestMapping(value = &quot;/getUserById/{id}&quot;, method = {RequestMethod.GET})</span>
    <span class="token comment">// 等价与该注解@GetMapping</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/getUserById/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUserById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> path <span class="token operator">=</span> <span class="token string">&quot;http://localhost:9091/user/findUserById/&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> json<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-3-调用测试" tabindex="-1"><a class="header-anchor" href="#_3-3-调用测试" aria-hidden="true">#</a> 3.3 调用测试</h2>`,13),_n={href:"http://localhost:8080/customer/getUserById/1",target:"_blank",rel:"noopener noreferrer"},xn=a('<figure><img src="'+R+'" alt="1562671100800" tabindex="0" loading="lazy"><figcaption>1562671100800</figcaption></figure><h2 id="_3-4-问题总结" tabindex="-1"><a class="header-anchor" href="#_3-4-问题总结" aria-hidden="true">#</a> 3.4 问题总结</h2><ul><li>消费方调用服务方地址硬编码</li><li>在服务消费方中，不清楚服务提供方的状态（是否健康）</li><li>提供方只有一个服务，如果服务宕机，则无法访问；即便服务提供方形成集群，服务消费方还需要自己实现负载均衡</li></ul><h1 id="_4-搭建eureka注册中心" tabindex="-1"><a class="header-anchor" href="#_4-搭建eureka注册中心" aria-hidden="true">#</a> 4 搭建Eureka注册中心</h1><h2 id="_4-1-eureka介绍" tabindex="-1"><a class="header-anchor" href="#_4-1-eureka介绍" aria-hidden="true">#</a> 4.1 Eureka介绍</h2><p>Eureka是Netflix开发的一个服务发现框架，本身是一个基于REST的服务，主要用于定位运行在AWS（Amazon Web Services ）域中的中间层服务，以达到负载均衡和中间层服务故障转移的目的。Spring Cloud将其集成在自己的子项目Spring Cloud Netflix中，以实现Spring Cloud的服务发现功能。</p><p>Eureka的服务发现包含两大组件：服务端发现组件（Eureka Server）和客户端发现组件（Eureka Client）。服务端发现组件也被称之为服务注册中心，主要提供了服务的注册功能，而客户端发现组件主要用于处理服务的注册与发现。</p><figure><img src="'+j+'" alt="1562666010564" tabindex="0" loading="lazy"><figcaption>1562666010564</figcaption></figure><p>从图可以看出，当客户端服务通过注解等方式嵌入到程序的代码中运行时，客户端发现组件就会向注册中心注册自身提供的服务，并周期性地发送心跳来更新服务（默认时间为30s，如果连续三次心跳都不能够发现服务，那么Eureka就会将这个服务节点从服务注册表中移除）。与此同时，客户端发现组件还会从服务端查询当前注册的服务信息并缓存到本地，即使Eureka Server出现了问题，客户端组件也可以通过缓存中的信息调用服务节点的服务。各个服务之间会通过注册中心的注册信息以Rest方式来实现调用，并且也可以直接通过服务名进行调用。</p><figure><img src="'+U+`" alt="1562666652758" tabindex="0" loading="lazy"><figcaption>1562666652758</figcaption></figure><p>在Eureka的服务发现机制中，包含了3个角色：服务注册中心、服务提供方和服务消费方。</p><p>服务注册中心即Eureka Server，而服务提供者和服务消费者是Eureka Client。这里的服务提供者是指提供服务的应用，可以是Spring Boot应用，也可以是其他技术平台且遵循Eureka通信机制的应用，应用在运行时会自动的将自己提供的服务注册到Eureka Server以供其他应用发现。</p><p>服务消费者就是需要服务的应用，该服务在运行时会从服务注册中心获取服务列表，然后通过服务列表知道去何处调用其他服务。服务消费者会与服务注册中心保持心跳连接，一旦服务提供者的地址发生变更时，注册中心会通知服务消费者。</p><p>需要注意的是，Eureka服务提供者和服务消费者之间的角色是可以相互转换的，因为一个服务既可能是服务消费方，同时也可能是服务提供方。</p><h2 id="_4-2-eureka入门程序" tabindex="-1"><a class="header-anchor" href="#_4-2-eureka入门程序" aria-hidden="true">#</a> 4.2 Eureka入门程序</h2><h3 id="_4-2-1-创建maven工程" tabindex="-1"><a class="header-anchor" href="#_4-2-1-创建maven工程" aria-hidden="true">#</a> 4.2.1 创建maven工程</h3><p>我们创建一个maven工程springcloud_microservice（parent），用来管理子工程，因为我们需要创建Eureka的注册中心以及Eureka提供方以及消费方，因此方便管理。创建好的maven工程中我们需要添加如下依赖：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.6.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>Greenwich.SR2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-2-创建eureka服务-注册中心" tabindex="-1"><a class="header-anchor" href="#_4-2-2-创建eureka服务-注册中心" aria-hidden="true">#</a> 4.2.2 创建Eureka服务-注册中心</h3><h4 id="_4-2-2-1-创建工程" tabindex="-1"><a class="header-anchor" href="#_4-2-2-1-创建工程" aria-hidden="true">#</a> 4.2.2.1 创建工程</h4><p>创建Eureka的服务（注册中心）eureka_server_registry工程，需要勾选如下依赖：</p><figure><img src="`+I+'" alt="1562744078358" tabindex="0" loading="lazy"><figcaption>1562744078358</figcaption></figure><h4 id="_4-2-2-2-在启动类中添加注解" tabindex="-1"><a class="header-anchor" href="#_4-2-2-2-在启动类中添加注解" aria-hidden="true">#</a> 4.2.2.2 在启动类中添加注解</h4><p>在启动类中添加@EnableEurekaServer注解。申明该工程为Eureka的服务。</p><figure><img src="'+P+`" alt="1562745111230" tabindex="0" loading="lazy"><figcaption>1562745111230</figcaption></figure><h4 id="_4-2-2-3-修改application文件" tabindex="-1"><a class="header-anchor" href="#_4-2-2-3-修改application文件" aria-hidden="true">#</a> 4.2.2.3 修改application文件</h4><p>这里我们同样将默认application.properties文件修改为application.yml文件，并内容如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment"># 无注释版本</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10086</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>server
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10086/eureka
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>


<span class="token comment"># 注释版本</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10086</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token comment"># 指定服务名称	</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>server
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token comment"># 注册中心地址</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10086/eureka
    <span class="token comment"># 是否需要注册到注册中心</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-2-2-4-访问注册中心" tabindex="-1"><a class="header-anchor" href="#_4-2-2-4-访问注册中心" aria-hidden="true">#</a> 4.2.2.4 访问注册中心</h4>`,29),wn={href:"http://localhost:10086/",target:"_blank",rel:"noopener noreferrer"},Sn=a('<figure><img src="'+A+'" alt="1562745976147" tabindex="0" loading="lazy"><figcaption>1562745976147</figcaption></figure><h3 id="_4-2-3-创建eureka客户端-提供方" tabindex="-1"><a class="header-anchor" href="#_4-2-3-创建eureka客户端-提供方" aria-hidden="true">#</a> 4.2.3 创建Eureka客户端-提供方</h3><h4 id="_4-2-3-1-创建工程" tabindex="-1"><a class="header-anchor" href="#_4-2-3-1-创建工程" aria-hidden="true">#</a> 4.2.3.1 创建工程</h4><p>创建服务提供方工程eureka_client_provider，需要勾选的依赖如下：</p><figure><img src="'+q+'" alt="1562746801830" tabindex="0" loading="lazy"><figcaption>1562746801830</figcaption></figure><h4 id="_4-2-3-2-编写代码" tabindex="-1"><a class="header-anchor" href="#_4-2-3-2-编写代码" aria-hidden="true">#</a> 4.2.3.2 编写代码</h4><p>将【3.1】章节的对用户的查询代码复制到该工程</p><figure><img src="'+H+'" alt="1562746949791" tabindex="0" loading="lazy"><figcaption>1562746949791</figcaption></figure><h4 id="_4-2-3-3-在启动类中添加注解" tabindex="-1"><a class="header-anchor" href="#_4-2-3-3-在启动类中添加注解" aria-hidden="true">#</a> 4.2.3.3 在启动类中添加注解</h4><p>在启动类中添加注解，表明为eureka的客户端。@EnableEurekaClient</p><figure><img src="'+z+`" alt="1562747233867" tabindex="0" loading="lazy"><figcaption>1562747233867</figcaption></figure><h4 id="_4-2-3-4-编写application-yml文件" tabindex="-1"><a class="header-anchor" href="#_4-2-3-4-编写application-yml文件" aria-hidden="true">#</a> 4.2.3.4 编写application.yml文件</h4><p>编写application.yml文件，内容如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment"># 配置应用基本信息和DB</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9091</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provider
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver
    <span class="token key atrule">password</span><span class="token punctuation">:</span> root
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/springcloud<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
<span class="token comment"># 配置eureka server</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10086/eureka

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-2-3-5-发布工程" tabindex="-1"><a class="header-anchor" href="#_4-2-3-5-发布工程" aria-hidden="true">#</a> 4.2.3.5 发布工程</h4><p>发布工程后，eureka的控制面板如下：可以看到发布的实例，也就是说服务提供方已发布到注册中心上。</p><figure><img src="`+M+'" alt="1562747425846" tabindex="0" loading="lazy"><figcaption>1562747425846</figcaption></figure><p><strong>备注：如果有红色先不用关心（只是一个警告）。</strong></p><h3 id="_4-2-4-创建eureka客户端-消费方" tabindex="-1"><a class="header-anchor" href="#_4-2-4-创建eureka客户端-消费方" aria-hidden="true">#</a> 4.2.4 创建Eureka客户端-消费方</h3><h4 id="_4-2-4-1-创建工程" tabindex="-1"><a class="header-anchor" href="#_4-2-4-1-创建工程" aria-hidden="true">#</a> 4.2.4.1 创建工程</h4><p>创建服务提供方工程eureka_client_consumer，需要勾选的依赖如下：</p><figure><img src="'+B+`" alt="1562747824364" tabindex="0" loading="lazy"><figcaption>1562747824364</figcaption></figure><h4 id="_4-2-4-2-编写controller" tabindex="-1"><a class="header-anchor" href="#_4-2-4-2-编写controller" aria-hidden="true">#</a> 4.2.4.2 编写Controller</h4><p>编写ConsumerController类。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/consumer&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DiscoveryClient</span> discoveryClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/getUser/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 指定请求服务的url，然后通过RestTemplate发送请求</span>
        <span class="token comment">// 不建议这种写法，url硬编码了</span>
<span class="token comment">//        String url = &quot;http://localhost:9091/user/findUserById/&quot; + id;</span>
        <span class="token comment">// 1、获取Eureka注册中心提供方实例列表</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> serviceInstances <span class="token operator">=</span> discoveryClient<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span><span class="token string">&quot;eureka_client_provider&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2、获取具体实例（服务）</span>
        <span class="token class-name">ServiceInstance</span> serviceInstance <span class="token operator">=</span> serviceInstances<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3、发送请求</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;http://&quot;</span><span class="token operator">+</span>serviceInstance<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;:&quot;</span><span class="token operator">+</span>serviceInstance<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;/user/findUserById/&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> json<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-2-4-3-修改启动类中" tabindex="-1"><a class="header-anchor" href="#_4-2-4-3-修改启动类中" aria-hidden="true">#</a> 4.2.4.3 修改启动类中</h4><p>在启动类中添加@EnableEurekaClient注解和注入RestTemplate。</p><figure><img src="`+L+`" alt="1562748335761" tabindex="0" loading="lazy"><figcaption>1562748335761</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableEurekaClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaClientConsumerApplication</span> <span class="token punctuation">{</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">EurekaClientConsumerApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-2-4-4-配置application-yml文件" tabindex="-1"><a class="header-anchor" href="#_4-2-4-4-配置application-yml文件" aria-hidden="true">#</a> 4.2.4.4 配置application.yml文件</h4><p>配置文件application.yml内容如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment"># 配置应用基本信息</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>client<span class="token punctuation">-</span>consumer
<span class="token comment"># 配置eureka server</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10086/eureka
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-2-4-5-发布工程" tabindex="-1"><a class="header-anchor" href="#_4-2-4-5-发布工程" aria-hidden="true">#</a> 4.2.4.5 发布工程</h4><p>发布工程后，我们看到eureka控制面板，内容如下：</p><figure><img src="`+N+'" alt="1562749250218" tabindex="0" loading="lazy"><figcaption>1562749250218</figcaption></figure><h3 id="_4-2-5-调用测试" tabindex="-1"><a class="header-anchor" href="#_4-2-5-调用测试" aria-hidden="true">#</a> 4.2.5 调用测试</h3>',36),Cn={href:"http://localhost:8080/consumer/getUser/1",target:"_blank",rel:"noopener noreferrer"},Tn=a('<figure><img src="'+F+`" alt="1562749895944" tabindex="0" loading="lazy"><figcaption>1562749895944</figcaption></figure><h3 id="_4-2-6-eureka其他配置说明" tabindex="-1"><a class="header-anchor" href="#_4-2-6-eureka其他配置说明" aria-hidden="true">#</a> 4.2.6 Eureka其他配置说明</h3><h4 id="_4-2-6-1-注解说明" tabindex="-1"><a class="header-anchor" href="#_4-2-6-1-注解说明" aria-hidden="true">#</a> 4.2.6.1 注解说明</h4><p>注册服务或者发现服务注解。 zk</p><ul><li><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableEurekaClient</span>：基于spring<span class="token operator">-</span>cloud<span class="token operator">-</span>netflix。就是如果选用的注册中心是eureka，那么就推荐使用
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableDiscoveryClient</span>：基于spring<span class="token operator">-</span>cloud<span class="token operator">-</span>commons。如果是其他的注册中心（consul<span class="token punctuation">,</span> zookeeper），那么推荐使用
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><h4 id="_4-2-6-2-服务注册" tabindex="-1"><a class="header-anchor" href="#_4-2-6-2-服务注册" aria-hidden="true">#</a> 4.2.6.2 服务注册</h4><p>在注册中心中心工程中配置： 开启自我保护</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10086</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>server
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10086/eureka
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">enable-self-preservation</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">ip-address</span><span class="token punctuation">:</span> 127.0.0.1
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>


<span class="token comment"># 注释版</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10086</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>server
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10086/eureka
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token comment"># 开启自我保护机制（默认就是true，如果设置成false则在eureka注册中心有红色警告）</span>
    <span class="token key atrule">enable-self-preservation</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
  	<span class="token comment"># 强制指定ip地址（不用配置，使用默认获取当前服务器地址）</span>
    <span class="token key atrule">ip-address</span><span class="token punctuation">:</span> 127.0.0.1
    <span class="token comment"># 默认获取当前服务器地址（可以不用配置，默认值就是true）</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+D+`" alt="1563813223116" tabindex="0" loading="lazy"><figcaption>1563813223116</figcaption></figure><p>效果如下：</p><ul><li><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">enable-self-preservation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 关闭自我保护机制，会有警告</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+O+'" alt="1563813480333" tabindex="0" loading="lazy"><figcaption>1563813480333</figcaption></figure></li><li><p>配置：ip-address: 127.0.0.1</p></li></ul><figure><img src="'+G+'" alt="1563813350472" tabindex="0" loading="lazy"><figcaption>1563813350472</figcaption></figure><ul><li>不配置：ip-address: 127.0.0.1</li></ul><figure><img src="'+V+`" alt="1563813291614" tabindex="0" loading="lazy"><figcaption>1563813291614</figcaption></figure><h4 id="_4-2-6-3-服务续约" tabindex="-1"><a class="header-anchor" href="#_4-2-6-3-服务续约" aria-hidden="true">#</a> 4.2.6.3 服务续约</h4><p>服务注册完成以后，服务提供者会维持一个<code>心跳</code>，保存服务处于存在状态。这个称之为服务续约(renew).服务超过90秒没有发生心跳，Eureka Server会将服务从列表移除。我们可以在eureka的客户端配置如下内容：</p><p>keepalived一样的。</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment">#向Eureka服务中心注册服务</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
  	<span class="token comment"># 租约到期，服务时效时间，默认值90秒</span>
    <span class="token key atrule">lease-expiration-duration-in-seconds</span><span class="token punctuation">:</span> <span class="token number">90</span> 
    <span class="token comment"># 租约续约间隔时间，默认30秒</span>
    <span class="token key atrule">lease-renewal-interval-in-seconds</span><span class="token punctuation">:</span> <span class="token number">30</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-2-6-4-失效剔除" tabindex="-1"><a class="header-anchor" href="#_4-2-6-4-失效剔除" aria-hidden="true">#</a> 4.2.6.4 失效剔除</h4><p>服务中心每隔一段时间(默认60秒)将清单中没有续约的服务剔除。通过<code>eviction-interval-timer-in-ms</code>配置可以对其进行修改，单位是秒。我们可以在eureka客户端程序中配置如下内容：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
  	<span class="token comment"># 超过180秒没有续约的服务将被剔除</span>
  	<span class="token key atrule">eviction-interval-timer-in-ms</span><span class="token punctuation">:</span> <span class="token number">180</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-2-6-5-自我保护" tabindex="-1"><a class="header-anchor" href="#_4-2-6-5-自我保护" aria-hidden="true">#</a> 4.2.6.5 自我保护</h4><figure><img src="`+Z+'" alt="1562753024965" tabindex="0" loading="lazy"><figcaption>1562753024965</figcaption></figure><p>警告信息是因为本地调试时触发了Eureka Server的自我保护机制。该机制会使注册中心所维护的实例不是很准确，所以在本地开发时，可以在Eureka Server应用的配置文件中使用eureka.server.enable-self-preservation=false参数来关闭保护机制，以确保注册中心可以将不可用的实例正确删除。</p><figure><img src="'+W+'" alt="1562753327031" tabindex="0" loading="lazy"><figcaption>1562753327031</figcaption></figure><h1 id="_5-使用ribbon实现负载均衡" tabindex="-1"><a class="header-anchor" href="#_5-使用ribbon实现负载均衡" aria-hidden="true">#</a> 5 使用Ribbon实现负载均衡</h1><h2 id="_5-1-ribbon介绍" tabindex="-1"><a class="header-anchor" href="#_5-1-ribbon介绍" aria-hidden="true">#</a> 5.1 Ribbon介绍</h2><p>在分布式架构中，服务器端负载均衡通常是由Nginx实现分发请求的，而客户端的同一个实例部署在多个应用上时，也需要实现负载均衡。那么Spring Cloud中是否提供了这种负载均衡的功能呢？答案是肯定的。我们可以通过Spring Cloud中的Ribbon来实现此功能</p><p>Spring Cloud Ribbon是一个基于HTTP和TCP的客户端负载均衡工具，它基于Netflix Ribbon实现。通过Spring Cloud的封装，可以让我们轻松地将面向服务的REST模版请求自动转换成客户端负载均衡的服务调用。Spring Cloud Ribbon虽然只是一个工具类框架，它不像服务注册中心、配置中心、API网关那样需要独立部署，但是它几乎存在于每一个Spring Cloud构建的微服务和基础设施中。因为微服务间的调用，API网关的请求转发等内容，实际上都是通过Ribbon来实现的，包括后续我们将要介绍的Feign，它也是基于Ribbon实现的工具。所以，对Spring Cloud Ribbon的理解和使用，对于我们使用Spring Cloud来构建微服务非常重要。</p><h2 id="_5-2-入门程序" tabindex="-1"><a class="header-anchor" href="#_5-2-入门程序" aria-hidden="true">#</a> 5.2 入门程序</h2><p>场景说明：</p><ul><li>开启多个（本次两个）服务提供方；</li><li>启动消费方进行调用测试</li></ul><h3 id="_5-2-1-启动两个提供方" tabindex="-1"><a class="header-anchor" href="#_5-2-1-启动两个提供方" aria-hidden="true">#</a> 5.2.1 启动两个提供方</h3><h4 id="_5-2-1-1-修改端口" tabindex="-1"><a class="header-anchor" href="#_5-2-1-1-修改端口" aria-hidden="true">#</a> 5.2.1.1 修改端口</h4>',34),En=n("p",{"port:9091":""},"修改提供方配置文件端口：$",-1),Rn=a('<figure><img src="'+K+'" alt="1562772884994" tabindex="0" loading="lazy"><figcaption>1562772884994</figcaption></figure><h4 id="_5-2-1-2-编辑启动应用配置" tabindex="-1"><a class="header-anchor" href="#_5-2-1-2-编辑启动应用配置" aria-hidden="true">#</a> 5.2.1.2 编辑启动应用配置</h4><ul><li>修改发布的应用名称；</li><li>修改发布的应用端口：-Dport=9091</li></ul><figure><img src="'+X+'" alt="1562773176094" tabindex="0" loading="lazy"><figcaption>1562773176094</figcaption></figure><h4 id="_5-2-1-3-复制一份" tabindex="-1"><a class="header-anchor" href="#_5-2-1-3-复制一份" aria-hidden="true">#</a> 5.2.1.3 复制一份</h4><ul><li><p>复制一份新的应用</p><figure><img src="'+J+'" alt="1562773278589" tabindex="0" loading="lazy"><figcaption>1562773278589</figcaption></figure></li><li><p>修改端口以及名称</p><figure><img src="'+Y+'" alt="1562773314326" tabindex="0" loading="lazy"><figcaption>1562773314326</figcaption></figure></li></ul><h4 id="_5-2-1-4-开启两个服务提供方" tabindex="-1"><a class="header-anchor" href="#_5-2-1-4-开启两个服务提供方" aria-hidden="true">#</a> 5.2.1.4 开启两个服务提供方</h4><p>分别启动9091以及9092的服务提供方。</p><figure><img src="'+Q+'" alt="1562773398605" tabindex="0" loading="lazy"><figcaption>1562773398605</figcaption></figure><h4 id="_5-2-1-5-通过eureka查看" tabindex="-1"><a class="header-anchor" href="#_5-2-1-5-通过eureka查看" aria-hidden="true">#</a> 5.2.1.5 通过Eureka查看</h4><p>通过eureka控制面板查看服务提供方是否启动</p><figure><img src="'+$+'" alt="1562773465222" tabindex="0" loading="lazy"><figcaption>1562773465222</figcaption></figure><h3 id="_5-3-1-修改消费方" tabindex="-1"><a class="header-anchor" href="#_5-3-1-修改消费方" aria-hidden="true">#</a> 5.3.1 修改消费方</h3><h4 id="_5-3-1-1-添加-loadbalanced注解" tabindex="-1"><a class="header-anchor" href="#_5-3-1-1-添加-loadbalanced注解" aria-hidden="true">#</a> 5.3.1.1 添加@LoadBalanced注解</h4><p>在启动类的注入RestTemplate方法上添加客户端负载均衡的注解。<strong>@LoadBalanced</strong></p><figure><img src="'+nn+'" alt="1562773626117" tabindex="0" loading="lazy"><figcaption>1562773626117</figcaption></figure><h4 id="_5-3-1-2-修改controller" tabindex="-1"><a class="header-anchor" href="#_5-3-1-2-修改controller" aria-hidden="true">#</a> 5.3.1.2 修改controller</h4><p>修改ConsumerController代码：</p><figure><img src="'+sn+`" alt="1562776240473" tabindex="0" loading="lazy"><figcaption>1562776240473</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/getUser/{id}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 指定请求 eureka_client_provider：指定的服务提供方名称</span>
    <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;http://eureka-client-provider/user/findUserById/&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token class-name">String</span> json <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> json<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-3-1-3-启动消费方" tabindex="-1"><a class="header-anchor" href="#_5-3-1-3-启动消费方" aria-hidden="true">#</a> 5.3.1.3 启动消费方</h4><p>略。</p><h3 id="_5-4-1-访问测试" tabindex="-1"><a class="header-anchor" href="#_5-4-1-访问测试" aria-hidden="true">#</a> 5.4.1 访问测试</h3><ul><li><p>我们可以在提供方的controller中打印port：</p><figure><img src="`+an+'" alt="1562774318479" tabindex="0" loading="lazy"><figcaption>1562774318479</figcaption></figure></li><li><p>刷新四次，console控制查看结果：（分别访问两次，默认走的负载均衡的策略为轮询）</p><figure><img src="'+tn+'" alt="1562776140067" tabindex="0" loading="lazy"><figcaption>1562776140067</figcaption></figure></li></ul><h3 id="_5-5-1-坑" tabindex="-1"><a class="header-anchor" href="#_5-5-1-坑" aria-hidden="true">#</a> 5.5.1 坑</h3><p>使用ribbon实现负载均衡的时候，服务名称不能用下划线。</p><figure><img src="'+en+`" alt="1562776420306" tabindex="0" loading="lazy"><figcaption>1562776420306</figcaption></figure><h2 id="_5-3-ribbon负载均衡策略" tabindex="-1"><a class="header-anchor" href="#_5-3-ribbon负载均衡策略" aria-hidden="true">#</a> 5.3 Ribbon负载均衡策略</h2><h3 id="_5-3-1-默认策略" tabindex="-1"><a class="header-anchor" href="#_5-3-1-默认策略" aria-hidden="true">#</a> 5.3.1 默认策略</h3><p>Ribbon默认的负载均衡策略是轮询。</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment"># 修改服务地址轮询策略，默认是轮询，配置之后变随机</span>
<span class="token key atrule">eureka_client_consumer</span><span class="token punctuation">:</span> <span class="token comment"># 服务名称</span>
  <span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
    <span class="token key atrule">NFLoadBalancerRuleClassName</span><span class="token punctuation">:</span> com.netflix.loadbalancer.RandomRule
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-2-ribbon支持的轮询算法" tabindex="-1"><a class="header-anchor" href="#_5-3-2-ribbon支持的轮询算法" aria-hidden="true">#</a> 5.3.2 Ribbon支持的轮询算法</h3><p>接口：自己扩展。（需求来决定）</p><figure><img src="`+pn+'" alt="1562777949257" tabindex="0" loading="lazy"><figcaption>1562777949257</figcaption></figure><table><thead><tr><th>RoundRobinRule</th><th>轮询规则（默认方法）</th></tr></thead><tbody><tr><td><strong>RandomRule</strong></td><td><strong>随机</strong></td></tr><tr><td>AvailabilityFilteringRule</td><td>先过滤掉由于多次访问故障而处于断路器跳闸状态的服务，还有并发的连接数量超过阈值的服务，然后对剩余的服务进行轮询</td></tr><tr><td>WeightedResponseTimeRule</td><td>根据平均响应时间计算服务的权重。统计信息不足时会按照轮询，统计信息足够会按照响应的时间选择服务</td></tr><tr><td>RetryRule</td><td>正常时按照轮询选择服务，若过程中有服务出现故障，在轮询一定次数后依然故障，则会跳过故障的服务继续轮询</td></tr><tr><td>BestAvailableRule</td><td>先过滤掉由于多次访问故障而处于断路器跳闸状态的服务，然后选择一个并发量最小的服务</td></tr><tr><td>ZoneAvoidanceRule</td><td>默认规则，符合判断server所在的区域的性能和server的可用性选择服务</td></tr></tbody></table><h1 id="_5-使用hystrix熔断器" tabindex="-1"><a class="header-anchor" href="#_5-使用hystrix熔断器" aria-hidden="true">#</a> 5 使用Hystrix熔断器</h1><h2 id="_5-1-hystrix介绍" tabindex="-1"><a class="header-anchor" href="#_5-1-hystrix介绍" aria-hidden="true">#</a> 5.1 Hystrix介绍</h2><figure><img src="'+on+'" alt="1562779660697" tabindex="0" loading="lazy"><figcaption>1562779660697</figcaption></figure><ul><li>Hystrix，英文意思是豪猪，全身是刺，刺是一种保护机制。Hystrix也是Netflix公司的一款组件。</li><li>Hystrix是Netflix开源的一个延迟和容错库，用于隔离访问远程服务、第三方库、防止出现级联失败也就是雪崩效应。</li><li>开源：参与 集成</li></ul><h2 id="_5-2-雪崩效应" tabindex="-1"><a class="header-anchor" href="#_5-2-雪崩效应" aria-hidden="true">#</a> 5.2 雪崩效应</h2><ul><li>微服务中，一个请求可能需要多个微服务接口才能实现，会形成复杂的调用链路。</li><li>如果某服务出现异常，请求阻塞，用户得不到响应，容器中线程不会释放，于是越来越多用户请求堆积，越来越多线程阻塞。</li><li>单服务器支持线程和并发数有限，请求如果一直阻塞，会导致服务器资源耗尽，从而导致所有其他服务都不可用，从而形成雪崩效应。</li></ul><figure><img src="'+cn+'" alt="1562779475671" tabindex="0" loading="lazy"><figcaption>1562779475671</figcaption></figure><p>A为服务提供者，B为A的服务调用者，C和D是B的服务调用者。随着时间的推移，当A的不可用引起B的不可用，并将不可用逐渐放大到C和D时，整个服务就崩溃了。</p><h2 id="_5-3-熔断器原理" tabindex="-1"><a class="header-anchor" href="#_5-3-熔断器原理" aria-hidden="true">#</a> 5.3 熔断器原理</h2><h3 id="_5-3-1-空气开关" tabindex="-1"><a class="header-anchor" href="#_5-3-1-空气开关" aria-hidden="true">#</a> 5.3.1 空气开关</h3><p>为了解决服务级联失败这种问题，在分布式架构中产生了熔断器等一系列的服务保护机制。分布式架构中的熔断器，就类似于我们生活中的空气开关，当电路发生短路等情况时，空气开关会立刻断开电流，以防止用电火灾的发生。</p><figure><img src="'+ln+'" alt="1562779688709" tabindex="0" loading="lazy"><figcaption>1562779688709</figcaption></figure><h3 id="_5-3-2-熔断器" tabindex="-1"><a class="header-anchor" href="#_5-3-2-熔断器" aria-hidden="true">#</a> 5.3.2 熔断器</h3><p>在Spring Cloud中，Spring Cloud Hystrix就是用来实现断路器、线程隔离等服务保护功能的。Spring Cloud Hystrix是基于Netflix的开源框架Hystrix实现的，该框架的使用目标在于通过控制那些访问远程系统、服务和第三方库的节点，从而对延迟和故障提供更强大的容错能力。</p><h4 id="_5-3-2-1-熔断器状态" tabindex="-1"><a class="header-anchor" href="#_5-3-2-1-熔断器状态" aria-hidden="true">#</a> 5.3.2.1 熔断器状态</h4><p>与空气开关不能自动重新打开有所不同的是，断路器是可以实现弹性容错的，在一定条件下它能够自动打开和关闭，其使用时主要有三种状态。</p><figure><img src="'+un+'" alt="1562921641664" tabindex="0" loading="lazy"><figcaption>1562921641664</figcaption></figure><ul><li>Closed：关闭状态（<strong>前健康状况高于设定阈值</strong>），所有请求正常访问</li><li>Open：打开状态（<strong>当前健康状况低于设定阈值</strong>），所有请求静止通过，如果设置了fallback方法，则进入该流程</li><li>Half Open：半开状态（<strong>当断路器开关处于打开状态，经过一段时间后，断路器会自动进入半开状态。这时断路器只允许一个请求通过；当该请求调用成功时，断路器恢复到关闭状态；若该请求失败，断路器继续保持打开状态，接下来的请求会被禁止通过</strong>）</li></ul><p>断路器的开关由关闭到打开的状态是通过当前服务健康状况（服务的健康状况=请求失败数/请求总数）和设定阈值（默认为5秒内的20次故障）比较决定的。当断路器开关关闭时，请求被允许通过断路器，如果当前健康状况高于设定阈值，开关继续保持关闭；如果当前健康状况低于设定阈值，开关则切换为打开状态。当断路器开关打开时，请求被禁止通过；如果设置了fallback方法，则会进入fallback的流程。当断路器开关处于打开状态，经过一段时间后，断路器会自动进入半开状态，这时断路器只允许一个请求通过；当该请求调用成功时，断路器恢复到关闭状态；若该请求失败，断路器继续保持打开状态，接下来的请求会被禁止通过。</p><h4 id="_5-3-2-2-服务降级方法" tabindex="-1"><a class="header-anchor" href="#_5-3-2-2-服务降级方法" aria-hidden="true">#</a> 5.3.2.2 服务降级方法</h4><p>pring Cloud Hystrix能保证服务调用者在调用异常服务时快速的返回结果，避免大量的同步等待，这是通过HystrixCommand的fallback方法实现的。</p><p><strong>熔断器的核心：线程隔离和服务降级。</strong></p><ul><li>线程隔离：是指Hystrix为每个依赖服务调用一个小的线程池，如果线程池用尽，调用立即被拒绝，默认不采用排队。</li><li>服务降级(兜底方法)：优先保证核心服务，而非核心服务不可用或弱可用。触发Hystrix服务降级的情况：线程池已满、请求超时。</li></ul><figure><img src="'+rn+`" alt="1562779998489" tabindex="0" loading="lazy"><figcaption>1562779998489</figcaption></figure><p>虽然A服务仍然不可用，但采用fallback的方式可以给用户一个友好的提示结果，这样就避免了其他服务的崩溃问题。</p><h2 id="_5-4-入门程序" tabindex="-1"><a class="header-anchor" href="#_5-4-入门程序" aria-hidden="true">#</a> 5.4 入门程序</h2><p>目标：服务提供者的服务出现了故障，服务消费者快速失败给用户友好提示。体验服务降级好处。</p><h3 id="_5-4-1-添加依赖" tabindex="-1"><a class="header-anchor" href="#_5-4-1-添加依赖" aria-hidden="true">#</a> 5.4.1 添加依赖</h3><p>在服务消费方工程（eureka_client_consumer）添加hystrix依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--开启熔断器--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-hystrix<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-4-2-开启熔断器注解" tabindex="-1"><a class="header-anchor" href="#_5-4-2-开启熔断器注解" aria-hidden="true">#</a> 5.4.2 开启熔断器注解</h3><p>在消费方工程的启动类中添加开启熔断器的注解：<strong>@EnableCircuitBreaker</strong>；或者直接添加一个组合注解：<strong>@SpringCloudApplication</strong>。</p><figure><img src="`+dn+'" alt="1562917251060" tabindex="0" loading="lazy"><figcaption>1562917251060</figcaption></figure><h3 id="_5-4-3-编写服务降级方法" tabindex="-1"><a class="header-anchor" href="#_5-4-3-编写服务降级方法" aria-hidden="true">#</a> 5.4.3 编写服务降级方法</h3>',69),jn=a('<h4 id="_5-4-3-1-方法上服务降级" tabindex="-1"><a class="header-anchor" href="#_5-4-3-1-方法上服务降级" aria-hidden="true">#</a> 5.4.3.1 方法上服务降级</h4><p>在消费方工程的controller中，添加服务降级方法：</p><figure><img src="'+kn+`" alt="1562917970988" tabindex="0" loading="lazy"><figcaption>1562917970988</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/getUser/{id}&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">&quot;getUserFallback&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 指定请求 eureka_client_provider：指定的服务提供方名称</span>
    <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;http://eureka-client-provider/user/findUserById/&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token class-name">String</span> json <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> json<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 服务降级方法</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUserFallback</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;槽糕，服务器打了一会儿盹。。。&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-4-3-2-类上服务降级" tabindex="-1"><a class="header-anchor" href="#_5-4-3-2-类上服务降级" aria-hidden="true">#</a> 5.4.3.2 类上服务降级</h4><ul><li>刚才把fallback写在了某个业务方法上，如果方法很多，可以将FallBack配置加在类上，实现默认FallBack</li><li>@DefaultProperties(defaultFallback=”defaultFallBack“)，在类上，指明统一的失败降级方法</li></ul><figure><img src="`+mn+`" alt="1562918833562" tabindex="0" loading="lazy"><figcaption>1562918833562</figcaption></figure><h2 id="_5-5-熔断策略" tabindex="-1"><a class="header-anchor" href="#_5-5-熔断策略" aria-hidden="true">#</a> 5.5 熔断策略</h2><h3 id="_5-5-1-常见熔断策略" tabindex="-1"><a class="header-anchor" href="#_5-5-1-常见熔断策略" aria-hidden="true">#</a> 5.5.1 常见熔断策略</h3><p>常见熔断策略配置：</p><ul><li>熔断后休眠时间：sleepWindowInMilliseconds</li><li>熔断触发最小请求次数：requestVolumeThreshold</li><li>熔断触发错误比例阈值：errorThresholdPercentage</li><li>熔断超时时间：timeoutInMilliseconds</li></ul><h3 id="_5-5-2-配置熔断策略" tabindex="-1"><a class="header-anchor" href="#_5-5-2-配置熔断策略" aria-hidden="true">#</a> 5.5.2 配置熔断策略</h3><p>在服务<strong>消费方工程</strong>配置如下内容：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment"># 无注解版 ，Threshold阈值的含义</span>
<span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
  <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token key atrule">default</span><span class="token punctuation">:</span>
      <span class="token key atrule">circuitBreaker</span><span class="token punctuation">:</span>
        <span class="token key atrule">forceOpen</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
        <span class="token key atrule">errorThresholdPercentage</span><span class="token punctuation">:</span> <span class="token number">50</span>
        <span class="token key atrule">sleepWindowInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">10000</span>
        <span class="token key atrule">requestVolumeThreshold</span><span class="token punctuation">:</span> <span class="token number">10</span>
      <span class="token key atrule">execution</span><span class="token punctuation">:</span>
        <span class="token key atrule">isolation</span><span class="token punctuation">:</span>
          <span class="token key atrule">thread</span><span class="token punctuation">:</span>
            <span class="token key atrule">timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">2000</span>

<span class="token comment"># 配置熔断策略：</span>
<span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
  <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token key atrule">default</span><span class="token punctuation">:</span>
      <span class="token key atrule">circuitBreaker</span><span class="token punctuation">:</span>
        <span class="token comment"># 强制打开熔断器 默认false关闭的。测试配置是否生效</span>
        <span class="token key atrule">forceOpen</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
        <span class="token comment"># 触发熔断错误比例阈值，默认值50%</span>
        <span class="token key atrule">errorThresholdPercentage</span><span class="token punctuation">:</span> <span class="token number">50</span>
        <span class="token comment"># 熔断后休眠时长，默认值5秒</span>
        <span class="token key atrule">sleepWindowInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">5000</span>
        <span class="token comment"># 熔断触发最小请求次数，默认值是20</span>
        <span class="token key atrule">requestVolumeThreshold</span><span class="token punctuation">:</span> <span class="token number">10</span>
      <span class="token key atrule">execution</span><span class="token punctuation">:</span>
        <span class="token key atrule">isolation</span><span class="token punctuation">:</span>
          <span class="token key atrule">thread</span><span class="token punctuation">:</span>
            <span class="token comment"># 熔断超时设置，默认为1秒</span>
            <span class="token key atrule">timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">2000</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-5-3-测试熔断超时时间" tabindex="-1"><a class="header-anchor" href="#_5-5-3-测试熔断超时时间" aria-hidden="true">#</a> 5.5.3 测试熔断超时时间</h3><p>在服务提供方，让线程休眠超过2秒中（例如休息5秒中），这个时候会走Fallback方法（因为在熔断策略配置当中，我们配置了熔断超时时间为2秒中，一旦超过2秒，则认为被调用的服务挂了，因此走Fallback【兜底】方法）。</p><figure><img src="`+vn+'" alt="1562920097541" tabindex="0" loading="lazy"><figcaption>1562920097541</figcaption></figure><h3 id="_5-5-4-测试熔断错误比例" tabindex="-1"><a class="header-anchor" href="#_5-5-4-测试熔断错误比例" aria-hidden="true">#</a> 5.5.4 测试熔断错误比例</h3><ul><li>在<strong>服务消费方</strong>编写抛出异常的代码（<strong>记得把提供方线程休眠的代码删除</strong>），如下：</li></ul><figure><img src="'+gn+'" alt="1562920566944" tabindex="0" loading="lazy"><figcaption>1562920566944</figcaption></figure>',20),Un=n("p",null,"如何测试：",-1),In={href:"http://localhost:8080/consumer/getUser/2",target:"_blank",rel:"noopener noreferrer"},Pn={href:"http://localhost:8080/consumer/getUser/1",target:"_blank",rel:"noopener noreferrer"},An=n("p",null,"多：",-1),qn=n("p",null,"1、远程调用",-1),Hn=n("p",null,"2、eureka注册中心",-1),zn=n("p",null,"2、负载均衡",-1),Mn=n("p",null,"3、熔断器",-1);function Bn(Ln,Nn){const t=o("ExternalLinkIcon");return i(),c("div",null,[hn,n("p",null,[s("访问地址："),n("a",yn,[s("http://localhost:9091/user/findUserById/1"),e(t)])]),fn,n("p",null,[s("请求地址："),n("a",_n,[s("http://localhost:8080/customer/getUserById/1"),e(t)])]),xn,n("p",null,[s("启动项目并访问，地址为： "),n("a",wn,[s("http://localhost:10086/"),e(t)]),s("> 。Eureka注册中心的控制面板如下：")]),Sn,n("p",null,[s("在消费方中调用，结果如下："),n("a",Cn,[s("http://localhost:8080/consumer/getUser/1"),e(t)])]),Tn,En,Rn,l("注意：因为熔断的降级逻辑方法跟正常逻辑方法一样，必须保证相同的参数列表和返回值相同"),jn,n("ul",null,[n("li",null,[Un,n("ul",null,[n("li",null,[s("访问"),n("a",In,[s("http://localhost:8080/consumer/getUser/2"),e(t)]),s(" 访问10次以上，那么这个时候访问id= 1的用户信息无法访问到，需要等待熔断休眠后（默认5秒） 防止恶意请求，就可以正常访问id=1的用户了。")]),n("li",null,[s("访问<"),n("a",Pn,[s("http://localhost:8080/consumer/getUser/1"),e(t)]),s(" 访问10次以上，再次访问id=2的用户信息超过5次，再次访问id为1的用户信息则无法访问到，错误请求占比正常请求达到50%。")])])])]),An,qn,Hn,zn,Mn])}const On=p(bn,[["render",Bn],["__file","SpringCloud（一）.html.vue"]]);export{On as default};
