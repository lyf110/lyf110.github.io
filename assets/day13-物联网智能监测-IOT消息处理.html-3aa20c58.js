import{_ as e}from"./plugin-vue_export-helper-c27b6911.js";import{r as o,o as c,c as l,a as n,b as s,d as p,e as a}from"./app-5f6064b2.js";const i="/assets/image-20240407192427960-328-869ad412.png",u="/assets/image-20240407192427966-358-5dbb320a.png",r="/assets/image-20240407192427966-359-50a96173.png",k="/assets/image-20240407192427966-360-211e18b6.png",d="/assets/image-20240407192427966-361-bc55670a.png",m="/assets/image-20240407192427966-362-8dadae3e.png",v="/assets/image-20240407192427966-363-5253673f.png",g="/assets/image-20240407192427967-364-7a532889.png",b="/assets/image-20240407192427967-365-f37efbd0.png",q="/assets/image-20240407192427967-366-34090a00.png",y="/assets/image-20240407192427967-367-018291ef.png",f="/assets/image-20240407192427967-368-a5c61a69.png",h="/assets/image-20240407192427967-369-954479d0.png",w="/assets/image-20240407192427967-370-cf56446d.png",I="/assets/image-20240407192427967-371-81a701f1.png",_="/assets/image-20240407192427967-372-1aa1d41d.png",S="/assets/image-20240407192427967-373-d04ca2b5.png",D="/assets/image-20240407192427967-374-2dbe565d.png",x="/assets/image-20240407192427967-375-fb0ffda7.png",T="/assets/image-20240407192427968-376-c3d1d731.png",j="/assets/image-20240407192427968-377-4a3ecf81.png",C="/assets/image-20240407192427968-378-d9e8ce07.png",A="/assets/image-20240407192427968-379-1638605b.png",R="/assets/image-20240407192427968-380-cd290116.png",L="/assets/image-20240407192427968-381-d3b81c7a.png",P="/assets/image-20240407192427968-382-2d59dcef.png",N="/assets/image-20240407192427968-383-9eb99127.png",V={},M=a('<h1 id="物联网智能监测-iot消息处理" tabindex="-1"><a class="header-anchor" href="#物联网智能监测-iot消息处理" aria-hidden="true">#</a> 物联网智能监测-IOT消息处理</h1><h2 id="_1-目标" tabindex="-1"><a class="header-anchor" href="#_1-目标" aria-hidden="true">#</a> 1 目标</h2><p>前一天我们已经完成了设备的管理，今天，我们就来处理设备联网之后上报数据的处理。</p><p>我们再来回顾一下IOT基本的工作原理</p><figure><img src="'+i+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>从图中，我们可以看到，当设备上报数据到IOT平台之后，业务系统可以从IOT平台中拉取数据到自己的数据库，方便在业务应用中去展示。</p><p>今天的目标：</p><ul><li>能够熟悉AMQP协议的特点</li><li>能够完成使用AMQP消费IOT中设备上报的数据</li><li>能够清楚线程池的使用方式及使用场景</li><li>能够完成智能床位的功能开发</li><li>能够完成家属端老人数据的报表展示</li></ul><h2 id="_2-异步处理基础概念" tabindex="-1"><a class="header-anchor" href="#_2-异步处理基础概念" aria-hidden="true">#</a> 2 异步处理基础概念</h2><h3 id="_2-1-同步和异步" tabindex="-1"><a class="header-anchor" href="#_2-1-同步和异步" aria-hidden="true">#</a> 2.1 同步和异步</h3><ul><li>同步（Background Synchronous）是指任务在后台进行处理，但需要等待任务完成后才能继续执行其他操作</li><li>异步（Asynchronous）是指任务的提交和执行是相互独立的，任务的执行不会阻塞程序的继续执行</li></ul><p>如下图：</p><figure><img src="'+u+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>同步模式下，任务1完成后才能执行任务2，任务2需要等待任务1的完成。这种顺序执行的方式称为同步。</li><li>异步模式下，任务1和任务2可以并行执行，彼此之间相互独立，不需要等待对方的完成。这种并行执行的方式称为异步。</li></ul><p>好处：</p><ul><li>提高系统的并发性</li><li>改善系统的响应性</li></ul><p>缺点：</p><ul><li>复杂性增加</li><li>资源消耗增加</li></ul><h3 id="_2-2-消息队列的基础概念" tabindex="-1"><a class="header-anchor" href="#_2-2-消息队列的基础概念" aria-hidden="true">#</a> 2.2 消息队列的基础概念</h3><figure><img src="'+r+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>生产者：负责将消息发送到消息队列中</li><li>消费者：负责从消息队列中获取消息并进行处理</li><li>队列：存储消息</li><li>broker：负责接收、存储和分发消息的中间件组件，实现了发送者和接收者之间的解耦和<strong>异步</strong>通信</li><li>topic：消息的分类</li></ul><p>在IOT中数据流转是这样的，如下图</p><figure><img src="'+k+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>生产者：设备负责将消息发送到IOT中（队列）</li><li>每个产品可以绑定不同的topic来进行消息分类，比如有电视topic、手表topic</li><li>IOT本身相当于是一个队列</li><li>消费者可以从指定的topic中获取数据</li><li>如果有多个消费者都要接收同一类消息，可以设置多个消费者，称为消费者组</li></ul><h3 id="_2-3-什么是amqp" tabindex="-1"><a class="header-anchor" href="#_2-3-什么是amqp" aria-hidden="true">#</a> 2.3 什么是AMQP</h3><p>AMQP全称Advanced Message Queuing Protocol，是一种网络协议，用于在应用程序之间传递消息。它是一种开放标准的消息传递协议，可以在不同的系统之间实现可靠、安全、高效的消息传递。</p><p>AMQP协议的实现包括多种消息队列软件，例如RabbitMQ、Apache ActiveMQ**、Apache Qpid**等。这些软件提供了可靠、高效的消息传递服务，广泛应用于分布式系统、云计算、物联网等领域。</p><blockquote><p>我们这次课程并不会详细讲解这些软件的使用，其中关于RabbitMQ我们后期的课程中会详细的，重点的去讲解。</p></blockquote><p>今天我们会在课程中快速使用Apache Qpid软件来接收IOT中的数据，如下图</p><figure><img src="'+d+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="_3-设备数据消费" tabindex="-1"><a class="header-anchor" href="#_3-设备数据消费" aria-hidden="true">#</a> 3 设备数据消费</h2><p>在IOT官方文档中，已经提供了对应的接收数据的解决方案，如下链接：</p>',32),z={href:"https://help.aliyun.com/zh/iot/developer-reference/connect-a-client-to-iot-platform-by-using-the-sdk-for-java?spm=a2c4g.11186623.0.0.7d7234bdQCi7MQ",target:"_blank",rel:"noopener noreferrer"},E=a(`<h3 id="_3-1-官网java-sdk接入" tabindex="-1"><a class="header-anchor" href="#_3-1-官网java-sdk接入" aria-hidden="true">#</a> 3.1 官网Java SDK接入</h3><h4 id="_3-1-1-导入pom依赖" tabindex="-1"><a class="header-anchor" href="#_3-1-1-导入pom依赖" aria-hidden="true">#</a> 3.1.1 导入pom依赖</h4><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- amqp 1.0 qpid client --&gt;</span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.qpid<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>qpid-jms-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.57.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
 <span class="token comment">&lt;!-- util for base64--&gt;</span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>commons-codec<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-codec<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-1-2-下载demo代码包" tabindex="-1"><a class="header-anchor" href="#_3-1-2-下载demo代码包" aria-hidden="true">#</a> 3.1.2 下载Demo代码包</h4>`,4),O={href:"https://linkkit-export.oss-cn-shanghai.aliyuncs.com/amqp/amqp-demo.zip",target:"_blank",rel:"noopener noreferrer"},U=a('<figure><img src="'+m+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>代码包可以在当天资料中找到</p><h4 id="_3-1-3-接收数据" tabindex="-1"><a class="header-anchor" href="#_3-1-3-接收数据" aria-hidden="true">#</a> 3.1.3 接收数据</h4><p>我们可以修改里面的参数，包含以下几个重要参数：</p><ul><li></li></ul><p>accessKey   秘钥key</p><ul><li></li></ul><p>accessSecret    秘钥</p><ul><li></li></ul><p>consumerGroupId    消费者组</p><figure><img src="'+v+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li></li></ul><p>iotInstanceId   公共实例ID</p><ul><li></li></ul><p>clientId：InetAddress.getLocalHost().getHostAddress();  获取本机ip作为clientId</p><p>修改之后的代码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>iotx<span class="token punctuation">.</span>demo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">InetAddress</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">URI</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">UnknownHostException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Hashtable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ExecutorService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">LinkedBlockingQueue</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ThreadPoolExecutor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span><span class="token class-name">Mac</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>spec<span class="token punctuation">.</span></span><span class="token class-name">SecretKeySpec</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>jms<span class="token punctuation">.</span></span><span class="token class-name">Connection</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>jms<span class="token punctuation">.</span></span><span class="token class-name">ConnectionFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>jms<span class="token punctuation">.</span></span><span class="token class-name">Destination</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>jms<span class="token punctuation">.</span></span><span class="token class-name">JMSException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>jms<span class="token punctuation">.</span></span><span class="token class-name">Message</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>jms<span class="token punctuation">.</span></span><span class="token class-name">MessageConsumer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>jms<span class="token punctuation">.</span></span><span class="token class-name">MessageListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>jms<span class="token punctuation">.</span></span><span class="token class-name">MessageProducer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>jms<span class="token punctuation">.</span></span><span class="token class-name">Session</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">Context</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">InitialContext</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>codec<span class="token punctuation">.</span>binary<span class="token punctuation">.</span></span><span class="token class-name">Base64</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>qpid<span class="token punctuation">.</span>jms<span class="token punctuation">.</span></span><span class="token class-name">JmsConnection</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>qpid<span class="token punctuation">.</span>jms<span class="token punctuation">.</span></span><span class="token class-name">JmsConnectionListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>qpid<span class="token punctuation">.</span>jms<span class="token punctuation">.</span>message<span class="token punctuation">.</span></span><span class="token class-name">JmsInboundMessageDispatch</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AmqpClient</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">AmqpClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 工程代码泄露可能会导致 AccessKey 泄露，并威胁账号下所有资源的安全性。以下代码示例使用环境变量获取 AccessKey 的方式进行调用，仅供参考
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> accessKey <span class="token operator">=</span> <span class="token string">&quot;LTAI5tDQKg9F61aJhbmhqVRK&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> accessSecret <span class="token operator">=</span> <span class="token string">&quot;LYUKZH7HQGBoD025pmSq0fQsREaOYD&quot;</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> consumerGroupId <span class="token operator">=</span> <span class="token string">&quot;eraicKJm98cQR0hHgsxb000100&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">//iotInstanceId：实例ID。若是2021年07月30日之前（不含当日）开通的公共实例，请填空字符串。</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> iotInstanceId <span class="token operator">=</span> <span class="token string">&quot;iot-06z00frq8umvkx2&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">//控制台服务端订阅中消费组状态页客户端ID一栏将显示clientId参数。</span>
    <span class="token comment">//建议使用机器UUID、MAC地址、IP等唯一标识等作为clientId。便于您区分识别不同的客户端。</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> clientId<span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            clientId <span class="token operator">=</span> <span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getLocalHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHostAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnknownHostException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//\${YourHost}为接入域名，请参见AMQP客户端接入说明文档。</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> host <span class="token operator">=</span> <span class="token string">&quot;iot-06z00frq8umvkx2.amqp.iothub.aliyuncs.com&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// 指定单个进程启动的连接数</span>
    <span class="token comment">// 单个连接消费速率有限，请参考使用限制，最大64个连接</span>
    <span class="token comment">// 连接数和消费速率及rebalance相关，建议每500QPS增加一个连接</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> connectionCount <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>

    <span class="token comment">//业务处理异步线程池，线程池参数可以根据您的业务特点调整，或者您也可以用其他异步方式处理接收到的消息。</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
        <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token punctuation">(</span><span class="token number">50000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">&gt;</span></span> connections <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//参数说明，请参见AMQP客户端接入说明文档。</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> connectionCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> timeStamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//签名方法：支持hmacmd5、hmacsha1和hmacsha256。</span>
            <span class="token class-name">String</span> signMethod <span class="token operator">=</span> <span class="token string">&quot;hmacsha1&quot;</span><span class="token punctuation">;</span>

            <span class="token comment">//userName组装方法，请参见AMQP客户端接入说明文档。</span>
            <span class="token class-name">String</span> userName <span class="token operator">=</span> clientId <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot;|authMode=aksign&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;,signMethod=&quot;</span> <span class="token operator">+</span> signMethod
                <span class="token operator">+</span> <span class="token string">&quot;,timestamp=&quot;</span> <span class="token operator">+</span> timeStamp
                <span class="token operator">+</span> <span class="token string">&quot;,authId=&quot;</span> <span class="token operator">+</span> accessKey
                <span class="token operator">+</span> <span class="token string">&quot;,iotInstanceId=&quot;</span> <span class="token operator">+</span> iotInstanceId
                <span class="token operator">+</span> <span class="token string">&quot;,consumerGroupId=&quot;</span> <span class="token operator">+</span> consumerGroupId
                <span class="token operator">+</span> <span class="token string">&quot;|&quot;</span><span class="token punctuation">;</span>
            <span class="token comment">//计算签名，password组装方法，请参见AMQP客户端接入说明文档。</span>
            <span class="token class-name">String</span> signContent <span class="token operator">=</span> <span class="token string">&quot;authId=&quot;</span> <span class="token operator">+</span> accessKey <span class="token operator">+</span> <span class="token string">&quot;&amp;timestamp=&quot;</span> <span class="token operator">+</span> timeStamp<span class="token punctuation">;</span>
            <span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token function">doSign</span><span class="token punctuation">(</span>signContent<span class="token punctuation">,</span> accessSecret<span class="token punctuation">,</span> signMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> connectionUrl <span class="token operator">=</span> <span class="token string">&quot;failover:(amqps://&quot;</span> <span class="token operator">+</span> host <span class="token operator">+</span> <span class="token string">&quot;:5671?amqp.idleTimeout=80000)&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;?failover.reconnectDelay=30&quot;</span><span class="token punctuation">;</span>

            <span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> hashtable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            hashtable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;connectionfactory.SBCF&quot;</span><span class="token punctuation">,</span> connectionUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            hashtable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;queue.QUEUE&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;default&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            hashtable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">INITIAL_CONTEXT_FACTORY</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.qpid.jms.jndi.JmsInitialContextFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Context</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InitialContext</span><span class="token punctuation">(</span>hashtable<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ConnectionFactory</span> cf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ConnectionFactory</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token string">&quot;SBCF&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Destination</span> queue <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Destination</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token string">&quot;QUEUE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 创建连接。</span>
            <span class="token class-name">Connection</span> connection <span class="token operator">=</span> cf<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span>userName<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
            connections<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">JmsConnection</span><span class="token punctuation">)</span>connection<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addConnectionListener</span><span class="token punctuation">(</span>myJmsConnectionListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 创建会话。</span>
            <span class="token comment">// Session.CLIENT_ACKNOWLEDGE: 收到消息后，需要手动调用message.acknowledge()。</span>
            <span class="token comment">// Session.AUTO_ACKNOWLEDGE: SDK自动ACK（推荐）。</span>
            <span class="token class-name">Session</span> session <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token class-name">Session</span><span class="token punctuation">.</span><span class="token constant">AUTO_ACKNOWLEDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            connection<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 创建Receiver连接。</span>
            <span class="token class-name">MessageConsumer</span> consumer <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createConsumer</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            consumer<span class="token punctuation">.</span><span class="token function">setMessageListener</span><span class="token punctuation">(</span>messageListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;amqp demo is started successfully, and will exit after 60s &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 结束程序运行 </span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">6000</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;run shutdown&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        connections<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                c<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JMSException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;failed to close connection&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>executorService<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;shutdown success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;failed to handle messages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">MessageListener</span> messageListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Message</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//1.收到消息之后一定要ACK。</span>
                <span class="token comment">// 推荐做法：创建Session选择Session.AUTO_ACKNOWLEDGE，这里会自动ACK。</span>
                <span class="token comment">// 其他做法：创建Session选择Session.CLIENT_ACKNOWLEDGE，这里一定要调message.acknowledge()来ACK。</span>
                <span class="token comment">// message.acknowledge();</span>
                <span class="token comment">//2.建议异步处理收到的消息，确保onMessage函数里没有耗时逻辑。</span>
                <span class="token comment">// 如果业务处理耗时过程过长阻塞住线程，可能会影响SDK收到消息后的正常回调。</span>
                executorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">processMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;submit task occurs exception &quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 在这里处理您收到消息后的具体业务逻辑。
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">processMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> topic <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getStringProperty</span><span class="token punctuation">(</span><span class="token string">&quot;topic&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> messageId <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getStringProperty</span><span class="token punctuation">(</span><span class="token string">&quot;messageId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;receive message&quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;,\\n topic = &quot;</span> <span class="token operator">+</span> topic
                <span class="token operator">+</span> <span class="token string">&quot;,\\n messageId = &quot;</span> <span class="token operator">+</span> messageId
                <span class="token operator">+</span> <span class="token string">&quot;,\\n content = &quot;</span> <span class="token operator">+</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;processMessage occurs error &quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">JmsConnectionListener</span> myJmsConnectionListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JmsConnectionListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * 连接成功建立。
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onConnectionEstablished</span><span class="token punctuation">(</span><span class="token class-name">URI</span> remoteURI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;onConnectionEstablished, remoteUri:{}&quot;</span><span class="token punctuation">,</span> remoteURI<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token doc-comment comment">/**
         * 尝试过最大重试次数之后，最终连接失败。
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onConnectionFailure</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;onConnectionFailure, {}&quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token doc-comment comment">/**
         * 连接中断。
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onConnectionInterrupted</span><span class="token punctuation">(</span><span class="token class-name">URI</span> remoteURI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;onConnectionInterrupted, remoteUri:{}&quot;</span><span class="token punctuation">,</span> remoteURI<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token doc-comment comment">/**
         * 连接中断后又自动重连上。
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onConnectionRestored</span><span class="token punctuation">(</span><span class="token class-name">URI</span> remoteURI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;onConnectionRestored, remoteUri:{}&quot;</span><span class="token punctuation">,</span> remoteURI<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onInboundMessage</span><span class="token punctuation">(</span><span class="token class-name">JmsInboundMessageDispatch</span> envelope<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSessionClosed</span><span class="token punctuation">(</span><span class="token class-name">Session</span> session<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onConsumerClosed</span><span class="token punctuation">(</span><span class="token class-name">MessageConsumer</span> consumer<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onProducerClosed</span><span class="token punctuation">(</span><span class="token class-name">MessageProducer</span> producer<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 计算签名，password组装方法，请参见AMQP客户端接入说明文档。
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">doSign</span><span class="token punctuation">(</span><span class="token class-name">String</span> toSignString<span class="token punctuation">,</span> <span class="token class-name">String</span> secret<span class="token punctuation">,</span> <span class="token class-name">String</span> signMethod<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">SecretKeySpec</span> signingKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span>secret<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> signMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Mac</span> mac <span class="token operator">=</span> <span class="token class-name">Mac</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>signMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mac<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>signingKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> rawHmac <span class="token operator">=</span> mac<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>toSignString<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">encodeBase64String</span><span class="token punctuation">(</span>rawHmac<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上代码启动之后，并不能接收到数据，因为设备并没有绑定topic，所以需要在物联网IOT平台设置topic，也就是消费者的消费者组</p><p>第一：找到  <strong>消息转发</strong>-&gt;<strong>服务端订阅</strong>-&gt;<strong>消费者组列表</strong></p><figure><img src="`+g+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>创建一个自己的消费者组</p><figure><img src="'+b+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>创建好之后可以查看到已经创建好的消费者组，并且自动生成了消费者组id</p><figure><img src="'+q+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>进入刚刚创建的消费者组，然后点击订阅产品，然后创建订阅</p><p>需要选择消费者组与推送消息类型（设备上报数据），如下图</p><figure><img src="'+y+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>修改demo代码中的消费者组，改为自己创建的消费者组ID</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> consumerGroupId <span class="token operator">=</span> <span class="token string">&quot;eraicKJm98cQR0hHgsxb000100&quot;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="_3-1-4-测试" tabindex="-1"><a class="header-anchor" href="#_3-1-4-测试" aria-hidden="true">#</a> 3.1.4 测试</h4><ul><li></li></ul><p>找一个设备进行数据上报</p><ul><li></li></ul><p>demo代码中绑定对应的消费者组</p><ul><li></li></ul><p>启动后台代码，可以在日志中查看消费者到的数据</p><figure><img src="`+f+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_3-2-sdk改造" tabindex="-1"><a class="header-anchor" href="#_3-2-sdk改造" aria-hidden="true">#</a> 3.2 SDK改造</h3><p>SDK提供好的这个工具类，我们需要改造这个类，改造内容如下：</p><ul><li>让spring进行管理和监听，一旦有数据变化之后，就可以马上消费，可以让这个类实现ApplicationRunner接口，重新run方法</li><li>可以在项目中自己配置线程池的使用</li><li>所有的可变参数，如实例id、accessKey、accessSecret、consumerGroupId这些统一在配置文件中维护</li></ul><h4 id="_3-2-1-application-yml文件中添加iot配置" tabindex="-1"><a class="header-anchor" href="#_3-2-1-application-yml文件中添加iot配置" aria-hidden="true">#</a> 3.2.1 application.yml文件中添加IOT配置</h4><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">zzyl</span><span class="token punctuation">:</span>
  <span class="token key atrule">aliyun</span><span class="token punctuation">:</span>
    <span class="token key atrule">accessKeyId</span><span class="token punctuation">:</span> LTAI5tDQKg9F61aJhbmhqVRK
    <span class="token key atrule">accessKeySecret</span><span class="token punctuation">:</span> LYUKZH7HQGBoD025pmSq0fQsREaOYD
    <span class="token key atrule">consumerGroupId</span><span class="token punctuation">:</span> DEFAULT_GROUP
    <span class="token key atrule">regionId</span><span class="token punctuation">:</span> cn<span class="token punctuation">-</span>shanghai
    <span class="token key atrule">iotInstanceId</span><span class="token punctuation">:</span> iot<span class="token punctuation">-</span>06z00frq8umvkx2
    <span class="token key atrule">host</span><span class="token punctuation">:</span> iot<span class="token punctuation">-</span>06z00frq8umvkx2.amqp.iothub.aliyuncs.com
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在zzyl-framework中添加读取文件配置类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>zzyl<span class="token punctuation">.</span>properties</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Getter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">NoArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Setter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">ToString</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">ConfigurationProperties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> sjqn
 * <span class="token keyword">@date</span> 2023/10/7
 */</span>

<span class="token annotation punctuation">@Setter</span>
<span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@ToString</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;zzyl.aliyun&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AliIoTConfigProperties</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 访问Key
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> accessKeyId<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 访问秘钥
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> accessKeySecret<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 区域id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> regionId<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 实例id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> iotInstanceId<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 域名
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> host<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 消费组
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> consumerGroupId<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-2-2-常见线程池配置类" tabindex="-1"><a class="header-anchor" href="#_3-2-2-常见线程池配置类" aria-hidden="true">#</a> 3.2.2 常见线程池配置类</h4><p>在zzyl-service中添加配置类，如下</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>zzyl<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ExecutorService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">LinkedBlockingQueue</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ThreadPoolExecutor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span></span><span class="token class-name">AtomicInteger</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolConfig</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 核心线程池大小
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CORE_POOL_SIZE</span> <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 最大可创建的线程数
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MAX_POOL_SIZE</span> <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 队列最大长度
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">QUEUE_CAPACITY</span> <span class="token operator">=</span> <span class="token number">50000</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 线程池维护线程所允许的空闲时间
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">KEEP_ALIVE_SECONDS</span> <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ExecutorService</span> <span class="token function">executorService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">AtomicInteger</span> c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token constant">QUEUE_CAPACITY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
                <span class="token constant">CORE_POOL_SIZE</span><span class="token punctuation">,</span>
                <span class="token constant">MAX_POOL_SIZE</span><span class="token punctuation">,</span>
                <span class="token constant">KEEP_ALIVE_SECONDS</span><span class="token punctuation">,</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">,</span>
                queue<span class="token punctuation">,</span>
                r <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">&quot;zzyl-pool-&quot;</span> <span class="token operator">+</span> c<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>DiscardPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-2-3-改造之后的amqpclient" tabindex="-1"><a class="header-anchor" href="#_3-2-3-改造之后的amqpclient" aria-hidden="true">#</a> 3.2.3 改造之后的AmqpClient</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>zzyl<span class="token punctuation">.</span>job</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>zzyl<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">AliIoTConfigProperties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>codec<span class="token punctuation">.</span>binary<span class="token punctuation">.</span></span><span class="token class-name">Base64</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>qpid<span class="token punctuation">.</span>jms<span class="token punctuation">.</span></span><span class="token class-name">JmsConnection</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>qpid<span class="token punctuation">.</span>jms<span class="token punctuation">.</span></span><span class="token class-name">JmsConnectionListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>qpid<span class="token punctuation">.</span>jms<span class="token punctuation">.</span>message<span class="token punctuation">.</span></span><span class="token class-name">JmsInboundMessageDispatch</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">ApplicationArguments</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">ApplicationRunner</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span><span class="token class-name">Mac</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>spec<span class="token punctuation">.</span></span><span class="token class-name">SecretKeySpec</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>jms<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">Context</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">InitialContext</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">InetAddress</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">URI</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">UnknownHostException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Hashtable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ExecutorService</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AmqpClient</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationRunner</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">AmqpClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AliIoTConfigProperties</span> aliIoTConfigProperties<span class="token punctuation">;</span>

    <span class="token comment">//控制台服务端订阅中消费组状态页客户端ID一栏将显示clientId参数。</span>
    <span class="token comment">//建议使用机器UUID、MAC地址、IP等唯一标识等作为clientId。便于您区分识别不同的客户端。</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> clientId<span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            clientId <span class="token operator">=</span> <span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getLocalHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHostAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnknownHostException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 指定单个进程启动的连接数</span>
    <span class="token comment">// 单个连接消费速率有限，请参考使用限制，最大64个连接</span>
    <span class="token comment">// 连接数和消费速率及rebalance相关，建议每500QPS增加一个连接</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> connectionCount <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>

    <span class="token comment">//业务处理异步线程池，线程池参数可以根据您的业务特点调整，或者您也可以用其他异步方式处理接收到的消息。</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ExecutorService</span> executorService<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">&gt;</span></span> connections <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//参数说明，请参见AMQP客户端接入说明文档。</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> connectionCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> timeStamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//签名方法：支持hmacmd5、hmacsha1和hmacsha256。</span>
            <span class="token class-name">String</span> signMethod <span class="token operator">=</span> <span class="token string">&quot;hmacsha1&quot;</span><span class="token punctuation">;</span>

            <span class="token comment">//userName组装方法，请参见AMQP客户端接入说明文档。</span>
            <span class="token class-name">String</span> userName <span class="token operator">=</span> clientId <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot;|authMode=aksign&quot;</span>
                    <span class="token operator">+</span> <span class="token string">&quot;,signMethod=&quot;</span> <span class="token operator">+</span> signMethod
                    <span class="token operator">+</span> <span class="token string">&quot;,timestamp=&quot;</span> <span class="token operator">+</span> timeStamp
                    <span class="token operator">+</span> <span class="token string">&quot;,authId=&quot;</span> <span class="token operator">+</span> aliIoTConfigProperties<span class="token punctuation">.</span><span class="token function">getAccessKeyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">&quot;,iotInstanceId=&quot;</span> <span class="token operator">+</span> aliIoTConfigProperties<span class="token punctuation">.</span><span class="token function">getIotInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">&quot;,consumerGroupId=&quot;</span> <span class="token operator">+</span> aliIoTConfigProperties<span class="token punctuation">.</span><span class="token function">getConsumerGroupId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">&quot;|&quot;</span><span class="token punctuation">;</span>
            <span class="token comment">//计算签名，password组装方法，请参见AMQP客户端接入说明文档。</span>
            <span class="token class-name">String</span> signContent <span class="token operator">=</span> <span class="token string">&quot;authId=&quot;</span> <span class="token operator">+</span> aliIoTConfigProperties<span class="token punctuation">.</span><span class="token function">getAccessKeyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&amp;timestamp=&quot;</span> <span class="token operator">+</span> timeStamp<span class="token punctuation">;</span>
            <span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token function">doSign</span><span class="token punctuation">(</span>signContent<span class="token punctuation">,</span> aliIoTConfigProperties<span class="token punctuation">.</span><span class="token function">getAccessKeySecret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> signMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> connectionUrl <span class="token operator">=</span> <span class="token string">&quot;failover:(amqps://&quot;</span> <span class="token operator">+</span> aliIoTConfigProperties<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:5671?amqp.idleTimeout=80000)&quot;</span>
                    <span class="token operator">+</span> <span class="token string">&quot;?failover.reconnectDelay=30&quot;</span><span class="token punctuation">;</span>

            <span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> hashtable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            hashtable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;connectionfactory.SBCF&quot;</span><span class="token punctuation">,</span> connectionUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            hashtable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;queue.QUEUE&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;default&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            hashtable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">INITIAL_CONTEXT_FACTORY</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.qpid.jms.jndi.JmsInitialContextFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Context</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InitialContext</span><span class="token punctuation">(</span>hashtable<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ConnectionFactory</span> cf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ConnectionFactory</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token string">&quot;SBCF&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Destination</span> queue <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Destination</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token string">&quot;QUEUE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 创建连接。</span>
            <span class="token class-name">Connection</span> connection <span class="token operator">=</span> cf<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span>userName<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
            connections<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">JmsConnection</span><span class="token punctuation">)</span> connection<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addConnectionListener</span><span class="token punctuation">(</span>myJmsConnectionListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 创建会话。</span>
            <span class="token comment">// Session.CLIENT_ACKNOWLEDGE: 收到消息后，需要手动调用message.acknowledge()。</span>
            <span class="token comment">// Session.AUTO_ACKNOWLEDGE: SDK自动ACK（推荐）。</span>
            <span class="token class-name">Session</span> session <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token class-name">Session</span><span class="token punctuation">.</span><span class="token constant">AUTO_ACKNOWLEDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            connection<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 创建Receiver连接。</span>
            <span class="token class-name">MessageConsumer</span> consumer <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createConsumer</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            consumer<span class="token punctuation">.</span><span class="token function">setMessageListener</span><span class="token punctuation">(</span>messageListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;amqp  is started successfully, and will exit after server shutdown &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">MessageListener</span> messageListener <span class="token operator">=</span> message <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//异步处理收到的消息，确保onMessage函数里没有耗时逻辑</span>
            executorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">processMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;submit task occurs exception &quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 在这里处理您收到消息后的具体业务逻辑。
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> contentStr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> topic <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getStringProperty</span><span class="token punctuation">(</span><span class="token string">&quot;topic&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> messageId <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getStringProperty</span><span class="token punctuation">(</span><span class="token string">&quot;messageId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;receive message&quot;</span>
                    <span class="token operator">+</span> <span class="token string">&quot;,\\n topic = &quot;</span> <span class="token operator">+</span> topic
                    <span class="token operator">+</span> <span class="token string">&quot;,\\n messageId = &quot;</span> <span class="token operator">+</span> messageId
                    <span class="token operator">+</span> <span class="token string">&quot;,\\n content = &quot;</span> <span class="token operator">+</span> contentStr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;processMessage occurs error &quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">JmsConnectionListener</span> myJmsConnectionListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JmsConnectionListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * 连接成功建立。
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onConnectionEstablished</span><span class="token punctuation">(</span><span class="token class-name">URI</span> remoteURI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;onConnectionEstablished, remoteUri:{}&quot;</span><span class="token punctuation">,</span> remoteURI<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token doc-comment comment">/**
         * 尝试过最大重试次数之后，最终连接失败。
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onConnectionFailure</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;onConnectionFailure, {}&quot;</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token doc-comment comment">/**
         * 连接中断。
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onConnectionInterrupted</span><span class="token punctuation">(</span><span class="token class-name">URI</span> remoteURI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;onConnectionInterrupted, remoteUri:{}&quot;</span><span class="token punctuation">,</span> remoteURI<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token doc-comment comment">/**
         * 连接中断后又自动重连上。
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onConnectionRestored</span><span class="token punctuation">(</span><span class="token class-name">URI</span> remoteURI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;onConnectionRestored, remoteUri:{}&quot;</span><span class="token punctuation">,</span> remoteURI<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onInboundMessage</span><span class="token punctuation">(</span><span class="token class-name">JmsInboundMessageDispatch</span> envelope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSessionClosed</span><span class="token punctuation">(</span><span class="token class-name">Session</span> session<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onConsumerClosed</span><span class="token punctuation">(</span><span class="token class-name">MessageConsumer</span> consumer<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onProducerClosed</span><span class="token punctuation">(</span><span class="token class-name">MessageProducer</span> producer<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 计算签名，password组装方法，请参见AMQP客户端接入说明文档。
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">doSign</span><span class="token punctuation">(</span><span class="token class-name">String</span> toSignString<span class="token punctuation">,</span> <span class="token class-name">String</span> secret<span class="token punctuation">,</span> <span class="token class-name">String</span> signMethod<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">SecretKeySpec</span> signingKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span>secret<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> signMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Mac</span> mac <span class="token operator">=</span> <span class="token class-name">Mac</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>signMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mac<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>signingKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> rawHmac <span class="token operator">=</span> mac<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>toSignString<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">encodeBase64String</span><span class="token punctuation">(</span>rawHmac<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ApplicationArguments</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-2-4-设备消息订阅" tabindex="-1"><a class="header-anchor" href="#_3-2-4-设备消息订阅" aria-hidden="true">#</a> 3.2.4 设备消息订阅</h4><p>在接收消息之前，我们需要让设备绑定消费组列表，这样才能通过消费组去接收消息</p><p>第一：找到  <strong>消息转发</strong>-&gt;<strong>服务端订阅</strong>-&gt;<strong>消费者组列表</strong></p><p>目前有一个默认的消费组</p><figure><img src="`+h+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>第二：创建订阅，让产品与消费组进行关联</p><figure><img src="'+w+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li></li></ul><p>在<strong>服务端订阅</strong>页面的<strong>订阅列表</strong>页签下，单击<strong>创建订阅</strong>。</p><ul><li></li></ul><p>在<strong>创建订阅</strong>对话框，设置参数后单击<strong>确认</strong>。</p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>产品</td><td>选择自己的产品（智能手表）</td></tr><tr><td>订阅类型</td><td>选择<strong>AMQP</strong></td></tr><tr><td>消费组</td><td>选择<strong>默认消费组</strong></td></tr><tr><td>推送消息类型</td><td>选择<strong>设备上报消息</strong></td></tr></tbody></table><h3 id="_3-3-接收设备端数据" tabindex="-1"><a class="header-anchor" href="#_3-3-接收设备端数据" aria-hidden="true">#</a> 3.3 接收设备端数据</h3><h4 id="_3-3-1-思路分析" tabindex="-1"><a class="header-anchor" href="#_3-3-1-思路分析" aria-hidden="true">#</a> 3.3.1 思路分析</h4><figure><img src="'+I+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="_3-3-2-功能实现" tabindex="-1"><a class="header-anchor" href="#_3-3-2-功能实现" aria-hidden="true">#</a> 3.3.2 功能实现</h4><p>接收到的数据格式</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;deviceType&quot;</span><span class="token operator">:</span><span class="token string">&quot;ActiveInfraredIntrusionDetectors&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;iotId&quot;</span><span class="token operator">:</span><span class="token string">&quot;DoXPJsxUkV0Kcw9zrLRaj0rk00&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;requestId&quot;</span><span class="token operator">:</span><span class="token string">&quot;1699948275310&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;checkFailedData&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>

    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;productKey&quot;</span><span class="token operator">:</span><span class="token string">&quot;j0rkHpZoAQ3&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;gmtCreate&quot;</span><span class="token operator">:</span><span class="token number">1699948275451</span><span class="token punctuation">,</span>
    <span class="token property">&quot;deviceName&quot;</span><span class="token operator">:</span><span class="token string">&quot;yangan_09&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;items&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;CurrentHumidity&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token number">75</span><span class="token punctuation">,</span>
            <span class="token property">&quot;time&quot;</span><span class="token operator">:</span><span class="token number">1699948275447</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;BatteryLevel&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token number">75</span><span class="token punctuation">,</span>
            <span class="token property">&quot;time&quot;</span><span class="token operator">:</span><span class="token number">1699948275447</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;SmokeSensorState&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token property">&quot;time&quot;</span><span class="token operator">:</span><span class="token number">1699948275447</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;IndoorTemperature&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token number">27</span><span class="token punctuation">,</span>
            <span class="token property">&quot;time&quot;</span><span class="token operator">:</span><span class="token number">1699948275447</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在转换的时候可以使用对象去接收</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>zzyl<span class="token punctuation">.</span>job</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Content</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 设备类型
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> deviceType<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 设备ID
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> iotId<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 请求ID
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> requestId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> checkFailedData<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 产品key
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> productKey<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> gmtCreate<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> deviceName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Item</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">long</span> time<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setValue</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> time<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTime</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>time <span class="token operator">=</span> time<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改AmqpClient类中的processMessage，方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">DeviceMapper</span> deviceMapper<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">DeviceDataMapper</span> deviceDataMapper<span class="token punctuation">;</span>


<span class="token doc-comment comment">/**
     * 在这里处理您收到消息后的具体业务逻辑。
     */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> contentStr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> topic <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getStringProperty</span><span class="token punctuation">(</span><span class="token string">&quot;topic&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> messageId <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getStringProperty</span><span class="token punctuation">(</span><span class="token string">&quot;messageId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;receive message&quot;</span>
                    <span class="token operator">+</span> <span class="token string">&quot;,\\n topic = &quot;</span> <span class="token operator">+</span> topic
                    <span class="token operator">+</span> <span class="token string">&quot;,\\n messageId = &quot;</span> <span class="token operator">+</span> messageId
                    <span class="token operator">+</span> <span class="token string">&quot;,\\n content = &quot;</span> <span class="token operator">+</span> contentStr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//解析数据</span>
        <span class="token class-name">Content</span> content <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>contentStr<span class="token punctuation">,</span> <span class="token class-name">Content</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//查询设备</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DeviceVo</span><span class="token punctuation">&gt;</span></span> deviceVos <span class="token operator">=</span> deviceMapper<span class="token punctuation">.</span><span class="token function">selectByDeviceIds</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">getIotId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>deviceVos<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;设备不存在&quot;</span> <span class="token operator">+</span> content<span class="token punctuation">.</span><span class="token function">getIotId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">DeviceVo</span> deviceVo <span class="token operator">=</span> deviceVos<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//保存设备数据,设备中可能会存在多个物模型</span>
        content<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">DeviceData</span> deviceData <span class="token operator">=</span> <span class="token class-name">DeviceData</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">alarmTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTimeUtil</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">deviceName</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">getDeviceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">iotId</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">getIotId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">productId</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">getProductKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">noteName</span><span class="token punctuation">(</span>deviceVo<span class="token punctuation">.</span><span class="token function">getNickname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">productName</span><span class="token punctuation">(</span>deviceVo<span class="token punctuation">.</span><span class="token function">getProductName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">accessLocation</span><span class="token punctuation">(</span>deviceVo<span class="token punctuation">.</span><span class="token function">getRemark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">functionName</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataValue</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">+</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//保存</span>
            deviceDataMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>deviceData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;processMessage occurs error &quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-3-3-测试" tabindex="-1"><a class="header-anchor" href="#_3-3-3-测试" aria-hidden="true">#</a> 3.3.3 测试</h4><p>（1）启动模拟设备进行上报</p><p>（2）启动后端项目，查看数据库是否保存数据成功</p><h3 id="_3-4-查看设备的物模型数据" tabindex="-1"><a class="header-anchor" href="#_3-4-查看设备的物模型数据" aria-hidden="true">#</a> 3.4 查看设备的物模型数据</h3><h4 id="_3-4-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_3-4-1-需求分析" aria-hidden="true">#</a> 3.4.1 需求分析</h4><p>我们先打开原型图，如下：</p><figure><img src="`+_+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>其中的数据值，是从IOT平台实时获取到的数据值</p><p>当点击了某个功能（物模型）的<strong>查看数据</strong>按钮，则会显示这个功能的历史数据，可以按照时间范围进行检索，如下图：</p><figure><img src="'+S+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>时间范围=1小时、24小时、7天、自定义；当选择自定义时，出时间选择器文本框；</p><h4 id="_3-4-2-接口定义" tabindex="-1"><a class="header-anchor" href="#_3-4-2-接口定义" aria-hidden="true">#</a> 3.4.2 接口定义</h4><p>目前需要两个接口，都是查询</p><ul><li>查询物模型列表及其数据</li><li>查询单个物模型的历史数据</li></ul><p>注意：其中的第一个接口，因为需要实时查询IOT平台，昨天已经实现，我们现在只需要实现第二个即可</p><p><strong>接口地址</strong>:<code>/device-data/get-page</code></p><p><strong>请求方式</strong>:<code>GET</code></p><p><strong>请求参数</strong>:</p><table><thead><tr><th>参数名称</th><th>参数说明</th><th>数据类型</th></tr></thead><tbody><tr><td>pageNum</td><td>页码</td><td>int</td></tr><tr><td>pageSize</td><td>每页大小</td><td>int</td></tr><tr><td>deviceName</td><td>设备名称</td><td>string</td></tr><tr><td>endTime</td><td>结束时间</td><td>long</td></tr><tr><td>functionId</td><td>功能ID</td><td>string</td></tr><tr><td>startTime</td><td>开始时间</td><td>long</td></tr><tr><td>status</td><td>状态 0 正常 1 异常 2待处理 3已处理</td><td>int</td></tr></tbody></table><p><strong>响应示例</strong>:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
	<span class="token string-property property">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token string-property property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token string-property property">&quot;page&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
		<span class="token string-property property">&quot;pageSize&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
		<span class="token string-property property">&quot;pages&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
		<span class="token string-property property">&quot;records&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
			<span class="token punctuation">{</span>
				<span class="token string-property property">&quot;accessLocation&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
				<span class="token string-property property">&quot;adminCreator&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
				<span class="token string-property property">&quot;alarmTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
				<span class="token string-property property">&quot;createBy&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
				<span class="token string-property property">&quot;createDay&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
				<span class="token string-property property">&quot;createTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
				<span class="token string-property property">&quot;createType&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
				<span class="token string-property property">&quot;creator&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
				<span class="token string-property property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
				<span class="token string-property property">&quot;dataState&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
				<span class="token string-property property">&quot;dataValue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
				<span class="token string-property property">&quot;deviceName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
				<span class="token string-property property">&quot;functionName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
				<span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
				<span class="token string-property property">&quot;noteName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
				<span class="token string-property property">&quot;processingResult&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
				<span class="token string-property property">&quot;processingTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
				<span class="token string-property property">&quot;processor&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
				<span class="token string-property property">&quot;productId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
				<span class="token string-property property">&quot;productName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
				<span class="token string-property property">&quot;remark&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
				<span class="token string-property property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
				<span class="token string-property property">&quot;updateBy&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
				<span class="token string-property property">&quot;updateTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
				<span class="token string-property property">&quot;updater&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">]</span><span class="token punctuation">,</span>
		<span class="token string-property property">&quot;total&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token string-property property">&quot;msg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
	<span class="token string-property property">&quot;operationTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-4-3-功能实现" tabindex="-1"><a class="header-anchor" href="#_3-4-3-功能实现" aria-hidden="true">#</a> 3.4.3 功能实现</h4><p>(1)定义接口</p><p>新增DeviceDataController类，并创建方法，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>zzyl<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>zzyl<span class="token punctuation">.</span>base<span class="token punctuation">.</span></span><span class="token class-name">PageResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>zzyl<span class="token punctuation">.</span>base<span class="token punctuation">.</span></span><span class="token class-name">ResponseResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>zzyl<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">DeviceDataService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>zzyl<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">DeviceDataVo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Api</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiOperation</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiParam</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestParam</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> sjqn
 * <span class="token keyword">@date</span> 2023/11/14
 */</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/device-data&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>tags <span class="token operator">=</span> <span class="token string">&quot;设备数据管理接口&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeviceDataController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DeviceDataService</span> deviceDataService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/get-page&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;获取设备数据分页结果&quot;</span><span class="token punctuation">,</span> notes <span class="token operator">=</span> <span class="token string">&quot;接收包含分页信息的请求参数，返回一个包含分页数据的Page&lt;DeviceDataDto&gt;对象&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageResponse</span><span class="token punctuation">&lt;</span><span class="token class-name">DeviceDataVo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getDeviceDataPage</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;页码&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;pageNum&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> pageNum<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;每页大小&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;pageSize&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> pageSize<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;设备名称&quot;</span><span class="token punctuation">)</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;deviceName&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> deviceName<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;功能ID&quot;</span><span class="token punctuation">)</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;functionId&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> functionId<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;开始时间&quot;</span><span class="token punctuation">)</span>  <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> startTime<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;结束时间&quot;</span><span class="token punctuation">)</span>  <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> endTime<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;状态 0 正常 1 异常 2待处理 3已处理&quot;</span><span class="token punctuation">)</span>  <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> status
    <span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> deviceDataService<span class="token punctuation">.</span><span class="token function">getDeviceDataPage</span><span class="token punctuation">(</span>pageNum<span class="token punctuation">,</span>pageSize<span class="token punctuation">,</span>deviceName<span class="token punctuation">,</span>accessLocation<span class="token punctuation">,</span>locationType<span class="token punctuation">,</span>functionId<span class="token punctuation">,</span>startTime<span class="token punctuation">,</span>endTime<span class="token punctuation">,</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(2)mapper和xml映射文件，已提供</p><p>(3)业务层</p><p>新增业务层接口DeviceDataService，定义方法如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>zzyl<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>zzyl<span class="token punctuation">.</span>base<span class="token punctuation">.</span></span><span class="token class-name">PageResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>zzyl<span class="token punctuation">.</span>base<span class="token punctuation">.</span></span><span class="token class-name">ResponseResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>zzyl<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">DeviceDataVo</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> sjqn
 * <span class="token keyword">@date</span> 2023/11/14
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">DeviceDataService</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 分页查询
     * <span class="token keyword">@param</span> <span class="token parameter">pageNum</span>
     * <span class="token keyword">@param</span> <span class="token parameter">pageSize</span>
     * <span class="token keyword">@param</span> <span class="token parameter">deviceName</span>
     * <span class="token keyword">@param</span> <span class="token parameter">accessLocation</span>
     * <span class="token keyword">@param</span> <span class="token parameter">locationType</span>
     * <span class="token keyword">@param</span> <span class="token parameter">functionId</span>
     * <span class="token keyword">@param</span> <span class="token parameter">startTime</span>
     * <span class="token keyword">@param</span> <span class="token parameter">endTime</span>
     * <span class="token keyword">@param</span> <span class="token parameter">status</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token class-name">ResponseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageResponse</span><span class="token punctuation">&lt;</span><span class="token class-name">DeviceDataVo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getDeviceDataPage</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> pageNum<span class="token punctuation">,</span> <span class="token class-name">Integer</span> pageSize<span class="token punctuation">,</span> <span class="token class-name">String</span> deviceName<span class="token punctuation">,</span> <span class="token class-name">String</span> accessLocation<span class="token punctuation">,</span> <span class="token class-name">Integer</span> locationType<span class="token punctuation">,</span> <span class="token class-name">String</span> functionId<span class="token punctuation">,</span> <span class="token class-name">Long</span> startTime<span class="token punctuation">,</span> <span class="token class-name">Long</span> endTime<span class="token punctuation">,</span> <span class="token class-name">Integer</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实现类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>zzyl<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>date<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTimeUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>pagehelper<span class="token punctuation">.</span></span><span class="token class-name">Page</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>pagehelper<span class="token punctuation">.</span></span><span class="token class-name">PageHelper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>zzyl<span class="token punctuation">.</span>base<span class="token punctuation">.</span></span><span class="token class-name">PageResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>zzyl<span class="token punctuation">.</span>base<span class="token punctuation">.</span></span><span class="token class-name">ResponseResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>zzyl<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">DeviceDataMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>zzyl<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">DeviceDataService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>zzyl<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">ObjectUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>zzyl<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">DeviceDataVo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> sjqn
 */</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeviceDataServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">DeviceDataService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DeviceDataMapper</span> deviceDataMapper<span class="token punctuation">;</span>


    <span class="token doc-comment comment">/**
     * 分页查询
     * <span class="token keyword">@param</span> <span class="token parameter">pageNum</span>
     * <span class="token keyword">@param</span> <span class="token parameter">pageSize</span>
     * <span class="token keyword">@param</span> <span class="token parameter">deviceName</span>
     * <span class="token keyword">@param</span> <span class="token parameter">accessLocation</span>
     * <span class="token keyword">@param</span> <span class="token parameter">locationType</span>
     * <span class="token keyword">@param</span> <span class="token parameter">functionId</span>
     * <span class="token keyword">@param</span> <span class="token parameter">startTime</span>
     * <span class="token keyword">@param</span> <span class="token parameter">endTime</span>
     * <span class="token keyword">@param</span> <span class="token parameter">status</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageResponse</span><span class="token punctuation">&lt;</span><span class="token class-name">DeviceDataVo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getDeviceDataPage</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> pageNum<span class="token punctuation">,</span> <span class="token class-name">Integer</span> pageSize<span class="token punctuation">,</span> <span class="token class-name">String</span> deviceName<span class="token punctuation">,</span> <span class="token class-name">String</span> accessLocation<span class="token punctuation">,</span> <span class="token class-name">Integer</span> locationType<span class="token punctuation">,</span> <span class="token class-name">String</span> functionId<span class="token punctuation">,</span> <span class="token class-name">Long</span> startTime<span class="token punctuation">,</span> <span class="token class-name">Long</span> endTime<span class="token punctuation">,</span> <span class="token class-name">Integer</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">PageHelper</span><span class="token punctuation">.</span><span class="token function">startPage</span><span class="token punctuation">(</span>pageNum<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DeviceDataVo</span><span class="token punctuation">&gt;</span></span> page <span class="token operator">=</span> deviceDataMapper<span class="token punctuation">.</span><span class="token function">page</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> deviceName<span class="token punctuation">,</span> accessLocation<span class="token punctuation">,</span> locationType<span class="token punctuation">,</span> functionId<span class="token punctuation">,</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token operator">?</span>  <span class="token keyword">null</span><span class="token operator">:</span> <span class="token class-name">LocalDateTimeUtil</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>endTime<span class="token punctuation">)</span><span class="token operator">?</span>  <span class="token keyword">null</span><span class="token operator">:</span> <span class="token class-name">LocalDateTimeUtil</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>endTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseResult</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token class-name">PageResponse</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> <span class="token class-name">DeviceDataVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(4)测试</p><p>打开设备详情，找到物模型数据，点击<strong>查看数据</strong>按钮，查询数据，是否正常</p><figure><img src="`+D+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="_4-智能床位功能" tabindex="-1"><a class="header-anchor" href="#_4-智能床位功能" aria-hidden="true">#</a> 4 智能床位功能</h2><h3 id="_4-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_4-1-需求分析" aria-hidden="true">#</a> 4.1 需求分析</h3><p>我们先来打开原型图</p><figure><img src="'+x+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>在床位管理里面有个智能床位，可以展示绑定智能设备的房间或床位以及设备对应的数据</li><li>其中数据有每分钟动态展示一次</li><li>如果某个设备的数据异常，则会在tab选项卡中进行提示</li></ul><h3 id="_4-2-思路分析" tabindex="-1"><a class="header-anchor" href="#_4-2-思路分析" aria-hidden="true">#</a> 4.2 思路分析</h3><p>表关系</p><figure><img src="'+T+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li></li></ul><p>先查询包含了智能设备的楼层</p><p>如果想要查询包含智能设备的楼层，需要关联以上四张表来查询</p><ul><li></li></ul><p>根据楼层查询房间或者是床位的设备数据（最新的一条数据）</p><p>通过查询到的楼层，然后再去查询设备中的数据，不过，这边有一个性能问题。我们需要查询包含设备的最新数据，并且只需要一条，其中device_data表中的数据是包含了所有设备上报的数据，量是特别大的，如果做关联查询，性能肯定不高。所以由于只需要查询最新的一条数据，我们可以把最新的数据存入redis缓存中，这样查询数据的时候，则无需查询device_data表，性能自然能提升不少，具体思路如下：</p><figure><img src="'+j+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_4-3-接口设计" tabindex="-1"><a class="header-anchor" href="#_4-3-接口设计" aria-hidden="true">#</a> 4.3 接口设计</h3><h4 id="_4-3-1-获取所有楼层-智能床位" tabindex="-1"><a class="header-anchor" href="#_4-3-1-获取所有楼层-智能床位" aria-hidden="true">#</a> 4.3.1 获取所有楼层 (智能床位)</h4><p><strong>接口地址</strong>:<code>/floor/getAllFloorsWithDevice</code></p><p><strong>请求方式</strong>:<code>GET</code></p><p><strong>请求参数</strong>:</p><p>无</p><p><strong>响应示例</strong>:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token string-property property">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;msg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;操作成功&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
            <span class="token string-property property">&quot;createTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-09-26 16:10:27&quot;</span><span class="token punctuation">,</span>
            <span class="token string-property property">&quot;updateTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-09-26 16:10:27&quot;</span><span class="token punctuation">,</span>
            <span class="token string-property property">&quot;createBy&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1671403256519078153&quot;</span><span class="token punctuation">,</span>
            <span class="token string-property property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1楼&quot;</span><span class="token punctuation">,</span>
            <span class="token string-property property">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span>
            <span class="token string-property property">&quot;createTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-09-26 17:37:20&quot;</span><span class="token punctuation">,</span>
            <span class="token string-property property">&quot;updateTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-09-26 17:37:20&quot;</span><span class="token punctuation">,</span>
            <span class="token string-property property">&quot;createBy&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1671403256519078138&quot;</span><span class="token punctuation">,</span>
            <span class="token string-property property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2楼&quot;</span><span class="token punctuation">,</span>
            <span class="token string-property property">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">2</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-3-2-获取所有楼层-智能床位" tabindex="-1"><a class="header-anchor" href="#_4-3-2-获取所有楼层-智能床位" aria-hidden="true">#</a> 4.3.2 获取所有楼层 (智能床位)</h4><p><strong>接口地址</strong>:<code>/room/getRoomsWithDeviceByFloorId/{floorId}</code></p><p><strong>请求方式</strong>:<code>GET</code></p><p><strong>请求参数</strong>:</p><table><thead><tr><th>参数名称</th><th>参数说明</th><th>数据类型</th></tr></thead><tbody><tr><td>floorId</td><td>楼层ID</td><td>long</td></tr></tbody></table><p><strong>响应示例</strong>:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token string-property property">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;msg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;操作成功&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span><span class="token comment">//房间数据</span>
      <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;createTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-09-26 17:38:25&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;updateTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-09-26 17:38:25&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;createBy&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1671403256519078138&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;code&quot;</span><span class="token operator">:</span> <span class="token string">&quot;101&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;sort&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;floorId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;bedVoList&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token comment">//床位列表</span>
        <span class="token punctuation">{</span><span class="token comment">//床位</span>
          <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;bedNumber&quot;</span><span class="token operator">:</span> <span class="token string">&quot;101-1&quot;</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;bedStatus&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;roomId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;马克&quot;</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;elderId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;134&quot;</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;deviceVos&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token comment">//床位中的设备列表</span>
            <span class="token punctuation">{</span>
              <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;136&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;deviceName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sm_01&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;deviceId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;jTYVdXNE8GZZMWTlKN9Tj0rk00&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;productKey&quot;</span><span class="token operator">:</span> <span class="token string">&quot;j0rkzrUrf05&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;productName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;睡眠监测带&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;deviceDataVos&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token comment">//设备中的数据</span>
                <span class="token punctuation">{</span>
                  <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;338546&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;createTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-10-11 19:13:59&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;updateTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-10-11 19:13:59&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;createBy&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;deviceName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sm_01&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;noteName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;睡眠监测带_01&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;productId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;j0rkzrUrf05&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;productName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;睡眠监测带&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;functionName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HeartRate&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;accessLocation&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1楼,101,101-1&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;dataValue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;88&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;alarmTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-10-11 19:13:59&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                  <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;338550&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;createTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-10-11 19:13:59&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;updateTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-10-11 19:13:59&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;createBy&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;deviceName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sm_01&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;noteName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;睡眠监测带_01&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;productId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;j0rkzrUrf05&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;productName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;睡眠监测带&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;functionName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;lichuangcishu&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;accessLocation&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1楼,101,101-1&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;dataValue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;15&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;alarmTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-10-11 19:13:59&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;deviceVos&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token comment">//房间中的设备</span>
        <span class="token punctuation">{</span>
          <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;135&quot;</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;deviceName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Smoke_alarm_03&quot;</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;deviceId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Z1Uaf123jnc1Cl8oAhGmj0rk00&quot;</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;productKey&quot;</span><span class="token operator">:</span> <span class="token string">&quot;j0rkHpZoAQ3&quot;</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;productName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;烟雾报警器&quot;</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;deviceDataVos&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
              <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;338537&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;createTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-10-11 19:13:54&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;updateTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-10-11 19:13:54&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;createBy&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;deviceName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Smoke_alarm_03&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;noteName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;智能烟感03&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;productId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;j0rkHpZoAQ3&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;productName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;烟雾报警器&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;functionName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;CurrentHumidity&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;accessLocation&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1楼,101&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;dataValue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;68&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;alarmTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-10-11 19:13:54&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
              <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;338539&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;createTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-10-11 19:13:54&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;updateTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-10-11 19:13:54&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;createBy&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;deviceName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Smoke_alarm_03&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;noteName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;智能烟感03&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;productId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;j0rkHpZoAQ3&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;productName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;烟雾报警器&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;functionName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;BatteryLevel&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;accessLocation&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1楼,101&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;dataValue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;-1990&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;alarmTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-10-11 19:13:54&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-功能实现" tabindex="-1"><a class="header-anchor" href="#_4-4-功能实现" aria-hidden="true">#</a> 4.4 功能实现</h3><h4 id="_4-4-1-获取所有楼层-智能床位" tabindex="-1"><a class="header-anchor" href="#_4-4-1-获取所有楼层-智能床位" aria-hidden="true">#</a> 4.4.1 获取所有楼层 (智能床位)</h4><p>(1)接口定义</p><p>在FloorController中新增方法查询楼层数据，如下</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/getAllFloorsWithDevice&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;获取所有楼层 （智能楼层）&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FloorVo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAllFloorsWithDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">ResponseResult</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>floorService<span class="token punctuation">.</span><span class="token function">getAllFloorsWithDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(2)mapper</p><p>在FloorMapper中新增方法，如下：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>List&lt;FloorVo&gt; getAllFloorsWithDevice();
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>映射文件：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>getAllFloorsWithDevice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.zzyl.vo.FloorVo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    select f.*
    from floor f
    left join room r on f.id = r.floor_id
    left join bed b on r.id = b.room_id
    left join device d on d.binding_location = r.id and d.location_type = 1 and d.physical_location_type = 1
    left join device dd on dd.binding_location = b.id and dd.location_type = 1 and dd.physical_location_type = 2
    where (d.id is not null or dd.id is not null)
    group by f.id
    order by f.code, f.create_time desc
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>device d关联的是房间的设备，在关联表后面限定了条件 <code>d.location_type = 1 and d.physical_location_type = 1</code>,代表的是：位置类型为<strong>位置</strong>，物理位置类为<strong>房间</strong></li><li>device dd 关联的是床位的设备，在关联表后面限定了条件 <code>d.location_type = 1 and d.physical_location_type = 2</code>,代表的是：位置类型为<strong>位置</strong>，物理位置类为<strong>床位</strong></li></ul><p>(3)业务层</p><p>在FloorService中新增方法，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
     * 查询包含智能设备的楼层
     * <span class="token keyword">@return</span>
     */</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FloorVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAllFloorsWithDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实现方法：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token doc-comment comment">/**
     * 查询包含智能设备的楼层
     * <span class="token keyword">@return</span>
     */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FloorVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAllFloorsWithDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> floorMapper<span class="token punctuation">.</span><span class="token function">getAllFloorsWithDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(4)测试</p><ul><li></li></ul><p>前提</p><p>新增设备，绑定楼层中的房间或床位</p><ul><li></li></ul><p>查询效果</p><p>在智能床位模块：展示绑定过的设备的房间或床位所在的楼层列表</p><h4 id="_4-4-2-获取所有楼层-智能床位" tabindex="-1"><a class="header-anchor" href="#_4-4-2-获取所有楼层-智能床位" aria-hidden="true">#</a> 4.4.2 获取所有楼层 (智能床位)</h4><p>(1)接口定义</p><p>在RoomController中定义新的接口，接收的参数为楼层id，方法如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/getRoomsWithDeviceByFloorId/{floorId}&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;获取所有房间（智能床位）&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">RoomVo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getRoomsWithDeviceByFloorId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> floorId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">ResponseResult</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>roomService<span class="token punctuation">.</span><span class="token function">getRoomsWithDeviceByFloorId</span><span class="token punctuation">(</span>floorId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(2)mapper</p><p>在RoomMapper中新增方法，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RoomVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getRoomsWithDeviceByFloorId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> floorId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>映射文件：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>getRoomsWithDeviceByFloorIdResultMap<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.zzyl.vo.RoomVo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>id<span class="token punctuation">&quot;</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>id<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>code<span class="token punctuation">&quot;</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>code<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sort<span class="token punctuation">&quot;</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sort<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sort<span class="token punctuation">&quot;</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sort<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>floorId<span class="token punctuation">&quot;</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>floor_id<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>floorName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fname<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>create_by<span class="token punctuation">&quot;</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>createBy<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>update_by<span class="token punctuation">&quot;</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>updateBy<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>remark<span class="token punctuation">&quot;</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>remark<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>create_time<span class="token punctuation">&quot;</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>createTime<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>update_time<span class="token punctuation">&quot;</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>updateTime<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>price<span class="token punctuation">&quot;</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>price<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>collection</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bedVoList<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ofType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.zzyl.vo.BedVo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bid<span class="token punctuation">&quot;</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>id<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bed_number<span class="token punctuation">&quot;</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bedNumber<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bed_status<span class="token punctuation">&quot;</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bedStatus<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>room_id<span class="token punctuation">&quot;</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>roomId<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ename<span class="token punctuation">&quot;</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>eid<span class="token punctuation">&quot;</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>elderId<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>collection</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>deviceVos<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ofType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.zzyl.vo.DeviceVo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>b_did<span class="token punctuation">&quot;</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>id<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>b_device_id<span class="token punctuation">&quot;</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>deviceId<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>b_device_name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>deviceName<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>b_product_key<span class="token punctuation">&quot;</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>productKey<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>b_produce_name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>productName<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>collection</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>collection</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>collection</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>deviceVos<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ofType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.zzyl.vo.DeviceVo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>r_did<span class="token punctuation">&quot;</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>BIGINT<span class="token punctuation">&quot;</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>id<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>device_id<span class="token punctuation">&quot;</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>VARCHAR<span class="token punctuation">&quot;</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>deviceId<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>device_name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>VARCHAR<span class="token punctuation">&quot;</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>deviceName<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>product_key<span class="token punctuation">&quot;</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>VARCHAR<span class="token punctuation">&quot;</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>productKey<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>produce_name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>BIT<span class="token punctuation">&quot;</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>productName<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>collection</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>getRoomsWithDeviceByFloorId<span class="token punctuation">&quot;</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>getRoomsWithDeviceByFloorIdResultMap<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    select r.*,
    b.id bid,
    b.bed_number,
    b.sort,
    b.bed_status,
    b.room_id,
    b.create_by,
    b.update_by,
    b.remark,
    b.create_time,
    b.update_time,
    e.name ename,
    e.id eid,
    d.id as r_did,
    d.device_id,
    d.product_id    as product_key,
    d.device_name,
    d.produce_name,
    dd.id as b_did,
    dd.device_id b_device_id,
    dd.product_id    as b_product_key,
    dd.device_name as b_device_name,
    dd.produce_name as b_produce_name
    from room r
    left join bed b on r.id = b.room_id
    left join elder e on b.id = e.bed_id
    left join device d on d.binding_location = r.id and d.location_type = 1 and d.physical_location_type = 1
    left join device dd on dd.binding_location = b.id and dd.location_type = 1 and dd.physical_location_type = 2
    where r.floor_id = #{floorId}
    and (d.id is not null or dd.id is not null)
    order by r.sort ,r.create_time desc
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(3)业务层</p><p>在RoomService中新增方法，如下</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
     * 查询楼层中的房间和床位设备及数据
     * <span class="token keyword">@param</span> <span class="token parameter">floorId</span>
     * <span class="token keyword">@return</span>
     */</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RoomVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getRoomsWithDeviceByFloorId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> floorId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实现方法：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
     * 查询楼层中的房间和床位设备及数据
     * <span class="token keyword">@param</span> <span class="token parameter">floorId</span>
     * <span class="token keyword">@return</span>
     */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RoomVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getRoomsWithDeviceByFloorId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> floorId<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//根据楼层id检索数据</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RoomVo</span><span class="token punctuation">&gt;</span></span> roomVos <span class="token operator">=</span> roomMapper<span class="token punctuation">.</span><span class="token function">getRoomsWithDeviceByFloorId</span><span class="token punctuation">(</span>floorId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    roomVos<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>roomVo <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取房间中的设备数据</span>
        roomVo<span class="token punctuation">.</span><span class="token function">getDeviceVos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>deviceVo <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> deviceId <span class="token operator">=</span> deviceVo<span class="token punctuation">.</span><span class="token function">getDeviceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> deviceLastDataJson <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEVICE_LASTDATA_CACHE_KEY</span><span class="token punctuation">,</span> deviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>deviceLastDataJson<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token comment">//跳过本次循环</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//获取设备中的数据</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DeviceDataVo</span><span class="token punctuation">&gt;</span></span> deviceDataVos <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span>deviceLastDataJson<span class="token punctuation">,</span> <span class="token class-name">DeviceDataVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            deviceVo<span class="token punctuation">.</span><span class="token function">setDeviceDataVos</span><span class="token punctuation">(</span>deviceDataVos<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//修改状态，告诉前端，设备中有数据</span>
            roomVo<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//获取房间中的床位及设备数据</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BedVo</span><span class="token punctuation">&gt;</span></span> bedVoList <span class="token operator">=</span> roomVo<span class="token punctuation">.</span><span class="token function">getBedVoList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bedVoList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>bedVo <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DeviceVo</span><span class="token punctuation">&gt;</span></span> deviceVos <span class="token operator">=</span> bedVo<span class="token punctuation">.</span><span class="token function">getDeviceVos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            deviceVos<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>deviceVo <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> deviceId <span class="token operator">=</span> deviceVo<span class="token punctuation">.</span><span class="token function">getDeviceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> deviceLastDataJson <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEVICE_LASTDATA_CACHE_KEY</span><span class="token punctuation">,</span> deviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>deviceLastDataJson<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token comment">//跳过本次循环</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//获取设备中的数据</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DeviceDataVo</span><span class="token punctuation">&gt;</span></span> deviceDataVos <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span>deviceLastDataJson<span class="token punctuation">,</span> <span class="token class-name">DeviceDataVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                deviceVo<span class="token punctuation">.</span><span class="token function">setDeviceDataVos</span><span class="token punctuation">(</span>deviceDataVos<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//修改状态，告诉前端，设备中有数据</span>
                roomVo<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                bedVo<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> roomVos<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中的常量定义在zzyl-common模块下创建，在Constants类中新增常量，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 设备最新数据缓存KEY
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEVICE_LASTDATA_CACHE_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;deviceLastData&quot;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(4)监听器中保存数据到缓存</p><p>在AmqpClient类中的processMessage方法，把设备的数据保存到缓存中</p><p>processMessage方法，完整代码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> redisTemplate<span class="token punctuation">;</span>


<span class="token doc-comment comment">/**
     * 在这里处理您收到消息后的具体业务逻辑。
     */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> contentStr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> topic <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getStringProperty</span><span class="token punctuation">(</span><span class="token string">&quot;topic&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> messageId <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getStringProperty</span><span class="token punctuation">(</span><span class="token string">&quot;messageId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;receive message&quot;</span>
                    <span class="token operator">+</span> <span class="token string">&quot;,\\n topic = &quot;</span> <span class="token operator">+</span> topic
                    <span class="token operator">+</span> <span class="token string">&quot;,\\n messageId = &quot;</span> <span class="token operator">+</span> messageId
                    <span class="token operator">+</span> <span class="token string">&quot;,\\n content = &quot;</span> <span class="token operator">+</span> contentStr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//解析数据</span>
        <span class="token class-name">Content</span> content <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>contentStr<span class="token punctuation">,</span> <span class="token class-name">Content</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//查询设备</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DeviceVo</span><span class="token punctuation">&gt;</span></span> deviceVos <span class="token operator">=</span> deviceMapper<span class="token punctuation">.</span><span class="token function">selectByDeviceIds</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">getIotId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>deviceVos<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;设备不存在&quot;</span> <span class="token operator">+</span> content<span class="token punctuation">.</span><span class="token function">getIotId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">DeviceVo</span> deviceVo <span class="token operator">=</span> deviceVos<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DeviceDataVo</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//保存设备数据,设备中可能会存在多个物模型</span>
        content<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">DeviceData</span> deviceData <span class="token operator">=</span> <span class="token class-name">DeviceData</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">alarmTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTimeUtil</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">deviceName</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">getDeviceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">iotId</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">getIotId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">productId</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">getProductKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">noteName</span><span class="token punctuation">(</span>deviceVo<span class="token punctuation">.</span><span class="token function">getNickname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">productName</span><span class="token punctuation">(</span>deviceVo<span class="token punctuation">.</span><span class="token function">getProductName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">accessLocation</span><span class="token punctuation">(</span>deviceVo<span class="token punctuation">.</span><span class="token function">getRemark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">functionName</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataValue</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">+</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//保存</span>
            deviceDataMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>deviceData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DeviceDataVo</span> deviceDataVo <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>deviceData<span class="token punctuation">,</span> <span class="token class-name">DeviceDataVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>deviceDataVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//保存数据到缓存中</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">DEVICE_LASTDATA_CACHE_KEY</span><span class="token punctuation">,</span> content<span class="token punctuation">.</span><span class="token function">getIotId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;processMessage occurs error &quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(5)测试</p><ul><li></li></ul><p>前提条件</p><p>在绑定设备的床位或房间中，启动设备模拟上报数据</p><ul><li></li></ul><p>在页面中查询上报之后的数据</p><figure><img src="`+C+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="_5-家属端家人数据报表展示" tabindex="-1"><a class="header-anchor" href="#_5-家属端家人数据报表展示" aria-hidden="true">#</a> 5 家属端家人数据报表展示</h2><h3 id="_5-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_5-1-需求分析" aria-hidden="true">#</a> 5.1 需求分析</h3><p>我们先来看原型图</p><figure><img src="'+A+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>在小程序端，绑定了老人之后，就可以查看老人的健康数据。</p><ul><li>在家人列表中，点击【健康数据】，跳转到【健康数据】，这里展示的是老人健康数据概览和当下最新指标数据</li><li>当点击了某一个指标之后，可以查看某一个指标的历史数据，可以按天或周进行报表展示</li><li>异常数据，后边讲完告警模块之后，再来完善异常数据展示</li></ul><h3 id="_5-2-思路分析" tabindex="-1"><a class="header-anchor" href="#_5-2-思路分析" aria-hidden="true">#</a> 5.2 思路分析</h3><figure><img src="'+R+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li><p>当查看<strong>家人列表</strong>的时候，需要查询当前登录人的老人列表，同时老人的其他信息也要查询出来（房间、床位、设备）</p></li><li><p>当点击<strong>健康数据</strong>的时候，需要根据当前老人绑定的产品和设备名称到IOT平台查询物模型数据</p></li><li><p>当点击<strong>某项指标数据</strong>，比如<strong>心率</strong>，可以查看这个指标数据的报表信息，报表包含了两种</p><ul><li>按照天查询，其中心率、血压、血氧、体温的传输频次：每3小时测量传输一次，所以一天展示8次</li><li>按周查询，周数据值显示近七天，天数据为当天数据的平均值</li></ul></li></ul><h3 id="_5-3-接口设计" tabindex="-1"><a class="header-anchor" href="#_5-3-接口设计" aria-hidden="true">#</a> 5.3 接口设计</h3><p>根据上面的思路分析，我们共需要开发4个接口，分别是：家人列表、查询健康数据、按天统计、按周统计</p><p>其中的家人列表，在代码中已经提供，我们重点实现剩下的3个</p><h4 id="_5-3-1-查询健康数据" tabindex="-1"><a class="header-anchor" href="#_5-3-1-查询健康数据" aria-hidden="true">#</a> 5.3.1 查询健康数据</h4><p><strong>接口地址</strong>:<code>/customer/user/QueryDevicePropertyStatus</code></p><p><strong>请求方式</strong>:<code>POST</code></p><p><strong>请求示例</strong>:</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;deviceName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;productKey&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>响应示例</strong>:</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;code&quot;</span><span class="token operator">:</span><span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token property">&quot;msg&quot;</span><span class="token operator">:</span><span class="token string">&quot;操作成功&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;data&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;list&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token property">&quot;propertyStatusInfo&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    <span class="token property">&quot;dataType&quot;</span><span class="token operator">:</span><span class="token string">&quot;int&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;identifier&quot;</span><span class="token operator">:</span><span class="token string">&quot;HeartRate&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;心率&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;time&quot;</span><span class="token operator">:</span><span class="token string">&quot;1697096335545&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;unit&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token string">&quot;87&quot;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    <span class="token property">&quot;dataType&quot;</span><span class="token operator">:</span><span class="token string">&quot;float&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;identifier&quot;</span><span class="token operator">:</span><span class="token string">&quot;BodyTemp&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;体温&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;time&quot;</span><span class="token operator">:</span><span class="token string">&quot;1697096335545&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;unit&quot;</span><span class="token operator">:</span><span class="token string">&quot;℃&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token string">&quot;39.0&quot;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    <span class="token property">&quot;dataType&quot;</span><span class="token operator">:</span><span class="token string">&quot;int&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;identifier&quot;</span><span class="token operator">:</span><span class="token string">&quot;xueyang&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;血氧&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;time&quot;</span><span class="token operator">:</span><span class="token string">&quot;1697096335545&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token string">&quot;106&quot;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    <span class="token property">&quot;dataType&quot;</span><span class="token operator">:</span><span class="token string">&quot;double&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;identifier&quot;</span><span class="token operator">:</span><span class="token string">&quot;BatteryPercentage&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;电池电量百分比&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;time&quot;</span><span class="token operator">:</span><span class="token string">&quot;1697096335545&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;unit&quot;</span><span class="token operator">:</span><span class="token string">&quot;%&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token string">&quot;-22.0&quot;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    <span class="token property">&quot;dataType&quot;</span><span class="token operator">:</span><span class="token string">&quot;int&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;identifier&quot;</span><span class="token operator">:</span><span class="token string">&quot;xueya&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;血压&quot;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-3-2-按天统计查询指标数据" tabindex="-1"><a class="header-anchor" href="#_5-3-2-按天统计查询指标数据" aria-hidden="true">#</a> 5.3.2 按天统计查询指标数据</h4><p><strong>接口地址</strong>:<code>/customer/user/get-page</code></p><p><strong>请求方式</strong>:<code>GET</code></p><p><strong>请求参数</strong>:</p><table><thead><tr><th>参数名称</th><th>参数说明</th><th>数据类型</th></tr></thead><tbody><tr><td>pageNum</td><td>页码</td><td>integer(int32)</td></tr><tr><td>pageSize</td><td>每页大小</td><td>integer(int32)</td></tr><tr><td>deviceName</td><td>设备名称</td><td>string</td></tr><tr><td>endTime</td><td>结束时间</td><td>integer(int64)</td></tr><tr><td>functionId</td><td>功能ID</td><td>string</td></tr><tr><td>startTime</td><td>开始时间</td><td>integer(int64)</td></tr><tr><td>status</td><td>状态 0 正常 1 异常 2待处理 3已处理</td><td>integer(int32)</td></tr></tbody></table><p><strong>响应示例</strong>:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token string-property property">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;msg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;操作成功&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;total&quot;</span><span class="token operator">:</span> <span class="token string">&quot;456&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;pageSize&quot;</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;pages&quot;</span><span class="token operator">:</span> <span class="token string">&quot;46&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;page&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;records&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;352069&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;createTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-10-12 15:41:31&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;updateTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-10-12 15:41:31&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;createBy&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;deviceName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;watch_08&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;noteName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;智能定位手表&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;productId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;j0rkM5mCanO&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;productName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;健康定位报警手表&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;functionName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HeartRate&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;accessLocation&quot;</span><span class="token operator">:</span> <span class="token string">&quot;马克&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;dataValue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;86&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;alarmTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-10-12 15:41:31&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-3-3-按周统计查询指标数据" tabindex="-1"><a class="header-anchor" href="#_5-3-3-按周统计查询指标数据" aria-hidden="true">#</a> 5.3.3 按周统计查询指标数据</h4><p><strong>接口地址</strong>:<code>/customer/user/get-week-page</code></p><p><strong>请求方式</strong>:<code>GET</code></p><p><strong>请求参数</strong>:</p><table><thead><tr><th>参数名称</th><th>参数说明</th><th>数据类型</th></tr></thead><tbody><tr><td>pageNum</td><td>页码</td><td>integer(int32)</td></tr><tr><td>pageSize</td><td>每页大小</td><td>integer(int32)</td></tr><tr><td>deviceName</td><td>设备名称</td><td>string</td></tr><tr><td>endTime</td><td>结束时间</td><td>integer(int64)</td></tr><tr><td>functionId</td><td>功能ID</td><td>string</td></tr><tr><td>startTime</td><td>开始时间</td><td>integer(int64)</td></tr><tr><td>status</td><td>状态 0 正常 1 异常 2待处理 3已处理</td><td>integer(int32)</td></tr></tbody></table><p><strong>响应示例</strong>:</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
  <span class="token property">&quot;msg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;操作成功&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;total&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;pageSize&quot;</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token property">&quot;pages&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;page&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;records&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;dataValue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;79.5531453362256&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token string">&quot;10月12日&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;dataValue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;78.51217712177122&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token string">&quot;10月11日&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;dataValue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;78.51217712177122&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token string">&quot;10月10日&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;dataValue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;78.51217712177122&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token string">&quot;10月09日&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;dataValue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;78.51217712177122&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token string">&quot;10月08日&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;dataValue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;78.51217712177122&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token string">&quot;10月07日&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;dataValue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;78.51217712177122&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token string">&quot;10月06日&quot;</span>
      <span class="token punctuation">}</span>
      
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-4-功能实现" tabindex="-1"><a class="header-anchor" href="#_5-4-功能实现" aria-hidden="true">#</a> 5.4 功能实现</h3><h4 id="_5-4-1-查询健康数据" tabindex="-1"><a class="header-anchor" href="#_5-4-1-查询健康数据" aria-hidden="true">#</a> 5.4.1 查询健康数据</h4><p>根据产品ID和设备名称查询物模型数据，我们在前一天已经实现过一次</p><p>小程序的查询需要定义在客户管理的控制层，CustomerUserController中实现，如下代码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>zzyl<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>customer</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
 * 用户管理
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>tags <span class="token operator">=</span> <span class="token string">&quot;客户管理&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/customer/user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerUserController</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MemberService</span> memberService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">Client</span> client<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${zzyl.aliyun.iotInstanceId}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> iotInstanceId<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/QueryDevicePropertyStatus&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;查询指定设备的状态&quot;</span><span class="token punctuation">,</span> notes <span class="token operator">=</span> <span class="token string">&quot;查询指定设备的状态&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseResult</span> <span class="token class-name">QueryDevicePropertyStatus</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">QueryDevicePropertyStatusRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        request<span class="token punctuation">.</span><span class="token function">setIotInstanceId</span><span class="token punctuation">(</span>iotInstanceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">QueryDevicePropertyStatusResponse</span> deviceStatus <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">queryDevicePropertyStatus</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseResult</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>deviceStatus<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试</p><ul><li></li></ul><p>前提条件有两个</p><ul><li>家属端登录人需要绑定带有智能手表设备的老人</li><li>启动模拟数据上报</li><li></li></ul><p>当点击了健康数据按钮，之后，查询效果如下：</p><figure><img src="`+L+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><blockquote><p>注意：目前前端只开发了心率的动态展示和报表展示，大家看效果主要看心率这个物模型</p></blockquote><h4 id="_5-4-2-按天统计查询指标数据" tabindex="-1"><a class="header-anchor" href="#_5-4-2-按天统计查询指标数据" aria-hidden="true">#</a> 5.4.2 按天统计查询指标数据</h4><p>(1) 接口定义</p><p>在CustomerUserController新增接口，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/get-page&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;获取设备数据分页结果&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageResponse</span><span class="token punctuation">&lt;</span><span class="token class-name">DeviceDataVo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getDeviceDataPage</span><span class="token punctuation">(</span>
    <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;页码&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;pageNum&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> pageNum<span class="token punctuation">,</span>
    <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;每页大小&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;pageSize&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> pageSize<span class="token punctuation">,</span>
    <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;设备名称&quot;</span><span class="token punctuation">)</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;deviceName&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> deviceName<span class="token punctuation">,</span>
    <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;功能ID&quot;</span><span class="token punctuation">)</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;functionId&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> functionId<span class="token punctuation">,</span>
    <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;开始时间&quot;</span><span class="token punctuation">)</span>  <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> startTime<span class="token punctuation">,</span>
    <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;结束时间&quot;</span><span class="token punctuation">)</span>  <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> endTime<span class="token punctuation">,</span>
    <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;状态 0 正常 1 异常 2待处理 3已处理&quot;</span><span class="token punctuation">)</span>  <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">PageResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DeviceDataVo</span><span class="token punctuation">&gt;</span></span> page <span class="token operator">=</span> deviceDataService<span class="token punctuation">.</span><span class="token function">getDeviceDataPage</span><span class="token punctuation">(</span>pageNum<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> deviceName<span class="token punctuation">,</span> functionId<span class="token punctuation">,</span> startTime<span class="token punctuation">,</span> endTime<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">ResponseResult</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(2) mapper</p><p>已实现</p><p>(3) 业务层</p><p>已实现</p><p>(4)测试</p><p>在小程序端点击心率，可以查看报表数据，也可以选择时间来进行检索，如下图</p><figure><img src="`+P+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="_5-4-3-按周统计查询指标数据" tabindex="-1"><a class="header-anchor" href="#_5-4-3-按周统计查询指标数据" aria-hidden="true">#</a> 5.4.3 按周统计查询指标数据</h4><p>(1) 接口定义</p><p>在CustomerUserController新增方法，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/get-week-page&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;按周获取设备数据分页结果&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageResponse</span><span class="token punctuation">&lt;</span><span class="token class-name">DeviceDataVo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getDeviceWeekDataPage</span><span class="token punctuation">(</span>
    <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;页码&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;pageNum&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> pageNum<span class="token punctuation">,</span>
    <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;每页大小&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;pageSize&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> pageSize<span class="token punctuation">,</span>
    <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;设备名称&quot;</span><span class="token punctuation">)</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;deviceName&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> deviceName<span class="token punctuation">,</span>
    <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;功能ID&quot;</span><span class="token punctuation">)</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;functionId&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> functionId<span class="token punctuation">,</span>
    <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;开始时间&quot;</span><span class="token punctuation">)</span>  <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> startTime<span class="token punctuation">,</span>
    <span class="token annotation punctuation">@ApiParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;结束时间&quot;</span><span class="token punctuation">)</span>  <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> endTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> deviceDataService<span class="token punctuation">.</span><span class="token function">getDeviceWeekDataPage</span><span class="token punctuation">(</span>pageNum<span class="token punctuation">,</span>pageSize<span class="token punctuation">,</span>deviceName<span class="token punctuation">,</span>functionId<span class="token punctuation">,</span>startTime<span class="token punctuation">,</span>endTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(2) mapper</p><p>在DeviceDataMapper中新增方法，如下</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DeviceDataVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">pageWeek</span><span class="token punctuation">(</span><span class="token class-name">String</span> deviceName<span class="token punctuation">,</span><span class="token class-name">String</span> functionId<span class="token punctuation">,</span> <span class="token class-name">LocalDateTime</span> startTime<span class="token punctuation">,</span> <span class="token class-name">LocalDateTime</span> endTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>映射文件：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pageWeek<span class="token punctuation">&quot;</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.zzyl.vo.DeviceDataVo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    select
    DATE_FORMAT(\`alarm_time\`, &#39;%m月%d日&#39;) AS \`data\`, AVG(\`data_value\`) AS \`data_value\`
    from device_data
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>where</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>deviceName != null<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            and device_name = #{deviceName,jdbcType=VARCHAR}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>functionId != null<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            and function_name = #{functionId,jdbcType=VARCHAR}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>startTime != null and endTime != null<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            AND alarm_time BETWEEN #{startTime} AND #{endTime}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>where</span><span class="token punctuation">&gt;</span></span>
    group by data
    order by create_time desc

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(3) 业务层</p><p>在DeviceDataService中新增方法，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
     * 根据周进行统计数据
     * <span class="token keyword">@param</span> <span class="token parameter">pageNum</span>
     * <span class="token keyword">@param</span> <span class="token parameter">pageSize</span>
     * <span class="token keyword">@param</span> <span class="token parameter">deviceName</span>
     * <span class="token keyword">@param</span> <span class="token parameter">functionId</span>
     * <span class="token keyword">@param</span> <span class="token parameter">startTime</span>
     * <span class="token keyword">@param</span> <span class="token parameter">endTime</span>
     * <span class="token keyword">@return</span>
     */</span>
<span class="token class-name">ResponseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageResponse</span><span class="token punctuation">&lt;</span><span class="token class-name">DeviceDataVo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getDeviceWeekDataPage</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> pageNum<span class="token punctuation">,</span> <span class="token class-name">Integer</span> pageSize<span class="token punctuation">,</span> <span class="token class-name">String</span> deviceName<span class="token punctuation">,</span> <span class="token class-name">String</span> functionId<span class="token punctuation">,</span> <span class="token class-name">Long</span> startTime<span class="token punctuation">,</span> <span class="token class-name">Long</span> endTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实现方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token doc-comment comment">/**
     * 根据周进行统计数据
     * <span class="token keyword">@param</span> <span class="token parameter">pageNum</span>
     * <span class="token keyword">@param</span> <span class="token parameter">pageSize</span>
     * <span class="token keyword">@param</span> <span class="token parameter">deviceName</span>
     * <span class="token keyword">@param</span> <span class="token parameter">functionId</span>
     * <span class="token keyword">@param</span> <span class="token parameter">startTime</span>
     * <span class="token keyword">@param</span> <span class="token parameter">endTime</span>
     * <span class="token keyword">@return</span>
     */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageResponse</span><span class="token punctuation">&lt;</span><span class="token class-name">DeviceDataVo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getDeviceWeekDataPage</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> pageNum<span class="token punctuation">,</span> <span class="token class-name">Integer</span> pageSize<span class="token punctuation">,</span> <span class="token class-name">String</span> deviceName<span class="token punctuation">,</span> <span class="token class-name">String</span> functionId<span class="token punctuation">,</span> <span class="token class-name">Long</span> startTime<span class="token punctuation">,</span> <span class="token class-name">Long</span> endTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">PageHelper</span><span class="token punctuation">.</span><span class="token function">startPage</span><span class="token punctuation">(</span>pageNum<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DeviceDataVo</span><span class="token punctuation">&gt;</span></span> deviceDataVos <span class="token operator">=</span> deviceDataMapper<span class="token punctuation">.</span><span class="token function">pageWeek</span><span class="token punctuation">(</span>deviceName<span class="token punctuation">,</span> functionId<span class="token punctuation">,</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token class-name">LocalDateTimeUtil</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>endTime<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token class-name">LocalDateTimeUtil</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>endTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">ResponseResult</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token class-name">PageResponse</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>deviceDataVos<span class="token punctuation">,</span><span class="token class-name">DeviceDataVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(4)测试</p><p>测试效果如下：</p><figure><img src="`+N+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>',258);function B(K,F){const t=o("ExternalLinkIcon");return c(),l("div",null,[M,n("p",null,[n("a",z,[s("https://help.aliyun.com/zh/iot/developer-reference/connect-a-client-to-iot-platform-by-using-the-sdk-for-java?spm=a2c4g.11186623.0.0.7d7234bdQCi7MQ"),p(t)])]),E,n("p",null,[s("下载地址："),n("a",O,[s("https://linkkit-export.oss-cn-shanghai.aliyuncs.com/amqp/amqp-demo.zip"),p(t)])]),U])}const J=e(V,[["render",B],["__file","day13-物联网智能监测-IOT消息处理.html.vue"]]);export{J as default};
